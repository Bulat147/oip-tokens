<!doctype html>
<html lang="ru">
 <head>
  <title>Дизайн hash-таблиц в redis / Хабр</title>
  <meta property="fb:app_id" content="444736788986613">
  <meta property="fb:pages" content="472597926099084">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@habr_com">
  <meta property="og:site_name" content="Хабр">
  <link href="https://habr.com/ru/rss/post/907408/?fl=ru" type="application/rss+xml" title rel="alternate" name="rss">
  <link href="https://habr.com/ru/articles/907408/" rel="canonical" data-hid="e3fa780">
  <link rel="image_src" href="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/" data-hid="2a79c45">
  <link rel="amphtml" href="https://habr.com/ru/amp/publications/907408/">
  <meta property="og:title" content="Дизайн hash-таблиц в redis">
  <meta name="twitter:title" content="Дизайн hash-таблиц в redis">
  <meta name="aiturec:title" content="Дизайн hash-таблиц в redis">
  <meta name="description" content="Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно....">
  <meta itemprop="description" content="Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно....">
  <meta property="og:description" content="Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно....">
  <meta name="twitter:description" content="Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно....">
  <meta property="aiturec:description" content="Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно....">
  <meta itemprop="image" content="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/">
  <meta property="og:image" content="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="aiturec:image" content="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/">
  <meta name="twitter:image" content="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/">
  <meta property="vk:image" content="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/?format=vk">
  <meta property="vk:image" content="https://habr.com/share/publication/907408/32116b20d32d88b828b59a947fef081a/?format=vk?format=vk">
  <meta property="aiturec:item_id" content="907408">
  <meta property="aiturec:datetime" content="2025-05-06T14:45:29.000Z">
  <meta content="https://habr.com/ru/articles/907408/" property="og:url">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="ru_RU">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="keywords" content="redis">
  <script type="application/ld+json" data-hid="1e0f0a2">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/articles\/907408\/"},"headline":"Дизайн hash-таблиц в redis","datePublished":"2025-05-06T17:45:29+03:00","dateModified":"2025-05-06T17:45:29+03:00","author":{"@type":"Person","name":"Клёпов Алексей"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Когда приходится работать большими redis базами в десятки Гб понимание &ldquo;а как оно там?&rdquo;, &ldquo;откуда такой размер?&rdquo;, &ldquo;как правильно отстрелить ногу при проектировани...","url":"https:\/\/habr.com\/ru\/articles\/907408\/#post-content-body","about":["h_nosql","f_develop"],"image":["https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f6a\/20b\/437\/f6a20b4374a2cd4603576028f32323a8.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fca\/58a\/a6b\/fca58aa6b09586e6574cb6695c1d584a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/873\/280\/0be\/8732800be159bc175d0980f82ee36ffe.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/ef7\/679\/a20\/ef7679a2075866e7ea6cc51bd880ae23.png"]}</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1,user-scalable=0">
  <meta name="referrer" content="unsafe-url">
  <style>
      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmojLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvk4jLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmYjLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvl4jLazX3dA.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSxf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveQhf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSBf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveRhf6Xl7Glw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSxf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eQhf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSBf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eRhf6Xl7Glw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" as="style" media="(prefers-color-scheme: light)">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" as="style" media="(prefers-color-scheme: dark)">
  <link id="light-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" media="(prefers-color-scheme: light)">
  <link id="dark-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" media="(prefers-color-scheme: dark)">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.635b6c39236ebd33fa716c71ab0131a0.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  <style>
      .grecaptcha-badge {
        visibility: hidden;
      }
    </style>
  <meta name="habr-version" content="2.241.0">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png">
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png">
  <link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png">
  <link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png">
  <link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" type="image/png" sizes="256x256" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png">
  <link rel="mask-icon" color="#77a2b6" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg">
  <link crossorigin="use-credentials" href="/manifest.webmanifest" rel="manifest">
  <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script>
  <script>window.yaContextCb = window.yaContextCb || []</script>
  <script src="https://yandex.ru/ads/system/context.js" async></script>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" as="script">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/app.8599692f.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/app.58b8c457.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.8599692f.css">
 </head>
 <body>
  <div id="mount">
   <div id="app">
    <div class="tm-layout__wrapper">
     <!--[--><!---->
     <div></div><!---->
     <header class="tm-header" data-test-id="header">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-header__container">
        <!----><span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_hl-ru tm-header__logo" href="/ru/">
          <svg class="tm-svg-img tm-header__icon" height="16" width="16">
           <title>
            Хабр
           </title><use xlink:href="/img/habr-logo-ru.svg#logo"></use>
          </svg></a><span style="display:none;" class="tm-header__beta-sign">β</span></span><!--[-->
        <div class="tm-dropdown tm-header__projects">
         <div class="tm-dropdown__head">
          <!--[-->
          <button class="tm-header__dropdown-toggle">
           <svg class="tm-svg-img tm-header__icon tm-header__icon_dropdown" height="16" width="16">
            <title>
             Открыть список
            </title><use xlink:href="/img/megazord-v28.7909a852..svg#arrow-down"></use>
           </svg></button><!--]-->
         </div><!---->
        </div><a href="/ru/sandbox/start/" class="tm-header__become-author-btn">Как стать автором</a>
        <div class="tm-feature tm-feature tm-feature_variant-inline tm-header__feature">
         <!---->
        </div><!----><!--]--><!---->
       </div><!--]-->
      </div>
     </header>
     <div class="tm-layout">
      <div class="tm-page-progress-bar"></div>
      <div class="tm-base-layout__header_is-sticky tm-base-layout__header" data-menu-sticky="true">
       <div class="tm-page-width">
        <!--[-->
        <div class="tm-base-layout__header-wrapper">
         <div class="tm-main-menu">
          <div class="tm-main-menu__section">
           <nav class="tm-main-menu__section-content">
            <!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/feed/">Моя лента</a><!--]--><!--[--><a class="tm-main-menu__item" href="/ru/articles/">Все потоки</a><!--]--><!--[--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/develop/">Разработка</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/admin/">Администрирование</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/design/">Дизайн</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/management/">Менеджмент</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/marketing/">Маркетинг</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/popsci/">Научпоп</a><!--]--><!--]-->
           </nav>
          </div>
         </div>
         <div class="tm-header-user-menu tm-base-layout__user-menu">
          <a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search" data-test-id="search-button">
           <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark" height="24" width="24">
            <title>
             Поиск
            </title><use xlink:href="/img/megazord-v28.7909a852..svg#search"></use>
           </svg></a><!----><!---->
          <div class="tm-header-user-menu__item tm-header-user-menu__write">
           <div>
            <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_write tm-header-user-menu__icon_dark" height="24" width="24">
             <title>
              Написать публикацию
             </title><use xlink:href="/img/megazord-v28.7909a852..svg#write"></use>
            </svg>
           </div><!---->
          </div><!--[-->
          <div class="tm-header-user-menu__item">
           <button class="tm-header-user-menu__toggle" data-test-id="user-menu-settings">
            <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_dark" height="24" width="24">
             <title>
              Настройки
             </title><use xlink:href="/img/megazord-v28.7909a852..svg#page-settings"></use>
            </svg></button>
          </div><a href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/articles/907408/&amp;hl=ru" rel="nofollow" class="tm-header-user-menu__item"><!--[-->
           <button class="btn btn_solid btn_small tm-header-user-menu__login" type="button"><!--[-->Войти<!--]--></button><!--]--></a><!--]--><!----><!--teleport start--><!--teleport end--><!---->
         </div>
        </div><!--]-->
       </div>
      </div><!---->
      <div class="tm-page-width">
       <!--[--><!--]-->
      </div>
      <main class="tm-layout__container">
       <div class="tm-page" hl="ru" data-async-called="true" style="--5ab2e5a8:16px;--44c4f6f6:100%;--45ba7a3b:0;">
        <div class="tm-page-width">
         <!--[--><!---->
         <div class="tm-page__wrapper">
          <div class="tm-page__main_has-sidebar tm-page__main">
           <div class="pull-down">
            <!---->
            <div class="pull-down__header" style="height:0px;">
             <div class="pull-down__content" style="bottom:10px;">
              <svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24">
               <title>
                Обновить
               </title><use xlink:href="/img/megazord-v28.7909a852..svg#pull-arrow"></use>
              </svg>
             </div>
            </div><!--[--><!--[--><!---->
            <div class="tm-article-presenter">
             <!--[--><!--]-->
             <div class="tm-article-presenter__body" data-test-id="article-body">
              <div class="tm-misprint-area">
               <div class="tm-misprint-area__wrapper">
                <!--[-->
                <article class="tm-article-presenter__content tm-article-presenter__content_narrow">
                 <!--[-->
                 <div class="tm-article-presenter__header">
                  <!--[--><!--]-->
                  <div class="tm-article-snippet tm-article-snippet tm-article-presenter__snippet">
                   <!--[--><!--]-->
                   <div class="tm-article-snippet__meta-container">
                    <div class="tm-article-snippet__meta">
                     <span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/XelaVopelk/" class="tm-user-info__userpic" data-test-id="user-info-pic" title="XelaVopelk">
                       <div class="tm-entity-image">
                        <!--[--><img alt="" class="tm-entity-image__pic" height="24" src="https://assets.habr.com/habr-web/img/avatars/020.png" width="24"><!--]-->
                       </div></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/XelaVopelk/" class="tm-user-info__username">XelaVopelk <!----></a><!--[--><span class="tm-article-datetime-published"><time datetime="2025-05-06T14:45:29.000Z" title="2025-05-06, 17:45">15 часов назад</time></span><!--]--></span></span>
                    </div><!---->
                   </div>
                   <h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle"><span>Дизайн hash-таблиц в redis</span></h1>
                   <div class="tm-article-snippet__stats" data-test-id="articleStats">
                    <div class="tm-article-complexity tm-article-complexity_complexity-medium">
                     <span class="tm-svg-icon__wrapper tm-article-complexity__icon">
                      <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                       <title>
                        Уровень сложности
                       </title><use xlink:href="/img/megazord-v28.7909a852..svg#complexity-medium"></use>
                      </svg></span><span class="tm-article-complexity__label">Средний</span>
                    </div>
                    <div class="tm-article-reading-time">
                     <span class="tm-svg-icon__wrapper tm-article-reading-time__icon">
                      <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                       <title>
                        Время на прочтение
                       </title><use xlink:href="/img/megazord-v28.7909a852..svg#clock"></use>
                      </svg></span><span class="tm-article-reading-time__label">7 мин</span>
                    </div><span class="tm-icon-counter tm-data-icons__item">
                     <svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24">
                      <title>
                       Количество просмотров
                      </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-views"></use>
                     </svg><span class="tm-icon-counter__value" title="1343">1.3K</span></span>
                   </div>
                   <div class="tm-publication-hubs__container" data-test-id="articleHubsList">
                    <div class="tm-publication-hubs">
                     <!--[--><span class="tm-publication-hub__link-container"><a href="/ru/hubs/nosql/" class="tm-publication-hub__link"><!--[--><span>NoSQL</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><!--]-->
                    </div>
                   </div>
                   <div class="tm-article-labels" data-test-id="articleLabels">
                    <div class="tm-article-labels__container">
                     <!----><!--[-->
                     <div class="tm-publication-label tm-publication-label_variant-sandbox">
                      <a href="/ru/sandbox/" class="">Из песочницы</a>
                     </div>
                     <div class="tm-publication-label tm-publication-label_variant-recovery">
                      <span>Recovery Mode</span>
                     </div><!--]-->
                    </div>
                   </div><!----><!---->
                  </div>
                 </div><!--[--><!---->
                 <div class="tm-article-body" data-gallery-root lang="ru">
                  <div>
                   <!--[--><!--]-->
                  </div>
                  <div id="post-content-body">
                   <div>
                    <div class="article-formatted-body article-formatted-body article-formatted-body_version-2">
                     <div xmlns="http://www.w3.org/1999/xhtml">
                      <p>Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно. Вообще структура хеш-таблиц в redis используется достаточно широко. Возьмём, к примеру структуру базы данных.</p>
                      <p>База данных redis (статья написана по redis_version:8.0) это сложное хранилище состоящее из большого количества hash-таблиц</p>
                      <pre><code>typedef struct redisDb {
	kvstore *keys; /* основное KV- хранилище*/
	kvstore *expires; /* Timeout of keys with a timeout set */
...
	dict *blocking_keys; /* Keys with clients waiting for data (BLPOP)*/
	dict *blocking_keys_unblock_on_nokey; /* Keys with clients waiting for
	* data, and should be unblocked if key is deleted (XREADEDGROUP).
	* This is a subset of blocking_keys*/
	dict *ready_keys; /* Blocked keys that received a PUSH */
	dict *watched_keys; /* WATCHED keys for MULTI/EXEC CAS */
	...
} redisDb;
….
struct kvstore {
...
	dict **dicts;
...
};
</code></pre>
                      <p>- watched_keys - организация работы [[Redis transactions|транзакции]]</p>
                      <p>- keys - основное хранилище ключ-значение redis. При однонодовой работе&nbsp; kvstore содержит один справочник, в кластерном режиме хеш-таблица создаётся для каждого слота. Собирается статистика в<code>htstats</code></p>
                      <p>- expires - хранилище времен окончания срока действия. Нюансы работы со слотам в кластерном режиме аналогичный keys. Собирается статистика в<code>htstats</code></p>
                      <p>- blocking_keys, blocking_keys_unblock_on_nokey - работа с блокирующими операциями типа BLPOP</p>
                      <p>- watched_keys - организация транзакции через команду <code>WATCH</code> транзакции</p>
                      <p>Если мы любим хранить ключи вида: USER_SESSIONS:IMPORTANT_INFORMATION:USER_ID_16780:FROM_2015:TO_2025 - это добро будет в нескольких хештаблицах как ключ и есть риск, что большую часть хранения займут как раз ключи.</p>
                      <p>Также хештаблицы используются в сложных структурах: set, hash, zlist,...&nbsp;</p>
                      <h2>Лирическое отступление. Коллизии</h2>
                      <p>Хеш-таблица представляет собой набор бакетов. Номер бакета получается после применения хеш-функции к ключу. Если несколько ключей попадают в один бакет - это называется "коллизия".</p>
                      <p>Обычно нельзя заранее предсказать, какой объём данных будет хранится в этой таблице. Хеш-таблица обычно инициализируется с меньшим размером с тем расчётом, что в конечном итоге количество ключей превысит первоначальный размер таблицы. Несоответствие между пространство ключей и количество бакетов хеш-таблицы проводит к тому, что хешфункция отображает разные ключи в одну и ту же ячейку.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f6a/20b/437/f6a20b4374a2cd4603576028f32323a8.png" width="1137" height="585" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f6a/20b/437/f6a20b4374a2cd4603576028f32323a8.png 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f6a/20b/437/f6a20b4374a2cd4603576028f32323a8.png 781w" loading="lazy" decode="async">
                      </figure>
                      <h2>Методы борьбы с коллизиями в redis</h2>
                      <p>В Redis предложена классическая реализация хеш-таблиц. Исходный код работы с хеш-таблицей находится в файлах dict.h (описание структур, прототипы функций) и dict.c (реализация методов). Хеш-таблица определена как двумерный массив <code>dictEntry **ht_table[2]</code>, каждый элемент массива, бакет - указатель на структуру <code>dictEntry</code>:</p>
                      <pre><code>struct dict {
	dictType *type;
	dictEntry **ht_table[2];
	unsigned long ht_used[2]; //элементов в хеш-таблице
	long rehashidx; /* rehashing not in progress if rehashidx == -1 */
	unsigned pauserehash : 15; /* If &gt;0 rehashing is paused */
	signed char ht_size_exp[2]; /* exponent of size. (size = 1&lt;&lt;exp) */
...
};
</code></pre>
                      <p><strong>Метод цепочек</strong></p>
                      <p>Ключи в бакете хранятся в виде связанного списка. Соответственно, если ключ попадает в непустой бакет, он добавляется в конец списка При большой длине списка может быть проблема производительности. Для реализации метода цепочек в структуре есть указатель `next` на следующую структуру dictEntry в бакете.</p>
                      <pre><code>typedef struct dictEntry {  
	void *key;  
	union {  
    	void *val;  
    	uint64_t u64;  
    	int64_t s64;  
    	double d;  
	} v;  
	struct dictEntry *next;  
} dictEntry;
</code></pre>
                      <p>структура v - вероятнее всего оптимизация, позволяющая хранить в структуре справочника типы, размеры которых известны: int64, double. Сама структура <code>dictEntry</code> занимает место - это надо учитывать при оценке размеров потенциального хранения.</p>
                      <p><strong>Перехеширование</strong></p>
                      <p>Когда длина цепочки превышает определёный порог, увеличение количества бакетов, может уменьшить количество коллизий. После увеличения количества бакетов, необходимо перераспределить по ним ключи, перехешировать. Перехеширование может быть дорогой операцией, поэтому redis использует инкрементальное перехеширование, растягивая процесс во времени.</p>
                      <p><strong>Вопрос: зачем иметь 2 пары ht_table, ht_used, ht_size_exp ?</strong></p>
                      <h2>Реализация перехеширования в Redis</h2>
                      <p>Массив бакетов может как увеличиваться, так и уменьшаться в зависимости от фактического заполнения, соответственно держать его избыточно большим - дорого Фактическое заполнение считается по количеству ключей в хеш-таблице ht_table - ht_used[], длина конкретных списков внутри бакетов не контролируется ( рандом нам поможет). Перехеширование нужно, когда нам надо изменить размер хеш-таблицы.</p>
                      <p>Основной подход заключается в следующем:</p>
                      <p>Redis поочерёдно использует две hash-таблицы во время перехеширования:</p>
                      <p>- При нормальной работе все пары ключ-значение записываются в <code>ht_table[0]</code></p>
                      <p>- При процедуре перехеширования значения постепенно переносятся из <code>ht_table[0]</code> в <code>ht_table[1]</code></p>
                      <p>- После завершения процедуры перехеширования память занятая <code>ht_table[0]</code> освобождается, а адрес <code>ht_table[1]</code> присваивается <code>ht_table[0]</code> и размер <code>ht_table[1]</code> сбрасывается в 0. В этот момент redis возобновляет нормальные операции. <code>ht_table[1]</code> резервируется на случай будущего перехеширования.</p>
                      <p>Перехеширование запускается при попытке изменения размера хеш-таблицы. Сначала увеличиваем размер - создаём <code>ht_table[1]</code> под “перспективное” заполнение, потом, запускаем перехеширование.</p>
                      <h2>Увеличение или инициализация хештаблицы</h2>
                      <p>Вариант когда таблица создаётся с нуля или увеличивается. Для проверки используется метод <code>dictExpandIfNeeded</code>. Проверка <code>dictExpandIfNeeded</code> запускается при любом добавлении или поиске элемента в таблице. При выполнении одного из условий создаётся <code>ht_table[1]</code> и запускается процесс перехеширования. Условия:</p>
                      <p>- размер <code>ht_table[0]</code>=0. Фактически инициализация с размером DICT_HT_INITIAL_SIZE=4.</p>
                      <p>- таблица заполнена <code>d-&gt;ht_used[0] &gt;= DICTHT_SIZE(d-&gt;ht_size_exp[0])</code> и изменение размера разрешено (DICT_RESIZE_ENABLE) - размер удваивается</p>
                      <p>- таблица заполнена более чем вчетверо <code>d-&gt;ht_used[0] &gt;= DICTHT_SIZE(d-&gt;ht_size_exp[0])</code> и изменение размера не запрещено (!DICT_RESIZE_FORBID&nbsp; - в форке процесса) - размер удваивается.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/fca/58a/a6b/fca58aa6b09586e6574cb6695c1d584a.png" alt="" title="" width="1421" height="456" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/fca/58a/a6b/fca58aa6b09586e6574cb6695c1d584a.png 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/fca/58a/a6b/fca58aa6b09586e6574cb6695c1d584a.png 781w" loading="lazy" decode="async">
                      </figure>
                      <h2>Уменьшение хештаблицы</h2>
                      <p>ля проверки используется метод dictShrinkIfNeeded. dictShrinkIfNeeded запускается при любом удалении элемента из таблицы. При выполнении одного из условий создаётся <code>ht_table[1]</code> и запускается процесс перехеширования.</p>
                      <p>Условия:</p>
                      <p>- если изменение размера разрешено (DICT_RESIZE_ENABLE) то при заполнении 1/8 от размера таблицы</p>
                      <p>- если не запрещено (DICT_RESIZE_FORBID - в форке процесса запрещено) - то при 1/32</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/873/280/0be/8732800be159bc175d0980f82ee36ffe.png" width="1484" height="608" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/873/280/0be/8732800be159bc175d0980f82ee36ffe.png 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/873/280/0be/8732800be159bc175d0980f82ee36ffe.png 781w" loading="lazy" decode="async">
                      </figure>
                      <h2>Мониторинг в debug режиме</h2>
                      <p>Верхнеуровево количество бакетов для двух основных хеш-таблиц можно посмотреть в дебаг-режиме. Режим не для прода.</p>
                      <p>Правим параметр <code>enable-debug-command</code> в yes. Через CONFIG SET не получится, т.к. параметр иммутабельный.</p>
                      <p>Команда <code>HTSTATS [dbid]</code> - можно получить статистику по хеш-таблицам базы. Пример ответа после установления 7х ключей и ttl одного из них: debug htstats 0 full</p>
                      <blockquote>
                       <p>[Dictionary HT]</p>
                       <p>Hash table 0 stats (main hash table):</p>
                       <p>&nbsp;table size: 8</p>
                       <p>&nbsp;number of elements: 7</p>
                       <p>&nbsp;different slots: 5</p>
                       <p>&nbsp;max chain length: 2</p>
                       <p>&nbsp;avg chain length (counted): 1.40</p>
                       <p>&nbsp;avg chain length (computed): 1.40</p>
                       <p>&nbsp;Chain length distribution:</p>
                       <p>&nbsp;&nbsp;&nbsp;0: 3 (37.50%)</p>
                       <p>&nbsp;&nbsp;&nbsp;1: 3 (37.50%)</p>
                       <p>&nbsp;&nbsp;&nbsp;2: 2 (25.00%)</p>
                       <p>[Expires HT]</p>
                       <p>Hash table 0 stats (main hash table):</p>
                       <p>&nbsp;table size: 4</p>
                       <p>&nbsp;number of elements: 1</p>
                       <p>&nbsp;different slots: 1</p>
                       <p>&nbsp;max chain length: 1</p>
                       <p>&nbsp;avg chain length (counted): 1.00</p>
                       <p>&nbsp;avg chain length (computed): 1.00</p>
                       <p>&nbsp;Chain length distribution:</p>
                       <p>&nbsp;&nbsp;&nbsp;0: 3 (75.00%)</p>
                       <p>&nbsp;&nbsp;&nbsp;1: 1 (25.00%)</p>
                      </blockquote>
                      <p>Не густо (хотелось бы и по остальным таблицам посмотреть), но тем не менее достаточно, чтобы посмотреть как “теория” натягивается фактические данные.</p>
                      <h2>Как работает инкрементальное перехеширование</h2>
                      <p>Когда таблица подвергается перехешированию, указатели на ключи должны быть скопированы в новую хеш-таблицу <code>ht_table[1]</code>. Переместить надо очень много ключей. При этом основной поток Redis будет заблокирован и не сможет обрабатывать пользовательские запросы. Для уменьшения негативного эффекта ключи не копируются за одну итерацию.</p>
                      <p><strong>Шаг перехеширования</strong></p>
                      <p>Логика работы шага перехеширования закопана в функции <code>dictRehash</code>. <code>dictRehash</code> фактически копирует ключи принимая на вход хеш-таблицы источника и приёмника и количество ключей, которые надо скопировать. Копирование происходит бакетами. Логика работы <code>dictRehash</code> состоит из двух частей:</p>
                      <ul>
                       <li>
                        <p><strong>Копирование данных</strong>. Копируем ключи в соответствии с указанным количеством бакетов. Индекс бакета, который переносится в данный момент находится в переменной rehashidx хеш-таблицы. Если бакет пуст, он пропускается и декрементируется счётчик пустых бакетов empty_visits. Когда он дойдёт до нуля, управление будет передано главному потоку и он сможет опять обрабатывать пользовательские запросы.</p></li>
                       <li>
                        <p><strong>Завершение перехеширования</strong>. После копирования проверяем, что все данные перенесены, и если да присваиваем <code>ht_table[0]</code> <code>ht_table[1].</code></p></li>
                      </ul>
                      <p><strong>Что вызывает итерацию перехеширования</strong></p>
                      <ul>
                       <li>
                        <p>cron. В cron перехешируется основная таблица kv-хранилища и таблица expired. Перехеширование происходит пачками по 100 бакетов с ограничением - 16мс на БД на каждую из двух хештаблиц. Больше баз на инстансе - больше работы на перехеширование.</p></li>
                      </ul>
                      <pre><code>for (j = 0; j &lt; dbs_per_call; j++) {
...
kvstoreTryResizeDicts(db-&gt;keys, CRON_DICTS_PER_DB);
kvstoreTryResizeDicts(db-&gt;expires, CRON_DICTS_PER_DB);
…
}
</code></pre>
                      <ul>
                       <li>
                        <p>любой доступ к бакету: добавление ключа, удаление ключа,... Перед операцией сначала вызывается <code>_dictRehashStep</code>, который перехеширует бакет и далее доступ идёт уже к <code>ht_table[1]</code>. Под капотом dictRehash, количество бакетов в параметре для переноса строго 1 - тот, к которому обращаемся.</p></li>
                      </ul>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/ef7/679/a20/ef7679a2075866e7ea6cc51bd880ae23.png" width="1555" height="873" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/ef7/679/a20/ef7679a2075866e7ea6cc51bd880ae23.png 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/ef7/679/a20/ef7679a2075866e7ea6cc51bd880ae23.png 781w" loading="lazy" decode="async">
                      </figure>
                      <h2>Метрики перехеширования</h2>
                      <p>Какие инструменты за исключением полулегального DEBUG есть, чтобы простучаться снаружи к метрикам связанным с хеш-таблицами. Их немного:</p>
                      <p><strong>INFO</strong></p>
                      <p><code>mem_overhead_db_hashtable_rehashing</code>: дополнительное потребление памяти на перехеширование по всем БД.</p>
                      <p><strong>MEMORY STATS</strong></p>
                      <p>- <code>db.dict.rehashing.count</code>: число БД в процессе перехеширования ( Redis 7.4+)</p>
                      <p>- <code>dbXXX</code>: Для каждой таблицы расчет занимаемых метаданных (<code>overhead.hashtable.main</code> and <code>overhead.hashtable.expires</code>, respectively) are reported in bytes. Дополнительное потребление памяти: hashtable(память для хештаблицы) + <code>dictEntry</code>(**для записи отношений** каждой пары) + <code>redisObject</code>(Описание различных типов данных) для main и hashtable + <code>dictEntry</code> для expired</p>
                      <p>- <code>overhead.db.hashtable.lut</code>: размер массива хештаблиц(ы) (прим. с учётом миграции from -&gt; to) при перехешировании&nbsp; (Redis 7.4+)</p>
                      <p>- <code>overhead.db.hashtable.rehashing</code>: дополнительное потребление памяти для проходящего перехеширования(Redis 7.4+)</p>
                      <p>- <code>db.dict.rehashing.count</code>: Количество хеш-таблиц в настоящее время находящиеся в процессе перехеширования (Redis 8.0+)</p>
                      <p>К примеру на старте main и expired имеют по 312 байт “на старте” и на каждый ключ растут по 40 и 24 байта соответственно (а почему меньше? см. замечание про union v в структуре dictEntry). Когда ключей сотни миллионов может быть существенно при расчёте объёма хранения.</p>
                     </div>
                    </div>
                   </div><!----><!---->
                  </div><!----><!---->
                 </div><!--]--><!---->
                 <div class="tm-article-presenter__meta" data-test-id="article-meta-links">
                  <div class="tm-separated-list tm-article-presenter__meta-list">
                   <span class="tm-separated-list__title">Теги:</span>
                   <ul class="tm-separated-list__list">
                    <!--[-->
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[redis]" class="tm-tags-list__link"><span>redis</span></a><!--]--></li><!--]--><!---->
                   </ul>
                  </div>
                  <div class="tm-separated-list tm-article-presenter__meta-list">
                   <span class="tm-separated-list__title">Хабы:</span>
                   <ul class="tm-separated-list__list">
                    <!--[-->
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/nosql/" class="tm-hubs-list__link"><!--[--><span>NoSQL</span><!--]--></a><!--]--></li><!--]--><!---->
                   </ul>
                  </div>
                 </div><!----><!--]-->
                </article><!--]-->
               </div><!---->
              </div>
              <div style="" class="tm-article-sticky-panel" data-test-id="article-sticky-panel">
               <div class="tm-data-icons tm-data-icons tm-data-icons_space-big tm-article-sticky-panel__icons" data-test-id="article-stats-icons">
                <div class="article-rating tm-data-icons__item" data-v-86aec4a7>
                 <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-article votes-switcher" title="Всего голосов 2: ↑2 и ↓0" data-v-86aec4a7>
                  <button class="tm-votes-lever__button" data-test-id="votes-lever-upvote-button" title="Нравится" type="button">
                   <svg class="tm-svg-img tm-votes-lever__icon" height="24" width="24">
                    <title>
                     Нравится
                    </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-vote"></use>
                   </svg></button>
                  <div class="tm-votes-lever__score tm-votes-lever__score_appearance-article tm-votes-lever__score">
                   <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_positive tm-votes-lever__score-counter" data-test-id="votes-score-counter">+3</span></span><!--]-->
                  </div>
                  <button class="tm-votes-lever__button" data-test-id="votes-lever-downvote-button" title="Не нравится" type="button">
                   <svg class="tm-svg-img tm-votes-lever__icon tm-votes-lever__icon_arrow-down" height="24" width="24">
                    <title>
                     Не нравится
                    </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-vote"></use>
                   </svg></button>
                 </div><!--teleport start--><!--teleport end--><!---->
                </div><!----><!---->
                <button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button"><span class="tm-svg-icon__wrapper bookmarks-button__icon">
                  <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                   <title>
                    Добавить в закладки
                   </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-favorite"></use>
                  </svg></span><span class="bookmarks-button__counter" title="Количество пользователей, добавивших публикацию в закладки">20</span></button>
                <div class="tm-sharing tm-data-icons__item" title="Поделиться">
                 <button class="tm-sharing__button" type="button">
                  <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon">
                   <path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path>
                  </svg></button><!--teleport start--><!--teleport end-->
                </div>
                <div class="tm-article-comments-counter-link tm-data-icons__item" title="Читать комментарии">
                 <a href="/ru/articles/907408/comments/" class="tm-article-comments-counter-link__link" data-test-id="counter-comments"><!--[-->
                  <svg class="tm-svg-img tm-article-comments-counter-link__icon" height="24" width="24">
                   <title>
                    Комментарии
                   </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use>
                  </svg><span class="tm-article-comments-counter-link__value">0</span><!--]--></a><!---->
                </div><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--teleport start--><!--teleport end--><!---->
               </div>
              </div>
             </div><!--[--><!--]-->
             <div class="tm-article-presenter__footer">
              <!--[--><!--[-->
              <div class="tm-article-blocks">
               <!----><!--[-->
               <section class="tm-block tm-block tm-block_spacing-bottom">
                <!----><!--[-->
                <div class="tm-block__body tm-block__body tm-block__body_variant-balanced">
                 <!--[-->
                 <div class="tm-article-author" data-test-id="article-author-info" data-async-called="true">
                  <!--[--><!--]-->
                  <div class="tm-user-card tm-user-card tm-user-card_variant-article tm-article-author__user-card" data-async-called="true">
                   <div class="tm-user-card__info-container">
                    <div class="tm-user-card__header">
                     <div class="tm-user-card__header-data">
                      <a href="/ru/users/XelaVopelk/" class="tm-user-card__userpic tm-user-card__userpic_size-40">
                       <div class="tm-entity-image">
                        <!--[--><img alt="" class="tm-entity-image__pic" src="https://assets.habr.com/habr-web/img/avatars/020.png"><!--]-->
                       </div></a>
                      <div class="tm-user-card__meta">
                       <div class="tm-counter-container karma" title=" 26 голосов " data-v-f7c0e283>
                        <div class="tm-counter-container__header">
                         <!--[-->
                         <div class="karma-display negative" data-v-f7c0e283 data-v-7635202e>
                          -4
                         </div><!----><!--]-->
                        </div>
                        <div class="tm-counter-container__footer">
                         <!--[-->
                         <div class="karma-text" data-v-f7c0e283>
                          Карма
                         </div><!--teleport start--><!--teleport end--><!--]-->
                        </div>
                       </div>
                       <div class="tm-counter-container" title="Рейтинг пользователя">
                        <div class="tm-counter-container__header">
                         <!--[--><!--[--><!--]-->
                         <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating">
                          <!---->
                          <div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score">
                           <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">3</span></span><!--]-->
                          </div><!---->
                         </div><!--]-->
                        </div>
                        <div class="tm-counter-container__footer">
                         <!--[--><span class="tm-rating__text tm-rating__text">Рейтинг</span><!--]-->
                        </div>
                       </div>
                      </div>
                     </div>
                    </div>
                    <div class="tm-user-card__info tm-user-card__info_variant-article tm-user-card__info">
                     <div class="tm-user-card__title tm-user-card__title_variant-article tm-user-card__title">
                      <span class="tm-user-card__name tm-user-card__name_variant-article tm-user-card__name">Клёпов Алексей</span><a href="/ru/users/XelaVopelk/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"> @XelaVopelk</a><!---->
                     </div>
                     <p class="tm-user-card__short-info tm-user-card__short-info_variant-article tm-user-card__short-info" data-test-id="user-card-speciality">Пользователь</p>
                    </div>
                   </div><!---->
                   <div class="tm-user-card__buttons tm-user-card__buttons_variant-article tm-user-card__buttons">
                    <!---->
                    <div class="tm-user-card__button">
                     <div class="tm-button-follow tm-user-card__button-follow">
                      <!---->
                      <button class="tm-button-follow__button tm-button-follow__button_big" data-test-id="follow-button" type="button">Подписаться</button>
                     </div>
                    </div><!---->
                    <div class="tm-user-card__button tm-user-card__button_write" data-test-id="user-card-conversations">
                     <svg class="tm-svg-img tm-user-card__button-icon" height="16" width="16">
                      <title>
                       Отправить сообщение
                      </title><use xlink:href="/img/megazord-v28.7909a852..svg#mail"></use>
                     </svg>
                    </div><!---->
                   </div><!---->
                  </div>
                  <div class="tm-article-author__user-contacts" data-test-id="author-contacts">
                   <!----><!----><!---->
                  </div>
                 </div><!--]-->
                </div><!--]--><!---->
               </section><!----><!--[-->
               <div class="banner-wrapper leaderboard tm-page-article__banner" style="--38f3d936:200px;--78a3cd06:auto;" data-v-f4bf0d24>
                <!--[-->
                <div class="placeholder-wrapper placeholder" data-v-f4bf0d24>
                 <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                 <div class="adfox-banner-placeholder leaderboard" data-v-12f7bcca>
                  <div class="image loads" data-v-12f7bcca></div>
                  <div class="lines" data-v-12f7bcca>
                   <div class="line loads" data-v-12f7bcca></div>
                   <div class="line loads" data-v-12f7bcca></div>
                   <div class="line loads" data-v-12f7bcca></div>
                  </div>
                 </div><!----><!----><!---->
                </div>
                <div id="adfox_164725660339535756" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]-->
               </div><!--]--><!--]-->
               <div class="tm-article-blocks__comments">
                <div id="publication-comments" class="tm-article-page-comments">
                 <div>
                  <!--[-->
                  <div class="tm-article-comments-counter-link tm-article-comments-counter-button">
                   <a href="/ru/articles/907408/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" data-test-id="counter-comments"><!--[-->
                    <svg class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted" height="24" width="24">
                     <title>
                      Комментарии
                     </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use>
                    </svg><span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted"> Комментировать </span><!--]--></a><!---->
                  </div><!--]-->
                 </div>
                </div>
               </div><!--[--><!--[--><!--]-->
               <section class="tm-block tm-block tm-block_spacing-bottom">
                <header class="tm-block__header tm-block__header tm-block__header_variant-borderless">
                 <div class="tm-block__header-container">
                  <h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2><!--[--><!--]-->
                 </div><!---->
                </header><!--[-->
                <div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim">
                 <!--[--><!--[-->
                 <div class="tm-tabs tm-tabs">
                  <div class="">
                   <!--[--><span class="tm-tabs__tab-item">
                    <button class="tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim tm-tabs__tab-link">Лучшие за сутки</button></span><span class="tm-tabs__tab-item">
                    <button class="tm-tabs__tab-link tm-tabs__tab-link_slim tm-tabs__tab-link">Похожие</button></span><!--]-->
                  </div><!---->
                 </div>
                 <div class="similar-and-daily__tab-view">
                  <div class="daily-articles-list">
                   <ul class="tm-article-card-list">
                    <!--[--><!--]-->
                    <div class="tm-bordered-card">
                     <!----><!--[--><!--]-->
                    </div>
                   </ul>
                   <div class="daily-articles-block__button-container">
                    <button class="btn btn_transparent btn_small tm-button tm-button_color-horizon" type="button"><!--[--><!--[-->Показать лучшие за всё время<!--]--><!--]--></button>
                   </div>
                  </div><!---->
                 </div><!--]--><!--]-->
                </div><!--]--><!---->
               </section><!--[-->
               <div>
                <div class="placeholder-wrapper">
                 <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                 <div class="tm-placeholder-promo">
                  <div class="tm-placeholder-promo__header">
                   <div class="tm-placeholder__line tm-placeholder__line_promo-title"></div>
                  </div>
                  <div class="tm-placeholder-promo__body">
                   <div class="tm-placeholder-promo__posts">
                    <div class="tm-placeholder-promo__post">
                     <div class="tm-placeholder-promo__image"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_post-title"></div>
                    </div>
                    <div class="tm-placeholder-promo__post">
                     <div class="tm-placeholder-promo__image"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_post-title"></div>
                    </div>
                    <div class="tm-placeholder-promo__post">
                     <div class="tm-placeholder-promo__image"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_post-title"></div>
                    </div>
                   </div>
                   <div class="tm-placeholder-promo__dots">
                    <div class="tm-placeholder-promo__dot"></div>
                    <div class="tm-placeholder-promo__dot"></div>
                    <div class="tm-placeholder-promo__dot"></div>
                   </div>
                  </div>
                 </div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                </div>
               </div>
               <div class="placeholder-wrapper">
                <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                <div class="tm-placeholder-inset tm-placeholder-courses">
                 <div class="tm-placeholder-inset__header">
                  <div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div>
                 </div>
                 <div class="tm-placeholder-inset__body">
                  <ul class="tm-placeholder-list">
                   <!--[-->
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder-list__title-container">
                     <div class="tm-placeholder__company-avatar"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    </div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder-list__title-container">
                     <div class="tm-placeholder__company-avatar"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    </div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder-list__title-container">
                     <div class="tm-placeholder__company-avatar"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    </div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder-list__title-container">
                     <div class="tm-placeholder__company-avatar"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    </div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder-list__title-container">
                     <div class="tm-placeholder__company-avatar"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    </div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li><!--]-->
                  </ul>
                 </div>
                 <div class="tm-placeholder-inset__footer">
                  <div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div>
                 </div>
                </div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
               </div><!--]--><!----><!--[--><!--]--><!--]-->
              </div><!--]--><!--]-->
             </div>
            </div><!--]--><!--]-->
           </div>
          </div>
          <div class="tm-page__sidebar">
           <!--[-->
           <div class="tm-layout-sidebar">
            <div class="tm-layout-sidebar__placeholder_initial"></div>
            <div class="tm-sexy-sidebar_initial tm-sexy-sidebar" style="margin-top:0px;">
             <!--[--><!--]--><!---->
             <div class="tm-layout-sidebar__ads_initial tm-layout-sidebar__ads">
              <div class="banner-wrapper half-page tm-layout-sidebar__banner tm-layout-sidebar__banner_top" style="--38f3d936:600px;--78a3cd06:auto;" data-v-f4bf0d24>
               <!--[-->
               <div class="placeholder-wrapper placeholder" data-v-f4bf0d24>
                <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                <div class="adfox-banner-placeholder half-page" data-v-12f7bcca>
                 <div class="image loads" data-v-12f7bcca></div>
                 <div class="lines" data-v-12f7bcca>
                  <div class="line loads" data-v-12f7bcca></div>
                  <div class="line loads" data-v-12f7bcca></div>
                  <div class="line loads" data-v-12f7bcca></div>
                 </div>
                </div><!----><!----><!---->
               </div>
               <div id="adfox_164725680533065327" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]-->
              </div>
             </div><!--[--><!---->
             <div></div><!---->
             <section class="tm-block tm-block tm-block_spacing-around block" data-v-6f380946>
              <header class="tm-block__header tm-block__header">
               <div class="tm-block__header-container">
                <h2 class="tm-block__title tm-block__title">Ближайшие события</h2><!--[--><!--]-->
               </div><!---->
              </header><!--[-->
              <div class="tm-block__body tm-block__body">
               <!--[-->
               <div class="placeholder-wrapper" data-v-6f380946>
                <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                <section class="tm-block tm-block tm-block_spacing-none" tabindex="-1" data-v-9caf0b82>
                 <!----><!--[-->
                 <div class="event-card-placeholder is-widget" data-v-9caf0b82>
                  <div class="image loads" data-v-9caf0b82></div>
                  <div class="info" data-v-9caf0b82>
                   <div class="date line" data-v-9caf0b82></div>
                   <div class="title line" data-v-9caf0b82></div>
                   <div class="places line" data-v-9caf0b82></div>
                   <div class="places line" data-v-9caf0b82></div>
                  </div>
                  <div class="footer widget" data-v-9caf0b82>
                   <div class="link line" data-v-9caf0b82></div>
                   <div class="categories" data-v-9caf0b82>
                    <!--[-->
                    <div class="category line" data-v-9caf0b82></div>
                    <div class="category line" data-v-9caf0b82></div>
                    <div class="category line" data-v-9caf0b82></div><!--]-->
                   </div>
                  </div>
                 </div><!--]--><!---->
                </section><!---->
               </div><!--]-->
              </div><!--]--><!---->
             </section><!--]-->
             <div class="banner-wrapper medium-rectangle tm-layout-sidebar__banner tm-layout-sidebar__banner_bottom" style="--38f3d936:250px;--78a3cd06:auto;" data-v-f4bf0d24>
              <!--[-->
              <div class="placeholder-wrapper placeholder" data-v-f4bf0d24>
               <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
               <div class="adfox-banner-placeholder medium-rectangle" data-v-12f7bcca>
                <div class="image loads" data-v-12f7bcca></div>
                <div class="lines" data-v-12f7bcca>
                 <div class="line loads" data-v-12f7bcca></div>
                 <div class="line loads" data-v-12f7bcca></div>
                 <div class="line loads" data-v-12f7bcca></div>
                </div>
               </div><!----><!----><!---->
              </div>
              <div id="adfox_164725691003361602" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]-->
             </div>
            </div>
           </div><!--]-->
          </div>
         </div><!----><!--]-->
        </div>
       </div>
      </main><!---->
     </div>
     <div class="tm-footer-menu">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-footer-menu__container">
        <!--[-->
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Ваш аккаунт</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/articles/907408/&amp;hl=ru" rel="nofollow" target="_self">Войти</a></li>
           <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/articles/907408/&amp;hl=ru" rel="nofollow" target="_self">Регистрация</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Разделы</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/ru/articles/" class="footer-menu__item-link">Статьи</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">Новости</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">Хабы</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">Компании</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">Авторы</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">Песочница</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Информация</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">Для авторов</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">Для компаний</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">Документы</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">Соглашение</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">Конфиденциальность</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Услуги</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">Корпоративный блог</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">Медийная реклама</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">Нативные проекты</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">Образовательные программы</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">Стартапам</a></li><!--]-->
          </ul>
         </div>
        </div><!--]-->
       </div><!--]-->
      </div>
     </div>
     <div class="tm-footer">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-footer__container">
        <!---->
        <div class="tm-footer__social">
         <!--[--><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Facebook
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-facebook"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Twitter
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-twitter"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            VK
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Telegram
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Youtube
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Яндекс Дзен
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use>
          </svg></a><!--]-->
        </div><!--teleport start--><!--teleport end-->
        <button class="tm-footer__link"><!----> Настройка языка</button><a href="/ru/feedback/" class="tm-footer__link">Техническая поддержка</a>
        <div class="tm-footer-copyright">
         <span class="tm-copyright"><span class="tm-copyright__years">© 2006–2025, </span><span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank">Habr</a></span></span>
        </div>
       </div><!--]-->
      </div>
     </div><!----><!--]-->
    </div><!---->
   </div>
   <script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"907408":{"id":"907408","timePublished":"2025-05-06T14:45:29+00:00","isCorporative":false,"lang":"ru","titleHtml":"Дизайн hash-таблиц в redis","leadData":{"textHtml":"\u003Cp\u003EКогда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер? - может быть полезно. База данных redis (статья написана по redis_version:8.0) это сложное хранилище состоящее из большого количества hash-таблиц...\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать далее","image":null},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"sandbox","typeOf":"system","title":"Из песочницы","data":{"url":null}},{"type":"recovery","typeOf":"system","title":"Recovery Mode","data":{"url":null}}],"author":{"id":"666537","alias":"XelaVopelk","fullname":"Клёпов Алексей","avatarUrl":null,"speciality":null,"scoreStats":{"score":-4,"votesCount":26},"rating":3,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"donationsMethod":null,"isInBlacklist":null,"careerProfile":null},"statistics":{"commentsCount":0,"favoritesCount":20,"readingCount":1343,"score":3,"votesCount":2,"votesCountPlus":2,"votesCountMinus":0},"hubs":[{"id":"16848","alias":"nosql","type":"collective","title":"NoSQL","titleHtml":"NoSQL","isProfiled":true,"relatedData":null}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"}],"relatedData":{"vote":null,"unreadCommentsCount":0,"bookmarked":false,"canComment":false,"canEdit":false,"canViewVotes":false,"votePlus":{"canVote":false,"isChargeEnough":false,"isKarmaEnough":false,"isVotingOver":false,"isPublicationLimitEnough":false},"voteMinus":{"canVote":false,"isChargeEnough":false,"isKarmaEnough":false,"isVotingOver":false,"isPublicationLimitEnough":false},"canModerateComments":false,"trackerSubscribed":false,"emailSubscribed":false},"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EКогда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно. Вообще структура хеш-таблиц в redis используется достаточно широко. Возьмём, к примеру структуру базы данных.\u003C\u002Fp\u003E\u003Cp\u003EБаза данных redis (статья написана по redis_version:8.0) это сложное хранилище состоящее из большого количества hash-таблиц\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Etypedef struct redisDb {\n\tkvstore *keys; \u002F* основное KV- хранилище*\u002F\n\tkvstore *expires; \u002F* Timeout of keys with a timeout set *\u002F\n...\n\tdict *blocking_keys; \u002F* Keys with clients waiting for data (BLPOP)*\u002F\n\tdict *blocking_keys_unblock_on_nokey; \u002F* Keys with clients waiting for\n\t* data, and should be unblocked if key is deleted (XREADEDGROUP).\n\t* This is a subset of blocking_keys*\u002F\n\tdict *ready_keys; \u002F* Blocked keys that received a PUSH *\u002F\n\tdict *watched_keys; \u002F* WATCHED keys for MULTI\u002FEXEC CAS *\u002F\n\t...\n} redisDb;\n….\nstruct kvstore {\n...\n\tdict **dicts;\n...\n};\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E- watched_keys - организация работы [[Redis transactions|транзакции]]\u003C\u002Fp\u003E\u003Cp\u003E- keys - основное хранилище ключ-значение redis. При однонодовой работе  kvstore содержит один справочник, в кластерном режиме хеш-таблица создаётся для каждого слота. Собирается статистика в\u003Ccode\u003Ehtstats\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E- expires - хранилище времен окончания срока действия. Нюансы работы со слотам в кластерном режиме аналогичный keys. Собирается статистика в\u003Ccode\u003Ehtstats\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E- blocking_keys, blocking_keys_unblock_on_nokey - работа с блокирующими операциями типа BLPOP\u003C\u002Fp\u003E\u003Cp\u003E- watched_keys - организация транзакции через команду \u003Ccode\u003EWATCH\u003C\u002Fcode\u003E транзакции\u003C\u002Fp\u003E\u003Cp\u003EЕсли мы любим хранить ключи вида: USER_SESSIONS:IMPORTANT_INFORMATION:USER_ID_16780:FROM_2015:TO_2025 - это добро будет в нескольких хештаблицах как ключ и есть риск, что большую часть хранения займут как раз ключи.\u003C\u002Fp\u003E\u003Cp\u003EТакже хештаблицы используются в сложных структурах: set, hash, zlist,...  \u003C\u002Fp\u003E\u003Ch2\u003EЛирическое отступление. Коллизии\u003C\u002Fh2\u003E\u003Cp\u003EХеш-таблица представляет собой набор бакетов. Номер бакета получается после применения хеш-функции к ключу. Если несколько ключей попадают в один бакет - это называется \"коллизия\".\u003C\u002Fp\u003E\u003Cp\u003EОбычно нельзя заранее предсказать, какой объём данных будет хранится в этой таблице. Хеш-таблица обычно инициализируется с меньшим размером с тем расчётом, что в конечном итоге количество ключей превысит первоначальный размер таблицы. Несоответствие между пространство ключей и количество бакетов хеш-таблицы проводит к тому, что хешфункция отображает разные ключи в одну и ту же ячейку.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff6a\u002F20b\u002F437\u002Ff6a20b4374a2cd4603576028f32323a8.png\" width=\"1137\" height=\"585\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff6a\u002F20b\u002F437\u002Ff6a20b4374a2cd4603576028f32323a8.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff6a\u002F20b\u002F437\u002Ff6a20b4374a2cd4603576028f32323a8.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EМетоды борьбы с коллизиями в redis\u003C\u002Fh2\u003E\u003Cp\u003EВ Redis предложена классическая реализация хеш-таблиц. Исходный код работы с хеш-таблицей находится в файлах dict.h (описание структур, прототипы функций) и dict.c (реализация методов). Хеш-таблица определена как двумерный массив \u003Ccode\u003EdictEntry **ht_table[2]\u003C\u002Fcode\u003E, каждый элемент массива, бакет - указатель на структуру \u003Ccode\u003EdictEntry\u003C\u002Fcode\u003E: \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Estruct dict {\n\tdictType *type;\n\tdictEntry **ht_table[2];\n\tunsigned long ht_used[2]; \u002F\u002Fэлементов в хеш-таблице\n\tlong rehashidx; \u002F* rehashing not in progress if rehashidx == -1 *\u002F\n\tunsigned pauserehash : 15; \u002F* If &gt;0 rehashing is paused *\u002F\n\tsigned char ht_size_exp[2]; \u002F* exponent of size. (size = 1&lt;&lt;exp) *\u002F\n...\n};\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Cstrong\u003EМетод цепочек\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EКлючи в бакете хранятся в виде связанного списка. Соответственно, если ключ попадает в непустой бакет, он добавляется в конец списка При большой длине списка может быть проблема производительности. Для реализации метода цепочек в структуре есть указатель `next` на следующую структуру dictEntry в бакете.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Etypedef struct dictEntry {  \n\tvoid *key;  \n\tunion {  \n    \tvoid *val;  \n    \tuint64_t u64;  \n    \tint64_t s64;  \n    \tdouble d;  \n\t} v;  \n\tstruct dictEntry *next;  \n} dictEntry;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003Eструктура v - вероятнее всего оптимизация, позволяющая хранить в структуре справочника типы, размеры которых известны: int64, double. Сама структура \u003Ccode\u003EdictEntry\u003C\u002Fcode\u003E занимает место - это надо учитывать при оценке размеров потенциального хранения. \u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EПерехеширование\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EКогда длина цепочки превышает определёный порог, увеличение количества бакетов, может уменьшить количество коллизий. После увеличения количества бакетов, необходимо перераспределить по ним ключи, перехешировать. Перехеширование может быть дорогой операцией, поэтому redis использует инкрементальное перехеширование, растягивая процесс во времени.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВопрос: зачем иметь 2 пары ht_table, ht_used, ht_size_exp ?\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Ch2\u003EРеализация перехеширования в Redis\u003C\u002Fh2\u003E\u003Cp\u003EМассив бакетов может как увеличиваться, так и уменьшаться в зависимости от фактического заполнения, соответственно держать его избыточно большим - дорого Фактическое заполнение считается по количеству ключей в хеш-таблице ht_table - ht_used[], длина конкретных списков внутри бакетов не контролируется ( рандом нам поможет). Перехеширование нужно, когда нам надо изменить размер хеш-таблицы.\u003C\u002Fp\u003E\u003Cp\u003EОсновной подход заключается в следующем:\u003C\u002Fp\u003E\u003Cp\u003ERedis поочерёдно использует две hash-таблицы во время перехеширования:\u003C\u002Fp\u003E\u003Cp\u003E- При нормальной работе все пары ключ-значение записываются в \u003Ccode\u003Eht_table[0]\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E- При процедуре перехеширования значения постепенно переносятся из \u003Ccode\u003Eht_table[0]\u003C\u002Fcode\u003E в \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E- После завершения процедуры перехеширования память занятая \u003Ccode\u003Eht_table[0]\u003C\u002Fcode\u003E освобождается, а адрес \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E присваивается \u003Ccode\u003Eht_table[0]\u003C\u002Fcode\u003E и размер \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E сбрасывается в 0. В этот момент redis возобновляет нормальные операции. \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E резервируется на случай будущего перехеширования.\u003C\u002Fp\u003E\u003Cp\u003EПерехеширование запускается при попытке изменения размера хеш-таблицы. Сначала увеличиваем размер - создаём \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E под “перспективное” заполнение, потом, запускаем перехеширование.\u003C\u002Fp\u003E\u003Ch2\u003EУвеличение или инициализация хештаблицы\u003C\u002Fh2\u003E\u003Cp\u003EВариант когда таблица создаётся с нуля или увеличивается. Для проверки используется метод \u003Ccode\u003EdictExpandIfNeeded\u003C\u002Fcode\u003E. Проверка \u003Ccode\u003EdictExpandIfNeeded\u003C\u002Fcode\u003E запускается при любом добавлении или поиске элемента в таблице. При выполнении одного из условий создаётся \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E и запускается процесс перехеширования. Условия:\u003C\u002Fp\u003E\u003Cp\u003E- размер \u003Ccode\u003Eht_table[0]\u003C\u002Fcode\u003E=0. Фактически инициализация с размером DICT_HT_INITIAL_SIZE=4.\u003C\u002Fp\u003E\u003Cp\u003E- таблица заполнена \u003Ccode\u003Ed-&gt;ht_used[0] &gt;= DICTHT_SIZE(d-&gt;ht_size_exp[0])\u003C\u002Fcode\u003E и изменение размера разрешено (DICT_RESIZE_ENABLE) - размер удваивается\u003C\u002Fp\u003E\u003Cp\u003E- таблица заполнена более чем вчетверо \u003Ccode\u003Ed-&gt;ht_used[0] &gt;= DICTHT_SIZE(d-&gt;ht_size_exp[0])\u003C\u002Fcode\u003E и изменение размера не запрещено (!DICT_RESIZE_FORBID  - в форке процесса) - размер удваивается.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffca\u002F58a\u002Fa6b\u002Ffca58aa6b09586e6574cb6695c1d584a.png\" alt=\"\" title=\"\" width=\"1421\" height=\"456\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffca\u002F58a\u002Fa6b\u002Ffca58aa6b09586e6574cb6695c1d584a.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffca\u002F58a\u002Fa6b\u002Ffca58aa6b09586e6574cb6695c1d584a.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EУменьшение хештаблицы\u003C\u002Fh2\u003E\u003Cp\u003Eля проверки используется метод dictShrinkIfNeeded. dictShrinkIfNeeded запускается при любом удалении элемента из таблицы. При выполнении одного из условий создаётся \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E и запускается процесс перехеширования.\u003C\u002Fp\u003E\u003Cp\u003EУсловия:\u003C\u002Fp\u003E\u003Cp\u003E- если изменение размера разрешено (DICT_RESIZE_ENABLE) то при заполнении 1\u002F8 от размера таблицы\u003C\u002Fp\u003E\u003Cp\u003E- если не запрещено (DICT_RESIZE_FORBID - в форке процесса запрещено) - то при 1\u002F32\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F873\u002F280\u002F0be\u002F8732800be159bc175d0980f82ee36ffe.png\" width=\"1484\" height=\"608\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F873\u002F280\u002F0be\u002F8732800be159bc175d0980f82ee36ffe.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F873\u002F280\u002F0be\u002F8732800be159bc175d0980f82ee36ffe.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EМониторинг в debug режиме\u003C\u002Fh2\u003E\u003Cp\u003EВерхнеуровево количество бакетов для двух основных хеш-таблиц можно посмотреть в дебаг-режиме. Режим не для прода.\u003C\u002Fp\u003E\u003Cp\u003EПравим параметр \u003Ccode\u003Eenable-debug-command\u003C\u002Fcode\u003E в yes. Через CONFIG SET не получится, т.к. параметр иммутабельный.\u003C\u002Fp\u003E\u003Cp\u003EКоманда \u003Ccode\u003EHTSTATS [dbid]\u003C\u002Fcode\u003E - можно получить статистику по хеш-таблицам базы. Пример ответа после установления 7х ключей и ttl одного из них: debug htstats 0 full\u003C\u002Fp\u003E\u003Cblockquote\u003E\u003Cp\u003E[Dictionary HT]\u003C\u002Fp\u003E\u003Cp\u003EHash table 0 stats (main hash table):\u003C\u002Fp\u003E\u003Cp\u003E table size: 8\u003C\u002Fp\u003E\u003Cp\u003E number of elements: 7\u003C\u002Fp\u003E\u003Cp\u003E different slots: 5\u003C\u002Fp\u003E\u003Cp\u003E max chain length: 2\u003C\u002Fp\u003E\u003Cp\u003E avg chain length (counted): 1.40\u003C\u002Fp\u003E\u003Cp\u003E avg chain length (computed): 1.40\u003C\u002Fp\u003E\u003Cp\u003E Chain length distribution:\u003C\u002Fp\u003E\u003Cp\u003E   0: 3 (37.50%)\u003C\u002Fp\u003E\u003Cp\u003E   1: 3 (37.50%)\u003C\u002Fp\u003E\u003Cp\u003E   2: 2 (25.00%)\u003C\u002Fp\u003E\u003Cp\u003E[Expires HT]\u003C\u002Fp\u003E\u003Cp\u003EHash table 0 stats (main hash table):\u003C\u002Fp\u003E\u003Cp\u003E table size: 4\u003C\u002Fp\u003E\u003Cp\u003E number of elements: 1\u003C\u002Fp\u003E\u003Cp\u003E different slots: 1\u003C\u002Fp\u003E\u003Cp\u003E max chain length: 1\u003C\u002Fp\u003E\u003Cp\u003E avg chain length (counted): 1.00\u003C\u002Fp\u003E\u003Cp\u003E avg chain length (computed): 1.00\u003C\u002Fp\u003E\u003Cp\u003E Chain length distribution:\u003C\u002Fp\u003E\u003Cp\u003E   0: 3 (75.00%)\u003C\u002Fp\u003E\u003Cp\u003E   1: 1 (25.00%)\u003C\u002Fp\u003E\u003C\u002Fblockquote\u003E\u003Cp\u003EНе густо (хотелось бы и по остальным таблицам посмотреть), но тем не менее достаточно, чтобы посмотреть как “теория” натягивается фактические данные.\u003C\u002Fp\u003E\u003Ch2\u003EКак работает инкрементальное перехеширование\u003C\u002Fh2\u003E\u003Cp\u003EКогда таблица подвергается перехешированию, указатели на ключи должны быть скопированы в новую хеш-таблицу \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E. Переместить надо очень много ключей. При этом основной поток Redis будет заблокирован и не сможет обрабатывать пользовательские запросы. Для уменьшения негативного эффекта ключи не копируются за одну итерацию. \u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EШаг перехеширования\u003C\u002Fstrong\u003E \u003C\u002Fp\u003E\u003Cp\u003EЛогика работы шага перехеширования закопана в функции \u003Ccode\u003EdictRehash\u003C\u002Fcode\u003E. \u003Ccode\u003EdictRehash\u003C\u002Fcode\u003E фактически копирует ключи принимая на вход хеш-таблицы источника и приёмника и количество ключей, которые надо скопировать. Копирование происходит бакетами. Логика работы \u003Ccode\u003EdictRehash\u003C\u002Fcode\u003E состоит из двух частей:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003EКопирование данных\u003C\u002Fstrong\u003E. Копируем ключи в соответствии с указанным количеством бакетов. Индекс бакета, который переносится в данный момент находится в переменной rehashidx хеш-таблицы. Если бакет пуст, он пропускается и декрементируется счётчик пустых бакетов empty_visits. Когда он дойдёт до нуля, управление будет передано главному потоку и он сможет опять обрабатывать пользовательские запросы. \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003EЗавершение перехеширования\u003C\u002Fstrong\u003E. После копирования проверяем, что все данные перенесены, и если да присваиваем \u003Ccode\u003Eht_table[0]\u003C\u002Fcode\u003E \u003Ccode\u003Eht_table[1].\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003E\u003Cstrong\u003EЧто вызывает итерацию перехеширования\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Ecron. В cron перехешируется основная таблица kv-хранилища и таблица expired. Перехеширование происходит пачками по 100 бакетов с ограничением - 16мс на БД на каждую из двух хештаблиц. Больше баз на инстансе - больше работы на перехеширование.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cpre\u003E\u003Ccode\u003Efor (j = 0; j &lt; dbs_per_call; j++) {\n...\nkvstoreTryResizeDicts(db-&gt;keys, CRON_DICTS_PER_DB);\nkvstoreTryResizeDicts(db-&gt;expires, CRON_DICTS_PER_DB);\n…\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eлюбой доступ к бакету: добавление ключа, удаление ключа,... Перед операцией сначала вызывается \u003Ccode\u003E_dictRehashStep\u003C\u002Fcode\u003E, который перехеширует бакет и далее доступ идёт уже к \u003Ccode\u003Eht_table[1]\u003C\u002Fcode\u003E. Под капотом dictRehash, количество бакетов в параметре для переноса строго 1 - тот, к которому обращаемся.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fef7\u002F679\u002Fa20\u002Fef7679a2075866e7ea6cc51bd880ae23.png\" width=\"1555\" height=\"873\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fef7\u002F679\u002Fa20\u002Fef7679a2075866e7ea6cc51bd880ae23.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fef7\u002F679\u002Fa20\u002Fef7679a2075866e7ea6cc51bd880ae23.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EМетрики перехеширования\u003C\u002Fh2\u003E\u003Cp\u003EКакие инструменты за исключением полулегального DEBUG есть, чтобы простучаться снаружи к метрикам связанным с хеш-таблицами. Их немного: \u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EINFO\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Emem_overhead_db_hashtable_rehashing\u003C\u002Fcode\u003E: дополнительное потребление памяти на перехеширование по всем БД. \u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EMEMORY STATS\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003E- \u003Ccode\u003Edb.dict.rehashing.count\u003C\u002Fcode\u003E: число БД в процессе перехеширования ( Redis 7.4+)\u003C\u002Fp\u003E\u003Cp\u003E- \u003Ccode\u003EdbXXX\u003C\u002Fcode\u003E: Для каждой таблицы расчет занимаемых метаданных (\u003Ccode\u003Eoverhead.hashtable.main\u003C\u002Fcode\u003E and \u003Ccode\u003Eoverhead.hashtable.expires\u003C\u002Fcode\u003E, respectively) are reported in bytes. Дополнительное потребление памяти: hashtable(память для хештаблицы) + \u003Ccode\u003EdictEntry\u003C\u002Fcode\u003E(**для записи отношений** каждой пары) + \u003Ccode\u003EredisObject\u003C\u002Fcode\u003E(Описание различных типов данных) для main и hashtable + \u003Ccode\u003EdictEntry\u003C\u002Fcode\u003E для expired\u003C\u002Fp\u003E\u003Cp\u003E- \u003Ccode\u003Eoverhead.db.hashtable.lut\u003C\u002Fcode\u003E: размер массива хештаблиц(ы) (прим. с учётом миграции from -&gt; to) при перехешировании  (Redis 7.4+)\u003C\u002Fp\u003E\u003Cp\u003E- \u003Ccode\u003Eoverhead.db.hashtable.rehashing\u003C\u002Fcode\u003E: дополнительное потребление памяти для проходящего перехеширования(Redis 7.4+)\u003C\u002Fp\u003E\u003Cp\u003E- \u003Ccode\u003Edb.dict.rehashing.count\u003C\u002Fcode\u003E: Количество хеш-таблиц в настоящее время находящиеся в процессе перехеширования (Redis 8.0+)\u003C\u002Fp\u003E\u003Cp\u003EК примеру на старте main и expired имеют по 312 байт “на старте” и на каждый ключ растут по 40 и 24 байта соответственно (а почему меньше? см. замечание про union v в структуре dictEntry). Когда ключей сотни миллионов может быть существенно при расчёте объёма хранения.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"redis"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F907408\u002F32116b20d32d88b828b59a947fef081a\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F907408\u002F32116b20d32d88b828b59a947fef081a\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Farticles\\\u002F907408\\\u002F\"},\"headline\":\"Дизайн hash-таблиц в redis\",\"datePublished\":\"2025-05-06T17:45:29+03:00\",\"dateModified\":\"2025-05-06T17:45:29+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Клёпов Алексей\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Когда приходится работать большими redis базами в десятки Гб понимание &ldquo;а как оно там?&rdquo;, &ldquo;откуда такой размер?&rdquo;, &ldquo;как правильно отстрелить ногу при проектировани...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Farticles\\\u002F907408\\\u002F#post-content-body\",\"about\":[\"h_nosql\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff6a\\\u002F20b\\\u002F437\\\u002Ff6a20b4374a2cd4603576028f32323a8.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffca\\\u002F58a\\\u002Fa6b\\\u002Ffca58aa6b09586e6574cb6695c1d584a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F873\\\u002F280\\\u002F0be\\\u002F8732800be159bc175d0980f82ee36ffe.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fef7\\\u002F679\\\u002Fa20\\\u002Fef7679a2075866e7ea6cc51bd880ae23.png\"]}","metaDescription":"Когда приходится работать большими redis базами в десятки Гб понимание “а как оно там?”, “откуда такой размер?”, “как правильно отстрелить ногу при проектировании схемы данных?” - может быть полезно....","mainImageUrl":null,"amp":true,"customTrackerLinks":[]},"polls":[],"commentsEnabled":{"status":true,"reason":null},"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"hasPinnedComments":false,"format":null,"banner":null,"multiwidget":null,"multiwidgetUuid":null,"readingTime":7,"complexity":"medium","isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"postReasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"viewedPosts":[],"myFeedFilter":{"complexity":"all","score":"all","types":["articles","posts","news"]},"myFeedIsApplyFilters":false,"myFeedIsForce":false,"karma":{"userReasonsList":null}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"nosql"},"comments":{"articleComments":{},"articlePinnedComments":{},"searchCommentsResults":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":"","idempotenceKey":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"multiwidgets":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"multiwidgetLoading":false,"vacancies":{},"companiesGalleries":{},"companiesBanners":{},"companiesLandingVacancies":{},"companiesTechnologies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null,"jivoStatus":0,"adminNotifications":null,"availableInvitesCount":{}},"companyAdd":{"currentStep":"","stepsData":{},"uncompletedSteps":[],"isStepLoading":true,"isStepCommitting":false,"isInitialized":false,"agreementContent":""},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"pagesCount":0},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":true},"fixedBanner":{"isArticleStickyPanelVisible":false,"isArticleStickyPanelAtTheBottom":false,"isFixedBannerVisible":false,"isStickyPanelIconsHidden":false},"flows":{"updates":{}},"global":{"isPwa":false,"device":"desktop","isHabrCom":true,"requestId":"195fa4a3641751c6db765c3f55557c79"},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"welcomePage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"query":{},"pathname":"\u002Fru\u002Farticles\u002F907408\u002F","path":"\u002Fru\u002Farticles\u002F907408\u002F","href":"\u002Fru\u002Farticles\u002F907408\u002F"}},"me":{"user":null,"uuid":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null,"userUpdates":{"feeds":{"newPostsCount":null,"newThreadsCount":null,"newNewsCount":null,"newCount":null},"conversationUnreadCount":0},"features":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"onboarding":{"currentStep":null,"stepsData":{},"stepsErrors":{},"completedSteps":[],"isStepCommitting":false,"isCommitDisabled":true},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{"courses":"project-block-article"}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null,"sticker":null},"publicationStatistics":{"statsInfo":{},"statsFunnels":{},"statsGraph":{},"defaultSuggest":{},"suggest":{},"timeTracker":{},"isTrackingActivity":false,"isUserActive":true,"otherPublicationStats":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":true,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"stories":{"stories":null},"technotext":{"years":[],"technotextDocForNominees":null,"technotextDocForWinners":null,"technotextInfo":{},"technotextInfoLoading":false,"technotextWinners":{},"technotextWinnersLoading":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"userVotes":{"karmaVotesList":[],"karmaVotesPagesCount":null,"karmaVotesListLoading":false,"commentsVotesList":[],"commentsVotesPagesCount":null,"commentsVotesListLoading":false,"postsVotesList":[],"postsVotesPagesCount":null,"postsVotesListLoading":false,"userVotesList":[],"userVotesPagesCount":null,"userVotesListLoading":false},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"notificationsLoading":false,"notificationsList":[],"notificationsPageCount":0,"pendingMarkNotificationsRead":[],"publicationsLoading":true,"publicationsList":[],"publicationsPageCount":0,"pendingDeletePublications":false,"pendingMarkPublicationsRead":false},"events":{"eventRefs":{},"eventIds":[],"pagesCount":0,"categories":[],"cities":[],"actualEvents":null,"currentEvent":null,"eventsFilter":{"city":"all","timeStarted":null,"timeEnded":null}},"wysiwyg":{"WYSIWYGRulesRefs":null},"refs":{"specializationRefs":[]},"hint":{"hints":{}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
   <script src="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" defer></script>
   <script src="https://assets.habr.com/habr-web/js/app.58b8c457.js" defer></script>
  </div>
  <div id="overlays">
   <!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor-->
  </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S28W1WC23F"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    </script>
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  </script>
  <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
 </body>
</html>