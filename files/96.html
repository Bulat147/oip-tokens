<!doctype html>
<html lang="ru">
 <head>
  <title>Сам себе awaiter / Хабр</title>
  <meta property="fb:app_id" content="444736788986613">
  <meta property="fb:pages" content="472597926099084">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@habr_com">
  <meta property="og:site_name" content="Хабр">
  <link href="https://habr.com/ru/rss/post/906790/?fl=ru" type="application/rss+xml" title rel="alternate" name="rss">
  <link href="https://habr.com/ru/articles/906790/" rel="canonical" data-hid="e3fa780">
  <link rel="image_src" href="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png" data-hid="2a79c45">
  <meta property="og:title" content="Сам себе awaiter">
  <meta name="twitter:title" content="Сам себе awaiter">
  <meta name="aiturec:title" content="Сам себе awaiter">
  <meta name="description" content="Сам себе awaiter Здравствуйте. Меня зовут Валерий и я — кодоголик люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и...">
  <meta itemprop="description" content="Сам себе awaiter Здравствуйте. Меня зовут Валерий и я — кодоголик люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и...">
  <meta property="og:description" content="Сам себе awaiter Здравствуйте. Меня зовут Валерий и я — кодоголик люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и...">
  <meta name="twitter:description" content="Сам себе awaiter Здравствуйте. Меня зовут Валерий и я — кодоголик люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и...">
  <meta property="aiturec:description" content="Сам себе awaiter Здравствуйте. Меня зовут Валерий и я — кодоголик люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и...">
  <meta itemprop="image" content="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png">
  <meta property="og:image" content="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="aiturec:image" content="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png">
  <meta name="twitter:image" content="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png">
  <meta property="vk:image" content="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png?format=vk">
  <meta property="vk:image" content="https://habrastorage.org/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png?format=vk">
  <meta property="aiturec:item_id" content="906790">
  <meta property="aiturec:datetime" content="2025-05-05T22:38:00.000Z">
  <meta content="https://habr.com/ru/articles/906790/" property="og:url">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="ru_RU">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="keywords" content="async-await">
  <script type="application/ld+json" data-hid="1e0f0a2">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/articles\/906790\/"},"headline":"Сам себе awaiter","datePublished":"2025-05-06T01:38:00+03:00","dateModified":"2025-05-07T01:23:21+03:00","author":{"@type":"Person","name":"Валерий"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Сам себе awaiter  Здравствуйте. Меня зовут Валерий и я  &mdash; кодоголиклюблю писать программы. И иногда в процессе написания программ сами собой возникают интересные...","url":"https:\/\/habr.com\/ru\/articles\/906790\/#post-content-body","about":["h_net","h_csharp","h_crazydev","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/906790\/c5b2af6b2c884ed7aa077f0459d21b26\/","https:\/\/habrastorage.org\/webt\/fh\/op\/0m\/fhop0mhc816xvqn_vluulrkhufi.png"]}</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1,user-scalable=0">
  <meta name="referrer" content="unsafe-url">
  <style>
      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmojLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvk4jLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmYjLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvl4jLazX3dA.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSxf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveQhf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSBf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveRhf6Xl7Glw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSxf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eQhf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSBf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eRhf6Xl7Glw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" as="style" media="(prefers-color-scheme: light)">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" as="style" media="(prefers-color-scheme: dark)">
  <link id="light-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" media="(prefers-color-scheme: light)">
  <link id="dark-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" media="(prefers-color-scheme: dark)">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.635b6c39236ebd33fa716c71ab0131a0.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  <style>
      .grecaptcha-badge {
        visibility: hidden;
      }
    </style>
  <meta name="habr-version" content="2.241.0">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png">
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png">
  <link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png">
  <link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png">
  <link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" type="image/png" sizes="256x256" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png">
  <link rel="mask-icon" color="#77a2b6" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg">
  <link crossorigin="use-credentials" href="/manifest.webmanifest" rel="manifest">
  <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script>
  <script>window.yaContextCb = window.yaContextCb || []</script>
  <script src="https://yandex.ru/ads/system/context.js" async></script>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" as="script">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/app.8599692f.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/app.58b8c457.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.8599692f.css">
 </head>
 <body>
  <div id="mount">
   <div id="app">
    <div class="tm-layout__wrapper">
     <!--[--><!---->
     <div></div><!---->
     <header class="tm-header" data-test-id="header">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-header__container">
        <!----><span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_hl-ru tm-header__logo" href="/ru/">
          <svg class="tm-svg-img tm-header__icon" height="16" width="16">
           <title>
            Хабр
           </title><use xlink:href="/img/habr-logo-ru.svg#logo"></use>
          </svg></a><span style="display:none;" class="tm-header__beta-sign">β</span></span><!--[-->
        <div class="tm-dropdown tm-header__projects">
         <div class="tm-dropdown__head">
          <!--[-->
          <button class="tm-header__dropdown-toggle">
           <svg class="tm-svg-img tm-header__icon tm-header__icon_dropdown" height="16" width="16">
            <title>
             Открыть список
            </title><use xlink:href="/img/megazord-v28.7909a852..svg#arrow-down"></use>
           </svg></button><!--]-->
         </div><!---->
        </div><a href="/ru/sandbox/start/" class="tm-header__become-author-btn">Как стать автором</a>
        <div class="tm-feature tm-feature tm-feature_variant-inline tm-header__feature">
         <!---->
        </div><!----><!--]--><!---->
       </div><!--]-->
      </div>
     </header>
     <div class="tm-layout">
      <div class="tm-page-progress-bar"></div>
      <div class="tm-base-layout__header_is-sticky tm-base-layout__header" data-menu-sticky="true">
       <div class="tm-page-width">
        <!--[-->
        <div class="tm-base-layout__header-wrapper">
         <div class="tm-main-menu">
          <div class="tm-main-menu__section">
           <nav class="tm-main-menu__section-content">
            <!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/feed/">Моя лента</a><!--]--><!--[--><a class="tm-main-menu__item" href="/ru/articles/">Все потоки</a><!--]--><!--[--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/develop/">Разработка</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/admin/">Администрирование</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/design/">Дизайн</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/management/">Менеджмент</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/marketing/">Маркетинг</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/popsci/">Научпоп</a><!--]--><!--]-->
           </nav>
          </div>
         </div>
         <div class="tm-header-user-menu tm-base-layout__user-menu">
          <a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search" data-test-id="search-button">
           <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark" height="24" width="24">
            <title>
             Поиск
            </title><use xlink:href="/img/megazord-v28.7909a852..svg#search"></use>
           </svg></a><!----><!---->
          <div class="tm-header-user-menu__item tm-header-user-menu__write">
           <div>
            <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_write tm-header-user-menu__icon_dark" height="24" width="24">
             <title>
              Написать публикацию
             </title><use xlink:href="/img/megazord-v28.7909a852..svg#write"></use>
            </svg>
           </div><!---->
          </div><!--[-->
          <div class="tm-header-user-menu__item">
           <button class="tm-header-user-menu__toggle" data-test-id="user-menu-settings">
            <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_dark" height="24" width="24">
             <title>
              Настройки
             </title><use xlink:href="/img/megazord-v28.7909a852..svg#page-settings"></use>
            </svg></button>
          </div><a href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/articles/906790/&amp;hl=ru" rel="nofollow" class="tm-header-user-menu__item"><!--[-->
           <button class="btn btn_solid btn_small tm-header-user-menu__login" type="button"><!--[-->Войти<!--]--></button><!--]--></a><!--]--><!----><!--teleport start--><!--teleport end--><!---->
         </div>
        </div><!--]-->
       </div>
      </div><!---->
      <div class="tm-page-width">
       <!--[--><!--]-->
      </div>
      <main class="tm-layout__container">
       <div class="tm-page" hl="ru" data-async-called="true" style="--5ab2e5a8:16px;--44c4f6f6:100%;--45ba7a3b:0;">
        <div class="tm-page-width">
         <!--[--><!---->
         <div class="tm-page__wrapper">
          <div class="tm-page__main_has-sidebar tm-page__main">
           <div class="pull-down">
            <!---->
            <div class="pull-down__header" style="height:0px;">
             <div class="pull-down__content" style="bottom:10px;">
              <svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24">
               <title>
                Обновить
               </title><use xlink:href="/img/megazord-v28.7909a852..svg#pull-arrow"></use>
              </svg>
             </div>
            </div><!--[--><!--[--><!---->
            <div class="tm-article-presenter">
             <!--[--><!--]-->
             <div class="tm-article-presenter__body" data-test-id="article-body">
              <div class="tm-misprint-area">
               <div class="tm-misprint-area__wrapper">
                <!--[-->
                <article class="tm-article-presenter__content tm-article-presenter__content_narrow">
                 <!--[-->
                 <div class="tm-article-presenter__header">
                  <!--[--><!--]-->
                  <div class="tm-article-snippet tm-article-snippet tm-article-presenter__snippet">
                   <!--[--><!--]-->
                   <div class="tm-article-snippet__meta-container">
                    <div class="tm-article-snippet__meta">
                     <span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/mvv-rus/" class="tm-user-info__userpic" data-test-id="user-info-pic" title="mvv-rus">
                       <div class="tm-entity-image">
                        <!--[--><img alt="" class="tm-entity-image__pic" height="24" src="https://assets.habr.com/habr-web/img/avatars/137.png" width="24"><!--]-->
                       </div></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/mvv-rus/" class="tm-user-info__username">mvv-rus <!----></a><!--[--><span class="tm-article-datetime-published"><time datetime="2025-05-05T22:38:00.000Z" title="2025-05-06, 01:38">вчера в 01:38</time></span><!--]--></span></span>
                    </div><!---->
                   </div>
                   <h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle"><span>Сам себе awaiter</span></h1>
                   <div class="tm-article-snippet__stats" data-test-id="articleStats">
                    <!---->
                    <div class="tm-article-reading-time">
                     <span class="tm-svg-icon__wrapper tm-article-reading-time__icon">
                      <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                       <title>
                        Время на прочтение
                       </title><use xlink:href="/img/megazord-v28.7909a852..svg#clock"></use>
                      </svg></span><span class="tm-article-reading-time__label">18 мин</span>
                    </div><span class="tm-icon-counter tm-data-icons__item">
                     <svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24">
                      <title>
                       Количество просмотров
                      </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-views"></use>
                     </svg><span class="tm-icon-counter__value" title="2509">2.5K</span></span>
                   </div>
                   <div class="tm-publication-hubs__container" data-test-id="articleHubsList">
                    <div class="tm-publication-hubs">
                     <!--[--><span class="tm-publication-hub__link-container"><a href="/ru/hubs/net/" class="tm-publication-hub__link"><!--[--><span>.NET</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/csharp/" class="tm-publication-hub__link"><!--[--><span>C#</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/crazydev/" class="tm-publication-hub__link"><!--[--><span>Ненормальное программирование</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><!--]-->
                    </div>
                   </div>
                   <div class="tm-article-labels" data-test-id="articleLabels">
                    <div class="tm-article-labels__container">
                     <div class="tm-publication-label tm-publication-label_variant-case">
                      <span>Кейс</span>
                     </div><!--[--><!--]-->
                    </div>
                   </div><!----><!---->
                  </div>
                 </div><!--[--><!---->
                 <div class="tm-article-body" data-gallery-root lang="ru">
                  <div>
                   <!--[--><!--]-->
                  </div>
                  <div id="post-content-body">
                   <div>
                    <div class="article-formatted-body article-formatted-body article-formatted-body_version-1">
                     <div xmlns="http://www.w3.org/1999/xhtml">
                      <h1 id="sam-sebe-awaiter">Сам себе awaiter</h1>
                      <br>
                      <p><img src="https://habrastorage.org/r/w1560/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png" alt="image" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png 780w,
       https://habrastorage.org/r/w1560/webt/fh/op/0m/fhop0mhc816xvqn_vluulrkhufi.png 781w" loading="lazy" decode="async"></p>
                      <br>
                      <p>Здравствуйте. Меня зовут Валерий и я 
                       <del>— кодоголик</del>люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и хочу рассказать в этой статье.</p>
                      <br>
                      <p>За десять с лишним лет, прошедших с момента изобретения конструкции async/await, она стала привычной и широко используемой. В наше время мало у кого вызывает затруднение написать самому или же понять смысл написанного кем-то другим выражения типа <code>await stream.ReadAsync(buffer,async, count)</code> — ясно, что это — чтение из потока в некий буфер, и что программа тут отдает управление на то время, пока это чтение выполняется, чтобы по завершении чтения получить управление продолжить свое выполнение дальше.</p>
                      <br>
                      <p>Но что вы скажете, увидев в коде вот такое выражение: <code>await this</code> в одном из методов класса, совершенно не похожего на Task/ValueTask или ещё что-то, что привычно видеть после await? Не правда ли это вас смутит и уж, тем более, вы вряд ли напишете такое сами? А я однажды такое написал 
                       <del>в здравом уме и трезвой памяти</del>. И если вам интересно, зачем это было так написано и 
                       <del>что за магия тут творится</del>как это работает, и как вообще определить свой класс, чтобы ссылку на него можно было указать после await — читайте статью.</p><a name="habracut"></a>
                      <br>
                      <h2 id="preduprezhdenie">Предупреждение</h2>
                      <br>
                      <p>Если вам, прежде всего, интересно пополнить свою коллекцию практических приемов решения задач, не особо глубоко разбираясь, как эти приемы работают, а тем более — если вы сейчас ищете решение конкретной задачи, то эта статья вряд ли принесет вам существенную пользу. Но если вам интересны вопросы типа "как это работает" или "как можно сделать то же самое другим способом", то эта статья — для вас.</p>
                      <br>
                      <h2 id="o-chem-sobstvenno-rech">О чем, собственно, речь</h2>
                      <br>
                      <p>Упомянутый оператор <code>await this</code>
                       <del>сам собой написался</del> я написал в одном методов одного из классов, который входит в мою новую библиотеку ActiveSession.</p>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">О библиотеке ActiveSession, если кому интересно</b>
                       <div class="spoiler_text">
                        <p>Об этой библиотеке я написал пару статей на Хабре: <a href="https://habr.com/ru/articles/850940/">основную</a> и <a href="https://habr.com/ru/articles/851922/">дополнительную к ней</a>. Класс, о котором идет речь — это один из классов стандартных исполнителей (термин "исполнитель" объяснен в этих статьях). Оригинал кода, о котором идет речь, можно посмотреть в <a href="https://github.com/mvvrus/ActiveSession/blob/e303213138020bda654d3d3396323876a1207e22/MVVrus.AspNetCore.ActiveSession/StdRunner/EnumAdapterRunner.cs#L266" rel="nofollow noopener noreferrer">репозитории библиотеки на GitHub</a>.<br>
                          Класс, про который идет речь — обобщенный, называется <code>EnumAdapterRunner&lt;TItem&gt;</code> и является наследником в иерархии из нескольких классов. Впрочем, все, что связано с наследованием и классами-предками, я постарался из рассказа убрать, как несущественные для этой статьи детали.</p>
                       </div>
                      </div>
                      <br>
                      <p>Но, на самом деле, это не важно, что это за класс — достаточно в нескольких словах рассказать, что делает этот класс и этот метод, чтобы понимать контекст.</p>
                      <br>
                      <p>Класс этот (он — обобщенный, с параметром-типом TItem) перечисляет в фоновом режиме последовательность записей типа TItem(<code>IEnumerable&lt;TItem&gt;</code>), свою для каждого экземпляра класса. При этом предполагается, что процесс перечисления занимает некоторое заметное время (например, записи получаются из базы данных или по сети). Полученные записи класс запоминает во внутреннем буфере. А затем, как раз при вызове рассматриваемого метода из внешней программы, возвращает указанное в параметрах вызова число этих записей. При этом полная совокупность вызовов этого метода возвращает все записи, без пропусков и дублей. Этот метод — асинхронный: если нужное число записей ещё не попало во внутренний буфер, то метод отдает управление до того момента, когда нужное число записей будет помещено фоновым процессом в буфер. Важной для этой статьи особенностью этого метода является то, что для одного экземпляра класса может выполняться одновременно только один вызов метода — потому что иначе порядок возвращенных записей и отсутствие пропусков или дублей сложно гарантировать.</p>
                      <br>
                      <p>То, что вызовы метода для экземпляра класса не могут осуществляться параллельно, позволяет для выражения, стоящего в конструкции await (далее в статье я называю его словом "ожидаемое") использовать нечто, уникальное только в рамках экземпляра. Это могло бы быть (и так нередко делают) поле экземпляра типа Task, содержащее задачу, которая завершается при добавлении записи в буфер. Но я подумал, а почему бы этим уникальным ожидаемым не мог бы быть сам экземпляр этого класса. Именно так и родилась идея использовать оператор <code>await this</code>.</p>
                      <br>
                      <h2 id="kak-eto-rabotaet">Как это работает</h2>
                      <br>
                      <h3 id="vzglyad-na-metod-ispolzuyuschiy-await-this">Взгляд на метод, использующий await this</h3>
                      <br>
                      <p>Этот метод (его название FetchRequiredAsync) выполняет выборку записей из буфера, которые помещает туда фоновый метод перечисления последовательности, о котором будет написано дальше.</p>
                      <br>
                      <p>Код обсуждаемого метода схематично выглядит так:</p>
                      <br>
                      <pre><code class="plaintext">        async Task FetchRequiredAsync(Int32 MaxAdvance, List&lt;TItem&gt; Result, CancellationToken Token)
        {
            using(Token.Register(EnqueueAwaitContinuationForRunning)) {
                while(Result.Count &lt; MaxAdvance &amp;&amp; Status.IsRunning() ){
                    CheckDisposed();
                    Token.ThrowIfCancellationRequested();

                    TItem? item;
                    if(_queue.TryTake(out item)) Result.Add(item!);
                    else if(_queue.IsAddingCompleted) break;
                    else await this;
                }

            }
        }</code></pre>
                      <br>
                      <p>Некоторые пояснения. Параметры метода имеют следующий смысл: Result — список, куда помещается результат вызова, MaxAdvance — сколько записей должен максимально содержать результат, Token — маркер отмены, который позволяет отменить выполнение метода. Поле экземпляра <code>_queue</code> — это промежуточный буфер, он имеет тип <code>ConcurentQueue&lt;TItem&gt;</code>. Метод CheckDisposed() выбрасывает исключение ObjectDisposedException если ранее началась очистка этого экземпляра (был вызван метод Dispose() или DisposeAsync() — обсуждаемый класс поддерживает оба этих варианта очистки): в отличие от многих классов в ASP.NET Core, обсуждаемый класс допускает вызов методов очистки параллельно, во время работы других методов.</p>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">На самом деле, приводимый в статье код - это упрощенная версия реального кода.</b>
                       <div class="spoiler_text">
                        <p>В реальности обсуждаемый класс является частью иерархии наследования классов. А потому перечисленные выше поля и методы находятся в классах, от которых он унаследован. Более того, поле <code>_queue</code> из базового класса для методов этого класса, на самом деле, напрямую недоступно, и весь доступ к нему осуществляется посредством защищенных (protected) методов-оболочек вида QueueSomeOperation(...) вместо <code>_queue.SomeOperation(...)</code>: эти методы-оболочки кроме вызовов соответствующих методов <code>_queue</code> могут дополнительно делать некие операции. Но эти операции в контексте статьи не существенны, потому я и упростил код (и во вставке выше, и в дальнейших вставках), вызывая методы для <code>_queue</code> напрямую.<br>
                          Кроме того, и сам обсуждаемый метод FetchRequiredAsync не является публичным, доступным снаружи — этот метод является защищенным виртуальным и он вызывается из другого, уже публичного метода в базовом классе, который помимо вызова обсуждаемого метода делает дополнительные проверки параметров, преобразует результат в нужную форму и т.п. (для тех, кто умеет в паттерны, поясню: в библиотеке используется прием проектирования "Шаблонный метод"). Но обсуждение всей этой обвязки ничего не дает для описания приема, про который я рассказываю тут в статье. Поэтому обсуждается только внутренний метод FetchRequiredAsync.<br>
                          И, наконец, во всем вставленном коде убрано все, касающееся записи трассировки выполнения методов посредством ILogger. Ради ясности убрана также оптимизация: делегаты для методов класса, которые используются в обсуждаемом в статье коде, не создаются (как в рабочем коде) однократно в конструкторе и не сохраняются во внутренних полях, чтобы их не приходилось создавать при каждом вызове, а создаются по необходимости при каждом вызове метода, которому требуется передать в качестве аргумента делегат для метода: так получается понятнее показать, делегат какого именно метода передается.</p>
                       </div>
                      </div>
                      <br>
                      <p>То есть, в целом, логика работы обсуждаемого метода типична для решаемой им задачи: он в цикле выбирает записи из промежуточного буфера, помещаемые фоновым процессом, пока они есть, а если их нет — асинхронно (т.е. не блокируя поток) ожидает с помощью await this появления новых записей или возникновения других событий: завершения фонового перечисления, отмены выполнения через маркер отмены, начала очистки всего экземпляра объекта. По завершении ожидания проверяет, по какой причине ожидание было прекращено, и либо продолжает выборку записей из буфера, либо завершает свое выполнение соответствующим образом — нормальным возвратом или выбросом исключения.</p>
                      <br>
                      <h3 id="fonovyy-metod-perechislyayuschiy-posledovatelnost">Фоновый метод, перечисляющий последовательность.</h3>
                      <br>
                      <p>Для дальнейшего обсуждения нужно иметь представление и о том методе, который выполняет перечисление последовательности в фоне. Здесь всё просто: в нем выполняется цикл перечисления последовательности до тех пор пока либо она не закончится, либо не придет команда на прекращение выполнения экземпляра, либо при перечислении не возникнет исключение. После каждого извлеченного члена последовательности, а также перед своим завершением метод фонового перечисления пытается запустить продолжение после await, если ожидание на await действительно происходит.</p>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">Код метода фонового перечисления:</b>
                       <div class="spoiler_text">
                        <p>Он выглядит (если упрощенно, без записи событий в журнал и кода, связанного с инициализацией и освобождением ресурсов) следующим образом:</p>
                        <br>
                        <pre><code class="plaintext">        void EnumerateSource()
        {
            try {
                foreach(TItem item in _source!) {
                    if(CompletionToken.IsCancellationRequested) {
                        //No need to proceed.
                        break;
                    }
                    if (_queue.TryAdd(item))
                    {
                        EnqueueAwaitContinuationForRunning();
                    }
                    else if (CompletionToken.IsCancellationRequested) {
                        //Apparently somewhat excessive check. It's intended to sped up a cancellation
                        //by avoiding one more (possibly long) enumeration at the start of the cycle
                        break;
                    }
                }
            }
            catch (Exception e)
            {
                Exception = e;
            }
            finally
            {
                _queue.CompleteAdding();
                EnqueueAwaitContinuationForRunning();
            }
        }</code></pre>
                        <br>
                        <p>Пояснения: CompletionToken — это свойство класса, которое содержит маркер отмены (CancellationToken), отменяемый при завершении работы класса, а Exception — свойство, которое хранит исключение, возникшее в фоновом процессе.<br>
                          Вызов метода EnqueueAwaitContinuationForRunning (о нем будет написано далее) пытается запустить делегат, продолжающий выполнение после await если таковой был сохранен, т.е. если await действительно ожидает.</p>
                       </div>
                      </div>
                      <br>
                      <h2 id="kak-realizovan-await-this">Как реализован await this</h2>
                      <br>
                      <p>Операция await, как известно, не требует, чтобы ожидаемое наследовалось от определенного класса или реализовывало какой-то определенный интерфейс, а опирается на поведенческую типизацию (она же — "утиная", по-английски — "duck typing"): если у класса есть метод GetAwaiter(), который возвращает объект-awaiter, удовлетворяющий определенным соглашениям, то этот класс может служить ожидаемым.</p>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">О названиях.</b>
                       <div class="spoiler_text">
                        <p>Слово awaitable, которое используется в документации, я предпочел перевести как "ожидаемое".<br>
                          Можно было бы перевести и "awaiter": по-русски наверное, это будет "ожидатель" (а сама Microsoft в русском переводе документации использует словосочетание "средство ожидания"), но и тот, и другой перевод кажется мне убогим, поэтому в статье я использую оригинальное английское название <em>awaiter</em>. В конце концов, если даже сам Пушкин так делал — "<em>Du comme il faut</em> (Шишков, прости: не знаю как перевести)", — то и мне такое тоже, думаю, позволительно.</p>
                       </div>
                      </div>
                      <br>
                      <p>И чтобы не плодить сущности, я сделал ровно то, что написано в заголовке статьи: метод GetAwaiter() класса возвращает this, то есть класс — действительно сам себе awaiter.</p>
                      <br>
                      <p>Awaiter обязан иметь нужный набор методов и свойств. Для него тоже используется поведенческая типизация, но требований здесь побольше.<br>
                        Прежде всего, awaiter должен реализовывать свойство <code>bool IsCompleted</code> на случай если нам вдруг повезло и реально ждать уже не надо. Продолжить мы можем, если за то время, пока поток, выполняющий метод, добирался до await, фоновый поток успел добавить в буфер следующую запись. Это реализуется вот таким, очевидным, кодом:</p>
                      <br>
                      <pre><code class="plaintext">bool IsCompleted { get { return _queue.Count &gt; 0; } }</code></pre>
                      <br>
                      <p>Следующий метод, который надо реализовать в awaiter- это GetResult(), он должен ожидать (синхронно) конца операции, которую мы ожидаем и, если надо, вернуть результат. Результат нам возвращать не надо, а ожидание реализует событие с ручным сбросом, которое сбрасывается или устанавливается кодом, планирующим выполнение продолжения (о нем ниже). В нашем случае, когда внутри класса производится только асинхронное ожидание в единственном методе, а ожидание на экземпляре класса невозможно, потому что все связанные с реализацией awaiter методы — закрытые (private), синхронное ожидание возникать не должно. Но, на всякий случай, оно реализовано.</p>
                      <br>
                      <pre><code class="plaintext">        readonly ManualResetEventSlim _complete_event = new ManualResetEventSlim(true);
        void GetResult() { _complete_event.Wait(); }</code></pre>
                      <br>
                      <p>И, наконец, awaiter обязан реализовывать интерфейс <a href="https://learn.microsoft.com/dotnet/api/system.runtime.compilerservices.inotifycompletion" rel="nofollow noopener noreferrer">INotifyCompletion</a> или унаследованный от него <a href="https://learn.microsoft.com/dotnet/api/system.runtime.compilerservices.icriticalnotifycompletion" rel="nofollow noopener noreferrer">ICriticalNotifyCompletion</a>. В настоящее время практически никакой разницы между использованием этих интерфейсов нет. Я выбрал второй вариант — реализовать ICriticalNotifyCompletion. В нем нужно реализовать два метода — OnCompleted (он унаследован от INotifyCompletion) и UnsafeOnCompleted, которые, по факту, делают одно и то же: они планируют запуск переданного им делегата продолжения по завершении операции, ожидание которой происходит.<br>
                        Реализация обоих методов идентична: они вызывают один и тот же внутренний метод который сохраняет переданный ему делегат продолжения для последующего вызова.</p>
                      <br>
                      <pre><code class="plaintext">        void ICriticalNotifyCompletion.UnsafeOnCompleted(Action Continuation) { Schedule(Continuation);}
        void INotifyCompletion.OnCompleted(Action Continuation) {Schedule(Continuation);}

        void Schedule(Action continuation)
        {
            _complete_event.Reset();
            try
            {
                if (Interlocked.CompareExchange(ref _continuation, continuation, null) != null)
                {
                    throw new InvalidOperationException("The schedule operation failed for unknown reason.");
                }
            }
            catch(Exception e)
            {
                _complete_event.Set();
                throw;
            }
            if (_queue.IsAddingCompleted)
            {
                EnqueueAwaitContinuationForRunning();
            }
        }</code></pre>
                      <br>
                      <p>Поскольку ожидать завершения операции — получения в фоновом режиме следующей записи последовательности — может только один поток управления, то делегат из этого потока достаточно сохранить просто в поле нужного типа в экземпляре. Сохранение производится потоковобезопасной операцией из класса Interlocked и, на всякий случай, проверяется, что другого ожидания операции нет. В случае успешного сохранения делегата для последующего вызова сбрасывается уже упомянутое событие с ручным сбросом, которое потенциально может ожидать метод GetResult(). Запуск делегата на выполнение обычно производится фоновой операцией перечисления (процесс будет рассмотрен далее). Но если фоновое перечисление уже завершилось, признаком чего является то, что <code>_queue.IsAddingCompleted</code> возвращает true, то запустить делегат продолжения, скорее всего, будет некому, поэтому, если он есть, придется запустить его здесь: ждать-то всё равно больше нечего.</p>
                      <br>
                      <h3 id="vozobnovlenie-vypolneniya-obsuzhdaemogo-metoda-posle-zaversheniya-ozhidaniya">Возобновление выполнения обсуждаемого метода после завершения ожидания</h3>
                      <br>
                      <p>Возобновление выполнения метода FetchRequiredAsync производится с помощью метода EnqueueAwaitContinuationForRunning:</p>
                      <br>
                      <pre><code class="plaintext">        void EnqueueAwaitContinuationForRunning()
        {
            Action? continuation = Interlocked.Exchange(ref _continuation, null);
            if (continuation != null)
            {
                ThreadPool.UnsafeQueueUserWorkItem(RunAwaitContinuation, continuation, false);
            }
        }</code></pre>
                      <br>
                      <p>Здесь всё просто: этот метод одной атомарной операцией извлекает и обнуляет при этом ссылку на сохраненный делегат продолжения. Если делегат продолжения там был — планирует его на выполнение в пуле потоков путем передачи на выполнение делегата для метода RunAwaitContinuation. Вот исходный код этого метода:</p>
                      <br>
                      <pre><code class="plaintext">        void RunAwaitContinuation(Action Continuation)
        {
            _complete_event.Set();
            Continuation();
        }</code></pre>
                      <br>
                      <p>Метод RunAwaitContinuation сначала устанавливает событие, которое потенциально может ждать метод GetResult() и затем вызывает делегат продолжения.</p>
                      <br>
                      <p>Если же метод FetchRequiredAsync не находится в состоянии ожидания, то поле <code>_continuation</code>, содержащее делегат продолжения — пустое и метод EnqueueAwaitContinuationForRunning ничего не делает. Поэтому его можно смело вызывать без каких-либо проверок: все, что надо, он проверит сам.</p>
                      <br>
                      <h3 id="chto-eschyo-delaet-obsuzhdaemyy-klass-takogo-chto-eto-nado-uchest">Что ещё делает обсуждаемый класс такого, что это надо учесть</h3>
                      <br>
                      <p>Первое — у него (точнее, у родительского класса) есть метод Abort, позволяющий прервать выполнение. В том, что касается обсуждаемого класса или метода, метод Abort во-первых, отменяет CompletionToken, вызывая тем самым завершение процесса фонового перечисления, а во-вторых, вызывает виртуальный метод DoAbort, который запускает на выполнение делегат продолжения(если он есть), чтобы завершить возможное ожидание в методе FetchRequiredAsync:</p>
                      <br>
                      <pre><code class="plaintext">        protected override void DoAbort(String TraceIdentifier)
        {
            EnqueueAwaitContinuationForRunning();
            base.DoAbort(TraceIdentifier);
        }</code></pre>
                      <br>
                      <p>После завершения ожидания возможны несколько путей выполнения этого метода (если кому интересно, я готов подробно расписать это в комментариях), но все они так или иначе приводят к завершению этого метода.</p>
                      <br>
                      <p>Второе — обсуждаемый класс обрабатывает ситуацию, когда в процессе ожидания был вызван один из методов очистки (Dispose() или DisposeAsync()) — в отличие от многих других классов в .NET обсуждаемый класс позволяет их вызывать в произвольные моменты времени. Эти методы определены в разных родительских классах, но, в любом случае, они выставляют сначала признак очистки а потом, до начала, собственно, очистки любых ресурсов, вызывают виртуальный метод PreDispose():</p>
                      <br>
                      <pre><code class="plaintext">        protected override void PreDispose()
        {
            base.PreDispose();
            EnqueueAwaitContinuationForRunning();
        }</code></pre>
                      <br>
                      <p>В обсуждаемом классе этот метод просто возобновляет выполнение метода FetchRequiredAsync, а уже в последнем происходит проверка методом CheckDisposed() на то, что запущена очистка. Метод CheckDisposed(), если очистка началась (признак начала очистки уже был выставлен) выбрасывает исключение ObjectDisposedException. Таким образом, при возобновлении выполнения метода FetchRequiredAsync задача, возвращаемая этим методом в случае начала очистки завершается с этим исключением.</p>
                      <br>
                      <p>Ну и, наконец, await this в FetchRequiredAsync должен реагировать на отмену маркера, переданного как параметр этого метода. Это делается обработчиком для маркера отмены, устанавливаемым через его метод Register. Этот обработчик тоже просто возобновляет метод FetchRequiredAsync, а исключение OperationCanceledException выбрасывается уже после возобновления вызовом метода ThrowIfCancellationRequested.</p>
                      <br>
                      <h2 id="yavlyaetsya-li-napisannaya-vyshe-realizaciya-primerom-universalnoy-realizacii">Является ли написанная выше реализация примером универсальной реализации?</h2>
                      <br>
                      <p>Ни в коем случае. Кроме упомянутого ограничения на параллельность, у нее есть ещё одно ограничение: операция await в этой реализации никогда не выбрасывает исключений. Вообще-то, операция await может выбросить исключение, возникшее в ожидаемом — например, в задаче (Task). Но в этой конкретном применении мне это просто не требовалось: все ситуации приводящие к исключению, обрабатываются в другом месте, совершенно отдельно: исключения в фоновом перечислении обрабатываются вообще по совсем другой логике, приводя к изменению статуса исполнителя как целого (подробнее — в цитированных статьях по библиотеке), а вызов метода очистки или отмена маркера, переданного через параметр Token во время выполнения операции await приводит просто к возобновлению ожидающего метода FetchRequiredAsync, который, если его возобновление было вызвано исключительной ситуацией, выбрасывает надлежащее исключение.</p>
                      <br>
                      <p>Реализация же выброса исключения в операции await — это совершенно отдельная задача, от решения которой я просто уклонился.</p>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">На самом деле, нет.</b>
                       <div class="spoiler_text">
                        <p>На самом деле я этот вариант все же реализовывал, но чисто для себя, и такой вариант реализации обсуждаемого метода можно увидеть в <a href="https://github.com/mvvrus/ActiveSession/tree/pass-await-this-except/MVVrus.AspNetCore.ActiveSession/StdRunner/EnumAdapterRunner.cs" rel="nofollow noopener noreferrer">побочной ветке репозитория</a>.</p>
                        <br>
                        <p>Если разрешить await this выбрасывать исключение, то код обсуждаемого метода FetchRequiredAsync можно немного, если так выразиться, упростить:</p>
                        <br>
                        <pre><code class="plaintext">        async Task FetchRequiredAsync(Int32 MaxAdvance, List&lt;TItem&gt; Result, CancellationToken Token)
        {
            Token.ThrowIfCancellationRequested();
            try {
            using(Token.Register(()=&gt;EnqueueAwaitContinuationForRunning(ExceptionDispatchInfo.Capture(new OperationCanceledException(Token))))) {
                while(Result.Count &lt; MaxAdvance &amp;&amp; Status.IsRunning() ){
                    TItem? item;
                    if(_queue.TryTake(out item)) Result.Add(item!);
                    else if(_queue.IsAddingCompleted) break;
                    else await this;
                }
            }
            }
            finally {
                Volatile.Write(ref _exceptInfo, null);
            }
        }</code></pre>
                        <br>
                        <p>То есть, проверку на очистку экземпляра с выбросом исключения стало возможным вообще из метода убрать (а возможностью ее начала при синхронном выполнении метода я решил пренебречь), а проверку на отмену маркера — вынести из цикла в начало метода. Там эта проверка нужна, чтобы отменить метод даже при синхронном выполнении, если маркер при вызове метода уже отменен. Нужно это или нет — вопрос спорный, но, по крайней мере, тесты у меня такой вариант изначально проверяли, а потому я его реализовал. А еще — изменился обработчик отмены маркера Token, устанавливаемый через его метод Register: он теперь не просто запускает делегат продолжения, но и передает информацию о возникновении исключения OperationCanceledException. Как он это делает — об этом я напишу чуть дальше. Ну, а ещё цикл был обернут в конструкцию try...finally, смысл которой будет раскрыт позже.</p>
                        <br>
                        <p>Исключение при реализации его выброса операцией await нужно выбрасывать в методе GetResult(), поэтому его код поменялся:</p>
                        <br>
                        <pre><code class="plaintext">        void GetResult() { 
            _complete_event.Wait();
            try {
                _exceptInfo?.Throw();
            }
            finally {
                _exceptInfo=null;
            }
        }</code></pre>
                        <br>
                        <p>Информация об исключении передается через поле экземпляра объекта <code>ExceptionDispatchInfo? _exceptInfo</code>. В обсуждаемом в статье классе так делать можно, потому что для каждого экземпляра одновременно может выполняться не более одного метода FetchRequiredAsync. Метод GetResult проверяет это поле, и если оно не пустое — выбрасывает переданное через него исключение, а потом безусловно делает его опять пустым.</p>
                        <br>
                        <p>Метод EnqueueAwaitContinuationForRunning получил новый необязательный параметр типа ExceptionDispatchInfo, через который ему может быть передана информация об исключении, которое нужно возбудить при завершении операции await. Эта информация запоминается в поле <code>_exceptInfo</code> экземпляра при условии, что там не хранится информация о другом исключении. Так что при следующем вызове метода GetResult() при завершении операции await будет вызвано хранящееся в этом поле исключение.</p>
                        <br>
                        <pre><code class="plaintext">        void EnqueueAwaitContinuationForRunning(ExceptionDispatchInfo? ExceptInfo=null)
        {
            Interlocked.CompareExchange(ref _exceptInfo, ExceptInfo, null);
            Action? continuation = Interlocked.Exchange(ref _continuation, null);
            if (continuation != null)
            {
                ThreadPool.UnsafeQueueUserWorkItem(RunAwaitContinuation, continuation, false);
            }
        }</code></pre>
                        <br>
                        <p>И, в любом случае, содержимое этого поля, чтобы не влиять на последующие вызовы обсуждаемого метода FetchRequiredAsync, сбрасывается при выходе из этого метода в той самой конструкцией try...finally, о которой я обещал рассказать.</p>
                        <br>
                        <p>Чтобы возобновить выполнение await this с выбросом исключения, методы, которым это требуется, вызывают EnqueueAwaitContinuationForRunning с непустым аргументом, содержащим информацию об исключении. В обсуждаемом классе таких методов два. Во-первых — это обработчик отмены маркера, который производит возобновление с исключением OperationCanceledException. Его реализация была уже приведена в коде метода FetchRequiredAsync, где он устанавливается. Другой метод, который производит возобновление с исключением — это PreDispose, возобновляющий выполнение после операции await this с выбросом исключения ObjectDisposedException. Его код после изменения выглядит так:</p>
                        <br>
                        <pre><code class="plaintext">        protected override void PreDispose()
        {
            base.PreDispose();
            EnqueueAwaitContinuationForRunning(ExceptionDispatchInfo.Capture(new ObjectDisposedException(DisposedObjectName())));
        }
</code></pre>
                        <br>
                        <p>В общем, я попробовал, как можно было реализовать ту же логику метода FetchRequiredAsync, используя выброс исключения в await this. И для полноты я привожу этот вариант здесь, в статье. Но в рабочем коде библиотеки я существующую реализацию менять не стал, ибо "не сломалось — не чини".</p>
                       </div>
                      </div>
                      <br>
                      <p>Можно подумать, что await всё же выбрасывает исключение в этом, основном, варианте, потому что в методе Schedule в одном месте выбрасывается исключение InvalidOperationException. Но в операцию await это исключение не попадает — оно возникает в потоке, в котором выброшенное исключение вообще не обрабатывается, что приводит к завершению всего приложения.</p>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">Так сделано специально.</b>
                       <div class="spoiler_text">
                        <p>Это исключение играет роль плавкого предохранителя "на всякий случай". Проверка на то, что метод FetchRequiredAsync экземпляра не вызывается параллельно с другим вызовом, реально производится в доступном приложениям публичном методе родительского класса, вызывающего обсуждаемый метод (и если такое обнаруживается, приложение об этом уведомляется). Поэтому ситуация параллельного вызова метода FetchRequiredAsync, из приложения напрямую недоступного, может возникнуть только вследствие внутренней ошибки библиотеки, а в таком случае прекращение работы процесса IMHO оправдано.</p>
                       </div>
                      </div>
                      <br>
                      <div class="spoiler" role="button" tabindex="0">
                       <b class="spoiler_title">А можно ли это исключение вернуть коду, вызвавшему лишний FetchRequiredAsync?</b>
                       <div class="spoiler_text">
                        <p>Технически — да, конечно. И в своих экспериментах с кодом библиотеки я это <a href="https://github.com/mvvrus/ActiveSession/blob/Pass_out-of-order_exception/MVVrus.AspNetCore.ActiveSession/StdRunner/EnumAdapterRunner.cs" rel="nofollow noopener noreferrer">даже сделал</a>.<br>
                          В обработчике этого исключения в методе Schedule вместо повторного выброса этого исключения оператором throw можно запустить выполнение продолжения в другом потоке через специально предназначенный для этого метод RunContinuationWithException.</p>
                        <br>
                        <pre><code class="plaintext">        void Schedule(Action continuation)
        {
            //...
            try
            {
                //...
            }
            catch(Exception e)
            {
                //Do not re-throw the exception here, instead pass it to the continuation
                ExceptionDispatchInfo exception_info = ExceptionDispatchInfo.Capture(e);
                ThreadPool.UnsafeQueueUserWorkItem(RunContinuationWithException, (Continuation, exception_info), false);
            }
            //...
        }
</code></pre>
                        <br>
                        <p>Метод RunContinuationWithException выглядит следующим образом:</p>
                        <br>
                        <pre><code class="plaintext">        void RunContinuationWithException((Action Continuation, ExceptionDispatchInfo? Error) State)
        {
            _exceptionPassed.Value=State.Error;
            _complete_event.Set();
            State.Continuation();
        }</code></pre>
                        <br>
                        <p>Он, так же, как и метод RunAwaitContinuation устанавливает событие, которое потенциально ожидает (на самом деле, этого никогла не происходит) метод GetResult(), сохраняет для метода GetResult() информацию об исключении и вызывает делегат продолжения. Информацию об исключении надо сохранить, потому что, как мы помним из предыдущего примера про выброс исключения операцией await (он — в скрытом тексте выше), его следует выбрасывать в методе GetResult. Но, в отличие от предыдущего примера, здесь нельзя просто взять и использовать для передачи информации об исключении какое-либо поле экземпляра обсуждаемого класса: поля экземпляра предназначены для await в нормальном (т.е. первом) вызове FetchRequiredAsync. Но выход есть: информация об исключении сохраняется в локальном для потока поле экземпляра:</p>
                        <br>
                        <pre><code class="plaintext">        ThreadLocal&lt;ExceptionDispatchInfo?&gt; _exceptionPassed=new ThreadLocal&lt;ExceptionDispatchInfo?&gt;();</code></pre>
                        <br>
                        <p>Так делать можно, потому что метод GetResult гарантированно будет выполнен (делегатом продолжения) в том же потоке. Ну, а в методе GetResult() проверяется, что исключение было передано, и, если так, — выбрасывается заново:</p>
                        <br>
                        <pre><code class="plaintext">        void GetResult() { 
            _complete_event.Wait(); 
            if(_exceptionPassed.Value is not null) _exceptionPassed.Value.Throw(); 
        }</code></pre>
                        <br>
                        <p>Короче, технически можно вместо прекращения работы приложения вызвать в данном случае ислючение в вызывающем коде, который сможет это исключение обрабоать. Однако, подумав, я решил оставить это исключение необработанным, потому что приложение, которое использует библиотеку, мало что может сделать с тем, что в коде библиотеки содержится ошибка.</p>
                       </div>
                      </div>
                      <br>
                      <h2 id="mozhno-li-bylo-sdelat-to-zhe-samoe-shtatnym-obrazom">Можно ли было сделать то же самое штатным образом?</h2>
                      <br>
                      <p>Конечно. Иначе эта статья не была бы опубликована в хабе "Ненормальное программирование". Проще всего было бы использовать await с Task в качестве ожидаемого. Тут сразу напрашивается использование объекта типа TaskCompletionSource с ожиданием на его поле Task и вызовом соответствующих методов завершения (SetCompletion или SetException) там, где ожидание нужно завершить: из фонового метода перечисления или из методов DoAbort и PreDispose. Такой вариант реализуется несложно и он вполне совместим с любой версией .NET, вообще поддерживающей async/await. Но он имеет тот недостаток, что требует создавать объект в куче для каждого ожидания — т.е., нагружает сборщик мусора. Поэтому при изначальном написании варианта обсуждаемого класса я от него отказался: await this экономит на создании лишнего объекта в куче.</p>
                      <br>
                      <p>Но в современном .NET можно использовать в качестве ожидаемого структуру ValueTask, создаваемую на базе реализации интерфейса IValueTaskSource с помощью вспомогательного класса (точнее, структуры) ManualResetValueTaskSourceCore. Такая реализация тоже позволяет избежать лишних размещений объектов в куче, а потому является рекомендуемой для применения(хотя и совершенно безобразно для целей такого применения документированной).</p>
                      <br>
                      <p>Однако когда изначально писался код, обсуждаемый в статье, я ориентировался на совместимость с .NET Framework (причем — не самых новых версий) — в котором поддержка этого варианта появилась достаточно поздно и была добавлена через пакеты, а в базовую поставку не входила. Потому код был написан так, как написан, ну а дальше — как всегда: "не сломалось — не чини". Впрочем, реализацию на базе ValueTask я тоже сделал, для себя. Но, вообще-то, это уже не тема для статьи из хаба "Ненормальное программирование". Да и статья, в которой был реализован ValueTask с использованием ManualResetValueTaskSourceCore на Хабре уже публиковалась, как минимум, <a href="https://habr.com/ru/articles/746934/">одна</a>. Однако если в комментариях будет проявлен интерес, я эту реализацию, так или иначе, выложу для публики.</p>
                      <br>
                      <h2 id="zaklyuchenie">Заключение</h2>
                      <br>
                      <p>В наше время, наверное не стоит использовать код из статьи как образец для новых разработок. Но вот как забавный пример реализации ожидаемого для использования с операцией await он, по моему мнению, вполне годится. А ещё этот код иллюстрирует, как вообще делать свою реализацию ожидаемого. Потому-то я и написал эту статью.</p>
                      <br>
                      <p>P.S. Здесь должна быть ссылка на мой телеграмм-канал — но у меня нет телеграмм-канала. Поэтому желающим читать меня придётся делать это на Хабре.</p>
                     </div>
                    </div>
                   </div><!----><!---->
                  </div><!----><!---->
                 </div><!--]--><!---->
                 <div class="tm-article-presenter__meta" data-test-id="article-meta-links">
                  <div class="tm-separated-list tm-article-presenter__meta-list">
                   <span class="tm-separated-list__title">Теги:</span>
                   <ul class="tm-separated-list__list">
                    <!--[-->
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[async-await]" class="tm-tags-list__link"><span>async-await</span></a><!--]--></li><!--]--><!---->
                   </ul>
                  </div>
                  <div class="tm-separated-list tm-article-presenter__meta-list">
                   <span class="tm-separated-list__title">Хабы:</span>
                   <ul class="tm-separated-list__list">
                    <!--[-->
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/net/" class="tm-hubs-list__link"><!--[--><span>.NET</span><!--]--></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/csharp/" class="tm-hubs-list__link"><!--[--><span>C#</span><!--]--></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/crazydev/" class="tm-hubs-list__link"><!--[--><span>Ненормальное программирование</span><!--]--></a><!--]--></li><!--]--><!---->
                   </ul>
                  </div>
                 </div><!----><!--]-->
                </article><!--]-->
               </div><!---->
              </div>
              <div style="" class="tm-article-sticky-panel" data-test-id="article-sticky-panel">
               <div class="tm-data-icons tm-data-icons tm-data-icons_space-big tm-article-sticky-panel__icons" data-test-id="article-stats-icons">
                <div class="article-rating tm-data-icons__item" data-v-86aec4a7>
                 <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-article votes-switcher" title="Всего голосов 2: ↑2 и ↓0" data-v-86aec4a7>
                  <button class="tm-votes-lever__button" data-test-id="votes-lever-upvote-button" title="Нравится" type="button">
                   <svg class="tm-svg-img tm-votes-lever__icon" height="24" width="24">
                    <title>
                     Нравится
                    </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-vote"></use>
                   </svg></button>
                  <div class="tm-votes-lever__score tm-votes-lever__score_appearance-article tm-votes-lever__score">
                   <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_positive tm-votes-lever__score-counter" data-test-id="votes-score-counter">+3</span></span><!--]-->
                  </div>
                  <button class="tm-votes-lever__button" data-test-id="votes-lever-downvote-button" title="Не нравится" type="button">
                   <svg class="tm-svg-img tm-votes-lever__icon tm-votes-lever__icon_arrow-down" height="24" width="24">
                    <title>
                     Не нравится
                    </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-vote"></use>
                   </svg></button>
                 </div><!--teleport start--><!--teleport end--><!---->
                </div><!----><!---->
                <button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button"><span class="tm-svg-icon__wrapper bookmarks-button__icon">
                  <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                   <title>
                    Добавить в закладки
                   </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-favorite"></use>
                  </svg></span><span class="bookmarks-button__counter" title="Количество пользователей, добавивших публикацию в закладки">17</span></button>
                <div class="tm-sharing tm-data-icons__item" title="Поделиться">
                 <button class="tm-sharing__button" type="button">
                  <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon">
                   <path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path>
                  </svg></button><!--teleport start--><!--teleport end-->
                </div>
                <div class="tm-article-comments-counter-link tm-data-icons__item" title="Читать комментарии">
                 <a href="/ru/articles/906790/comments/" class="tm-article-comments-counter-link__link" data-test-id="counter-comments"><!--[-->
                  <svg class="tm-svg-img tm-article-comments-counter-link__icon" height="24" width="24">
                   <title>
                    Комментарии
                   </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use>
                  </svg><span class="tm-article-comments-counter-link__value">2</span><!--]--></a><!---->
                </div><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--teleport start--><!--teleport end--><!---->
               </div>
              </div>
             </div><!--[--><!--]-->
             <div class="tm-article-presenter__footer">
              <!--[--><!--[-->
              <div class="tm-article-blocks">
               <!----><!--[-->
               <section class="tm-block tm-block tm-block_spacing-bottom">
                <!----><!--[-->
                <div class="tm-block__body tm-block__body tm-block__body_variant-balanced">
                 <!--[-->
                 <div class="tm-article-author" data-test-id="article-author-info" data-async-called="true">
                  <!--[--><!--]-->
                  <div class="tm-user-card tm-user-card tm-user-card_variant-article tm-article-author__user-card" data-async-called="true">
                   <div class="tm-user-card__info-container">
                    <div class="tm-user-card__header">
                     <div class="tm-user-card__header-data">
                      <a href="/ru/users/mvv-rus/" class="tm-user-card__userpic tm-user-card__userpic_size-40">
                       <div class="tm-entity-image">
                        <!--[--><img alt="" class="tm-entity-image__pic" src="https://assets.habr.com/habr-web/img/avatars/137.png"><!--]-->
                       </div></a>
                      <div class="tm-user-card__meta">
                       <div class="tm-counter-container karma" title=" 146 голосов " data-v-f7c0e283>
                        <div class="tm-counter-container__header">
                         <!--[-->
                         <div class="karma-display positive" data-v-f7c0e283 data-v-7635202e>
                          46
                         </div><!----><!--]-->
                        </div>
                        <div class="tm-counter-container__footer">
                         <!--[-->
                         <div class="karma-text" data-v-f7c0e283>
                          Карма
                         </div><!--teleport start--><!--teleport end--><!--]-->
                        </div>
                       </div>
                       <div class="tm-counter-container" title="Рейтинг пользователя">
                        <div class="tm-counter-container__header">
                         <!--[--><!--[--><!--]-->
                         <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating">
                          <!---->
                          <div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score">
                           <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">4.8</span></span><!--]-->
                          </div><!---->
                         </div><!--]-->
                        </div>
                        <div class="tm-counter-container__footer">
                         <!--[--><span class="tm-rating__text tm-rating__text">Рейтинг</span><!--]-->
                        </div>
                       </div>
                      </div>
                     </div>
                    </div>
                    <div class="tm-user-card__info tm-user-card__info_variant-article tm-user-card__info">
                     <div class="tm-user-card__title tm-user-card__title_variant-article tm-user-card__title">
                      <span class="tm-user-card__name tm-user-card__name_variant-article tm-user-card__name">Валерий</span><a href="/ru/users/mvv-rus/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"> @mvv-rus</a><!---->
                     </div>
                     <p class="tm-user-card__short-info tm-user-card__short-info_variant-article tm-user-card__short-info" data-test-id="user-card-speciality">Ненастоящий программист</p>
                    </div>
                   </div><!---->
                   <div class="tm-user-card__buttons tm-user-card__buttons_variant-article tm-user-card__buttons">
                    <!---->
                    <div class="tm-user-card__button">
                     <div class="tm-button-follow tm-user-card__button-follow">
                      <!---->
                      <button class="tm-button-follow__button tm-button-follow__button_big" data-test-id="follow-button" type="button">Подписаться</button>
                     </div>
                    </div><!---->
                    <div class="tm-user-card__button tm-user-card__button_write" data-test-id="user-card-conversations">
                     <svg class="tm-svg-img tm-user-card__button-icon" height="16" width="16">
                      <title>
                       Отправить сообщение
                      </title><use xlink:href="/img/megazord-v28.7909a852..svg#mail"></use>
                     </svg>
                    </div><!---->
                   </div><!---->
                  </div>
                  <div class="tm-article-author__user-contacts" data-test-id="author-contacts">
                   <!----><!----><!---->
                  </div>
                 </div><!--]-->
                </div><!--]--><!---->
               </section><!----><!--[-->
               <div class="banner-wrapper leaderboard tm-page-article__banner" style="--38f3d936:200px;--78a3cd06:auto;" data-v-f4bf0d24>
                <!--[-->
                <div class="placeholder-wrapper placeholder" data-v-f4bf0d24>
                 <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                 <div class="adfox-banner-placeholder leaderboard" data-v-12f7bcca>
                  <div class="image loads" data-v-12f7bcca></div>
                  <div class="lines" data-v-12f7bcca>
                   <div class="line loads" data-v-12f7bcca></div>
                   <div class="line loads" data-v-12f7bcca></div>
                   <div class="line loads" data-v-12f7bcca></div>
                  </div>
                 </div><!----><!----><!---->
                </div>
                <div id="adfox_164725660339535756" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]-->
               </div><!--]--><!--]-->
               <div class="tm-article-blocks__comments">
                <div id="publication-comments" class="tm-article-page-comments">
                 <div>
                  <!--[-->
                  <div class="tm-article-comments-counter-link tm-article-comments-counter-button">
                   <a href="/ru/articles/906790/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" data-test-id="counter-comments"><!--[-->
                    <svg class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted" height="24" width="24">
                     <title>
                      Комментарии
                     </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use>
                    </svg><span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted"> Комментарии 2 </span><!--]--></a><!---->
                  </div><!--]-->
                 </div>
                </div>
               </div><!--[--><!--[--><!--]-->
               <section class="tm-block tm-block tm-block_spacing-bottom">
                <header class="tm-block__header tm-block__header tm-block__header_variant-borderless">
                 <div class="tm-block__header-container">
                  <h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2><!--[--><!--]-->
                 </div><!---->
                </header><!--[-->
                <div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim">
                 <!--[--><!--[-->
                 <div class="tm-tabs tm-tabs">
                  <div class="">
                   <!--[--><span class="tm-tabs__tab-item">
                    <button class="tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim tm-tabs__tab-link">Лучшие за сутки</button></span><span class="tm-tabs__tab-item">
                    <button class="tm-tabs__tab-link tm-tabs__tab-link_slim tm-tabs__tab-link">Похожие</button></span><!--]-->
                  </div><!---->
                 </div>
                 <div class="similar-and-daily__tab-view">
                  <div class="daily-articles-list">
                   <ul class="tm-article-card-list">
                    <!--[--><!--]-->
                    <div class="tm-bordered-card">
                     <!----><!--[--><!--]-->
                    </div>
                   </ul>
                   <div class="daily-articles-block__button-container">
                    <button class="btn btn_transparent btn_small tm-button tm-button_color-horizon" type="button"><!--[--><!--[-->Показать лучшие за всё время<!--]--><!--]--></button>
                   </div>
                  </div><!---->
                 </div><!--]--><!--]-->
                </div><!--]--><!---->
               </section><!--[-->
               <div>
                <div class="placeholder-wrapper">
                 <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                 <div class="tm-placeholder-promo">
                  <div class="tm-placeholder-promo__header">
                   <div class="tm-placeholder__line tm-placeholder__line_promo-title"></div>
                  </div>
                  <div class="tm-placeholder-promo__body">
                   <div class="tm-placeholder-promo__posts">
                    <div class="tm-placeholder-promo__post">
                     <div class="tm-placeholder-promo__image"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_post-title"></div>
                    </div>
                    <div class="tm-placeholder-promo__post">
                     <div class="tm-placeholder-promo__image"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_post-title"></div>
                    </div>
                    <div class="tm-placeholder-promo__post">
                     <div class="tm-placeholder-promo__image"></div>
                     <div class="tm-placeholder__line tm-placeholder__line_post-title"></div>
                    </div>
                   </div>
                   <div class="tm-placeholder-promo__dots">
                    <div class="tm-placeholder-promo__dot"></div>
                    <div class="tm-placeholder-promo__dot"></div>
                    <div class="tm-placeholder-promo__dot"></div>
                   </div>
                  </div>
                 </div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                </div>
               </div>
               <div class="placeholder-wrapper">
                <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                <div class="tm-placeholder-inset tm-placeholder-questions">
                 <div class="tm-placeholder-inset__header">
                  <div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div>
                 </div>
                 <div class="tm-placeholder-inset__body">
                  <ul class="tm-placeholder-list">
                   <!--[-->
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li>
                   <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                    <div class="tm-project-block-items__properties">
                     <!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]-->
                    </div></li><!--]-->
                  </ul>
                 </div>
                 <div class="tm-placeholder-inset__footer">
                  <div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div>
                 </div>
                </div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
               </div><!--]--><!----><!--[--><!--]--><!--]-->
              </div><!--]--><!--]-->
             </div>
            </div><!--]--><!--]-->
           </div>
          </div>
          <div class="tm-page__sidebar">
           <!--[-->
           <div class="tm-layout-sidebar">
            <div class="tm-layout-sidebar__placeholder_initial"></div>
            <div class="tm-sexy-sidebar_initial tm-sexy-sidebar" style="margin-top:0px;">
             <!--[--><!--]--><!---->
             <div class="tm-layout-sidebar__ads_initial tm-layout-sidebar__ads">
              <div class="banner-wrapper half-page tm-layout-sidebar__banner tm-layout-sidebar__banner_top" style="--38f3d936:600px;--78a3cd06:auto;" data-v-f4bf0d24>
               <!--[-->
               <div class="placeholder-wrapper placeholder" data-v-f4bf0d24>
                <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                <div class="adfox-banner-placeholder half-page" data-v-12f7bcca>
                 <div class="image loads" data-v-12f7bcca></div>
                 <div class="lines" data-v-12f7bcca>
                  <div class="line loads" data-v-12f7bcca></div>
                  <div class="line loads" data-v-12f7bcca></div>
                  <div class="line loads" data-v-12f7bcca></div>
                 </div>
                </div><!----><!----><!---->
               </div>
               <div id="adfox_164725680533065327" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]-->
              </div>
             </div><!--[--><!---->
             <div></div>
             <section class="tm-block tm-block tm-block_spacing-around" data-async-called="true">
              <header class="tm-block__header tm-block__header">
               <div class="tm-block__header-container">
                <h2 class="tm-block__title tm-block__title">Работа</h2><!--[--><!--]-->
               </div><!---->
              </header><!--[-->
              <div class="tm-block__body tm-block__body">
               <!--[--><!--[-->
               <div class="tm-vacancies-block__item">
                <a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/programmist_c_sharp" target="_blank">Программист C# удаленно</a>
                <div class="tm-vacancies-block__vacancies-count">
                 62 вакансии
                </div>
               </div>
               <div class="tm-vacancies-block__item">
                <a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/net_developer" target="_blank">.NET разработчик</a>
                <div class="tm-vacancies-block__vacancies-count">
                 44 вакансии
                </div>
               </div><!--]--><!--]-->
              </div><!--]-->
              <footer class="tm-block__footer">
               <!--[--><a class="tm-block-extralink" href="https://career.habr.com/catalog">Все вакансии</a><!--]-->
              </footer>
             </section>
             <section class="tm-block tm-block tm-block_spacing-around block" data-v-6f380946>
              <header class="tm-block__header tm-block__header">
               <div class="tm-block__header-container">
                <h2 class="tm-block__title tm-block__title">Ближайшие события</h2><!--[--><!--]-->
               </div><!---->
              </header><!--[-->
              <div class="tm-block__body tm-block__body">
               <!--[-->
               <div class="placeholder-wrapper" data-v-6f380946>
                <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                <section class="tm-block tm-block tm-block_spacing-none" tabindex="-1" data-v-9caf0b82>
                 <!----><!--[-->
                 <div class="event-card-placeholder is-widget" data-v-9caf0b82>
                  <div class="image loads" data-v-9caf0b82></div>
                  <div class="info" data-v-9caf0b82>
                   <div class="date line" data-v-9caf0b82></div>
                   <div class="title line" data-v-9caf0b82></div>
                   <div class="places line" data-v-9caf0b82></div>
                   <div class="places line" data-v-9caf0b82></div>
                  </div>
                  <div class="footer widget" data-v-9caf0b82>
                   <div class="link line" data-v-9caf0b82></div>
                   <div class="categories" data-v-9caf0b82>
                    <!--[-->
                    <div class="category line" data-v-9caf0b82></div>
                    <div class="category line" data-v-9caf0b82></div>
                    <div class="category line" data-v-9caf0b82></div><!--]-->
                   </div>
                  </div>
                 </div><!--]--><!---->
                </section><!---->
               </div><!--]-->
              </div><!--]--><!---->
             </section><!--]-->
             <div class="banner-wrapper medium-rectangle tm-layout-sidebar__banner tm-layout-sidebar__banner_bottom" style="--38f3d936:250px;--78a3cd06:auto;" data-v-f4bf0d24>
              <!--[-->
              <div class="placeholder-wrapper placeholder" data-v-f4bf0d24>
               <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
               <div class="adfox-banner-placeholder medium-rectangle" data-v-12f7bcca>
                <div class="image loads" data-v-12f7bcca></div>
                <div class="lines" data-v-12f7bcca>
                 <div class="line loads" data-v-12f7bcca></div>
                 <div class="line loads" data-v-12f7bcca></div>
                 <div class="line loads" data-v-12f7bcca></div>
                </div>
               </div><!----><!----><!---->
              </div>
              <div id="adfox_164725691003361602" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]-->
             </div>
            </div>
           </div><!--]-->
          </div>
         </div><!----><!--]-->
        </div>
       </div>
      </main><!---->
     </div>
     <div class="tm-footer-menu">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-footer-menu__container">
        <!--[-->
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Ваш аккаунт</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/articles/906790/&amp;hl=ru" rel="nofollow" target="_self">Войти</a></li>
           <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/articles/906790/&amp;hl=ru" rel="nofollow" target="_self">Регистрация</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Разделы</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/ru/articles/" class="footer-menu__item-link">Статьи</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">Новости</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">Хабы</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">Компании</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">Авторы</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">Песочница</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Информация</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">Для авторов</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">Для компаний</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">Документы</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">Соглашение</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">Конфиденциальность</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Услуги</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">Корпоративный блог</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">Медийная реклама</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">Нативные проекты</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">Образовательные программы</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">Стартапам</a></li><!--]-->
          </ul>
         </div>
        </div><!--]-->
       </div><!--]-->
      </div>
     </div>
     <div class="tm-footer">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-footer__container">
        <!---->
        <div class="tm-footer__social">
         <!--[--><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Facebook
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-facebook"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Twitter
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-twitter"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            VK
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Telegram
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Youtube
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Яндекс Дзен
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use>
          </svg></a><!--]-->
        </div><!--teleport start--><!--teleport end-->
        <button class="tm-footer__link"><!----> Настройка языка</button><a href="/ru/feedback/" class="tm-footer__link">Техническая поддержка</a>
        <div class="tm-footer-copyright">
         <span class="tm-copyright"><span class="tm-copyright__years">© 2006–2025, </span><span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank">Habr</a></span></span>
        </div>
       </div><!--]-->
      </div>
     </div><!----><!--]-->
    </div><!---->
   </div>
   <script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"906790":{"id":"906790","timePublished":"2025-05-05T22:38:00+00:00","isCorporative":false,"lang":"ru","titleHtml":"Сам себе awaiter","leadData":{"textHtml":"\u003Ch1 id=\"sam-sebe-awaiter\"\u003EСам себе awaiter\u003C\u002Fh1\u003E\u003Cbr\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffh\u002Fop\u002F0m\u002Ffhop0mhc816xvqn_vluulrkhufi.png\" alt=\"image\"\u003E\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EЗдравствуйте. Меня зовут Валерий и я \u003Cdel\u003E — кодоголик\u003C\u002Fdel\u003Eлюблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и хочу рассказать в этой статье.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EЗа десять с лишним лет, прошедших с момента изобретения конструкции async\u002Fawait, она стала привычной и широко используемой. В наше время мало у кого вызывает затруднение написать самому или же понять смысл написанного кем-то другим выражения типа \u003Ccode\u003Eawait stream.ReadAsync(buffer,async, count)\u003C\u002Fcode\u003E — ясно, что это — чтение из потока в некий буфер, и что программа тут отдает управление на то время, пока это чтение выполняется, чтобы по завершении чтения получить управление продолжить свое выполнение дальше.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EНо что вы скажете, увидев в коде вот такое выражение: \u003Ccode\u003Eawait this\u003C\u002Fcode\u003E в одном из методов класса, совершенно не похожего на Task\u002FValueTask или ещё что-то, что привычно видеть после await? Не правда ли это вас смутит и уж, тем более, вы вряд ли напишете такое сами? А я однажды такое написал \u003Cdel\u003Eв здравом уме и трезвой памяти\u003C\u002Fdel\u003E. И если вам интересно, зачем это было так написано и \u003Cdel\u003Eчто за магия тут творится\u003C\u002Fdel\u003Eкак это работает, и как вообще определить свой класс, чтобы ссылку на него можно было указать после await — читайте статью.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"1398912","alias":"mvv-rus","fullname":"Валерий","avatarUrl":null,"speciality":"Ненастоящий программист","scoreStats":{"score":46,"votesCount":146},"rating":4.8,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"donationsMethod":null,"isInBlacklist":null,"careerProfile":null},"statistics":{"commentsCount":2,"favoritesCount":17,"readingCount":2509,"score":3,"votesCount":2,"votesCountPlus":2,"votesCountMinus":0},"hubs":[{"id":"546","alias":"net","type":"collective","title":".NET","titleHtml":".NET","isProfiled":true,"relatedData":null},{"id":"17718","alias":"csharp","type":"collective","title":"C#","titleHtml":"C#","isProfiled":true,"relatedData":null},{"id":"84","alias":"crazydev","type":"collective","title":"Ненормальное программирование","titleHtml":"Ненормальное программирование","isProfiled":true,"relatedData":null}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"}],"relatedData":{"vote":null,"unreadCommentsCount":0,"bookmarked":false,"canComment":false,"canEdit":false,"canViewVotes":false,"votePlus":{"canVote":false,"isChargeEnough":false,"isKarmaEnough":false,"isVotingOver":false,"isPublicationLimitEnough":false},"voteMinus":{"canVote":false,"isChargeEnough":false,"isKarmaEnough":false,"isVotingOver":false,"isPublicationLimitEnough":false},"canModerateComments":false,"trackerSubscribed":false,"emailSubscribed":false},"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Ch1 id=\"sam-sebe-awaiter\"\u003EСам себе awaiter\u003C\u002Fh1\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Ffh\u002Fop\u002F0m\u002Ffhop0mhc816xvqn_vluulrkhufi.png\" alt=\"image\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fwebt\u002Ffh\u002Fop\u002F0m\u002Ffhop0mhc816xvqn_vluulrkhufi.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Ffh\u002Fop\u002F0m\u002Ffhop0mhc816xvqn_vluulrkhufi.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЗдравствуйте. Меня зовут Валерий и я \u003Cdel\u003E — кодоголик\u003C\u002Fdel\u003Eлюблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и хочу рассказать в этой статье.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЗа десять с лишним лет, прошедших с момента изобретения конструкции async\u002Fawait, она стала привычной и широко используемой. В наше время мало у кого вызывает затруднение написать самому или же понять смысл написанного кем-то другим выражения типа \u003Ccode\u003Eawait stream.ReadAsync(buffer,async, count)\u003C\u002Fcode\u003E — ясно, что это — чтение из потока в некий буфер, и что программа тут отдает управление на то время, пока это чтение выполняется, чтобы по завершении чтения получить управление продолжить свое выполнение дальше.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EНо что вы скажете, увидев в коде вот такое выражение: \u003Ccode\u003Eawait this\u003C\u002Fcode\u003E в одном из методов класса, совершенно не похожего на Task\u002FValueTask или ещё что-то, что привычно видеть после await? Не правда ли это вас смутит и уж, тем более, вы вряд ли напишете такое сами? А я однажды такое написал \u003Cdel\u003Eв здравом уме и трезвой памяти\u003C\u002Fdel\u003E. И если вам интересно, зачем это было так написано и \u003Cdel\u003Eчто за магия тут творится\u003C\u002Fdel\u003Eкак это работает, и как вообще определить свой класс, чтобы ссылку на него можно было указать после await — читайте статью.\u003C\u002Fp\u003E\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"preduprezhdenie\"\u003EПредупреждение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЕсли вам, прежде всего, интересно пополнить свою коллекцию практических приемов решения задач, не особо глубоко разбираясь, как эти приемы работают, а тем более — если вы сейчас ищете решение конкретной задачи, то эта статья вряд ли принесет вам существенную пользу. Но если вам интересны вопросы типа \"как это работает\" или \"как можно сделать то же самое другим способом\", то эта статья — для вас.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"o-chem-sobstvenno-rech\"\u003EО чем, собственно, речь\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EУпомянутый оператор \u003Ccode\u003Eawait this\u003C\u002Fcode\u003E \u003Cdel\u003Eсам собой написался\u003C\u002Fdel\u003E я написал в одном методов одного из классов, который входит в мою новую библиотеку ActiveSession.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EО библиотеке ActiveSession, если кому интересно\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EОб этой библиотеке я написал пару статей на Хабре: \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F850940\u002F\"\u003Eосновную\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F851922\u002F\"\u003Eдополнительную к ней\u003C\u002Fa\u003E. Класс, о котором идет речь — это один из классов стандартных исполнителей (термин \"исполнитель\" объяснен в этих статьях). Оригинал кода, о котором идет речь, можно посмотреть в \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmvvrus\u002FActiveSession\u002Fblob\u002Fe303213138020bda654d3d3396323876a1207e22\u002FMVVrus.AspNetCore.ActiveSession\u002FStdRunner\u002FEnumAdapterRunner.cs#L266\" rel=\"nofollow noopener noreferrer\"\u003Eрепозитории библиотеки на GitHub\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\nКласс, про который идет речь — обобщенный, называется \u003Ccode\u003EEnumAdapterRunner&lt;TItem&gt;\u003C\u002Fcode\u003E и является наследником в иерархии из нескольких классов. Впрочем, все, что связано с наследованием и классами-предками, я постарался из рассказа убрать, как несущественные для этой статьи детали. \u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EНо, на самом деле, это не важно, что это за класс — достаточно в нескольких словах рассказать, что делает этот класс и этот метод, чтобы понимать контекст.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EКласс этот (он — обобщенный, с параметром-типом TItem) перечисляет в фоновом режиме последовательность записей типа TItem(\u003Ccode\u003EIEnumerable&lt;TItem&gt;\u003C\u002Fcode\u003E), свою для каждого экземпляра класса. При этом предполагается, что процесс перечисления занимает некоторое заметное время (например, записи получаются из базы данных или по сети). Полученные записи класс запоминает во внутреннем буфере. А затем, как раз при вызове рассматриваемого метода из внешней программы, возвращает указанное в параметрах вызова число этих записей. При этом полная совокупность вызовов этого метода возвращает все записи, без пропусков и дублей. Этот метод — асинхронный: если нужное число записей ещё не попало во внутренний буфер, то метод отдает управление до того момента, когда нужное число записей будет помещено фоновым процессом в буфер. Важной для этой статьи особенностью этого метода является то, что для одного экземпляра класса может выполняться одновременно только один вызов метода — потому что иначе порядок возвращенных записей и отсутствие пропусков или дублей сложно гарантировать.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EТо, что вызовы метода для экземпляра класса не могут осуществляться параллельно, позволяет для выражения, стоящего в конструкции await (далее в статье я называю его словом \"ожидаемое\") использовать нечто, уникальное только в рамках экземпляра. Это могло бы быть (и так нередко делают) поле экземпляра типа Task, содержащее задачу, которая завершается при добавлении записи в буфер. Но я подумал, а почему бы этим уникальным ожидаемым не мог бы быть сам экземпляр этого класса. Именно так и родилась идея использовать оператор \u003Ccode\u003Eawait this\u003C\u002Fcode\u003E. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"kak-eto-rabotaet\"\u003EКак это работает\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Ch3 id=\"vzglyad-na-metod-ispolzuyuschiy-await-this\"\u003EВзгляд на метод, использующий await this\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЭтот метод (его название FetchRequiredAsync) выполняет выборку записей из буфера, которые помещает туда фоновый метод перечисления последовательности, о котором будет написано дальше.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EКод обсуждаемого метода схематично выглядит так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        async Task FetchRequiredAsync(Int32 MaxAdvance, List&lt;TItem&gt; Result, CancellationToken Token)\n        {\n            using(Token.Register(EnqueueAwaitContinuationForRunning)) {\n                while(Result.Count &lt; MaxAdvance &amp;&amp; Status.IsRunning() ){\n                    CheckDisposed();\n                    Token.ThrowIfCancellationRequested();\n\n                    TItem? item;\n                    if(_queue.TryTake(out item)) Result.Add(item!);\n                    else if(_queue.IsAddingCompleted) break;\n                    else await this;\n                }\n\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EНекоторые пояснения. Параметры метода имеют следующий смысл: Result — список, куда помещается результат вызова, MaxAdvance — сколько записей должен максимально содержать результат, Token — маркер отмены, который позволяет отменить выполнение метода. Поле экземпляра \u003Ccode\u003E_queue\u003C\u002Fcode\u003E — это промежуточный буфер, он имеет тип \u003Ccode\u003EConcurentQueue&lt;TItem&gt;\u003C\u002Fcode\u003E. Метод CheckDisposed() выбрасывает исключение ObjectDisposedException если ранее началась очистка этого экземпляра (был вызван метод Dispose() или DisposeAsync() — обсуждаемый класс поддерживает оба этих варианта очистки): в отличие от многих классов в ASP.NET Core, обсуждаемый класс допускает вызов методов очистки параллельно, во время работы других методов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EНа самом деле, приводимый в статье код - это упрощенная версия реального кода.\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EВ реальности обсуждаемый класс является частью иерархии наследования классов. А потому перечисленные выше поля и методы находятся в классах, от которых он унаследован. Более того, поле \u003Ccode\u003E_queue\u003C\u002Fcode\u003E из базового класса для методов этого класса, на самом деле, напрямую недоступно, и весь доступ к нему осуществляется посредством защищенных (protected) методов-оболочек вида QueueSomeOperation(...) вместо \u003Ccode\u003E_queue.SomeOperation(...)\u003C\u002Fcode\u003E: эти методы-оболочки кроме вызовов соответствующих методов \u003Ccode\u003E_queue\u003C\u002Fcode\u003E могут дополнительно делать некие операции. Но эти операции в контексте статьи не существенны, потому я и упростил код (и во вставке выше, и в дальнейших вставках), вызывая методы для \u003Ccode\u003E_queue\u003C\u002Fcode\u003E напрямую.\u003Cbr\u002F\u003E\nКроме того, и сам обсуждаемый метод FetchRequiredAsync не является публичным, доступным снаружи — этот метод является защищенным виртуальным и он вызывается из другого, уже публичного метода в базовом классе, который помимо вызова обсуждаемого метода делает дополнительные проверки параметров, преобразует результат в нужную форму и т.п. (для тех, кто умеет в паттерны, поясню: в библиотеке используется прием проектирования \"Шаблонный метод\"). Но обсуждение всей этой обвязки ничего не дает для описания приема, про который я рассказываю тут в статье. Поэтому обсуждается только внутренний метод FetchRequiredAsync.\u003Cbr\u002F\u003E\nИ, наконец, во всем вставленном коде убрано все, касающееся записи трассировки выполнения методов посредством ILogger. Ради ясности убрана также оптимизация: делегаты для методов класса, которые используются в обсуждаемом в статье коде, не создаются (как в рабочем коде) однократно в конструкторе и не сохраняются во внутренних полях, чтобы их не приходилось создавать при каждом вызове, а создаются по необходимости при каждом вызове метода, которому требуется передать в качестве аргумента делегат для метода: так получается понятнее показать, делегат какого именно метода передается.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EТо есть, в целом, логика работы обсуждаемого метода типична для решаемой им задачи: он в цикле выбирает записи из промежуточного буфера, помещаемые фоновым процессом, пока они есть, а если их нет — асинхронно (т.е. не блокируя поток) ожидает с помощью await this появления новых записей или возникновения других событий: завершения фонового перечисления, отмены выполнения через маркер отмены, начала очистки всего экземпляра объекта. По завершении ожидания проверяет, по какой причине ожидание было прекращено, и либо продолжает выборку записей из буфера, либо завершает свое выполнение соответствующим образом — нормальным возвратом или выбросом исключения.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch3 id=\"fonovyy-metod-perechislyayuschiy-posledovatelnost\"\u003EФоновый метод, перечисляющий последовательность.\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EДля дальнейшего обсуждения нужно иметь представление и о том методе, который выполняет перечисление последовательности в фоне. Здесь всё просто: в нем выполняется цикл перечисления последовательности до тех пор пока либо она не закончится, либо не придет команда на прекращение выполнения экземпляра, либо при перечислении не возникнет исключение. После каждого извлеченного члена последовательности, а также перед своим завершением метод фонового перечисления пытается запустить продолжение после await, если ожидание на await действительно происходит.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EКод метода фонового перечисления:\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EОн выглядит (если упрощенно, без записи событий в журнал и кода, связанного с инициализацией и освобождением ресурсов) следующим образом:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void EnumerateSource()\n        {\n            try {\n                foreach(TItem item in _source!) {\n                    if(CompletionToken.IsCancellationRequested) {\n                        \u002F\u002FNo need to proceed.\n                        break;\n                    }\n                    if (_queue.TryAdd(item))\n                    {\n                        EnqueueAwaitContinuationForRunning();\n                    }\n                    else if (CompletionToken.IsCancellationRequested) {\n                        \u002F\u002FApparently somewhat excessive check. It's intended to sped up a cancellation\n                        \u002F\u002Fby avoiding one more (possibly long) enumeration at the start of the cycle\n                        break;\n                    }\n                }\n            }\n            catch (Exception e)\n            {\n                Exception = e;\n            }\n            finally\n            {\n                _queue.CompleteAdding();\n                EnqueueAwaitContinuationForRunning();\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EПояснения: CompletionToken — это свойство класса, которое содержит маркер отмены (CancellationToken), отменяемый при завершении работы класса, а Exception — свойство, которое хранит исключение, возникшее в фоновом процессе.\u003Cbr\u002F\u003E\nВызов метода EnqueueAwaitContinuationForRunning (о нем будет написано далее) пытается запустить делегат, продолжающий выполнение после await если таковой был сохранен, т.е. если await действительно ожидает.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"kak-realizovan-await-this\"\u003EКак реализован await this\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EОперация await, как известно, не требует, чтобы ожидаемое наследовалось от определенного класса или реализовывало какой-то определенный интерфейс, а опирается на поведенческую типизацию (она же — \"утиная\", по-английски — \"duck typing\"): если у класса есть метод GetAwaiter(), который возвращает объект-awaiter, удовлетворяющий определенным соглашениям, то этот класс может служить ожидаемым. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EО названиях.\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EСлово awaitable, которое используется в документации, я предпочел перевести как \"ожидаемое\".\u003Cbr\u002F\u003E\nМожно было бы перевести и \"awaiter\": по-русски наверное, это будет \"ожидатель\" (а сама Microsoft в русском переводе документации использует словосочетание \"средство ожидания\"), но и тот, и другой перевод кажется мне убогим, поэтому в статье я использую оригинальное английское название \u003Cem\u003Eawaiter\u003C\u002Fem\u003E. В конце концов, если даже сам Пушкин так делал — \"\u003Cem\u003EDu comme il faut\u003C\u002Fem\u003E (Шишков, прости: не знаю как перевести)\", — то и мне такое тоже, думаю, позволительно.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EИ чтобы не плодить сущности, я сделал ровно то, что написано в заголовке статьи: метод GetAwaiter() класса возвращает this, то есть класс — действительно сам себе awaiter.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EAwaiter обязан иметь нужный набор методов и свойств. Для него тоже используется поведенческая типизация, но требований здесь побольше.\u003Cbr\u002F\u003E\nПрежде всего, awaiter должен реализовывать свойство \u003Ccode\u003Ebool IsCompleted\u003C\u002Fcode\u003E на случай если нам вдруг повезло и реально ждать уже не надо. Продолжить мы можем, если за то время, пока поток, выполняющий метод, добирался до await, фоновый поток успел добавить в буфер следующую запись. Это реализуется вот таким, очевидным, кодом:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Ebool IsCompleted { get { return _queue.Count &gt; 0; } }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EСледующий метод, который надо реализовать в awaiter- это GetResult(), он должен ожидать (синхронно) конца операции, которую мы ожидаем и, если надо, вернуть результат. Результат нам возвращать не надо, а ожидание реализует событие с ручным сбросом, которое сбрасывается или устанавливается кодом, планирующим выполнение продолжения (о нем ниже). В нашем случае, когда внутри класса производится только асинхронное ожидание в единственном методе, а ожидание на экземпляре класса невозможно, потому что все связанные с реализацией awaiter методы — закрытые (private), синхронное ожидание возникать не должно. Но, на всякий случай, оно реализовано.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        readonly ManualResetEventSlim _complete_event = new ManualResetEventSlim(true);\n        void GetResult() { _complete_event.Wait(); }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EИ, наконец, awaiter обязан реализовывать интерфейс \u003Ca href=\"https:\u002F\u002Flearn.microsoft.com\u002Fdotnet\u002Fapi\u002Fsystem.runtime.compilerservices.inotifycompletion\" rel=\"nofollow noopener noreferrer\"\u003EINotifyCompletion\u003C\u002Fa\u003E или унаследованный от него \u003Ca href=\"https:\u002F\u002Flearn.microsoft.com\u002Fdotnet\u002Fapi\u002Fsystem.runtime.compilerservices.icriticalnotifycompletion\" rel=\"nofollow noopener noreferrer\"\u003EICriticalNotifyCompletion\u003C\u002Fa\u003E. В настоящее время практически никакой разницы между использованием этих интерфейсов нет. Я выбрал второй вариант — реализовать ICriticalNotifyCompletion. В нем нужно реализовать два метода — OnCompleted (он унаследован от INotifyCompletion) и UnsafeOnCompleted, которые, по факту, делают одно и то же: они планируют запуск переданного им делегата продолжения по завершении операции, ожидание которой происходит.\u003Cbr\u002F\u003E\nРеализация обоих методов идентична: они вызывают один и тот же внутренний метод который сохраняет переданный ему делегат продолжения для последующего вызова.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void ICriticalNotifyCompletion.UnsafeOnCompleted(Action Continuation) { Schedule(Continuation);}\n        void INotifyCompletion.OnCompleted(Action Continuation) {Schedule(Continuation);}\n\n        void Schedule(Action continuation)\n        {\n            _complete_event.Reset();\n            try\n            {\n                if (Interlocked.CompareExchange(ref _continuation, continuation, null) != null)\n                {\n                    throw new InvalidOperationException(\"The schedule operation failed for unknown reason.\");\n                }\n            }\n            catch(Exception e)\n            {\n                _complete_event.Set();\n                throw;\n            }\n            if (_queue.IsAddingCompleted)\n            {\n                EnqueueAwaitContinuationForRunning();\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EПоскольку ожидать завершения операции — получения в фоновом режиме следующей записи последовательности — может только один поток управления, то делегат из этого потока достаточно сохранить просто в поле нужного типа в экземпляре. Сохранение производится потоковобезопасной операцией из класса Interlocked и, на всякий случай, проверяется, что другого ожидания операции нет. В случае успешного сохранения делегата для последующего вызова сбрасывается уже упомянутое событие с ручным сбросом, которое потенциально может ожидать метод GetResult(). Запуск делегата на выполнение обычно производится фоновой операцией перечисления (процесс будет рассмотрен далее). Но если фоновое перечисление уже завершилось, признаком чего является то, что \u003Ccode\u003E_queue.IsAddingCompleted\u003C\u002Fcode\u003E возвращает true, то запустить делегат продолжения, скорее всего, будет некому, поэтому, если он есть, придется запустить его здесь: ждать-то всё равно больше нечего.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch3 id=\"vozobnovlenie-vypolneniya-obsuzhdaemogo-metoda-posle-zaversheniya-ozhidaniya\"\u003EВозобновление выполнения обсуждаемого метода после завершения ожидания\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EВозобновление выполнения метода FetchRequiredAsync производится с помощью метода EnqueueAwaitContinuationForRunning:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void EnqueueAwaitContinuationForRunning()\n        {\n            Action? continuation = Interlocked.Exchange(ref _continuation, null);\n            if (continuation != null)\n            {\n                ThreadPool.UnsafeQueueUserWorkItem(RunAwaitContinuation, continuation, false);\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЗдесь всё просто: этот метод одной атомарной операцией извлекает и обнуляет при этом ссылку на сохраненный делегат продолжения. Если делегат продолжения там был — планирует его на выполнение в пуле потоков путем передачи на выполнение делегата для метода RunAwaitContinuation. Вот исходный код этого метода:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void RunAwaitContinuation(Action Continuation)\n        {\n            _complete_event.Set();\n            Continuation();\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EМетод RunAwaitContinuation сначала устанавливает событие, которое потенциально может ждать метод GetResult() и затем вызывает делегат продолжения.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЕсли же метод FetchRequiredAsync не находится в состоянии ожидания, то поле \u003Ccode\u003E_continuation\u003C\u002Fcode\u003E, содержащее делегат продолжения — пустое и метод EnqueueAwaitContinuationForRunning ничего не делает. Поэтому его можно смело вызывать без каких-либо проверок: все, что надо, он проверит сам.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch3 id=\"chto-eschyo-delaet-obsuzhdaemyy-klass-takogo-chto-eto-nado-uchest\"\u003EЧто ещё делает обсуждаемый класс такого, что это надо учесть\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EПервое — у него (точнее, у родительского класса) есть метод Abort, позволяющий прервать выполнение. В том, что касается обсуждаемого класса или метода, метод Abort во-первых, отменяет CompletionToken, вызывая тем самым завершение процесса фонового перечисления, а во-вторых, вызывает виртуальный метод DoAbort, который запускает на выполнение делегат продолжения(если он есть), чтобы завершить возможное ожидание в методе FetchRequiredAsync:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        protected override void DoAbort(String TraceIdentifier)\n        {\n            EnqueueAwaitContinuationForRunning();\n            base.DoAbort(TraceIdentifier);\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EПосле завершения ожидания возможны несколько путей выполнения этого метода (если кому интересно, я готов подробно расписать это в комментариях), но все они так или иначе приводят к завершению этого метода.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EВторое — обсуждаемый класс обрабатывает ситуацию, когда в процессе ожидания был вызван один из методов очистки (Dispose() или DisposeAsync()) — в отличие от многих других классов в .NET обсуждаемый класс позволяет их вызывать в произвольные моменты времени. Эти методы определены в разных родительских классах, но, в любом случае, они выставляют сначала признак очистки а потом, до начала, собственно, очистки любых ресурсов, вызывают виртуальный метод PreDispose():\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        protected override void PreDispose()\n        {\n            base.PreDispose();\n            EnqueueAwaitContinuationForRunning();\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EВ обсуждаемом классе этот метод просто возобновляет выполнение метода FetchRequiredAsync, а уже в последнем происходит проверка методом CheckDisposed() на то, что запущена очистка. Метод CheckDisposed(), если очистка началась (признак начала очистки уже был выставлен) выбрасывает исключение ObjectDisposedException. Таким образом, при возобновлении выполнения метода FetchRequiredAsync задача, возвращаемая этим методом в случае начала очистки завершается с этим исключением.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EНу и, наконец, await this в FetchRequiredAsync должен реагировать на отмену маркера, переданного как параметр этого метода. Это делается обработчиком для маркера отмены, устанавливаемым через его метод Register. Этот обработчик тоже просто возобновляет метод FetchRequiredAsync, а исключение OperationCanceledException выбрасывается уже после возобновления вызовом метода ThrowIfCancellationRequested.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"yavlyaetsya-li-napisannaya-vyshe-realizaciya-primerom-universalnoy-realizacii\"\u003EЯвляется ли написанная выше реализация примером универсальной реализации?\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EНи в коем случае. Кроме упомянутого ограничения на параллельность, у нее есть ещё одно ограничение: операция await в этой реализации никогда не выбрасывает исключений. Вообще-то, операция await может выбросить исключение, возникшее в ожидаемом — например, в задаче (Task). Но в этой конкретном применении мне это просто не требовалось: все ситуации приводящие к исключению, обрабатываются в другом месте, совершенно отдельно: исключения в фоновом перечислении обрабатываются вообще по совсем другой логике, приводя к изменению статуса исполнителя как целого (подробнее — в цитированных статьях по библиотеке), а вызов метода очистки или отмена маркера, переданного через параметр Token во время выполнения операции await приводит просто к возобновлению ожидающего метода FetchRequiredAsync, который, если его возобновление было вызвано исключительной ситуацией, выбрасывает надлежащее исключение. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EРеализация же выброса исключения в операции await — это совершенно отдельная задача, от решения которой я просто уклонился. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EНа самом деле, нет.\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EНа самом деле я этот вариант все же реализовывал, но чисто для себя, и такой вариант реализации обсуждаемого метода можно увидеть в \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmvvrus\u002FActiveSession\u002Ftree\u002Fpass-await-this-except\u002FMVVrus.AspNetCore.ActiveSession\u002FStdRunner\u002FEnumAdapterRunner.cs\" rel=\"nofollow noopener noreferrer\"\u003Eпобочной ветке репозитория\u003C\u002Fa\u003E. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЕсли разрешить await this выбрасывать исключение, то код обсуждаемого метода FetchRequiredAsync можно немного, если так выразиться, упростить:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        async Task FetchRequiredAsync(Int32 MaxAdvance, List&lt;TItem&gt; Result, CancellationToken Token)\n        {\n            Token.ThrowIfCancellationRequested();\n            try {\n            using(Token.Register(()=&gt;EnqueueAwaitContinuationForRunning(ExceptionDispatchInfo.Capture(new OperationCanceledException(Token))))) {\n                while(Result.Count &lt; MaxAdvance &amp;&amp; Status.IsRunning() ){\n                    TItem? item;\n                    if(_queue.TryTake(out item)) Result.Add(item!);\n                    else if(_queue.IsAddingCompleted) break;\n                    else await this;\n                }\n            }\n            }\n            finally {\n                Volatile.Write(ref _exceptInfo, null);\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EТо есть, проверку на очистку экземпляра с выбросом исключения стало возможным вообще из метода убрать (а возможностью ее начала при синхронном выполнении метода я решил пренебречь), а проверку на отмену маркера — вынести из цикла в начало метода. Там эта проверка нужна, чтобы отменить метод даже при синхронном выполнении, если маркер при вызове метода уже отменен. Нужно это или нет — вопрос спорный, но, по крайней мере, тесты у меня такой вариант изначально проверяли, а потому я его реализовал. А еще — изменился обработчик отмены маркера Token, устанавливаемый через его метод Register: он теперь не просто запускает делегат продолжения, но и передает информацию о возникновении исключения OperationCanceledException. Как он это делает — об этом я напишу чуть дальше. Ну, а ещё цикл был обернут в конструкцию try...finally, смысл которой будет раскрыт позже.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EИсключение при реализации его выброса операцией await нужно выбрасывать в методе GetResult(), поэтому его код поменялся:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void GetResult() { \n            _complete_event.Wait();\n            try {\n                _exceptInfo?.Throw();\n            }\n            finally {\n                _exceptInfo=null;\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EИнформация об исключении передается через поле экземпляра объекта \u003Ccode\u003EExceptionDispatchInfo? _exceptInfo\u003C\u002Fcode\u003E. В обсуждаемом в статье классе так делать можно, потому что для каждого экземпляра одновременно может выполняться не более одного метода FetchRequiredAsync. Метод GetResult проверяет это поле, и если оно не пустое — выбрасывает переданное через него исключение, а потом безусловно делает его опять пустым.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EМетод EnqueueAwaitContinuationForRunning получил новый необязательный параметр типа ExceptionDispatchInfo, через который ему может быть передана информация об исключении, которое нужно возбудить при завершении операции await. Эта информация запоминается в поле \u003Ccode\u003E_exceptInfo\u003C\u002Fcode\u003E экземпляра при условии, что там не хранится информация о другом исключении. Так что при следующем вызове метода GetResult() при завершении операции await будет вызвано хранящееся в этом поле исключение.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void EnqueueAwaitContinuationForRunning(ExceptionDispatchInfo? ExceptInfo=null)\n        {\n            Interlocked.CompareExchange(ref _exceptInfo, ExceptInfo, null);\n            Action? continuation = Interlocked.Exchange(ref _continuation, null);\n            if (continuation != null)\n            {\n                ThreadPool.UnsafeQueueUserWorkItem(RunAwaitContinuation, continuation, false);\n            }\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EИ, в любом случае, содержимое этого поля, чтобы не влиять на последующие вызовы обсуждаемого метода FetchRequiredAsync, сбрасывается при выходе из этого метода в той самой конструкцией try...finally, о которой я обещал рассказать. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EЧтобы возобновить выполнение await this с выбросом исключения, методы, которым это требуется, вызывают EnqueueAwaitContinuationForRunning с непустым аргументом, содержащим информацию об исключении. В обсуждаемом классе таких методов два. Во-первых — это обработчик отмены маркера, который производит возобновление с исключением OperationCanceledException. Его реализация была уже приведена в коде метода FetchRequiredAsync, где он устанавливается. Другой метод, который производит возобновление с исключением — это PreDispose, возобновляющий выполнение после операции await this с выбросом исключения ObjectDisposedException. Его код после изменения выглядит так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        protected override void PreDispose()\n        {\n            base.PreDispose();\n            EnqueueAwaitContinuationForRunning(ExceptionDispatchInfo.Capture(new ObjectDisposedException(DisposedObjectName())));\n        }\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EВ общем, я попробовал, как можно было реализовать ту же логику метода FetchRequiredAsync, используя выброс исключения в await this. И для полноты я привожу этот вариант здесь, в статье. Но в рабочем коде библиотеки я существующую реализацию менять не стал, ибо \"не сломалось — не чини\".\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EМожно подумать, что await всё же выбрасывает исключение в этом, основном, варианте, потому что в методе Schedule в одном месте выбрасывается исключение InvalidOperationException. Но в операцию await это исключение не попадает — оно возникает в потоке, в котором выброшенное исключение вообще не обрабатывается, что приводит к завершению всего приложения. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EТак сделано специально.\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EЭто исключение играет роль плавкого предохранителя \"на всякий случай\". Проверка на то, что метод FetchRequiredAsync экземпляра не вызывается параллельно с другим вызовом, реально производится в доступном приложениям публичном методе родительского класса, вызывающего обсуждаемый метод (и если такое обнаруживается, приложение об этом уведомляется). Поэтому ситуация параллельного вызова метода FetchRequiredAsync, из приложения напрямую недоступного, может возникнуть только вследствие внутренней ошибки библиотеки, а в таком случае прекращение работы процесса IMHO оправдано.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EА можно ли это исключение вернуть коду, вызвавшему лишний FetchRequiredAsync?\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EТехнически — да, конечно. И в своих экспериментах с кодом библиотеки я это \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmvvrus\u002FActiveSession\u002Fblob\u002FPass_out-of-order_exception\u002FMVVrus.AspNetCore.ActiveSession\u002FStdRunner\u002FEnumAdapterRunner.cs\" rel=\"nofollow noopener noreferrer\"\u003Eдаже сделал\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\nВ обработчике этого исключения в методе Schedule вместо повторного выброса этого исключения оператором throw можно запустить выполнение продолжения в другом потоке через специально предназначенный для этого метод RunContinuationWithException.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void Schedule(Action continuation)\n        {\n            \u002F\u002F...\n            try\n            {\n                \u002F\u002F...\n            }\n            catch(Exception e)\n            {\n                \u002F\u002FDo not re-throw the exception here, instead pass it to the continuation\n                ExceptionDispatchInfo exception_info = ExceptionDispatchInfo.Capture(e);\n                ThreadPool.UnsafeQueueUserWorkItem(RunContinuationWithException, (Continuation, exception_info), false);\n            }\n            \u002F\u002F...\n        }\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EМетод RunContinuationWithException выглядит следующим образом:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void RunContinuationWithException((Action Continuation, ExceptionDispatchInfo? Error) State)\n        {\n            _exceptionPassed.Value=State.Error;\n            _complete_event.Set();\n            State.Continuation();\n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EОн, так же, как и метод RunAwaitContinuation устанавливает событие, которое потенциально ожидает (на самом деле, этого никогла не происходит) метод GetResult(), сохраняет для метода GetResult() информацию об исключении и вызывает делегат продолжения. Информацию об исключении надо сохранить, потому что, как мы помним из предыдущего примера про выброс исключения операцией await (он — в скрытом тексте выше), его следует выбрасывать в методе GetResult. Но, в отличие от предыдущего примера, здесь нельзя просто взять и использовать для передачи информации об исключении какое-либо поле экземпляра обсуждаемого класса: поля экземпляра предназначены для await в нормальном (т.е. первом) вызове FetchRequiredAsync. Но выход есть: информация об исключении сохраняется в локальном для потока поле экземпляра:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        ThreadLocal&lt;ExceptionDispatchInfo?&gt; _exceptionPassed=new ThreadLocal&lt;ExceptionDispatchInfo?&gt;();\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EТак делать можно, потому что метод GetResult гарантированно будет выполнен (делегатом продолжения) в том же потоке. Ну, а в методе GetResult() проверяется, что исключение было передано, и, если так, — выбрасывается заново:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E        void GetResult() { \n            _complete_event.Wait(); \n            if(_exceptionPassed.Value is not null) _exceptionPassed.Value.Throw(); \n        }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EКороче, технически можно вместо прекращения работы приложения вызвать в данном случае ислючение в вызывающем коде, который сможет это исключение обрабоать. Однако, подумав, я решил оставить это исключение необработанным, потому что приложение, которое использует библиотеку, мало что может сделать с тем, что в коде библиотеки содержится ошибка.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"mozhno-li-bylo-sdelat-to-zhe-samoe-shtatnym-obrazom\"\u003EМожно ли было сделать то же самое штатным образом?\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EКонечно. Иначе эта статья не была бы опубликована в хабе \"Ненормальное программирование\". Проще всего было бы использовать await с Task в качестве ожидаемого. Тут сразу напрашивается использование объекта типа TaskCompletionSource с ожиданием на его поле Task и вызовом соответствующих методов завершения (SetCompletion или SetException) там, где ожидание нужно завершить: из фонового метода перечисления или из методов DoAbort и PreDispose. Такой вариант реализуется несложно и он вполне совместим с любой версией .NET, вообще поддерживающей async\u002Fawait. Но он имеет тот недостаток, что требует создавать объект в куче для каждого ожидания — т.е., нагружает сборщик мусора. Поэтому при изначальном написании варианта обсуждаемого класса я от него отказался: await this экономит на создании лишнего объекта в куче.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EНо в современном .NET можно использовать в качестве ожидаемого структуру ValueTask, создаваемую на базе реализации интерфейса IValueTaskSource с помощью вспомогательного класса (точнее, структуры) ManualResetValueTaskSourceCore. Такая реализация тоже позволяет избежать лишних размещений объектов в куче, а потому является рекомендуемой для применения(хотя и совершенно безобразно для целей такого применения документированной). \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EОднако когда изначально писался код, обсуждаемый в статье, я ориентировался на совместимость с .NET Framework (причем — не самых новых версий) — в котором поддержка этого варианта появилась достаточно поздно и была добавлена через пакеты, а в базовую поставку не входила. Потому код был написан так, как написан, ну а дальше — как всегда: \"не сломалось — не чини\". Впрочем, реализацию на базе ValueTask я тоже сделал, для себя. Но, вообще-то, это уже не тема для статьи из хаба \"Ненормальное программирование\". Да и статья, в которой был реализован ValueTask с использованием ManualResetValueTaskSourceCore на Хабре уже публиковалась, как минимум, \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F746934\u002F\"\u003Eодна\u003C\u002Fa\u003E. Однако если в комментариях будет проявлен интерес, я эту реализацию, так или иначе, выложу для публики. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Ch2 id=\"zaklyuchenie\"\u003EЗаключение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EВ наше время, наверное не стоит использовать код из статьи как образец для новых разработок. Но вот как забавный пример реализации ожидаемого для использования с операцией await он, по моему мнению, вполне годится. А ещё этот код иллюстрирует, как вообще делать свою реализацию ожидаемого. Потому-то я и написал эту статью.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\n\u003Cp\u003EP.S. Здесь должна быть ссылка на мой телеграмм-канал — но у меня нет телеграмм-канала. Поэтому желающим читать меня придётся делать это на Хабре.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"async-await"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffh\u002Fop\u002F0m\u002Ffhop0mhc816xvqn_vluulrkhufi.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffh\u002Fop\u002F0m\u002Ffhop0mhc816xvqn_vluulrkhufi.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Farticles\\\u002F906790\\\u002F\"},\"headline\":\"Сам себе awaiter\",\"datePublished\":\"2025-05-06T01:38:00+03:00\",\"dateModified\":\"2025-05-07T01:23:21+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Валерий\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Сам себе awaiter  Здравствуйте. Меня зовут Валерий и я  &mdash; кодоголиклюблю писать программы. И иногда в процессе написания программ сами собой возникают интересные...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Farticles\\\u002F906790\\\u002F#post-content-body\",\"about\":[\"h_net\",\"h_csharp\",\"h_crazydev\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F906790\\\u002Fc5b2af6b2c884ed7aa077f0459d21b26\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ffh\\\u002Fop\\\u002F0m\\\u002Ffhop0mhc816xvqn_vluulrkhufi.png\"]}","metaDescription":"Сам себе awaiter Здравствуйте. Меня зовут Валерий и я — кодоголик люблю писать программы. И иногда в процессе написания программ сами собой возникают интересные истории. Об одной такой история я и...","mainImageUrl":null,"amp":false,"customTrackerLinks":[]},"polls":[],"commentsEnabled":{"status":true,"reason":null},"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"hasPinnedComments":false,"format":"case","banner":null,"multiwidget":null,"multiwidgetUuid":null,"readingTime":18,"complexity":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"postReasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"viewedPosts":[],"myFeedFilter":{"complexity":"all","score":"all","types":["articles","posts","news"]},"myFeedIsApplyFilters":false,"myFeedIsForce":false,"karma":{"userReasonsList":null}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[{"title":"Программист C# удаленно","vacanciesCount":62,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fprogrammist_c_sharp","itemHubs":["csharp"]},{"title":".NET разработчик","vacanciesCount":44,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fnet_developer","itemHubs":["net"]}],"hubs":"net,csharp,crazydev"},"comments":{"articleComments":{},"articlePinnedComments":{},"searchCommentsResults":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":"","idempotenceKey":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"multiwidgets":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"multiwidgetLoading":false,"vacancies":{},"companiesGalleries":{},"companiesBanners":{},"companiesLandingVacancies":{},"companiesTechnologies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null,"jivoStatus":0,"adminNotifications":null,"availableInvitesCount":{}},"companyAdd":{"currentStep":"","stepsData":{},"uncompletedSteps":[],"isStepLoading":true,"isStepCommitting":false,"isInitialized":false,"agreementContent":""},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"pagesCount":0},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":true},"fixedBanner":{"isArticleStickyPanelVisible":false,"isArticleStickyPanelAtTheBottom":false,"isFixedBannerVisible":false,"isStickyPanelIconsHidden":false},"flows":{"updates":{}},"global":{"isPwa":false,"device":"desktop","isHabrCom":true,"requestId":"18c1f33158bfd110d51b98da74603e20"},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"welcomePage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"query":{},"pathname":"\u002Fru\u002Farticles\u002F906790\u002F","path":"\u002Fru\u002Farticles\u002F906790\u002F","href":"\u002Fru\u002Farticles\u002F906790\u002F"}},"me":{"user":null,"uuid":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null,"userUpdates":{"feeds":{"newPostsCount":null,"newThreadsCount":null,"newNewsCount":null,"newCount":null},"conversationUnreadCount":0},"features":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"onboarding":{"currentStep":null,"stepsData":{},"stepsErrors":{},"completedSteps":[],"isStepCommitting":false,"isCommitDisabled":true},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{"questions":"project-block-article"}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null,"sticker":null},"publicationStatistics":{"statsInfo":{},"statsFunnels":{},"statsGraph":{},"defaultSuggest":{},"suggest":{},"timeTracker":{},"isTrackingActivity":false,"isUserActive":true,"otherPublicationStats":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":true,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"stories":{"stories":null},"technotext":{"years":[],"technotextDocForNominees":null,"technotextDocForWinners":null,"technotextInfo":{},"technotextInfoLoading":false,"technotextWinners":{},"technotextWinnersLoading":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"userVotes":{"karmaVotesList":[],"karmaVotesPagesCount":null,"karmaVotesListLoading":false,"commentsVotesList":[],"commentsVotesPagesCount":null,"commentsVotesListLoading":false,"postsVotesList":[],"postsVotesPagesCount":null,"postsVotesListLoading":false,"userVotesList":[],"userVotesPagesCount":null,"userVotesListLoading":false},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"notificationsLoading":false,"notificationsList":[],"notificationsPageCount":0,"pendingMarkNotificationsRead":[],"publicationsLoading":true,"publicationsList":[],"publicationsPageCount":0,"pendingDeletePublications":false,"pendingMarkPublicationsRead":false},"events":{"eventRefs":{},"eventIds":[],"pagesCount":0,"categories":[],"cities":[],"actualEvents":null,"currentEvent":null,"eventsFilter":{"city":"all","timeStarted":null,"timeEnded":null}},"wysiwyg":{"WYSIWYGRulesRefs":null},"refs":{"specializationRefs":[]},"hint":{"hints":{}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
   <script src="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" defer></script>
   <script src="https://assets.habr.com/habr-web/js/app.58b8c457.js" defer></script>
  </div>
  <div id="overlays">
   <!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor-->
  </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S28W1WC23F"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    </script>
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  </script>
  <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
 </body>
</html>