<!doctype html>
<html lang="ru">
 <head>
  <title>Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется? / Хабр</title>
  <meta property="fb:app_id" content="444736788986613">
  <meta property="fb:pages" content="472597926099084">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@habr_com">
  <meta property="og:site_name" content="Хабр">
  <link href="https://habr.com/ru/rss/post/907262/?fl=ru" type="application/rss+xml" title rel="alternate" name="rss">
  <link href="https://habr.com/ru/companies/rtk_service/articles/907262/" rel="canonical" data-hid="e3fa780">
  <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg" data-hid="2a79c45">
  <link rel="amphtml" href="https://habr.com/ru/amp/publications/907262/">
  <meta property="og:title" content="Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?">
  <meta name="twitter:title" content="Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?">
  <meta name="aiturec:title" content="Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?">
  <meta name="description" content="Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась с...">
  <meta itemprop="description" content="Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась с...">
  <meta property="og:description" content="Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась с...">
  <meta name="twitter:description" content="Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась с...">
  <meta property="aiturec:description" content="Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась с...">
  <meta itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg">
  <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg">
  <meta name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg">
  <meta property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg?format=vk">
  <meta property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/4d1/4d4/a8d/4d14d4a8d686a6e7a9e642d1b3844714.jpg?format=vk">
  <meta property="aiturec:item_id" content="907262">
  <meta property="aiturec:datetime" content="2025-05-06T09:05:41.000Z">
  <meta content="https://habr.com/ru/companies/rtk_service/articles/907262/" property="og:url">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="ru_RU">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="keywords" content="lte tdd, qos, ptpv2, isis, базовые станции, телеком, телекоммуникационное оборудование, сетевая инфраструктура, сетевое администрирование, сетевое программирование">
  <script type="application/ld+json" data-hid="1e0f0a2">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/companies\/rtk_service\/articles\/907262\/"},"headline":"Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?","datePublished":"2025-05-06T12:05:41+03:00","dateModified":"2025-05-07T00:31:53+03:00","author":{"@type":"Person","name":"Denis_Vdovin"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось расск...","url":"https:\/\/habr.com\/ru\/companies\/rtk_service\/articles\/907262\/#post-content-body","about":["c_rtk_service","h_tdd","h_network_hardware","h_network_technologies","h_sys_admin","f_develop","f_admin","f_popsci"],"image":["https:\/\/habr.com\/share\/publication\/907262\/d01a7775bf64f3fb7f70daa76fe0651b\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/824\/e44\/989\/824e44989117fd1fa43106402d5d0e7e.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/d68\/20d\/c7c\/d6820dc7c216e1684b4eb38781f91d68.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/35c\/202\/7a9\/35c2027a96be852b5b44139b0e28f3e0.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/dd8\/845\/5c8\/dd88455c8f2824d034e2a5cb4922bfaa.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e4a\/ef5\/8d4\/e4aef58d49873335bb02936a8a28a93a.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/8c2\/46a\/636\/8c246a6363c39a4d1c33f571e888f20b.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/79a\/38d\/926\/79a38d92692c8985ff8736205143b6e6.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/816\/522\/c15\/816522c15da1e6fe1b2420dbfe03e55e.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/6fd\/158\/662\/6fd1586622e52aee469fecb188bf2661.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/23d\/e71\/3c5\/23de713c5659465259a68cb89a3a422c.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/957\/54f\/462\/95754f462fe9926ea4a103dac4f824cf.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/af1\/76c\/ee7\/af176cee7a05d938e0a61d559fb9bc47.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f36\/b14\/f79\/f36b14f7922436fc9a91869276a744f3.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f53\/ec7\/165\/f53ec7165bb173c9a1cdf04981e2f35c.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e6d\/5c0\/e8f\/e6d5c0e8fe32ba3627fba7ca531d7d4b.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/52d\/c73\/b2f\/52dc73b2fb5554436640a8ead402bf89.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/55f\/b7b\/12a\/55fb7b12ae53814928b561a48ef4c110.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/1b4\/3cd\/c3d\/1b43cdc3d4e63afed09339997f1e39bc.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/694\/f2e\/544\/694f2e54431d5a8582082b7f718b9828.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/2f5\/077\/0bb\/2f50770bbc93f2638de57c1d5d30c154.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/7e7\/d25\/b28\/7e7d25b280994f9aa4dd94d68267711f.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a6a\/ced\/330\/a6aced330a335ae06738561f103fe267.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f9a\/a9b\/746\/f9aa9b746ad76b46e18302cd616e7c99.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/632\/d84\/651\/632d84651511335f71de8c9261851ed6.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/43b\/99d\/f20\/43b99df203b5518eb3b445ecfd70568a.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e1a\/f5b\/8fb\/e1af5b8fba0196353706c0b4d52544c2.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/459\/96b\/05f\/45996b05ff21cdf6181fe1a8e8960ce1.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/cb3\/1e4\/73b\/cb31e473bfdb9ac72a7c98e19f7b175f.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f3f\/7a8\/123\/f3f7a81231a2b1d218ec7ea1f92a7e00.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a22\/761\/c81\/a22761c813e19f750e4153a3dba1c43c.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b22\/135\/c4b\/b22135c4b3e95fb1290e178ce2723951.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c49\/093\/5c4\/c490935c42333a5eae6d357fae09db69.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/d7d\/985\/956\/d7d9859562932d54873879b817ec696c.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fe3\/2ee\/859\/fe32ee859712befad50182933467e92f.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3de\/244\/ad8\/3de244ad8b18a41d82716467a66c230f.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c4e\/507\/dda\/c4e507ddad05a3d5826bb37dedecccc5.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/2b8\/d24\/03f\/2b8d2403f3b0e5da5a89c4878b81998b.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f3f\/385\/017\/f3f3850179fde52eed6abe1d2d8dcf1c.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b05\/eeb\/f22\/b05eebf2218ecadf1bbda31e94209bae.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e20\/701\/386\/e2070138638f1c866a6a389a878477ac.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f90\/31e\/e4c\/f9031ee4c45b16aa41692684d36da3a8.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/cbe\/ebd\/744\/cbeebd74499b93204738a13cf2325687.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/272\/944\/da9\/272944da9d97beabd9a9f5a08c5867a7.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/8b0\/606\/c5f\/8b0606c5f1e34a55d4567038de09b4ba.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/7a4\/b05\/de2\/7a4b05de28ddb02ad907084d0cba3cd2.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/07c\/345\/cf6\/07c345cf6d65d641327ae8a798f3a425.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/28e\/4f8\/1f2\/28e4f81f25fd26b7b483582185edc499.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/1e2\/33b\/e65\/1e233be653c0e8afd903b1f5a26f4d4d.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c3d\/3ef\/fc7\/c3d3effc7e763a751d5f0952b0b78714.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/dd1\/c1c\/fcc\/dd1c1cfcc3a00717e1245eb5436781c8.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/874\/997\/49a\/87499749a3e627e44bdf8869c986c6a3.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/0a6\/491\/31d\/0a649131dd0315188b7915c3706011b3.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/125\/3bf\/f14\/1253bff14d5475f0307871a0e9f6cec7.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/4d1\/4d4\/a8d\/4d14d4a8d686a6e7a9e642d1b3844714.jpg"]}</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1,user-scalable=0">
  <meta name="referrer" content="unsafe-url">
  <style>
      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmojLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvk4jLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmYjLazX3dGTP.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvl4jLazX3dA.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSxf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveQhf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSBf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveRhf6Xl7Glw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* cyrillic-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSxf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
      }

      /* cyrillic */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eQhf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
      }

      /* latin-ext */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSBf6Xl7Gl3LX.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }

      /* latin */
      @font-face {
        font-family: 'Fira Sans';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eRhf6Xl7Glw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" as="style" media="(prefers-color-scheme: light)">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" as="style" media="(prefers-color-scheme: dark)">
  <link id="light-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" media="(prefers-color-scheme: light)">
  <link id="dark-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" media="(prefers-color-scheme: dark)">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.635b6c39236ebd33fa716c71ab0131a0.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  <style>
      .grecaptcha-badge {
        visibility: hidden;
      }
    </style>
  <meta name="habr-version" content="2.241.0">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png">
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png">
  <link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png">
  <link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png">
  <link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" type="image/png" sizes="256x256" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png">
  <link rel="mask-icon" color="#77a2b6" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg">
  <link crossorigin="use-credentials" href="/manifest.webmanifest" rel="manifest">
  <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script>
  <script>window.yaContextCb = window.yaContextCb || []</script>
  <script src="https://yandex.ru/ads/system/context.js" async></script>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" as="script">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/app.8599692f.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/app.58b8c457.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.8599692f.css">
 </head>
 <body>
  <div id="mount">
   <div id="app">
    <div class="tm-layout__wrapper">
     <!--[--><!---->
     <div></div><!---->
     <header class="tm-header" data-test-id="header">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-header__container">
        <!----><span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_hl-ru tm-header__logo" href="/ru/">
          <svg class="tm-svg-img tm-header__icon" height="16" width="16">
           <title>
            Хабр
           </title><use xlink:href="/img/habr-logo-ru.svg#logo"></use>
          </svg></a><span style="display:none;" class="tm-header__beta-sign">β</span></span><!--[-->
        <div class="tm-dropdown tm-header__projects">
         <div class="tm-dropdown__head">
          <!--[-->
          <button class="tm-header__dropdown-toggle">
           <svg class="tm-svg-img tm-header__icon tm-header__icon_dropdown" height="16" width="16">
            <title>
             Открыть список
            </title><use xlink:href="/img/megazord-v28.7909a852..svg#arrow-down"></use>
           </svg></button><!--]-->
         </div><!---->
        </div><a href="/ru/sandbox/start/" class="tm-header__become-author-btn">Как стать автором</a>
        <div class="tm-feature tm-feature tm-feature_variant-inline tm-header__feature">
         <!---->
        </div><!----><!--]--><!---->
       </div><!--]-->
      </div>
     </header>
     <div class="tm-layout">
      <div class="tm-page-progress-bar"></div>
      <div class="tm-base-layout__header_is-sticky tm-base-layout__header" data-menu-sticky="true">
       <div class="tm-page-width">
        <!--[-->
        <div class="tm-base-layout__header-wrapper">
         <div class="tm-main-menu">
          <div class="tm-main-menu__section">
           <nav class="tm-main-menu__section-content">
            <!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/feed/">Моя лента</a><!--]--><!--[--><a class="tm-main-menu__item" href="/ru/articles/">Все потоки</a><!--]--><!--[--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/develop/">Разработка</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/admin/">Администрирование</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/design/">Дизайн</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/management/">Менеджмент</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/marketing/">Маркетинг</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/popsci/">Научпоп</a><!--]--><!--]-->
           </nav>
          </div>
         </div>
         <div class="tm-header-user-menu tm-base-layout__user-menu">
          <a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search" data-test-id="search-button">
           <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark" height="24" width="24">
            <title>
             Поиск
            </title><use xlink:href="/img/megazord-v28.7909a852..svg#search"></use>
           </svg></a><!----><!---->
          <div class="tm-header-user-menu__item tm-header-user-menu__write">
           <div>
            <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_write tm-header-user-menu__icon_dark" height="24" width="24">
             <title>
              Написать публикацию
             </title><use xlink:href="/img/megazord-v28.7909a852..svg#write"></use>
            </svg>
           </div><!---->
          </div><!--[-->
          <div class="tm-header-user-menu__item">
           <button class="tm-header-user-menu__toggle" data-test-id="user-menu-settings">
            <svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_dark" height="24" width="24">
             <title>
              Настройки
             </title><use xlink:href="/img/megazord-v28.7909a852..svg#page-settings"></use>
            </svg></button>
          </div><a href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/companies/rtk_service/articles/907262/&amp;hl=ru" rel="nofollow" class="tm-header-user-menu__item"><!--[-->
           <button class="btn btn_solid btn_small tm-header-user-menu__login" type="button"><!--[-->Войти<!--]--></button><!--]--></a><!--]--><!----><!--teleport start--><!--teleport end--><!---->
         </div>
        </div><!--]-->
       </div>
      </div><!---->
      <div class="tm-page-width">
       <!--[--><!--]-->
      </div>
      <main class="tm-layout__container">
       <div class="tm-page" hl="ru" companyname="rtk_service" data-async-called="true" style="--5ab2e5a8:16px;--44c4f6f6:100%;--45ba7a3b:0;">
        <div class="tm-page-width">
         <!--[-->
         <div class="tm-page__header">
          <!--[-->
          <div class="tm-company-card__branding tm-company-card__branding_loading tm-company-article__branding" data-test-id="company-card-branding">
           <div class="tm-company-card__branding-placeholder">
            <!---->
           </div><a href="https://www.rtk-service.ru/about/?utm_source=habr&amp;utm_medium=oblozhka&amp;utm_campaign=o_kompanii"><img class="tm-company-card__branding-image" src="//habrastorage.org/getpro/habr/branding/3d9/71a/ad8/3d971aad80c9b24e73923683f499f56f.jpg"></a>
          </div><!--]-->
         </div>
         <div class="tm-page__wrapper">
          <div class="tm-page__main_has-sidebar tm-page__main">
           <div class="pull-down">
            <!---->
            <div class="pull-down__header" style="height:0px;">
             <div class="pull-down__content" style="bottom:10px;">
              <svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24">
               <title>
                Обновить
               </title><use xlink:href="/img/megazord-v28.7909a852..svg#pull-arrow"></use>
              </svg>
             </div>
            </div><!--[--><!--[-->
            <div class="tm-article-presenter">
             <!--[--><!--[--><!---->
             <div class="tm-company-profile-card tm-company-article__profile-card">
              <div class="tm-company-card tm-company-profile-card__info">
               <div class="tm-company-card__header">
                <a href="/ru/companies/rtk_service/profile/" class="tm-company-card__avatar">
                 <div class="tm-entity-image">
                  <img alt="" class="tm-entity-image__pic" height="48" src="//habrastorage.org/getpro/habr/company/c54/0b3/20b/c540b320b21dcbd5c351f5dd831afca9.jpg" width="48">
                 </div></a><!--[--><!---->
                <div class="tm-counter-container tm-company-card__rating">
                 <div class="tm-counter-container__header">
                  <!--[--><!--[--><!--]-->
                  <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating">
                   <!---->
                   <div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score">
                    <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">48.85</span></span><!--]-->
                   </div><!---->
                  </div><!--]-->
                 </div>
                 <div class="tm-counter-container__footer">
                  <!--[--><span class="tm-rating__text tm-rating__text">Рейтинг</span><!--]-->
                 </div>
                </div><!----><!--]-->
               </div>
               <div class="tm-company-card__info">
                <a href="/ru/companies/rtk_service/profile/" class="tm-company-card__name"><span>РТК-Сервис</span></a><!---->
               </div>
              </div>
              <div class="tm-company-profile-card__buttons">
               <div class="tm-button-follow tm-company-profile-card__button tm-company-profile-card__button_follow">
                <!---->
                <button class="tm-button-follow__button tm-button-follow__button_big" data-test-id="follow-button" type="button">Подписаться</button>
               </div><!----><!----><!---->
              </div>
             </div><!----><!--]--><!--]-->
             <div class="tm-article-presenter__body" data-test-id="article-body">
              <div class="tm-misprint-area">
               <div class="tm-misprint-area__wrapper">
                <!--[-->
                <article class="tm-article-presenter__content tm-article-presenter__content_narrow">
                 <!--[-->
                 <div class="tm-article-presenter__header">
                  <!--[--><!--]-->
                  <div class="tm-article-snippet tm-article-snippet tm-article-presenter__snippet">
                   <!--[--><!--]-->
                   <div class="tm-article-snippet__meta-container">
                    <div class="tm-article-snippet__meta">
                     <span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Denis_Vdovin/" class="tm-user-info__userpic" data-test-id="user-info-pic" title="Denis_Vdovin">
                       <div class="tm-entity-image">
                        <!--[--><img alt="" class="tm-entity-image__pic" height="24" src="https://assets.habr.com/habr-web/img/avatars/025.png" width="24"><!--]-->
                       </div></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/Denis_Vdovin/" class="tm-user-info__username">Denis_Vdovin <!----></a><!--[--><span class="tm-article-datetime-published"><time datetime="2025-05-06T09:05:41.000Z" title="2025-05-06, 12:05">21 час назад</time></span><!--]--></span></span>
                    </div><!---->
                   </div>
                   <h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle"><span>Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?</span></h1>
                   <div class="tm-article-snippet__stats" data-test-id="articleStats">
                    <!---->
                    <div class="tm-article-reading-time">
                     <span class="tm-svg-icon__wrapper tm-article-reading-time__icon">
                      <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                       <title>
                        Время на прочтение
                       </title><use xlink:href="/img/megazord-v28.7909a852..svg#clock"></use>
                      </svg></span><span class="tm-article-reading-time__label">46 мин</span>
                    </div><span class="tm-icon-counter tm-data-icons__item">
                     <svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24">
                      <title>
                       Количество просмотров
                      </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-views"></use>
                     </svg><span class="tm-icon-counter__value" title="1111">1.1K</span></span>
                   </div>
                   <div class="tm-publication-hubs__container" data-test-id="articleHubsList">
                    <div class="tm-publication-hubs">
                     <!--[--><span class="tm-publication-hub__link-container"><a href="/ru/companies/rtk_service/articles/" class="tm-publication-hub__link"><!--[--><span>Блог компании РТК-Сервис</span><!----><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/tdd/" class="tm-publication-hub__link"><!--[--><span>TDD</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/network_hardware/" class="tm-publication-hub__link"><!--[--><span>Сетевое оборудование</span><!----><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/network_technologies/" class="tm-publication-hub__link"><!--[--><span>Сетевые технологии</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/sys_admin/" class="tm-publication-hub__link"><!--[--><span>Системное администрирование</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><!--]-->
                    </div>
                   </div>
                   <div class="tm-article-labels" data-test-id="articleLabels">
                    <div class="tm-article-labels__container">
                     <div class="tm-publication-label tm-publication-label_variant-review">
                      <span>Обзор</span>
                     </div><!--[--><!--]-->
                    </div>
                   </div><!----><!---->
                  </div>
                 </div><!--[--><!---->
                 <div class="tm-article-body" data-gallery-root lang="ru">
                  <div>
                   <!--[--><!--]-->
                  </div>
                  <div id="post-content-body">
                   <div>
                    <div class="article-formatted-body article-formatted-body article-formatted-body_version-2">
                     <div xmlns="http://www.w3.org/1999/xhtml">
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/824/e44/989/824e44989117fd1fa43106402d5d0e7e.jpg" width="1018" height="739" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/824/e44/989/824e44989117fd1fa43106402d5d0e7e.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/824/e44/989/824e44989117fd1fa43106402d5d0e7e.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Всем привет! Меня зовут <s>я сам прихожу</s> Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась <s>с салата </s>еще в зимние каникулы. В ней в разных пропорциях смешались ISIS, QoS, загадочный PTPv2, распределение Пуассона, теория массового обслуживания и LTE TDD, отчего она показалась мне крайне интересна и достойна публикации отдельной статьей.</p>
                      <p>Сей трактат, направленный на решение конкретной прикладной проблемы, будет довольно длинным и с каждым листом А4 сложность для понимания будет нарастать. Затрагиваются, казалось бы, совсем далекие друг от друга галактики, поэтому если вы где-то не смогли уследить за руками факира — это норма. Главное, что в конце вас ждет награда - мы научимся вычислять джиттер на обычном калькуляторе по графикам из Заббикса. Поехали.</p>
                      <p>К исходу десятого дня новогодних праздников, когда оливьешка, к слову, уже далеко не первой свежести, методично доламывала остатки нейронных связей в мозгу, замещая собой серое вещество, откуда-то из недр памяти всплыли мимолетом сказанные пару месяцев назад заказчиком слова, что у них есть сотни секторов БС LTE TDD и они не работают. Надо сказать, что на сетях заказчиков мы выполняем полный комплекс настроечных и монтажных работ: пишем HLD и LLD, готовим спецификации, монтируем и кроссируем, после чего долго и упорно, нажимая кнопки, претворяем в жизнь идеи, заложенные в дизайне. Короче, делаем сеть высокой культуры и быта «под ключ». И вот подумалось, это как это так, когда мы после нескольких десятков бессонных ночей уже почти закончили приведение сети из сотен маршрутизаторов к целевому дизайну, у нас там нестареющий MPLS, всякие FRR (которые FastReRoute), куда ж без него - BGP, на подходе сложнейший QoS, а какое-то там LTE не работает? Да что оно себе позволяет? И закипела кровь от такой несправедливости!</p>
                      <h2>Что за зверь LTE TDD?</h2>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/d68/20d/c7c/d6820dc7c216e1684b4eb38781f91d68.jpg" width="803" height="609" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/d68/20d/c7c/d6820dc7c216e1684b4eb38781f91d68.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/d68/20d/c7c/d6820dc7c216e1684b4eb38781f91d68.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Как говорится, чтобы починить что-то неработающее, надо <s>случайно сломать что-то работающее</s> понять, что ж там конкретно не работает и к какому снаряду мы вообще подходим. Перво-наперво проведенный опрос свидетелей показал, что проблема действительно существует в заявленном виде. У заказчика (оператора фиксированной и мобильной связи) есть базовые станции разных поколений: 2G, 3G, 4G (LTE), которые связаны с контроллерами через таким трудом перенастраиваемую нами сеть MPLS (т.&nbsp;н. MBH – Mobile Backhaul – модненькое название обычной сети, по которой гоняются сервисы мобильной сети). В целом как бы все работает, но вот для предоставления 4G используется две технологии: LTE FDD и LTE TDD. С первой все хорошо, а со второй не очень. Точнее очень нехорошо. При включении базовой станции (БС) в системе управления вываливаются аварии о потере синхронизации, а на соседних БС (в т.ч. FDD) начинаются какие-то проблемы, из-за чего даже принято решение вывести сектора из эфира (а это, на минуточку, когда-то были миллионы инвестиций). Оказывается, базовые станции TDD, например, существенно дешевле своих FDDшных собратьев, но более требовательны к качеству синхронизации (это нам пока вообще ни о чем не говорит). Лучше всего синхронизируют системы спутникового позиционирования GPS/ГЛОНАСС/Baidu. Когда это дело закупалось, что GPS, что ГЛОНАСС были безлимитными и чем-то совершенно естественным и доступным в любом месте страны, как воздух, солнце и вода. Но в 2022 году средствами РЭБ сигнал был много где (но не везде) заглушен, и на бОльшей части БС LTE TDD праздник мобильного интернета закончился. И уже почти три года бОльшая часть секторов греют воздух, вместо того чтобы радовать абонентов видосиками и мемасиками, потому что на альтернативном источнике PTPv2 оно не заработало. Видимо, куда-то сюда и надо будет копать.</p>
                      <p>С предысторией немного разобрались, пора понять, что это за технологии.</p>
                      <p>Предупреждение: читателям из мобильного мира и просто с тонкой душевной организацией просьба закрыть глаза на следующие пару абзацев, чтобы ваши чувства случайно не были оскорблены неточностью терминологии или некорректным описанием принципов. Для выстраивания общей картины сказать несколько слов про ваши технологии так и так придется, не обессудьте.</p>
                      <p><strong>LTE FDD</strong> – Frequency Division Duplex – частотное разделение.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/35c/202/7a9/35c2027a96be852b5b44139b0e28f3e0.jpg" width="222" height="212" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/35c/202/7a9/35c2027a96be852b5b44139b0e28f3e0.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/35c/202/7a9/35c2027a96be852b5b44139b0e28f3e0.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>За каждым оператором специальным органом ГКРЧ (Государственная комиссия по радиочастотам) по результатам гладиаторских боев (в формате все против всех, а нынче у кого толще кошелек) в каждом регионе присутствия закрепляется (или не закрепляется) некий спектр частот (для простоты — несущих). Правило простое: чем спектр шире, тем быстрее будет загружаться рутуб, тем счастливее будут абоненты. Поэтому за частоты борьба идет не на жизнь, а насмерть. А с трибуны за этим действом наблюдают военные, которые знают, что частота все равно останется у них :-)). Downlink и Uplink разнесены по разным частотам. Т.е. вместо одной на базу нужно две.&nbsp;</p>
                      <p>Чтобы было понятнее, что за страшное испытание выпало на долю коллег из мобильного мира — это сродни тому, как в пакетных сетях получить новый блок IPv4. Если не получилось (а это не получилось), то в ход идут NAT, CG-NAT, NAToverNAT, а от безысходности и IPv6. И вот, несчастные операторы сотовой связи, жонглируя этими немногочисленными несущими, пытаются с одной стороны выжать максимум с одной БС, а с другой – размазать диапазон на весь город, чтобы одна БС не мешала другой (условно говоря, БС на одной частоте должны светить в разные стороны или находиться в разных частях города). И эти частоты нужно изолировать друг друга промежутками, а это неэффективное использование ценного ресурса. А ведь еще кто-то нехороший залазит на твою частоту. А еще используются очень сложные технологии кодирования и мультиплексирования типа OFDM, из-за чего оборудование существенно дороже (правда, скорости и дальность чудо как хороши). В ход идут разные ухищрения: рефарминг (перераспределение частот между технологиями), запуск VoLTE, отключение 3G, MVNO и т.&nbsp;д. Ужас-ужас, в общем, как сложно, поэтому у каждого оператора есть большие отделы ПиО (планирование и оптимизация), которые в эти шахматы на ежедневной основе вынуждены играть без перерывов на выходные и обед. Так или иначе, технология FDD доминирует в мире LTE, на ней построено большинство сетей.</p>
                      <p>Как водится, есть второй способ подойти к снаряду: <strong>LTE TDD</strong> – Time Division Duplex – временное разделение.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/dd8/845/5c8/dd88455c8f2824d034e2a5cb4922bfaa.jpg" width="507" height="490" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/dd8/845/5c8/dd88455c8f2824d034e2a5cb4922bfaa.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/dd8/845/5c8/dd88455c8f2824d034e2a5cb4922bfaa.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Downlink и Uplink работают на одной частоте, но под них выделяются разные временные промежутки (таймслоты), в зависимости от регулировки которых можно получать разное соотношение upload и download, не тратя драгоценную несущую (на картинке, кстати, полоса поделена 50/50). Технология использует более простые алгоритмы модуляции, оборудование стоит дешевле, пинги больше, а главное, не очень-то распространена из-за текущих ограничений по скорости, дальности и требований к точности синхронизации (чтобы это ни значило). Из-за этого желающих ее использовать не то, чтобы вагон, а скромная маленькая тележка, в которой, как оказалось, мы путешествуем вместе с заказчиком. Вероятно, со временем к этой технологии присмотрятся более пристально, т.к. там еще есть свободные частоты.</p>
                      <h2>Синхронизация — кто ты такое?</h2>
                      <p>Есть в нашем мире коммутаторов и маршрутизаторов несколько вещей, которые выбиваются из стройной пакетной парадигмы, как-то отторгаются, что ли, нашим ethernet-сознанием. На мой взгляд, это мультикаст во всех его проявлениях (кроме, может, MVPN), QoS и синхронизация (а в последнее время и BGP из-за приставки MP- становится все менее уютным и ламповым) — страшно далеки они от нашей повседневной жизни, наполненной ip и mpls-заголовками.</p>
                      <p>Так или иначе, но без синхронизации в мобильных (да и во многих других, например, энергетических, финансовых, военных) сетях — никуда. Последние 15 лет пакетный транспорт вытеснял-вытеснял, да так и недовытеснил TDM, но подвинул солидно. Для этого ему пришлось научиться в синхронизацию. Как говорилось выше, можно сделать дорого и красиво, просто прикрутив к каждому потребителю/маршрутизатору по GPS-модулю (дополнительное оборачивание в консервную банку для преодоления РЭБа не предлагать!), а можно попытаться передать синхронизацию через сеть. Ведь TDM-транспорт с этим как-то же справляется? Давайте и мы попробуем разобраться, что там у нас в пакетке было придумано.</p>
                      <p>Но сначала предлагаю узнать, что бы этакого можно было засинхронизировать, и зачем это надо. Фаза, время дня, частота, амплитуда. Все это хорошо понятно радиоинженерам и любителям электроники, а для тех, кто страшно далек от этих вещей, есть вот такой жизненный пример, который я подсмотрел на каком-то форуме. Значит, примерно за месяц-два до Парада на 9 Мая начинаются мероприятия по подготовке.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/e4a/ef5/8d4/e4aef58d49873335bb02936a8a28a93a.jpg" width="1200" height="800" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/e4a/ef5/8d4/e4aef58d49873335bb02936a8a28a93a.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/e4a/ef5/8d4/e4aef58d49873335bb02936a8a28a93a.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Задача, надо сказать, нетривиальная. Заставить несколько тысяч человек шагать в ногу. В чем тут проблема? Поначалу каждый, чувствуя в себе личность, еще не подавленную железной волей командира, норовит шагнуть в случайный момент времени. В словах «шагом марш» без учета многозначительной паузы набирается 9 букв. Кто на какую стартанет — неизвестно. Т.е. не выровнено абсолютное время старта. Далее — этот ниже, этот выше, этому сапог жмет — длина шага у всех будет разная (т.&nbsp;е. кто-то будет убегать вперед, а кто-то отставать — в итоге с фазой каждого следующего шага начинаются проблемы). Ну и усиливают трескучие боли в седой голове командира проблемы с частотой шага — этот спешит, этот вразвалочку. В итоге картина ежегодно за месяц до парада вырисовывается совершенно неприглядная, и на взгляд обывателя даже катастрофическая. Но в ходе нудных и трудных ежедневных тренировок производится синхронизация всех участников, как внутри парадных коробочек, так и между ними. Общее движение всей колонны начинается в одно и то же время, далее каждый шаг начинается у всех в одно время (фаза), с одинаковой длиной (амплитуда) и происходит с одной частотой. Надеюсь, стало понятнее.</p>
                      <p>Или вот дирижер машет палочкой. Это он не просто так делает, чтобы ему потом восторженные зрители в ладошки похлопали.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/8c2/46a/636/8c246a6363c39a4d1c33f571e888f20b.jpg" width="1216" height="832" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/8c2/46a/636/8c246a6363c39a4d1c33f571e888f20b.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/8c2/46a/636/8c246a6363c39a4d1c33f571e888f20b.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Перед глазами оркестрантов — только ноты, в которых указано, какие звуки надо извлечь из инструмента. Музыкантов в яму посажено много, они громкие и никого, кроме себя, как бы эгоистично ни было, не слышат, особенно кто дудит в духовые. А вот глядя на взмахи палочки дирижера (и его выразительно говорящие глаза), можно понять, насколько усердно и с какой частотой надо лупить по струнам. В итоге тромбон и арфа, сидящие в разных частях ямы, что называется, попадают в одни и те же ноты. Такой вот кожаный тактово-амплитудный синхронизатор. Так что, если вам понравилась музыка, то 50% успеха — на дирижере. И ест свой хлеб он не зря.</p>
                      <h2>Протоколы синхронизации в Ethernet и IP-сетях</h2>
                      <p>Итак, на текущий момент в ходу есть несколько протоколов синхронизации: NTP (и его отпрыск для локальных сетей SNTP), 1588v2 он же PTPv2, SyncE.</p>
                      <p>Синхру можно передать на разных уровнях модели OSI: физическом, канальном, сетевом.</p>
                      <p>Есть разные потребители синхронизации, которые хотят разное и в разных комбинациях: абсолютное время (время суток), частоту, фазу (по-другому время, но не путать с абсолютным).</p>
                      <p>Наверное, первый протокол синхронизации, который появился и крайне активно используется в пакетных сетях — <strong>NTP</strong> – Network Time Protocol.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/79a/38d/926/79a38d92692c8985ff8736205143b6e6.jpg" width="341" height="200" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/79a/38d/926/79a38d92692c8985ff8736205143b6e6.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/79a/38d/926/79a38d92692c8985ff8736205143b6e6.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Есть сервер точного времени, у которого клиент запрашивает это самое точное время. Работает в т.ч. через сеть интернет, поэтому точность его невелика, измеряется в миллисекундах. Условно говоря, если нужно выставить часы, чтобы будильник вовремя зазвонил или в лог-файле была временная отметка — великолепное решение. Все компьютеры в мире им пользуются и никто не жалуется. Раз интернет, значит, работает поверх IP, т.е. на сетевом уровне. Фактически протокол выполняет синхронизацию <em>абсолютного времени </em>или<em> времени суток</em>. Не так давно в российском сегменте интернета <a href="https://habr.com/ru/companies/yandex/articles/861538/">были большие проблемы</a> с NTP, отчего части вирусологов и экспертов в области международной политики, вероятно, даже пришлось переквалифицироваться в ntpлогов.</p>
                      <p>Нельзя просто так взять и закопать TDM, не взяв оттуда принцип частотной синхронизации. Сказано — сделано. Держите протокол <strong>SyncE </strong>– Synchronous Ethernet – в чистом виде косплей на <em>частотную</em> синхронизацию из TDM. Работает на физическом уровне.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/816/522/c15/816522c15da1e6fe1b2420dbfe03e55e.jpg" alt="Картинка отсюда" title="Картинка отсюда" width="480" height="261" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/816/522/c15/816522c15da1e6fe1b2420dbfe03e55e.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/816/522/c15/816522c15da1e6fe1b2420dbfe03e55e.jpg 781w" loading="lazy" decode="async">
                       <div>
                        <figcaption>
                         Картинка <a href="https://tf.zone/solutions/architecture-and-testing-of-network-synchronization-systems/">отсюда</a>
                        </figcaption>
                       </div>
                      </figure>
                      <p>В сети есть эталонный источник, который передает эталонную частоту. Каждая транспортная железка на пути до потребителя должна поддерживать этот протокол, имея на борту отдельный чип для обработки физического синхросигнала. И это сложность, потому что аппаратная поддержка — это затраты на оборудование. А помимо этого, у ряда вендоров возникают и лицензионные ограничения. В общем, это уже серьезный протокол за серьезные деньги, который умеет передавать только частоту. И нужно хорошо понимать, кому и зачем он нужен. Сам протокол разбирать не будем, он выходит за рамки статьи. Общая архитектура красиво изображена в википедии.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/6fd/158/662/6fd1586622e52aee469fecb188bf2661.jpg" width="481" height="292" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/6fd/158/662/6fd1586622e52aee469fecb188bf2661.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/6fd/158/662/6fd1586622e52aee469fecb188bf2661.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Ну и, наверное, вишенкой на нашем прекрасном торте синхронизации и вершиной инженерной мысли является стандарт IEEE 1588, второе имя ему PTP – Precision Time Protocol. Есть две версии 1 и 2. Одна старая, другая новая, они между собой несовместимы. Смотреть будем на самую молоденькую от 2008 года <strong>1588v2</strong> <strong>или</strong> <strong>PTPv2. </strong>Заявленная точность измеряется в наносекундах, что очень жирно и на 5-6 порядков лучше, чем у NTP. Умеет синхронизировать <em>абсолютное время, фазу и частоту.</em></p>
                      <p>Мне, как человеку, у которого всю жизнь перед глазами туда-сюда мельтешат пакеты в асинхронном режиме, где задержки в буфере составляют десятки миллисекунд, решительно непонятно было, каким образом можно было заставить пакетную сеть передавать синхронизацию. Ну ладно время еще, ладно фазу, но частоту-то как, камон? В этом, наверное, и есть гениальность людей, которые все эти протоколы изобретают. Будем разбираться.</p>
                      <p>Главной особенностью PTPv2 является то, что он как кофе 3 в 1 — дешевый (не всегда), желанный и умеет сразу все — передавать абсолютное время, фазу и частоту. Сам по себе 1588v2 в живой природе себя особо не проявил. Фактически он описывает набор сигнальных сообщений, правила их обработки и математику, по которой вычисляются требуемые потребителям величины. И имя ему <strong>1588v2 Default Profile</strong>. Это база. Просто транспорт для практических реализаций, если хотите. А уже дальше товарищи из разных отраслей народного хозяйства дополнили протокол профилями под собственные нужды: телекоммуникационный, энергетический, финансовый, военный. Профили отличаются видами транспорта (ethernet, ip), требуемой точностью, частотой отправки сигнальных сообщений, видами поддерживаемой синхронизации.</p>
                      <p>Но давайте сперва про сам 1588v2. Чтение, наверное, лучше начать вот с <a href="https://habr.com/ru/articles/163253/"><strong>этой статьи</strong></a>.</p>
                      <p>С аппаратной точки зрения в простейшем виде это сервер, который по сути своей владеет только сакральным знанием о точном мировом времени. Где уж он его берет — от GPS, ПЗГ, ВЗГ, SDH, атомных часов или сам придумывает – значения для нас не имеет. Там есть специальные люди, которые в этом очень сильно разбираются и всю эту синхронизацию в масштабах мира поддерживают. Далее есть клиент, который умеет получать сигнал точного времени и выгодным для себя образом интерпретировать, попутно задавая серверу наводящие вопросы. С программной точки зрения это всего-навсего 2 простейших сигнальных сообщения, которые всю эту магию и колдуют:</p>
                      <ul>
                       <li>
                        <p><strong>Announce</strong> – сервер рассказывает о своих возможностях, настроенном профиле, поддерживаемых видах синхронизации, классе точности. Посылается нечасто, что-то типа Hello в других протоколах, где он описывает, что жив-здоров и свои возможности. Потребитель по этому сообщению выбирает тот сервер, который ему больше мил и люб.</p></li>
                       <li>
                        <p><strong>Sync</strong> – сервер отправляет в сторону клиентов данные о своем времени (timestamp). А вот это уже самое главное. На основе сообщения Sync происходит синхронизация абсолютного времени (без поправки на задержку), и, что самое волшебное, частоты. Как? Разберемся чуть позже.</p></li>
                       <li>
                        <p><strong>DelayReq</strong> и <strong>DelayResp</strong> – для того, чтобы сделать время более точным, необходимо убрать из расчетов задержку, возникающую при передаче пакетов через сеть (мы ведь помним, что все эти сообщения — это просто пакеты?). Клиент отправляет в сторону сервера сообщение DelayReq и получает в ответ с DelayResp. Ну дальше включается калькулятор, который по двум нехитрым формулам корректирует абсолютное время и фазу.</p></li>
                       <li>
                        <p>Есть и еще сообщения, но они нам не особо интересны, т.&nbsp;к. суть не раскрывают.</p></li>
                      </ul>
                      <p>Теперь давайте в картинках разберемся, какое сообщение (Sync, DelayReq, DelayResp) на что влияет. Право, я перечитал множество статей с формулами несколько раз, но доходило крайне туго, пока не увидел у какого-то интуриста расчеты на конкретных числах.</p>
                      <p>Поехали. Одно единственное сообщение Sync самым примитивным образом корректирует абсолютное время на клиенте.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/23d/e71/3c5/23de713c5659465259a68cb89a3a422c.jpg" width="367" height="381" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/23d/e71/3c5/23de713c5659465259a68cb89a3a422c.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/23d/e71/3c5/23de713c5659465259a68cb89a3a422c.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Вот так незамысловато сервер вставил в пакет Sync текущую метку своего точного времени (в примере 0 секунд), отправил пакет по сети, где он, судя по графику, летел 1 секунду. У клиента в это время была своя рандомная шкала времени. На момент прихода пакета Sync натикало 19 секунд. Клиент просто берет и покорно применяет себе время сервера, не думая ни о каких задержках.&nbsp;</p>
                      <p>Такс, самое простое позади, очень примерно выставили время, пусть это делу пока особо и не поможет.</p>
                      <p>Но мы же знаем, что пакет по сети летит какое-то время, накапливая все большую и большую задержку: обработка маршрутизатором (наносекунды), буферизация (миллисекунды), сериализация (время передачи в линию — от наносекунд до миллисекунд в низкоскоростных линиях типа ADSL), передача по линии (где чем длиннее линия, тем больше задержка, например на спутниковых каналах легко набегает по 200мс в одну сторону). И вот эту задержку нам бы надо компенсировать. Делается это с помощью сообщений DelayReq и DelayResp.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/957/54f/462/95754f462fe9926ea4a103dac4f824cf.jpg" width="454" height="383" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/957/54f/462/95754f462fe9926ea4a103dac4f824cf.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/957/54f/462/95754f462fe9926ea4a103dac4f824cf.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Клиент, ежели ему зачем-то надо (а оно не всегда так) выяснить совсем точное время, отправляет сообщение DelayReq с указанием своего абсолютного времени отправки (1 секунда). Сервер, немного подумав (неважно сколько), в ответ отправляет сообщение DelayResp, указав, что он получил это сообщение в 3 секунды по своей шкале. Клиент получает это сообщение и начинает строить в голове логическую цепочку: так, отправил я в 1 секунду, он получил в 3. Значит шло оно 3-1=2 секунды. Но мое-то время на предыдущем этапе по сообщению Sync также было выставлено с задержкой! Значит надо разделить на <em>полопам</em>. (3-1)/2=1 секунда. Это будет время односторонней задержки. И продолжает рассуждать: у меня на часах на момент получения DelayResp было 4 секунды, добавляем посчитанную одну секунду для коррекции и вуаля — мы с сервером полностью выровняли свое время. Сообщения Sync и Delay посылаются на постоянной основе несколько раз в секунду в зависимости от выбранного профиля.</p>
                      <p>Что тут занимательного? Время отправки и получения сообщения DelayResp ни на что не влияет, ни в каких в формулах расчета не участвует, оно просто переносит данные о метке времени. А вот сообщение DelayReq очень даже влияет. Также как и Sync. Ну и что? А то, что каналы в сервер-клиент и клиент-сервер должны быть симметричными. Зная, как вольно, бывает, обращаются в сетях с метриками или настройками прямых и обратных rsvp-туннелей, это может привести к проблемам. Зарубим себе на носу. И второе, чем меньше джиттер при доставке сообщение Sync и DelayReq, тем более точно подстраивается шкала времени клиента. Запишем и это в нашу книгу пожеланий.</p>
                      <p>А самое главное знаете что? Мы сейчас с вами увидели принцип <strong>фазовой (временной) синхронизации! </strong>Это ли не чудо? Да, вот так просто. Фазовая (временная синхронизация) — это когда на разных железках одно и то же действие начинается в один и тот же момент. А еще знаете что? Именно этот тип синхронизации так нужен для корректной работы LTE TDD (но об этом чуть ниже).</p>
                      <p>Но и это еще не все, до чего смогли додуматься эти крейзи инженеры. Ну вот казалось бы, ладно еще можно понять, когда у вас на физическом уровне в SyncE эталонная синусоида посылается с такой-то частотой, бери и по фронту синхронизируйся. Но как вы через пакеты-то это делаете??? А оно, оказывается, еще легче легкого.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/af1/76c/ee7/af176cee7a05d938e0a61d559fb9bc47.png" width="500" height="358" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/af1/76c/ee7/af176cee7a05d938e0a61d559fb9bc47.png 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/af1/76c/ee7/af176cee7a05d938e0a61d559fb9bc47.png 781w" loading="lazy" decode="async">
                      </figure>
                      <p>У каждого девайса есть встроенный тактовый генератор, который вообще-то&nbsp; — уникальная неповторимая снежинка. Мало того, что частота может различаться на пару сотен герц, так еще и окружающие условия могут влиять (все как у людей). По итогу получаем, что 1 секунда на сервере гарантировано вообще не тоже самое, что на клиенте. Настало время побеждать и эту проблему.</p>
                      <p>Сообщения Sync имеют периодический характер. И вот за счет них-то и производится коррекция, а точнее — можно вычислить коэффициент, с которым часы (генератор) клиента убегает или отстает от сервера. Сервер отправляет сообщение Sync, проставив метку времени отправки 1 секунда, спустя пару секунд (в нашем примере) отправляет еще одно сообщение Sync (проставив метку 3 секунды). Клиент получает оба сообщения, видит, что первое он получил в 6 секунд, а второе в 12. Далее разницу времени отправки на сервере он делит на разницу времени получения на клиенте и получает искомый коэффициент, на который можно смело умножать время на клиенте. В нашем карикатурном случае часы на клиенте бегут в три раза быстрее, чем на сервере. Если коэффициент меньше 1, значит часы на клиенте бегут вперед, если больше 1 — отстают. Все гениальное — гениально! Таким образом решена проблема <strong>частотной синхронизации.</strong></p>
                      <p>Я долго думал, ну как же так получилось, что частоту и фазу удалось откорректировать через показания времени, присланном в пакете <s>с пакетами</s>? И вот буквально на днях дошло. Частота измеряется в герцах. А что такое герц? Это единица делить на секунду. Т.е. величина обратно пропорциональная времени. Разработчики стандарта взяли за основу поговорку «время временем вышибают» и воплотили в жизнь. Чертовы гении. Ну а с фазой совсем просто — это опять же просто время запаздывания или отклонения одного сигнала от другого.</p>
                      <h2>Профили PTPv2 (1588v2)</h2>
                      <p>Мы молодцы, разобрались с <s>физическими</s> логическими основами пакетной синхронизации. Это хорошо. Но было лишь начало. Теперь давайте посмотрим, какие профили бывают. Как с умным видом говорилось ранее, протокол PTPv2 описывает формат сообщений и что из них можно выжать. А дальше каждый сам волен придумывать себе настройки под разные требования. Кому-то нужна только частота, кому-то подавай и фазу. Этим — точность десятки микросекунд,&nbsp; тем — наносекунды. У этих есть только Ethernet, у этих IP (и заметьте, про MPLS ни слова).</p>
                      <p>ITU-T определил три профиля PTP для телекоммуникационных приложений, описанных в спецификациях G.8265.1, G.8275.1 и G.8275.2.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f36/b14/f79/f36b14f7922436fc9a91869276a744f3.jpg" width="977" height="416" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f36/b14/f79/f36b14f7922436fc9a91869276a744f3.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f36/b14/f79/f36b14f7922436fc9a91869276a744f3.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p><strong>G.8265.1 Profile </strong>используется<strong> </strong>для обеспечения точной частотной, но не временной синхронизации базовых станций мобильной связи. Хорошо подходит для 2G, 3G, LTE FDD. Старые сервера синхронизации умеют поддерживать только его. Реализован у многих мобильных операторов (чуть позже разберем как). В железе выглядит следующим образом.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f53/ec7/165/f53ec7165bb173c9a1cdf04981e2f35c.jpg" width="1110" height="371" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f53/ec7/165/f53ec7165bb173c9a1cdf04981e2f35c.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f53/ec7/165/f53ec7165bb173c9a1cdf04981e2f35c.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Сервер с завидной регулярностью шлет сообщения Sync, на основе которых клиент (базовая станция) производит корректировку частоты. И изредка Announce, как аналог Hello в других протоколах. Работает поверх IP и тем удобен. И как бы все. Но не совсем. По факту в нем есть сообщения DelayReq и DelayResp, но для вычисления фазы они не используются. Вероятно, их можно использовать для выставления абсолютного времени. А еще 8265 в принципе по жизни работает без коррекции на промежуточных девайсах.</p>
                      <p><strong> G.8275.1 Profile</strong> предназначен для обеспечения высокоточной частотной синхронизации, фазовой синхронизации и синхронизации времени суток (ToD – time of day). Этот профиль работает только на канальном уровне методом мультикаст-вещания. Хорош собой, но требует обязательную поддержку на каждом транзитном устройстве. А это — капитальные затраты на обновление плат, софта, лицензий и железок в целом. Каждое устройство на пути производит коррекцию времени (вставляет время входа и выхода пакета, чтобы уже в сообщении Sync компенсировать джиттер). Профиль полностью независим от загрузки сети и в этом его жирнейший плюс. Но вот то, что его нельзя запустить без модернизации сети, — минус. Подходит для запуска 2G, 3G, LTE FDD и TDD.</p>
                      <p><strong> G.8275.2 Profile</strong> предназначен для обеспечения точной частотной синхронизации, фазовой синхронизации и ToD при лишь <strong><em>частичной</em></strong> поддержке со стороны сети. А вот это уже интересно. Профиль является дальнейшим развитием 8275.1, но может, во-первых, работать поверх IP, а, во-вторых, не обязательно должен поддерживаться всеми транзитными маршрутизаторами. Второй пункт на самом деле в стандарте описан по-другому. В сети есть несколько типов устройств:</p>
                      <ul>
                       <li>
                        <p>Boundary Clock (BC) – устройство, которое умеет производить расчеты времени. В т.ч. источник синхронизации (GrandMaster Clock)</p></li>
                       <li>
                        <p>Ordinary Clock (OC) – потребитель синхронизации по-нашему, например, базовая станция</p></li>
                       <li>
                        <p>Transparent Clock (TC) – транзитное устройство, которое умеет вносить корректировку задержки времени прихода и ухода пакета с железки</p></li>
                      </ul>
                      <p>Позаимствуем картинку с сайта хуавея, которая описывает структуру сети, предложенную стандартом (кстати картинка одинакова для 1 и 2 профилей).</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/e6d/5c0/e8f/e6d5c0e8fe32ba3627fba7ca531d7d4b.jpg" width="359" height="396" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/e6d/5c0/e8f/e6d5c0e8fe32ba3627fba7ca531d7d4b.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/e6d/5c0/e8f/e6d5c0e8fe32ba3627fba7ca531d7d4b.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Каждое транзитное устройство в сети по стандарту должно быть BC или TC, т.&nbsp;е. на аппаратном уровне обеспечивать поддержку PTPv2 (ставить временные отметки в пакете), а это снова капитальные затраты на модернизацию сети. Но, PTPv2 на сетях операторов я видел (правда, неизвестно с каким профилем), а вот чтобы мы его как-то настраивали в железе – припомнить не могу… И вот за эту-то соломину будем цепляться зубами, интерпретируя эти данные нужным нам образом, но чуть позже. Прежде давайте посмотрим, как выглядит в Wireshark’е сигнальный обмен между сервером и клиентом (БС).</p>
                      <p>Со стороны сервера мы можем лицезреть три типа сигнальных сообщений: Announce, Sync и DelayResp.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/52d/c73/b2f/52dc73b2fb5554436640a8ead402bf89.jpg" width="1133" height="684" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/52d/c73/b2f/52dc73b2fb5554436640a8ead402bf89.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/52d/c73/b2f/52dc73b2fb5554436640a8ead402bf89.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Как видим, изредка сервер напоминает миру сообщением Announce (149 пакет) о своем существовании и параметрах. Периодическими сообщениями Sync (142,152,161,170 пакеты) производится коррекция частоты и просто поддержание точного времени суток. Ну а сообщения DelayResp летят в ответ на запрос клиента DelayReq из следующего дампа и служат для корректировки фазы. Кстати, обратите внимание, что на одно Sync приходится 8 сообщений Delay. Это как раз параметры выставляемые в телекоммуникационном профиле G.8275.2. Например в энергетическом профиле частота отправки этих сообщений будет немножечко другая, и по сути это и будет единственная разница между профилями. Но от частоты отправки этих сообщений зависят характеристики сервера (сколько клиентов в единицу времени он может обслуживать).</p>
                      <p>Но давайте взглянем на обещанный дамп глазами клиента (базовой станции):</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/55f/b7b/12a/55fb7b12ae53814928b561a48ef4c110.jpg" width="1124" height="395" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/55f/b7b/12a/55fb7b12ae53814928b561a48ef4c110.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/55f/b7b/12a/55fb7b12ae53814928b561a48ef4c110.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Как видим, кроме как DelayReq базовая станция ничего не шлет. Да ей и не требуется. Частоту и время она получила из сообщений Sync, а вот фазу берет из сообщений Delay. Вот, собственно, и вся магия.</p>
                      <p>Для закрепления давайте еще глянем на общие параметры частоты отправки Sync и Delay, под которые БС подстроилась, проанализировав сообщения Announce от разных серверов. Это выгрузка параметров с базовой станции, уж простите за качество.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/1b4/3cd/c3d/1b43cdc3d4e63afed09339997f1e39bc.jpg" width="229" height="269" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/1b4/3cd/c3d/1b43cdc3d4e63afed09339997f1e39bc.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/1b4/3cd/c3d/1b43cdc3d4e63afed09339997f1e39bc.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Что здесь примечательного. Для начала БС поняла, что она Ordinary Clock, т.&nbsp;е. потребитель синхронизации. Настроена на работу с профилем G.8275.2 поверх IPv4 в unicast-режиме. Т.е. в настройках руками указаны сервера. Есть такое поле Domain = 44. Оно служит для разделения разных групп источников синхронизации, но для нас, как пакетчиков, оно интересно тем, что при анализе дампов оно может указать, какой профиль используется G.8275.2, G.8265.1, G.8275.1, потому что под профили эти номера доменов заранее предопределены. Как минимум в ходе реверс-инжиниринга (читай – ковыряния в дампах) мне это сильно помогло разобраться в происходящем. Ну и мы видим, что телекоммуникационным профилем G.8275.2 определена (точнее запрошена базой) частота отправки сообщений Sync 16Гц (или pps – packet per second), а сообщений Delay – с частотой 128 Гц (или опять же pps). Как раз разница в 8 раз, что мы видели в дампе выше.</p>
                      <p>А теперь давайте подумаем, что мы имеем заключить из всего вышесказанного и увиденного? На базовой станции есть работающий профиль G.8275.2, зацепленный за сервер синхронизации, который по стандарту обладает наносекундной точностью. Это раз. Профиль есть, значит, есть фаза и частота, но LTE TDD не работает. Это два. Три — на пакетной сети никто не настраивал аппаратную поддержку этому профилю, хотя стандарт его требует. Т.е. в сети есть один Boundary Clock (он же Grandmaster, он же источник синхронизации) и множество Ordinary Clock (базовые станции). А всяких промежуточных Transparent clock нет. Четыре — режим IPv4, но мы-то знаем, что у нас на сети никого IPv4 нет — у нас там MPLS. Крайне любопытная картина вырисовывается. Т.е. фактически мы подаем на базовую станцию синхронизацию частоты и фазы. Точности частоты хватает, чтобы работало 2G, 3G и сектора LTE FDD, а вот точности фазы для запуска LTE TDD категорически не хватает. А это уже кое да что.</p>
                      <p>Кстати, по ходу разбирательств во всей этой синхронизации на глаза попалась <a href="https://tf.zone/solutions/architecture-and-testing-of-network-synchronization-systems/"><strong>хорошая справочная табличка</strong></a>, в которой описаны разные виды рекомендаций для тех или иных технологий передачи данных.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/694/f2e/544/694f2e54431d5a8582082b7f718b9828.jpg" width="481" height="140" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/694/f2e/544/694f2e54431d5a8582082b7f718b9828.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/694/f2e/544/694f2e54431d5a8582082b7f718b9828.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <h2>Что там у мобилы?</h2>
                      <p>Что ж, пора, наверное, поскролить <s>тик-ток</s> интернет на предмет того, какие, собственно, требования выдвигаются со стороны мобильной сети для разных технологий. Основательный гуглеж показал, что веб-комьюнити, например, <a href="https://www.dealer.su/articles/45916/"><strong>вот здесь</strong></a><strong>.</strong> примерно сходится на одних и тех же параметрах и для LTE TDD требует точность синхронизации ± 1,5мкс.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/2f5/077/0bb/2f50770bbc93f2638de57c1d5d30c154.jpg" width="481" height="213" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/2f5/077/0bb/2f50770bbc93f2638de57c1d5d30c154.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/2f5/077/0bb/2f50770bbc93f2638de57c1d5d30c154.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p><a href="https://tf.nist.gov/seminars/WSTS/PDFs/2-2_Ericsson_Ruffini_Sync_in_MobileStandards_ruffini-rev3-tot.pdf"><strong>Вторят</strong></a><strong> </strong>нашим отечественным коллегам и именитые импортные товарищи из Ericsson, которые в сотовой связи сильно хороши.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/7e7/d25/b28/7e7d25b280994f9aa4dd94d68267711f.jpg" width="424" height="301" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/7e7/d25/b28/7e7d25b280994f9aa4dd94d68267711f.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/7e7/d25/b28/7e7d25b280994f9aa4dd94d68267711f.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Доверяй, но проверяй. Если мы в пакетных сетях руководствуемся требованиями RFC, то мобила живет и строится по законам, описанным законодателем мобильной моды — 3GPP — 3rd&nbsp;Generation&nbsp;Partnership&nbsp;Project&nbsp;— консорциумом, разрабатывающим спецификации для мобильной телефонии. На слайдике выше указан любопытный документ 3GPP TS 36.133, в котором на 47 (из 462) странице озвучиваемые интернетом требования вполне подтверждаются. Хотят точность меньше 3 мкс для каких-то маленьких ячеек и 10 мкс для больших.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/a6a/ced/330/a6aced330a335ae06738561f103fe267.jpg" width="831" height="459" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/a6a/ced/330/a6aced330a335ae06738561f103fe267.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/a6a/ced/330/a6aced330a335ae06738561f103fe267.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>И вот теперь впору слегка пригорюниться и словами одного автоблогера задать витающий в воздухе вопрос: «3GPP, вы там у себя не офигели»? Мы тут в пакетных сетях задержки измеряем в миллисекундах, как мы вам должны микро- и нано- обеспечивать? У нас даже скорость света конечна, по проводу длиной 10км пакет физически летит со скоростью 280000км/с 0,03мс (это уже 30мкс), а еще сериализация, буферизация, маршрутизация...</p>
                      <p>Но если хорошенечко призадуматься, то тут явно что-то не то. И верно, раз транспортная сеть физически не в состоянии обеспечить микросекундые задержки (delay), значит, речь о другом. И это другое — джиттер (jitter) или дрожание. Пакеты приходят с какой-то задержкой и она плавает, например, в диапазоне от 10 до 15мс. Вот эта разница между максимальной и минимальной задержкой в 5мс и будет джиттером. Т.е. для успешного запуска LTE TDD нам нужно всего-то навсего — обеспечить джиттер синхропакетов в пределах 3 мкс... Без коррекции на промежуточных маршрутизаторах… Пффф,&nbsp; да раз плюнуть.</p>
                      <h2>Средний по больнице MBH</h2>
                      <p>Для понимания, откуда берется задержка, а вместе с ней и джиттер, надо глянуть на среднестатистическую структуру обычной российской се<s>мь</s>ти. Строится она по одним и тем же лекалам у всех операторов: мобильная кора (пакетная и голосовая с контроллерами), сама сеть MBH из маршрутизаторов агрегации (подороже и помощнее) и доступа (подешевле и послабее), и собственно базовая станция, ради которой все это делается. Но давайте разберем чуточку подробнее, как это выглядит.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f9a/a9b/746/f9aa9b746ad76b46e18302cd616e7c99.jpg" width="707" height="788" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f9a/a9b/746/f9aa9b746ad76b46e18302cd616e7c99.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f9a/a9b/746/f9aa9b746ad76b46e18302cd616e7c99.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>PS/CS Core через Opt. A (набор вланов под разные интерфейсы мобильной сети Abis, Iub, S1 и управление OAM) стыкуются с городской/областной mpls-сетью. Эта сеть обычно имеет выделенный уровень агрегации из мощных маршрутизаторов с большим количеством портов и толстых линков, который строится по кольцевой топологии. Пример очень простой, обычно роутеров больше. На агрегаторы опираются кольца доступа, состоящие из железок с функциональным названием CSR (Cell Site Router). К CSR’ам уже непосредственно подключаются базовые станции. С т.з. физики, наверное, у всех все одинаково. Различия начинаются в части логической архитектуры, что выливается в разный набор используемых протоколов для организации транспортной и сервисной составляющей: ospf/isis, ldp/rsvp, l2vpn/l3vpn, <s>canon/nikon</s>, vpls/evpn, иерархический/плоский vpn — в общем, вариативность хорошая. Но по факту единственная цель дотянуться вланом или по l3 от PS Core до базовой станции, попутно обеспечивая резервирование узлов и линий связи с быстрым переключением на резерв.</p>
                      <h2>Теряем время</h2>
                      <p>Давайте попробуем разобраться, в каком месте сети набегает задержка и что добавляет ей неопределенности — того самого джиттера. Для этого рассмотрим трассу от PS Core до базовой станции, развернув схему выше в цепочку и пустим <s>скупую слезу</s> пакет размером 1500Байт.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/632/d84/651/632d84651511335f71de8c9261851ed6.jpg" width="481" height="82" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/632/d84/651/632d84651511335f71de8c9261851ed6.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/632/d84/651/632d84651511335f71de8c9261851ed6.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>При передаче по сети пакет проходит через маршрутизаторы и по линиям связи. Крупными мазками в маршрутизаторе он проходит:</p>
                      <ol>
                       <li>
                        <p>стадию внутренней обработки включая десериализацию (восстановление битового потока в пакет и поиск выходного интерфейса)</p></li>
                       <li>
                        <p>буферизацию перед отправкой в линию, если она вдруг занята</p></li>
                       <li>
                        <p>сериализацию (передача набора битов в линию)</p></li>
                      </ol>
                      <p>С линиями все просто. Оптический или электрический сигнал распространяется хотя и очень быстро, но с конечной скоростью, которая где-то в районе скорости света. Но т.&nbsp;к. у нас тут сферический конь не в вакууме, то она поменьше. Мне нравится думать про 280000 км/с (не знаю откуда взял). В итоге чем длиннее линия, тем дольше пакет будет по ней ехать.</p>
                      <p>Давайте рассчитаем примерную задержку для нашей сети, вызванную <strong>длиной линии</strong>. Примем, что длина каждого линка равна 10км. Сигнал преодолеет 10км за 10км/280000км/с= 0,035мс = 35мкс. По дороге у нас пять таких линий, значит, в сумме это займет 0,035мс*5= 0,175мс = 175мкс. В целом немного. Для примера, если речь будет идти про спутниковую связь, то для геостационарной орбиты пока пакет слетает в космос на высоту 35000км делить на 300000км/с (тут уже вакуум) это займет 116мс. Отразится от спутника и долетит до наземного терминала это еще минимум 116мс, итого минимально физически возможное время односторонней задержки 232мс (а на самом деле сильно больше). У Старлинка в этом случае сильно веселее, орбита на 550км — это примерно 3,6мс. Этот параметр фактически зависит только от ограничений, налагаемых вселенной, и его не обойти. Наверное все, кто работал в эксплуатации, сталкивались с абонентами, которые жаловались на высокий пинг из условного Владивостока до Москвы — это как раз случай с расстояниями. И увы, здесь помогут только просветительская деятельность и надежда, что когда-нибудь сервер с танчиками поставят поближе к абонентам. Хотя бывают случаи, когда операторы из Владивостока стыкуются где-нибудь на М9 в Москве — это двойная пытка с административной составляющей для абонентов.</p>
                      <p>Теперь давайте посчитаем, сколько времени пакет проводит внутри маршрутизатора. Скажу сразу, сделать это получится весьма условно, потому что зависит как минимум от типа обработки пакета. Допустим если он умеет обрабатывать «на лету», то ему не надо дожидаться поступления всего пакета, а достаточно только заголовка, из которого можно выяснить выходной интерфейс. Но обработать-то заголовок оно сможет, а вот передать дальше - нет, пока не получит весь пакет целиком. Почему? Потому что наш старый добрый Ethernet работает с полем контрольной суммы (FCS), которое вставляется в конец кадра. Т.е. сначала надо узнать, пришел ли пакет целым, а потом нужно сосчитать новую сумму, т.е. пакет так или иначе должен оказаться в маршрутизаторе целиком. Это будет десериализация. Операции десериализации (сборка пакета из битового потока) и поиск выходного интерфейса в целом можно распараллелить. Сколько времени будет длиться обработка пакета — одному чипу известно: это очень индивидуально, даже лезть не будем, но в современных маршрутизаторах это наносекунды. Но если кто-нибудь подскажет, как сделать трейсы пакетов на Huawei, Juniper и Nokia аналогично как в <a href="https://habr.com/ru/companies/cbs/articles/323080/"><strong>этой статье</strong></a><strong> </strong>по циске, то нашей статье явно добавится точности. А так посчитаем только то, что можем точно посчитать.</p>
                      <p>Сперва переведем наши 1500 байтов в биты, чтобы делить и умножать одни и те же единицы. 1500 байт * 8 = 12000 бит.</p>
                      <p>Все начинается с того, что PS Core на скорости 100G выплевывает пакет в сеть. Это <strong>сериализация</strong>. Время передачи всего пакета размером 12000 бит со скоростью 100Гб/с из порта в линию составит 12000бит / 100Гбит/с = 0,12 мкс. Немного. Узел Agg1 в сторону Agg2, работая на 20G, затратит на эту же операцию сериализации в 5 раз больше времени, т.&nbsp;е. 0,6 мкс. Интерфейсы Agg2 и CSR1 в сторону БС работают на скорости 10G, поэтому они потратят по 1,2 мкс. Ну и CSR2 смотрит в БС на скорости 1G, т.е. он потратит 12 мкс. Просуммируем время сериализации 0,12 + 0,6 + 1,2 + 1,2 + 12 = 15,12 мкс = 0,01512 мс. В целом тоже не очень много.</p>
                      <p>Какие выводы? С одной стороны, чем больше размер пакета, тем больше времени на его передачу надо. Товарищи, которым важно работать с данными в режиме реального времени, типа голоса или эмуляций потока поверх RTP, давно смекнули, что с мелкими пакетиками проще гарантировать какую-никакую стабильность (технология ATM со своими ячейками в 53 байта была родоначальником этой моды). С другой, чем выше скорость порта, тем меньше время, затрачиваемое на передачу. И этот параметр уже зависит от наших финансовых возможностей. Говорят, что купить можно все, кроме времени. Мы с вами только что разрушили этот миф! В дата-центрах все очень богатые и работают на межгалактических скоростях в 100G и 400G чуть не на доступе с основной целью — уменьшить задержку. Это у нас в провайдинге миллисекундой больше, миллисекундой меньше — все равно проблема абонента. А они там сети строят для себя любимых, чтобы ублажить протокол TCP или его гугловского братишку QUIC, которые в большинстве реализаций крайне чувствительны к задержке.</p>
                      <p>Но если подумать, что такое 15мкс, которых у нас набрались за пяток маршрутизаторов — мелочи? Ан нет, можно очень неудачно вляпаться. Давайте откатимся на 10-15 лет назад, в эпоху xDSL и Serial-интерфейсов, которые местами встречаются и сейчас. Там скорости вращаются в районе 2Мб/с. А для 1500Б пакета это сразу же +6 мс на процедуре сериализации. А давайте сделаем еще хуже (мы это умеем) — выкручиваем MTU до 9000Б. И тут же получаем 30 мс. А это, на минуточку, пинг из Екатеринбурга до Москвы. Вот так легко и непринужденно мы довели сеть до крайности, заменив 4000 км оптики всего одним неудачным маршрутизатором. Чем еще плох медленный процесс сериализации? Пока железка мучительно передает пакет в линию, остальные томятся в буфере, а это уже про массовое влияние. Про half-duplex и коллизии уже говорить не будем — сегодняшняя статья не о том, как сломать жизнь себе или абонентам. Хотя нет, все-таки будем. Мы-то ведь как думаем, что потоки E1, Frame Relay, PPP и ADSL далеко в прошлом и больше мы об этом ничего не услышим. Услышим и еще как. Низкоскоростные интерфейсы не выходили и вряд ли уйдут из нашей жизни. Тот же LTE на своих радио-интерфейсах в сторону абонентов будет выдавать совсем небольшие скорости, в пределах нескольких мегабит в ЧНН в зависимости от числа абонентов на БС. Правда и здесь можно купить себе симочку подороже с более приоритетным QCI (quality class identifier — мобильный qos) и наслаждаться прелестями капитализма. В LTE TDD дополнительно добавляется задержка из-за half-duplex, потому что прием и передача ведутся по очереди (пусть и в разных пропорциях). Но LTE — это про абонентов. А в сетях провайдеров очень распространены радио-релейные линии, которые работают на скоростях и в 100М, и в 250М. Или остался SDH, который <s>выкидывать жалко</s> умеет EoS (Ethernet over SDH), и вот мы уже передаем Ethernet на скорости VC4 в районе 150М. Так что процедуру сериализации со счетов сбрасывать никак нельзя.</p>
                      <p>Ну ладно, с сериализацией разобрались. Пакет вылетел из PS Core по 100G линку, пролетел 10 км и попадает на AGG1. Здесь его ждет обратный процесс — десериализация. Из битового потока <s>сознания</s> нужно собрать пакет обратно. По сути это займет столько же времени, поэтому просто добавляем еще 15,12 мкс к нашим расчетам и на этом успокаиваемся.</p>
                      <p>Всего на линии и в процессе сериализации/десериализации мы потеряли 175 + 15 + 15 = 205 мкс = 0,2мс. Знаете, что объединяет все виды задержки, которые были описаны и посчитаны в этой главе? Они нам неинтересны! Они статичны, даже если земля перестанет держаться на трех китах, формула расстояние = скорость*время не изменится. Понятно, что если размер пакета будет 100Б, а не 1500Б, то времени на его передачу уйдет поменьше, но сам принцип расчета останется простым и понятным как три копейки. На наши потуги запустить чудо-синхронизацию для LTE TDD оно особо не повлияет, потому что это delay, а не jitter, с которым мы будем биться. Хотя вообще-то в теории есть ситуация, когда и задержка повлияет — это процедура handover’а, т.е. передачи абонента с одной базы на другую, но это не точно.</p>
                      <p>Ну а вообще мы посмотрели на все основные виды задержки, которые возникают на сети, кроме буферизации. А вот она-то как раз ломает нашу стройную систему расчетов постоянной задержки, внося хаос и обеспечивая тот самый джиттер.</p>
                      <h2>Буферизация</h2>
                      <p>Это время, которое пакет находится в буфере (памяти), ожидая своей очереди на отправку (фактически до начала сериализации). Время это носит абсолютно случайный характер и зависит от множества параметров: сколько уже пакетиков лежит в буфере, сколько очередей и какие у них настройки, есть ли полисер, в какую очередь пакет попал, какой максимальный размер буфера, сколько юзеров в сети и как сильно им хочется интернета, насколько мощные сервера, есть ли шейпер и много другое, что делает процедуру буферизации на первый взгляд непредсказуемой.</p>
                      <p>В пакетных сетях буферизация возникает по двум основным причинам:</p>
                      <ul>
                       <li>
                        <p>понижение скорости</p></li>
                       <li>
                        <p>одновременный приход пакетов</p></li>
                      </ul>
                      <p>Сперва про понижение скорости. Тут все довольно просто. Нельзя просто взять и пакет, летящий на скорости 10G, передать в порт 1G. Сперва его нужно пропустить через замедлитель интернетных частиц, коим является буфер коммутатора/маршрутизатора. Так сказать, произвести выравнивание линейных скоростей интерфейсов.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/43b/99d/f20/43b99df203b5518eb3b445ecfd70568a.jpg" alt="Картинка отсюда  " title="Картинка отсюда  " width="481" height="289" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/43b/99d/f20/43b99df203b5518eb3b445ecfd70568a.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/43b/99d/f20/43b99df203b5518eb3b445ecfd70568a.jpg 781w" loading="lazy" decode="async">
                       <div>
                        <figcaption>
                         Картинка <a href="https://www.ixbt.com/news/2023/03/24/v-bolshom-adronnom-kollajdere-vpervye-udalos-zaregistrirovat-samuju-neulovimuju-jelementarnuju-chasticu.html">отсюда</a>
                        </figcaption>
                       </div>
                      </figure>
                      <p>Но есть нюанс, который довольно сложно уловить. Замедляется не столько скорость отдельного пакета, сколько скорость потока данных. Ну вот смотрите. Есть сервера условного Яндекса или ВК, жесткие диски которых умеют производить чтение и передачу видосиков в сеть на скорости 100G, а есть телефонная станция, обученная сызмальства только теореме Котельникова, передающая разговор на скорости 64 кбит/с. Сервер Яндекса и телефонная станция могут быть подключены по 100G-интерфейсу. Но сервер будет передавать информационный поток на этой скорости, а телефонная станция как использовала свои 64 кбит/с, так и будет. Понятно, что поток данных на скорости 100G нельзя целиком засунуть в 10G, пакеты начинают складываться в буфер, потом буфер кончается и они теряются (а в это время усиленно работает TCP, который вычисляет реальную пропускную способность канала с точностью до нескольких килобит на основании всего двух параметров — двусторонней задержки и процента потерь, попутно подстраивая/понижая скорость чтения жесткого диска до 10G, но это из другой оперы). При этом условная телефонная станция, несмотря на потрясающую скорость интерфейса, передает голосовой поток на скорости 64к, что без всякой буферизации прекрасно пройдет через 10G линк.</p>
                      <p>Если пример с серверами не подходит, то возьмем из жизни. Вот перед нами 10 полосное шоссе, у которого из-за ремонта осталась только 1 полоса. В месте сужения полос возникнет пробка, которая, чем больше машин, тем длиннее растянется. Фактически, пробка — это буфер, который производит выравнивание возможностей 10-ти полосного шоссе с узкой дорогой. С другой стороны ночью, когда трафика нет, можно ворваться на однополоску — тапку в пол, волосы назад, т.е. выравнивать тут особо нечего, т.к. дорога свободна.</p>
                      <p>Все мы знаем, что пакетные сети изначально построены на <s>обмане потребителя</s> теории вероятности. Это когда у нас у коммутатора 20*1G портов и 2*10G, причем только один 10G смотрит в аплинк. Итого мы запихиваем 20G в 10G, называя это нейтральным словом <em>мультиплексирование</em> в соотношении 2:1 (а в случае с платами переподпиской). И в общем-то здесь все в порядке, вероятность того, что трафика одновременно будет хотя бы пару гигов, крайне низка, и на графиках в Cacti никто никакого криминала не увидит. В теории. А вот если копнуть чуть поглубже, то становится понятно — вероятность, что два пакета придут одновременно и захотят попасть в один и тот же выходной порт очень сильно больше 0.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/e1a/f5b/8fb/e1af5b8fba0196353706c0b4d52544c2.jpg" width="481" height="175" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/e1a/f5b/8fb/e1af5b8fba0196353706c0b4d52544c2.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/e1a/f5b/8fb/e1af5b8fba0196353706c0b4d52544c2.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>По итогу, одному из пакетов придется полежать в буфере, пока другой проходит сериализацию. Чем больше «одновременных» пакетов, тем дольше они будут сидеть в очереди. Это в чистом виде теория массового обслуживания, которую каждый из нас пропустил через себя с утра в плацкартном вагоне в очереди к столь вожделенному туалету на подъезде к конечной станции.</p>
                      <p>Оба механизма, приводящие к необходимости буферизации, желательно понять <s>и простить</s>, чтобы знать, где очередь (а вместе с ней джиттер) может возникнуть, а где нет.</p>
                      <h2>Радикальный сетевой фундаментализм</h2>
                      <p>А вот теперь будет немножечко хардкора, без которого эта заметка не имела бы такого смысла. Как чинить джиттер — не секрет, для этого существует QoS с правильной классификацией и продуманным планировщиком, но об этом немного попозже. Пока же обсудим одну статью в моем ультра кратком изложении, которая попалась на глаза за неумеренным потреблением оливье. Итак, простой парень из солнечного Сан-Хосе с исконно калифорнийским именем Diptanshu Singh задался вопросом, а как, собственно, <a href="https://packetpushers.net/blog/average-network-delay">посчитать этот джиттер</a>. Если быть точнее, то в своей статье он вывел формулу для расчета времени буферизации, а это ни что иное, как джиттер. Я проверил, она работает на практике, поэтому хочется объяснить, что к чему, ведь это позволяет с простым калькулятором в руках проверить те или иные техрешения и предсказать, что заработает, а что нет.</p>
                      <p>Процесс буферизации в сети представляют собой модель массового обслуживания, которая хорошо изучена, разложена на компоненты и описана. Удобнее всего рассматривать на примере условного магазина с покупателями. Есть интенсивность поступления клиентов в очередь, есть сама очередь возле кассы, есть скорость обработки очереди (расторопность кассира).</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/459/96b/05f/45996b05ff21cdf6181fe1a8e8960ce1.jpg" width="334" height="134" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/459/96b/05f/45996b05ff21cdf6181fe1a8e8960ce1.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/459/96b/05f/45996b05ff21cdf6181fe1a8e8960ce1.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Поступление клиентов в очередь удобно представлять в виде распределения Пуассона. Это когда мы знаем, что за час в среднем придет 5 человек, но когда конкретно они это сделают — загадка, друг на друга они не ориентируются. Могут прийти все вместе, а могут и нет. А могут и вообще прийти не 5, а 8. Это важный момент, свойственный именно пакетным сетям. Допустим, в TDM-сетях поступление данных осуществляется с постоянной скоростью через равные промежутки времени длиной в 1 таймслот (или канальный интервал для тех, кому ИКМ-30 ближе) и там все дальнейшие расчеты смысла уже не имеют. В распределении же Пуассона много случайностей.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/cb3/1e4/73b/cb31e473bfdb9ac72a7c98e19f7b175f.jpg" width="152" height="95" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/cb3/1e4/73b/cb31e473bfdb9ac72a7c98e19f7b175f.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/cb3/1e4/73b/cb31e473bfdb9ac72a7c98e19f7b175f.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Для процесса Пуассона придумана формула, которая рассказывает, с какой вероятностью за какое-то время произойдет n событий. Например, при средней интенсивности 5, придет все-таки не 5, а целых 8 человек. Эта формула на самом деле интересна, потому что через нее можно получить все что угодно. И, что особенно радует, нам она не нужна, с ней математики пусть работают ))</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f3f/7a8/123/f3f7a81231a2b1d218ec7ea1f92a7e00.jpg" width="180" height="58" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f3f/7a8/123/f3f7a81231a2b1d218ec7ea1f92a7e00.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f3f/7a8/123/f3f7a81231a2b1d218ec7ea1f92a7e00.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Есть разные модели массового обслуживание, мы будем рассматривать самую простую M/M/1, которая нам подходит. В ней первая «М» означает поступление пакетов по распределению Пуассона. Вторая «М» — обработка пакетов «без памяти» вне зависимости, было что-то до этого сделано или нет. И «1» означает, что у нас только один обработчик очереди (когда мы будем считать реальную сеть, будет понятно, почему это допустимо).</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/a22/761/c81/a22761c813e19f750e4153a3dba1c43c.jpg" width="262" height="58" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/a22/761/c81/a22761c813e19f750e4153a3dba1c43c.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/a22/761/c81/a22761c813e19f750e4153a3dba1c43c.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Базовыми характеристиками, описывающими систему массового обслуживания, являются интенсивность поступления пакетов <strong>λ</strong> и интенсивности (скорость) их обработки <strong>µ</strong>. Отношение интенсивности поступления к интенсивности обработки обозначается буковкой&nbsp;<strong>ρ</strong></p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/b22/135/c4b/b22135c4b3e95fb1290e178ce2723951.jpg" width="180" height="37" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/b22/135/c4b/b22135c4b3e95fb1290e178ce2723951.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/b22/135/c4b/b22135c4b3e95fb1290e178ce2723951.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Если соотношение меньше 1, значит система успевает обрабатывать всех клиентов, если больше — значит клиенты начинают теряться. Чем ближе <strong>ρ</strong> к нулю, тем меньше время ожидания в очереди.</p>
                      <p>Вообще-то, лично я бы уже на этой формуле закончил всю эту математику. Если вдуматься, то фактически здесь мы видим не только скорость убывания, но и в каком-то смысле коэффициент буферизации. Т.е. условно при интенсивности поступления 5 человек и скорости обслуживания кассы в 6 человек, ρ=5/6 = 0,83 из них оказались бы постоянно в очереди. А почему бы не взять и именно так не интерпретировать эту формулу? Я бы так и сделал. И ошибся. Потому что именно понимание деталей процесса отличает математиков от меня — они-то знают, что каждый клиент, который находится на кассе, отнимает время у всех, кто стоит дальше за ним. Склоняю голову перед их умищем. Дальше в статье идет большая простыня из формул, которые приводят нас к простому способу вычисления среднего количества пакетов в отдельно взятой очереди N (внимание, формулой ниже этот же параметр обозначается буквой q).</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/c49/093/5c4/c490935c42333a5eae6d357fae09db69.jpg" width="75" height="40" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/c49/093/5c4/c490935c42333a5eae6d357fae09db69.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/c49/093/5c4/c490935c42333a5eae6d357fae09db69.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Если на пути много очередей (в нашем случае маршрутизаторов), то для каждой из них считается свой N, где λ это скорость поступления пакетов усредненной длины, а µ это скорость обработки интерфейсом этих пакетов. И в итоге мы получаем, что при интенсивности 5 и скорости обработки 6, в очереди будет не 0,83 клиента (как я ошибочно хотел насчитать ранее), а 5/(6-5)=5 клиентов. Если бы интенсивность поступления была 3, то очередь 3/(6-3)=1 уменьшилась радикально. Популярное мнение, что лучший qos — это широкие линки, правильное. Но в целом мы с вами увидели ключевую формулу для расчета джиттера.</p>
                      <p>Без стеснения жонглируя формулами товарищ выводит схему расчета <strong>джиттера T для отдельного порта или маршрутизатора.</strong></p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/d7d/985/956/d7d9859562932d54873879b817ec696c.jpg" width="220" height="46" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/d7d/985/956/d7d9859562932d54873879b817ec696c.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/d7d/985/956/d7d9859562932d54873879b817ec696c.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Честно говоря, не понял, что он хотел показать, используя в этой формуле букву q, а формулой выше букву N – это одно и тоже – среднее число пакетов, лежащих в буфере. Но не суть, главное теперь у нас есть формула расчета джиттера, которая в переводе на человеческий звучит как отношение числа пакетов в буфере q (или N) к интенсивности поступления пакетов.</p>
                      <p>Ну и если маршрутизаторов по трассе много, то нужно посчитать, сколько пакетов сидит в буферах на всех изучаемых портах и разделить это на сумму интенсивностей поступления трафика в эти порты.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/fe3/2ee/859/fe32ee859712befad50182933467e92f.jpg" width="332" height="73" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/fe3/2ee/859/fe32ee859712befad50182933467e92f.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/fe3/2ee/859/fe32ee859712befad50182933467e92f.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>В своей статье он зовет это задержкой, и c т.з. маршрутизатора он полностью прав — мы считаем время задержки пакета в буфере. Но с т.з. сети это уже в чистом виде джиттер. Позволю себе открыть паинт и переписать формулу.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/3de/244/ad8/3de244ad8b18a41d82716467a66c230f.jpg" width="244" height="66" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/3de/244/ad8/3de244ad8b18a41d82716467a66c230f.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/3de/244/ad8/3de244ad8b18a41d82716467a66c230f.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Очень интересно, но ничего не понятно? И это хорошо —&nbsp; вы нормальный!</p>
                      <p>Для желающих окунуться поглубже и подсмотреть еще пару фокусов, <a href="https://real-statistics.com/probability-functions/queueing-theory/m-m-1-queueing-model/"><strong>вот здесь</strong></a> товарищ показывает нам, как еще можно провернуть эти формулы, причем удобненько в экселичке. На самом деле можно рекомендовать проделать это упражнение, в ходе которого можно спрогнозировать с какой вероятностью джиттер будет увеличиваться при разной загрузке порта.</p>
                      <h2>Кто виноват?</h2>
                      <p>Кажется, сейчас самое время не отходя от кассы попробовать натянуть эту математику на нашу сеть и разобраться, почему же LTE TDD не захотело само заработать. Вспомним, что ключевым моментом является жесткое требование к джиттеру при передаче пакетов синхронизации в пределах 3мкс, чтобы обеспечить достойную фазовую синхронизацию. Профиль PTPv2 G.8275.2 с коррекцией фазы у нас есть, но что-то ему не хватает для счастья. Поэтому берем ту же самую сеть и с интересом препарируем кусочек, выделенный зеленым прямоугольничком. В нем у нас сервер синхронизации (в народе бывает зовется IPClock) по красной пунктирной стрелочке безуспешно пытается доставить фазу на базу.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/c4e/507/dda/c4e507ddad05a3d5826bb37dedecccc5.jpg" width="740" height="791" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/c4e/507/dda/c4e507ddad05a3d5826bb37dedecccc5.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/c4e/507/dda/c4e507ddad05a3d5826bb37dedecccc5.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Для начала нужно понять, где будет возникать джиттер. Напомню, что он появляется или при понижении скоростей, или, если трафик из нескольких линков пытается попасть в один. С одной стороны, это вызывает буферизацию, а с другой – наш маршрутизатор можно описать через распределение Пуассона и модель М/М/1, что позволяет использовать формулы из прошлой главы.</p>
                      <p>Итак, IPClock посылает пакеты на скорости 1G, он их источник, делает стабильно в рамках возможностей своего процессора. Никакого джиттера там нет. Следующая железка AGG1, в ней сходится несколько аплинков, т.е. для джиттера самое оно. Записали. На AGG2 мало того, что аплинки из разных направлений, так еще и понижение скорости с 20G до 10G. Наш кандидат. У CSR1 условно говоря только один аплинк, из которого прилетит трафик в сторону CSR2, оба порта работают на скорости 10G, условия не выполняются, так что мимо. Ну и последний девайс – это CSR2, он выполняет понижение скорости с 10G до 1G. Итого имеем, что буферизация производится на AGG2, AGG1, CSR2.</p>
                      <p>Хорошо, теперь надо посчитать λ и µ. Где их взять? Да очень просто. λ – это скорость, с какой идет трафик, а µ – это скорость на которой работают интерфейсы. Единственный момент, надо это дело перевести из мегабит/с в пакеты/с. Ну просто потому, что по сети у нас летают именно пакеты. Что ж, просто заходим на порт AGG1 делаем sh int X и получаем готовенький результат. Либо берем график с пиковыми значениями и идем считать.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/2b8/d24/03f/2b8d2403f3b0e5da5a89c4878b81998b.jpg" width="1269" height="323" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/2b8/d24/03f/2b8d2403f3b0e5da5a89c4878b81998b.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/2b8/d24/03f/2b8d2403f3b0e5da5a89c4878b81998b.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Здесь мы видим, что интенсивность поступления в ЧНН:</p>
                      <p><code>λ = 1,17 Mpps.</code></p>
                      <p>А еще обратите внимание, что я беру график со всего порта без деления на очереди, где вместе с голосом может летать домашний интернет. Все верно, до приведения QoS’ов на всей сети до желаемой модели трафик голоса, синхронизации, управления и всего остального может попадать совсем не в те очереди, где им место. В нашем случае он оказался в нулевой.</p>
                      <p>Такс, а еще нам нужно вычислить средний размер пакета. Делается просто: делим скорость в мегабитах на скорость в пакетах, и на 8 не забываем, чтобы обратить биты в байты:&nbsp;&nbsp;&nbsp;</p>
                      <p>&nbsp;<code>11,52Gbps / 8 / 1,17Mpps = 1230 байт.</code></p>
                      <p>Теперь мы можем посчитать скорость обработки интерфейса 20G в pps для усредненных 1230 байтных пакетов:</p>
                      <p><code>µ = 20Gbps / 8 / 1230B = 2&nbsp;032&nbsp;520 pps.</code></p>
                      <p>А теперь просто возьмем и посчитаем средний джиттер, который возникает при передаче пакетов через AGG1 при передаче через интерфейс по формуле</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f3f/385/017/f3f3850179fde52eed6abe1d2d8dcf1c.jpg" width="220" height="46" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f3f/385/017/f3f3850179fde52eed6abe1d2d8dcf1c.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f3f/385/017/f3f3850179fde52eed6abe1d2d8dcf1c.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p><code>T = 1/(2032520pps-1170000pps)=1 / 862520 pps=1,16*10<sup>-6</sup>с= 1,16мкс</code></p>
                      <p>Вроде бы немного. Но мы посмотрели только на один линк, и он уже выбрал 30% от бюджета в 3мкс необходимого для запуска LTE TDD. А еще не будем забывать, что мы увидели <strong><em>среднюю</em></strong> задержку буферизации. Распределение Пуассона говорит нам о том, что может прийти 1 Mpps, а может прийти и 1,5 Mpps (всплеск), пусть и с меньшей вероятностью. Мы на графике или счетчике видим оооочень усредненные значения, т.&nbsp;к. фактически джиттер плавает в значительно бОльших пределах. Так, при всплеске до 80% от емкости порта (это ~16G или ~1,6 Mpps) джиттер на линке составит</p>
                      <p><code>T = 1/(2032520pps-1600000pps)=1 / 862520 pps=2,3*10<sup>-6</sup>с= 2,3мкс</code></p>
                      <p>И все, давай G.8275.2, до свидания.</p>
                      <p>Но пока не будем о грустном, считаем трассу дальше. Берем график с AGG2, на порту xe-1/1/0 которого происходит понижение скорости с 20G до 10G.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/b05/eeb/f22/b05eebf2218ecadf1bbda31e94209bae.jpg" width="1280" height="324" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/b05/eeb/f22/b05eebf2218ecadf1bbda31e94209bae.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/b05/eeb/f22/b05eebf2218ecadf1bbda31e94209bae.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Средний размер пакета:</p>
                      <p><code>607,62Mbps / 8 / 107kpps = 709B</code></p>
                      <p>Скорость 10G интерфейса в pps:</p>
                      <p><code>µ = 10Gbps / 8 / 709B = 1763000 Трафик в ЧНН поступает со скоростью:</code></p>
                      <p><code>λ = 107 kpps.</code></p>
                      <p>pps</p>
                      <p>Джиттер:</p>
                      <p><code>T = 1/(1763000pps-107000pps)=1 / 1656000 pps=6*10<sup>-7</sup>с= 0,6мкс</code></p>
                      <p>И посчитаем последний из интересных линков уже на CSR2, где происходит понижение с 10G до 1G непосредственно в базовую станцию. Также берем картиночку, стираем с нее отпечатки пальцев и смотрим, что выходит.</p>
                      <p>Трафик идет со скоростью:</p>
                      <p><code>λ = 6,7 kpps</code></p>
                      <p>Средний размер пакета:</p>
                      <p><code>56,32Mbps / 8 / 6,7kpps = 1050B</code></p>
                      <p>Скорость 10G интерфейса в pps:</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/e20/701/386/e2070138638f1c866a6a389a878477ac.png" width="1280" height="312" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/e20/701/386/e2070138638f1c866a6a389a878477ac.png 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/e20/701/386/e2070138638f1c866a6a389a878477ac.png 781w" loading="lazy" decode="async">
                      </figure>
                      <p><code>µ = 1Gbps / 8 / 1050B = 119000 pps</code></p>
                      <p>Джиттер:</p>
                      <p><code>T = 1/(119000 pps-6700pps) =1 / 112300 pps=8,9*10<sup>-6</sup>с= 8,9мкс</code></p>
                      <p>А вот это уже интересно. Фактически на пустом гиговом порту, где в ЧНН 50М трафика (загрузка 5%) набежало джиттера сразу на 9 мкс. Ни о каком LTE TDD и 3мкс говорить больше не приходится. Вот оно – то место, которое нам гарантированно всю малину испортило. Какая бы классная сеть у нас не была, на гигабитном порту возникает крайне неприятный эффект накопления времени буферизации. Помните, мы ранее считали сериализацию. Так вот здесь, на медленном интерфейсе, она начинает влиять на время буферизации. Такой вот замкнутый круг.</p>
                      <p>Для очистки совести давайте еще просуммируем джиттеры по всей трассе AGG1-AGG2-CSR2:</p>
                      <p><code>1,16 мкс + 0,6 мкс + 8,9 мкс = 10,66 мкс</code></p>
                      <p>И заметьте, это только в одну сторону от PS Core до БС. Этот джиттер будет воздействовать на сообщения Sync в PTPv2 G.8275.2. От БС до PS Core тоже есть разные линки, и там будет накапливаться свой джиттер (немного меньше, но порядок тот же), который будет ломать нам сообщения DelayReq. А еще мы не учитывали (потому что не умеем), что поиск выходного порта (маршрутизация/коммутация) все-таки занимает какое-то время.</p>
                      <p>Такие дела. Только что мы с вами своими руками посчитали и нашли место (и не одно), где вся наша синхронизация сыпется.</p>
                      <h2>Что делать?</h2>
                      <p>Проблему нашли, дело за малым - ответить на извечный вопрос. Томить не буду, перед нами стоит две решаемые задачи:</p>
                      <ol>
                       <li>
                        <p>Обеспечить одинаковую задержку (delay) пакетов по направления PS Core – БС (для сообщений Sync) и БС — PS Core (для сообщений DelayReq). Делается с помощью ISIS/OSPF (а у кого-то и RSVP, и BGP).</p></li>
                       <li>
                        <p>Уменьшить задержку буферизации (jitter) хотя бы на порядок. Тут только QoS.</p></li>
                      </ol>
                      <p>Пойдем по порядку. Для правильного расчета фазовой синхронизации необходимо, чтобы задержка в обе стороны была как можно более одинакова. Даже, наверное, нет так. Внутри одной БС постоянная ассиметричность маршрута ни на что влиять не должна. Но вот для правильного расчета фазовой синхронизации <strong>двух соседних секторов</strong>, между которыми осуществляется handover (передача абонента с одной БС на другую) - по логике симметричность совершенно необходима. Достигается это симметричностью трассы. И в самом деле, давайте глянем на нашу схему с немного вывернутой метрикой на участке CSR1-CSR2.</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/f90/31e/e4c/f9031ee4c45b16aa41692684d36da3a8.jpg" width="740" height="791" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/f90/31e/e4c/f9031ee4c45b16aa41692684d36da3a8.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/f90/31e/e4c/f9031ee4c45b16aa41692684d36da3a8.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Как видим, из-за некорректно проставленных метрик сигнальный пакет Sync от сервера к БС пойдет короткой дорогой по красной линии, а вот пакет DelayReq побежит по длинной трассе (синяя линия), легко намотав сотню-другую километров оптики. А мы помним, что 100 км / 280000 км/с = 357 мкс. И вот так легко мы внесем непоправимую ошибку в расчеты PTPv2 для абсолютного времени и фазы. Поэтому необходимо перелопатить всю сеть, обеспечив абсолютную симметрию всех метрик. И этот минимум мы сделали.</p>
                      <p>Для донов, которые используют RSVP, задачка может оказаться посложнее (а местами и вовсе нерешаемой без редизайна). Во-первых, в старых HLD некоторые производители рекомендовали использовать explicit-path для решения всяких разных проблем (например, неумения софта рассчитывать резервные lsp&nbsp; при частичном пересечении путей до появления опции overlap). И вот, когда инженеры вручную пишут эксплиситы, а потом через год что-то куда-то переносят, то прямые и обратные туннели легко разъезжаются по разным трассам, потому что сначала тут забыли исправить, потом там.</p>
                      <p>Во-вторых, есть великолепный функционал RSVP Auto-bandwidth, который позволяет строить lsp из расчета загрузки линков. Очень помогает избежать ручного администрирования, но на больмень загруженной сети прямой и обратный туннели с изрядной доли вероятности в ЧНН скорее всего разойдутся по разным направлениям. И еще учитывайте, что синхронизация в принципе крайне нервно, даже истерично, относится к изменению физической трассы и, как следствие, задержки. Для синхронизации лучше использовать постоянные туннели.</p>
                      <p>В-третьих, есть и еще проблемка для сетей, где используется иерархический VPN (особо касается случаев с OSPF, где используется нулевая и номерные зоны). Не углядев за master/slave на транзитных железках, куда приземляются vpls (t-ldp) или l3vpn (mp-bgp opt B), возникнет еще одно место, где задержка поплывет. В общем, вариантов как сделать сеть хуже — масса, обращайтесь )).</p>
                      <p>Нас бог миловал, сеть по HLD запроектирована максимально простой на IGP+LDP, а проблемы емкости и прочего трафик-инжиниринга решаются выделением лямбды в хорошо развитом DWDM. Мы полностью переделывали только метрики в IGP, практически гарантировав симметрию (на самом деле мы полностью все переписали заново на сотнях маршрутизаторов). Остаются, конечно, нюансики, когда на пути есть ECMP. С одной стороны Juniper, с другой Cisco и скорее всего они посчитают хэш совершенно по-разному, но благо разница по расстояниям будет в пару километров, что приемлемо.</p>
                      <p>Теперь давайте заборим джиттер. Здесь, конечно, сильно сложнее, потому что требуется внедрение QoS. Там большая теория, у меня на эту тему рассказать на 2-3 дня есть что. Начать ознакомление стоит, конечно же, с <a href="https://habr.com/ru/articles/420525/"><strong>СДСМ</strong></a>. Наверное, без общего понимания как оно работает и какого-никакого опыта, сложно советовать залазить в эту тематику, потому что, скорее всего, получится сделать только хуже. Но объяснить попробую.</p>
                      <p>QoS, как и все остальное в этих наших сетях состоит из данных, переносимых в пакетах и обработчике на маршрутизаторах/коммутаторах. В зависимости от выполненных настроек, можно вкладывать разный смысл и философию:</p>
                      <ul>
                       <li>
                        <p>гарантировать разным видам трафика минимальную полосу</p></li>
                       <li>
                        <p>приоритезировать один вид трафика на другим</p></li>
                       <li>
                        <p>обеспечить моментальное обслуживание высокоприоритетному трафику</p></li>
                       <li>
                        <p>не дать кому-то больше, чем нужно, или как раз дать больше, чем нужно, но ненадолго</p></li>
                       <li>
                        <p>и т.&nbsp;д.</p></li>
                      </ul>
                      <p>Все это можно миксовать между собой, запуская в придачу HQoS, который так-то сильно аппаратно зависим даже в рамках одного вендора. Тема QoS крайне обширная, включает в себя классификацию, полисинг, входную перемаркировку, маркировку (цветовую), управление перегрузками (RED/WRED), работу с очередями (PQ/WRR/DWRR-CBWFQ), шейпинг, выходную перемаркировку, настройку размера очереди (в секундах или байтах) — сложно и много короче. А еще это должно быть одинаково на всей сети, вплоть до каждого порта и саб-интерфейса. Это называется единая политика QoS оператора или DiffServ-домен.</p>
                      <p>Мы настраиваем оператора связи, у него бегает трафик домашнего интернета с торрентами (b2c), iptv, трафик абонентов юр. лиц (b2b), протоколов маршрутизации, голоса и сигналки и мобильной и фиксированной телефонной связи и много чего еще — в общем полный набор. И здесь главная задача – определить, что важно, а что не очень. Вообще, как и все в сетях, умные люди постарались это дело стандартизировать. Например, нарисовали такую табличку</p>
                      <p>Где разным видам трафика назначили разные приоритеты. И все - живи с этим как хочешь.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/cbe/ebd/744/cbeebd74499b93204738a13cf2325687.jpg" width="382" height="287" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/cbe/ebd/744/cbeebd74499b93204738a13cf2325687.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/cbe/ebd/744/cbeebd74499b93204738a13cf2325687.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Доны из 3GPP пошли чуть дальше и дополнили таблицу типов трафика требования к задержкам и потерям (причем это чисто мобильный QoS).</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/272/944/da9/272944da9d97beabd9a9f5a08c5867a7.jpg" width="481" height="247" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/272/944/da9/272944da9d97beabd9a9f5a08c5867a7.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/272/944/da9/272944da9d97beabd9a9f5a08c5867a7.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Стандартизация получилась не очень, надо сказать, потому что не только лишь все понимают, что с этим делать. Нет единой таблицы, которая бы связала воедино классификацию и настройки планировщика, слишком много места для безудержного полета фантазии, и, что хуже, реализации в железе. Так что это все рекомендации, а потому не имеют особого значения, потому что каждый оператор — Художник. Вот как он видит, такой QoS у него и будет.</p>
                      <p>Хватит бесполезно растекаться мыслью. Имея опыт работы с операторами, мы выделили (классифицировали) голосовой и сигнальный трафик (включая синхронизацию) в отдельный класс (условно назовем его VoIP) и поместили в очередь PQ (Priority Queue или SP – Strict Priority). Другие типы трафика поместим в другие очереди, которые обрабатываются по другим правилам. В целом это выглядит примерно как на этой картинке <a href="https://habr.com/ru/articles/246791/"><strong>из статьи</strong></a> (у нас очередей только побольше и они по-другому называются).</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/8b0/606/c5f/8b0606c5f1e34a55d4567038de09b4ba.jpg" width="332" height="181" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/8b0/606/c5f/8b0606c5f1e34a55d4567038de09b4ba.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/8b0/606/c5f/8b0606c5f1e34a55d4567038de09b4ba.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Особенность очереди VoIP (кстати, если из VoIP выкинуть букву «o», то станет VIP)) настроенной в режиме PQ в том, что пакеты из нее вынимаются, как только они там появляются, в то время как остальные обслуживаются по очереди, да еще и с отведенным лимитом, чтобы всем досталось времени обслуживания. Допустим, идем сверху вниз по картинке, сначала достали <strong>все</strong> пакеты из очереди VoIP, потом сколько-то Call-Signalling, потом несколько из Critical Data. Тут снова <s>с ноги врывается</s> появляется пакет в очереди VoIP. Бросаем все и сломя голову c криком <em>БАНЗАЙ</em> несемся обрабатывать пакеты VoIP. Вот в этот самый момент другие пакеты в очередях накапливают задержку (джиттер) сидя на лавке в <s>поликлинике</s> буфере, а наш дерзкий и быстрый приоритетный пакетик синхронизации залетает&nbsp; почти без задержки, чисто на харизме со словами</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/7a4/b05/de2/7a4b05de28ddb02ad907084d0cba3cd2.jpg" alt="Источник: https://fotostrana.ru/public/post/231949/2663335609" title="Источник: https://fotostrana.ru/public/post/231949/2663335609" width="419" height="419" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/7a4/b05/de2/7a4b05de28ddb02ad907084d0cba3cd2.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/7a4/b05/de2/7a4b05de28ddb02ad907084d0cba3cd2.jpg 781w" loading="lazy" decode="async">
                       <div>
                        <figcaption>
                         Источник: <a href="https://fotostrana.ru/public/post/231949/2663335609/">https://fotostrana.ru/public/post/231949/2663335609</a>
                        </figcaption>
                       </div>
                      </figure>
                      <p>Но это лирика. Что дает нам приоритетное обслуживание в очереди PQ с т.з. математики и ненавистных формул? Во-первых, ожидаемо мы сильно уменьшаем интенсивность поступления трафика. Отделив мух от котлет, а голос от торрентов, скорость λ уменьшается на порядок, а то и два. Хоть это и не принципиально на незагруженных линках.</p>
                      <p>Во-вторых, мы всю пропускную способность порта отдаем в распоряжение нашей очереди с синхронизацией. Параметр µ будет использоваться нами без ограничений (в реальной сети, конечно, нужно ограничивать очереди PQ шейпером, чтобы при шторме он не убил всю сеть, но на расчеты это не влияет)</p>
                      <p>В-третьих, что более неожиданно и вообще-то является залогом успеха, мы уменьшаем средний размер пакета. Если домашний интернет бегает с пакетами по 1200 байт, то голос/сигнализация/синхронизация по 100-135 байт. В 10 раз меньше. Просто потому, что эти виды трафика так устроены. Вот, например, дамп пакета PTPv2.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/07c/345/cf6/07c345cf6d65d641327ae8a798f3a425.jpg" width="458" height="85" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/07c/345/cf6/07c345cf6d65d641327ae8a798f3a425.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/07c/345/cf6/07c345cf6d65d641327ae8a798f3a425.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>А вот соседствующего с ним голосовой пакетик в технологии 3G.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/28e/4f8/1f2/28e4f81f25fd26b7b483582185edc499.jpg" width="388" height="106" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/28e/4f8/1f2/28e4f81f25fd26b7b483582185edc499.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/28e/4f8/1f2/28e4f81f25fd26b7b483582185edc499.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Добавляем сюда пару заголовков mpls по 4 байта, накидываем 14 байт Ethernet, 4 байта 802.1q, можно еще преамбулу и контрольную сумму байт на 12. Короче то на то и выходит.</p>
                      <p>И вот это уже заявочка на победу. Помните, как в прошлой главе наши мечты расслабленно запустить синхронизацию на гиговом линке разбились о суровую реальность? При средней длине пакета в ~1200Б мы получили джиттер 8,9мкс. А коли мы уменьшим пакет в 10 раз до 120Б, то и джиттер упадет примерно в 10 раз до 0,89 мкс. И вот же оно!</p>
                      <p>А, ну и излишне, наверное, говорить, что разработав модель QoS, учитывающую профили трафика Заказчика, мы вновь бессонными ночами прошлись по этим же сотням маршрутизаторов, перенастроив их фактически с нуля.</p>
                      <h2>Посчитаем заново</h2>
                      <p>Берем нашу же сеть, и, даже не дожидаясь стандартного ЧНН в 20:00-22:00, идем по железкам собирать выводы счетчиков очередей (можно было бы и по графикам посчитать, да там очереди не рисуются, но заодно покажу другой метод расчета). Почему ЧНН ждать не обязательно? Потому что трафика в очереди VoIP несколько мегабит, что днем, что ночью. На расчеты это не влияет</p>
                      <p>На Juniper AGG1 это будет так</p>
                      <p><code>sh int queue ae10 forwarding-class VoIP</code></p>
                      <p><code>…</code></p>
                      <p><code>Egress queues: 8 supported, 8 in use</code></p>
                      <p><code>Queue: 5, Forwarding classes: VoIP</code></p>
                      <p><code>&nbsp;&nbsp;Queued:</code></p>
                      <p><code>&nbsp;&nbsp;&nbsp;&nbsp;Packets&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28304481228 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10656 pps</code></p>
                      <p><code>&nbsp;&nbsp;&nbsp;&nbsp;Bytes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : &nbsp; &nbsp; &nbsp; &nbsp; 3505717139707&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11136896 bps</code></p>
                      <p><code>…</code></p>
                      <p>На линке 20G трафика 11 мегабит, ну правда, оно не изменится на порядок. А если изменится, то это некритично. Напомню, что когда деления на очереди не было, то мы считали для 11 гигов, а не 11 мегабит.</p>
                      <p>Итак, здесь у нас интенсивность поступления трафика</p>
                      <p><code>λ = 10656 pps</code></p>
                      <p>Средний размер пакета здесь и сейчас</p>
                      <p><code>11136896 bps / 8 / 10656 pps = 130 Байт</code></p>
                      <p>Скорость работы интерфейса с пакетами размером 130 Байт</p>
                      <p><code>µ = 20Gbps / 8 / 130B = 19&nbsp;230&nbsp;769 pps (понятно, что такой скорости на практике вряд ли добиться)</code></p>
                      <p>Джиттер</p>
                      <p><code>T = 1/(19230769 pps-10656 pps)=1 / 19&nbsp;220&nbsp;113 pps=5,2*10<sup>-8</sup>с= 0,05мкс</code></p>
                      <p>А до косов был 1,16 мкс. На этой железке уменьшили на порядок, точнее в 23 раза.</p>
                      <p>Идем дальше, считаем AGG2</p>
                      <p><code>show interfaces queue xe-1/1/0 forwarding-class VoIP</code></p>
                      <p><code>…</code></p>
                      <p><code>Egress queues: 8 supported, 8 in use</code></p>
                      <p><code>Queue: 5, Forwarding classes: VoIP</code></p>
                      <p><code>&nbsp;&nbsp;Queued:</code></p>
                      <p><code>&nbsp;&nbsp;&nbsp;&nbsp;Packets&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32217685641 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11089 pps</code></p>
                      <p><code>&nbsp;&nbsp;&nbsp;&nbsp;Bytes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : &nbsp; &nbsp; &nbsp; &nbsp; 4696632048800&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11856768 bps</code></p>
                      <p><code>…</code></p>
                      <p>Интенсивность</p>
                      <p><code>λ = 11089 pps</code></p>
                      <p>Внимательный читатель может спросить – WTF? Почему на нижестоящей железке трафика стало больше? Потому что у нее два аплинка и трафик между ними делится примерно поровну. 5,5М залетает с разных сторон.</p>
                      <p>Средний размер пакета здесь и сейчас</p>
                      <p><code>11856768 bps / 8 / 11089 pps = 133 Байта</code></p>
                      <p>Скорость работы интерфейса с пакетами размером 133 Байт</p>
                      <p><code>µ = 10Gbps / 8 / 133B = 9&nbsp;398&nbsp;496 pps</code></p>
                      <p>Джиттер</p>
                      <p><code>T = 1/(9&nbsp;398&nbsp;496 pps-11089 pps)=1 / 9&nbsp;387&nbsp;407 pps=1*10<sup>-7</sup>с= 0,1мкс</code></p>
                      <p>А до косов был 0,6 мкс. На этой железке уменьшили всего в 6 раз.</p>
                      <p>В оконцовке считаем CSR2, где была самая боль из-за гигового интерфейса.</p>
                      <p>На Huawei это выглядит</p>
                      <p><code>dis port-queue statistics interface gi0/2/20 ef outbound</code></p>
                      <p><code>GigabitEthernet0/2/20 outbound traffic statistics:</code></p>
                      <p><code>&nbsp;[ef]</code></p>
                      <p><code>&nbsp;&nbsp;Pass:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 844,167,975 packets,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 103,921,473,916 bytes</code></p>
                      <p><code>&nbsp;&nbsp;Discard: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 packets,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 bytes</code></p>
                      <p><code>&nbsp;&nbsp;Last 5 seconds pass rate:</code></p>
                      <p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;368 pps,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 324,328 bps</code></p>
                      <p><code>&nbsp;&nbsp;Last 5 seconds discard rate:</code></p>
                      <p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 pps,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 bps</code></p>
                      <p>Интенсивность</p>
                      <p><code>λ = 368 pps</code></p>
                      <p>Средний размер пакета здесь и сейчас</p>
                      <p><code>324328 bps / 8 / 368 pps = 110 Байт (такое ощущение, что Хуавей не учитывает l2 заголовок)</code></p>
                      <p>Скорость работы интерфейса с пакетами размером 110 Байт</p>
                      <p><code>µ = 1Gbps / 8 / 110B = 1&nbsp;136&nbsp;363 pps</code></p>
                      <p>Джиттер</p>
                      <p><code>T = 1/(1&nbsp;136&nbsp;363 pps-368 pps)=1 / 1&nbsp;135&nbsp;995 pps=8,8*10<sup>-7</sup>с= 0,88мкс</code></p>
                      <p>А до косов был 8,6 мкс. На этой железке уменьшили на порядок, в 10 раз.</p>
                      <p>И давайте насладимся результатом, сложив все джиттеры по дороге AGG1-AGG2-CSR2</p>
                      <p><code>0,05 + 0,1 + 0,88 = 1 мкс</code></p>
                      <p>Вуаля, мы уложились! Не забываем добавить еще 1 мкс в обратную сторону (хотя ее бы неплохо посчитать таким же образом, но мне лень). И получается, что мы остались в рамках бюджета 3 мкс. На тоненького конечно, но пролазим же! Натурные эксперименты показали, что все работает. Пока не сломается).</p>
                      <h2>Доверяй, но проверяй</h2>
                      <p>У читателя из нашей проф. среды ко всем этим выкладкам может возникнуть законный вопрос.</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/1e2/33b/e65/1e233be653c0e8afd903b1f5a26f4d4d.jpg" width="233" height="288" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/1e2/33b/e65/1e233be653c0e8afd903b1f5a26f4d4d.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/1e2/33b/e65/1e233be653c0e8afd903b1f5a26f4d4d.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Право, у самого были сомнения. Одно дело, что пробные базы LTE TDD заработали, но никто ж не может проверить, что там происходит в буфере с джиттерами. Расчеты расчетами, но хочется чего-то более осязаемого. И их есть у нас! Оказывается, в системе управления базовыми станциями можно запускать тесты качества синхронизации. Условно раз в секунду система залазит в стек PTPv2 и анализирует время.</p>
                      <p>Скомпилированная таблица выгрузки по 9 тестовым базовым станциям в разных точках сети с разным количеством маршрутизаторов по дороге (от 3 до 10) выглядит следующим образом:</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/c3d/3ef/fc7/c3d3effc7e763a751d5f0952b0b78714.jpg" width="384" height="139" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/c3d/3ef/fc7/c3d3effc7e763a751d5f0952b0b78714.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/c3d/3ef/fc7/c3d3effc7e763a751d5f0952b0b78714.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>В ней представлены максимальные отклонения от… а вот не знаю от чего. Либо от первого значения. Либо... да кто его знает. У меня документации на эту тему нет. В последней строчке данные по среднему значению задержки. Очень интересно, но кроме того, что некие результаты идут в ± микросекундах ничего не дает. Но, вот дальше по каждой БС есть своя статистика. Выглядит следующим образом:</p>
                      <figure class="">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/dd1/c1c/fcc/dd1c1cfcc3a00717e1245eb5436781c8.jpg" width="481" height="301" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/dd1/c1c/fcc/dd1c1cfcc3a00717e1245eb5436781c8.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/dd1/c1c/fcc/dd1c1cfcc3a00717e1245eb5436781c8.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>В этой табличке видно, что проводится некий тест Phase Discrimination, что на русский переводится как изменение фазы или дрожание фазы, ну а на нашем пакетном языке — тот самый джиттер. И тут не совсем понятно что это за значения и почему часть из них имеет отрицательное значение. Либо система накапливает статистику двусторонних задержек за секунду и считает среднее. Либо берет какое-то случайное значение раз в секунду. Я склонен думать, что истина где-то посередине. Но главное, что в колонке G показан тот самый джиттер. Мы пытаемся попасть в ±1,5мкс (или ± 1500нс) и результат в колонке G радует глаз. А главное совпадает с расчетами. Можно задавать разную длительность теста. У нас он шел 2500 секунд (~40 минут). Естественно, результаты такого количества измерение приятнее смотреть на графике. Можно так</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/874/997/49a/87499749a3e627e44bdf8869c986c6a3.jpg" width="1003" height="592" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/874/997/49a/87499749a3e627e44bdf8869c986c6a3.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/874/997/49a/87499749a3e627e44bdf8869c986c6a3.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Можно этак</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/0a6/491/31d/0a649131dd0315188b7915c3706011b3.jpg" width="1003" height="771" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/0a6/491/31d/0a649131dd0315188b7915c3706011b3.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/0a6/491/31d/0a649131dd0315188b7915c3706011b3.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Что мы тут наблюдаем? Для БС3 основная масса значений находится в коридоре ± 1000нс. Есть случаи единичных выбросов за +2000нс и -3000нс. Что это означает, судить без документации не берусь. Могу лишь констатировать факт, что как и было рассчитано, джиттер плавает в зависимости от заполненности буферов на маршрутизаторах и в целом не особо зависит от количества железок в трассе. Как говорилось ранее, на джиттер в основном влияет понижение скорости по трассе типа 100G→10G, 10G→1G и несколько аплинков у железки. Для всех БС количество маршрутизаторов в трассе разное, но количество девайсов, где проводится понижение скорости или есть несколько аплинков — одинаковое: в ядре (несколько аплинков и понижение), на агрегации на входе в кольцо (несколько аплинков) и на конечном маршрутизаторе (понижение скорости). В итоге значения джиттера для БС в разных конца сети построенной по нашему дизайну похожи как братья близнецы. С чем нас и поздравляем.</p>
                      <h2>Аппаратная vs программная синхронизация</h2>
                      <p>Отличия качества синхронизации G.8275.1 с аппаратной поддержкой от G.8275.2 запущенного правильным дизайном, QoS’ом и божьей помощью можно оценить по той же самой скомпилированной табличке измерений джиттера из системы управления базовыми станциями. И видны они невооруженным взглядом .</p>
                      <figure class="full-width ">
                       <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/125/3bf/f14/1253bff14d5475f0307871a0e9f6cec7.jpg" width="643" height="361" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/125/3bf/f14/1253bff14d5475f0307871a0e9f6cec7.jpg 780w,
       https://habrastorage.org/r/w1560/getpro/habr/upload_files/125/3bf/f14/1253bff14d5475f0307871a0e9f6cec7.jpg 781w" loading="lazy" decode="async">
                      </figure>
                      <p>Смотрите. Желтым цветом это БС живущие на программном G.8275.2. Зеленым и синим — на аппаратном G.8275.1. Если для желтых БС1-БС9 джиттер (для примера выделен красный прямоугольник) измеряется в тысячах наносекунд, то для БС10-БС15 (зеленые) в единицах и десятках. А для БС16-БС18 (синие) в сотнях. Почему есть разница между желтыми и синими однозначно не скажу, скорее всего проблема в том, что синие живут на Juniper ACX2100, а там есть какие-то проблемки с простановкой timestamp в режиме boundary clock. Но тут интересно другое. На аппаратном профиле среднее значение задержки (фиолетовый прямоугольник) в районе 0 нс (это взяли и сложили все 2500 измерений). А на программном втором профиле оно болтается в районе микросекунды. И именно что болтается — никакой стабильности. Вот вам и разница, вот вам и ответ — аппаратный профиль точнее на целый порядок, а то и три, не зависит от загрузки на сети и позволяет без всяких QoS’ов и дизайнов запустить хоть LTE TDD, хоть LTE Advanced MIMO. Правда требуется заплатить денюжки за аппаратную часть и лицензии. Но это уже тема другого разговора.</p>
                      <h2>Что это было?</h2>
                      <p>Но вообще мы с вами скрестили магию <s>воды и огня</s> теории вероятностей и QoS’ов, чтобы посмотреть, как же оно там работает и что можно сделать. Если очень кратко, то разобравшись, как работает протокол PTPv2 (а именно вычисляет фазу и частоту), поняли, что для счастья нужно:</p>
                      <p>1. обеспечить симметрию прямых и обратных путей</p>
                      <p>2. уменьшить джиттер</p>
                      <p>Первый пункт мы решили исправлением метрик с сопутствующей перенастройкой ISIS. А вот второй решали через QoS, поместив пакеты синхронизации в отдельную очередь с приоритетным обслуживанием. <strong><em>Но фокус состоял не в приоритетности обслуживания пакетов синхронизации как таковой, а в том, что в этой очереди мы собрали маленькие пакеты, уменьшив их среднюю длину в 10 раз, из-за чего джиттер также упал на один порядок</em></strong><em>. </em>Я же говорю, что QoS крайне плохо стандартизирован и каждый художник вертит им как хочет в самую неожиданную сторону. На мой взгляд QoS – это крайне расплывчатая и даже не технология, а набор каких-то магических заклинаний, комбинируя которые можно гибко подходить к решению разных задач. Играть можно не только настройками классификатора и планировщика, но и разными метками (dscp/802.1p/exp) в пакетах, но это как-нибудь в другой статье.</p>
                      <h2>Успешный успех?</h2>
                      <p>Пытливый читатель, домотав досюда все 45 листов А4, возможно спросит: «И че? В чем новизна? Что ты хотел сказать этой статьей? Отвечаю. Во-первых, получай 3GPP! Что вы там у себя думали, мы тут не сможем на коленке микросекунды собрать? А во-вторых, просто рассказать, как не случайно съеденная оливьешка <s>взмахнула крылом</s> случайно привела к формуле вычисления джиттера и ее практическому применению. Ну и вообще – еще одно подтверждение, что сеть надо не просто купить, но и как следует приготовить. А QoS он как мазик для оливьешки — серьезному блюду серьезный ингредиент, без которого даже докторская колбаса не вывезет.</p>
                      <p>Заказчик получил возможность запустить сотни простаивающих секторов LTE TDD на врЕменном решении. Почему временном? Потому что при данной реализации без промежуточной коррекции и с подачей PTPv2 G.8275.2 поверх MPLS, а не IP с аппаратной поддержкой (как завещано стандартом) есть зависимость от количества трафика на сети. Достаточно кому-то очень упорному или клиентоориентированному прописать толстый канал для абонента и раскрасить его realtime qos’ом, как синхронизация может посыпаться, унося в небытие радость интернета для мобильных абонентов. С другой стороны, никто не мешает написать скрипт, который будет укладывать отдельные сектора LTE TDD при потере/ухудшении качества синхронизации, чтобы они не доставляли проблемы на сети, после чего идти оперативно разбираться с происходящим. В общем, заказчику вернули веру в счастливое будущее и возможность запустить сотни секторов, пока где-то едут платы с аппаратной поддержкой G.8275.1, чтоб уж точно не зависеть от геополитических раскладов на карте мира.</p>
                      <p>Всем оливье, мира и сетей. Встретимся в других статьях.</p>
                      <p><br></p>
                      <p>Список сопутствующей литературы использованной при изысканиях:</p>
                      <p><a href="https://habr.com/ru/companies/yandex/articles/861538/">https://habr.com/ru/companies/yandex/articles/861538/</a> - проблемы с NTP</p>
                      <p><a href="https://habr.com/ru/articles/163253/">https://habr.com/ru/articles/163253/</a> - про PTPv2</p>
                      <p><a href="https://tf.zone/solutions/architecture-and-testing-of-network-synchronization-systems/">https://tf.zone/solutions/architecture-and-testing-of-network-synchronization-systems/</a> - про синхронизацию в мобильных сетях</p>
                      <p><a href="https://tf.nist.gov/seminars/WSTS/PDFs/2-2_Ericsson_Ruffini_Sync_in_MobileStandards_ruffini-rev3-tot.pdf">https://tf.nist.gov/seminars/WSTS/PDFs/2-2_Ericsson_Ruffini_Sync_in_MobileStandards_ruffini-rev3-tot.pdf</a> — 3GPP TS36.133 про требования к LTE сетям</p>
                      <p><a href="https://packetpushers.net/blog/average-network-delay/">https://packetpushers.net/blog/average-network-delay/</a> - про вычисление джиттера</p>
                      <p><a href="https://real-statistics.com/probability-functions/queueing-theory/m-m-1-queueing-model/">https://real-statistics.com/probability-functions/queueing-theory/m-m-1-queueing-model/</a> - теория вероятностей в экселичке</p>
                      <p><a href="https://habr.com/ru/articles/420525/">https://habr.com/ru/articles/420525/</a> - СДСМ QoS</p>
                      <p><a href="https://habr.com/ru/articles/246791/">https://habr.com/ru/articles/246791/</a> - еще про QoS</p>
                      <p>И еще множество полезного прочитанного</p>
                      <p><a href="https://www.elec.ru/publications/tsifrovye-tekhnologii-svjaz-izmerenija/6015/">https://www.elec.ru/publications/tsifrovye‑tekhnologii‑svjaz‑izmerenija/6015/</a></p>
                      <p><a href="https://russianelectronics.ru/ieee1588/">https://russianelectronics.ru/ieee1588/</a></p>
                      <p><a href="https://infocenter.nokia.com/public/7210SAS229R1A/index.jsp?topic=%2Fcom.nokia.TSR_Basic_System_Guide%2Fieee_1588v2_ptp-ai9j4okj0i.html">https://infocenter.nokia.com/public/7210SAS229R1A/index.jsp?topic=%2Fcom.nokia.TSR_Basic_System_Guide%2Fieee_1588v2_ptp‑ai9j4okj0i.html</a></p>
                      <p><a href="https://habr.com/ru/companies/phoenix_contact/articles/495920/">https://habr.com/ru/companies/phoenix_contact/articles/495&nbsp;920/</a></p>
                      <p><a href="https://www.design-reuse.com/articles/49934/delivering-timing-accuracy-in-5g-networks.html">https://www.design‑reuse.com/articles/49&nbsp;934/delivering‑timing‑accuracy‑in-5g‑networks.html</a></p>
                      <p><a href="https://support.huawei.com/enterprise/en/doc/EDOC1100174721/5cffe072/ptp-sync-and-delay_req-messages">https://support.huawei.com/enterprise/en/doc/EDOC1&nbsp;100&nbsp;174&nbsp;721/5cffe072/ptp‑sync‑and‑delay_req‑messages</a></p>
                     </div>
                    </div>
                   </div><!----><!---->
                  </div><!----><!---->
                 </div><!--]--><!---->
                 <div class="tm-article-presenter__meta" data-test-id="article-meta-links">
                  <div class="tm-separated-list tm-article-presenter__meta-list">
                   <span class="tm-separated-list__title">Теги:</span>
                   <ul class="tm-separated-list__list">
                    <!--[-->
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[lte+tdd]" class="tm-tags-list__link"><span>lte tdd</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[qos]" class="tm-tags-list__link"><span>qos</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[ptpv2]" class="tm-tags-list__link"><span>ptpv2</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[isis]" class="tm-tags-list__link"><span>isis</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%B1%D0%B0%D0%B7%D0%BE%D0%B2%D1%8B%D0%B5+%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B8]" class="tm-tags-list__link"><span>базовые станции</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%82%D0%B5%D0%BB%D0%B5%D0%BA%D0%BE%D0%BC]" class="tm-tags-list__link"><span>телеком</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%82%D0%B5%D0%BB%D0%B5%D0%BA%D0%BE%D0%BC%D0%BC%D1%83%D0%BD%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D0%BE%D0%B5+%D0%BE%D0%B1%D0%BE%D1%80%D1%83%D0%B4%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5]" class="tm-tags-list__link"><span>телекоммуникационное оборудование</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%B0%D1%8F+%D0%B8%D0%BD%D1%84%D1%80%D0%B0%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0]" class="tm-tags-list__link"><span>сетевая инфраструктура</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B5+%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5]" class="tm-tags-list__link"><span>сетевое администрирование</span></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B5+%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5]" class="tm-tags-list__link"><span>сетевое программирование</span></a><!--]--></li><!--]--><!---->
                   </ul>
                  </div>
                  <div class="tm-separated-list tm-article-presenter__meta-list">
                   <span class="tm-separated-list__title">Хабы:</span>
                   <ul class="tm-separated-list__list">
                    <!--[-->
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/companies/rtk_service/articles/" class="tm-hubs-list__link"><!--[--><span>Блог компании РТК-Сервис</span><!--]--></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/tdd/" class="tm-hubs-list__link"><!--[--><span>TDD</span><!--]--></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/network_hardware/" class="tm-hubs-list__link"><!--[--><span>Сетевое оборудование</span><!--]--></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/network_technologies/" class="tm-hubs-list__link"><!--[--><span>Сетевые технологии</span><!--]--></a><!--]--></li>
                    <li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/sys_admin/" class="tm-hubs-list__link"><!--[--><span>Системное администрирование</span><!--]--></a><!--]--></li><!--]--><!---->
                   </ul>
                  </div>
                 </div><!----><!--]-->
                </article><!--]-->
               </div><!---->
              </div>
              <div style="" class="tm-article-sticky-panel" data-test-id="article-sticky-panel">
               <div class="tm-data-icons tm-data-icons tm-data-icons_space-big tm-article-sticky-panel__icons" data-test-id="article-stats-icons">
                <div class="article-rating tm-data-icons__item" data-v-86aec4a7>
                 <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-article votes-switcher" title="Всего голосов 4: ↑4 и ↓0" data-v-86aec4a7>
                  <button class="tm-votes-lever__button" data-test-id="votes-lever-upvote-button" title="Нравится" type="button">
                   <svg class="tm-svg-img tm-votes-lever__icon" height="24" width="24">
                    <title>
                     Нравится
                    </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-vote"></use>
                   </svg></button>
                  <div class="tm-votes-lever__score tm-votes-lever__score_appearance-article tm-votes-lever__score">
                   <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_positive tm-votes-lever__score-counter" data-test-id="votes-score-counter">+6</span></span><!--]-->
                  </div>
                  <button class="tm-votes-lever__button" data-test-id="votes-lever-downvote-button" title="Не нравится" type="button">
                   <svg class="tm-svg-img tm-votes-lever__icon tm-votes-lever__icon_arrow-down" height="24" width="24">
                    <title>
                     Не нравится
                    </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-vote"></use>
                   </svg></button>
                 </div><!--teleport start--><!--teleport end--><!---->
                </div><!----><!---->
                <button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button"><span class="tm-svg-icon__wrapper bookmarks-button__icon">
                  <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
                   <title>
                    Добавить в закладки
                   </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-favorite"></use>
                  </svg></span><span class="bookmarks-button__counter" title="Количество пользователей, добавивших публикацию в закладки">9</span></button>
                <div class="tm-sharing tm-data-icons__item" title="Поделиться">
                 <button class="tm-sharing__button" type="button">
                  <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon">
                   <path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path>
                  </svg></button><!--teleport start--><!--teleport end-->
                </div>
                <div class="tm-article-comments-counter-link tm-data-icons__item" title="Читать комментарии">
                 <a href="/ru/companies/rtk_service/articles/907262/comments/" class="tm-article-comments-counter-link__link" data-test-id="counter-comments"><!--[-->
                  <svg class="tm-svg-img tm-article-comments-counter-link__icon" height="24" width="24">
                   <title>
                    Комментарии
                   </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use>
                  </svg><span class="tm-article-comments-counter-link__value">3</span><!--]--></a><!---->
                </div><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--teleport start--><!--teleport end--><!---->
               </div>
              </div>
             </div><!--[--><!--]-->
             <div class="tm-article-presenter__footer">
              <!--[--><!--[-->
              <div class="tm-article-blocks">
               <!----><!--[-->
               <section class="tm-block tm-block tm-block_spacing-bottom">
                <!----><!--[-->
                <div class="tm-block__body tm-block__body tm-block__body_variant-balanced">
                 <!--[-->
                 <div class="tm-article-author" data-test-id="article-author-info" data-async-called="true">
                  <!--[--><!--[-->
                  <div class="tm-article-author__company">
                   <div class="tm-article-author__company-card">
                    <div class="tm-company-snippet">
                     <a href="/ru/companies/rtk_service/profile/" class="tm-company-snippet__logo-link">
                      <div class="tm-entity-image">
                       <img alt="" class="tm-entity-image__pic" height="40" src="//habrastorage.org/getpro/habr/company/c54/0b3/20b/c540b320b21dcbd5c351f5dd831afca9.jpg" width="40">
                      </div></a>
                     <div class="tm-company-snippet__info">
                      <a href="/ru/companies/rtk_service/profile/" class="tm-company-snippet__title" data-test-id="company-title"><span>РТК-Сервис</span></a>
                      <div class="tm-company-snippet__description">
                       Компания
                      </div>
                     </div>
                    </div>
                    <div class="tm-article-author__buttons">
                     <!----><!---->
                    </div>
                   </div>
                   <div class="tm-article-author__company-contacts">
                    <!--[--><a class="tm-article-author__contact" href="https://www.rtk-service.ru/" rel="noopener" target="_blank">Сайт</a><!--]-->
                   </div>
                   <div class="tm-article-author__separator"></div>
                  </div><!--]--><!--]-->
                  <div class="tm-user-card tm-user-card tm-user-card_variant-article tm-article-author__user-card" data-async-called="true">
                   <div class="tm-user-card__info-container">
                    <div class="tm-user-card__header">
                     <div class="tm-user-card__header-data">
                      <a href="/ru/users/Denis_Vdovin/" class="tm-user-card__userpic tm-user-card__userpic_size-40">
                       <div class="tm-entity-image">
                        <!--[--><img alt="" class="tm-entity-image__pic" src="https://assets.habr.com/habr-web/img/avatars/025.png"><!--]-->
                       </div></a>
                      <div class="tm-user-card__meta">
                       <div class="tm-counter-container karma" title=" 3 голоса " data-v-f7c0e283>
                        <div class="tm-counter-container__header">
                         <!--[-->
                         <div class="karma-display positive" data-v-f7c0e283 data-v-7635202e>
                          3
                         </div><!----><!--]-->
                        </div>
                        <div class="tm-counter-container__footer">
                         <!--[-->
                         <div class="karma-text" data-v-f7c0e283>
                          Карма
                         </div><!--teleport start--><!--teleport end--><!--]-->
                        </div>
                       </div>
                       <div class="tm-counter-container" title="Рейтинг пользователя">
                        <div class="tm-counter-container__header">
                         <!--[--><!--[--><!--]-->
                         <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating">
                          <!---->
                          <div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score">
                           <!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">6</span></span><!--]-->
                          </div><!---->
                         </div><!--]-->
                        </div>
                        <div class="tm-counter-container__footer">
                         <!--[--><span class="tm-rating__text tm-rating__text">Рейтинг</span><!--]-->
                        </div>
                       </div>
                      </div>
                     </div>
                    </div>
                    <div class="tm-user-card__info tm-user-card__info_variant-article tm-user-card__info">
                     <div class="tm-user-card__title tm-user-card__title_variant-article tm-user-card__title">
                      <!----><a href="/ru/users/Denis_Vdovin/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"> @Denis_Vdovin</a><!---->
                     </div>
                     <p class="tm-user-card__short-info tm-user-card__short-info_variant-article tm-user-card__short-info" data-test-id="user-card-speciality">Пользователь</p>
                    </div>
                   </div><!---->
                   <div class="tm-user-card__buttons tm-user-card__buttons_variant-article tm-user-card__buttons">
                    <!---->
                    <div class="tm-user-card__button">
                     <div class="tm-button-follow tm-user-card__button-follow">
                      <!---->
                      <button class="tm-button-follow__button tm-button-follow__button_big" data-test-id="follow-button" type="button">Подписаться</button>
                     </div>
                    </div><!---->
                    <div class="tm-user-card__button tm-user-card__button_write" data-test-id="user-card-conversations">
                     <svg class="tm-svg-img tm-user-card__button-icon" height="16" width="16">
                      <title>
                       Отправить сообщение
                      </title><use xlink:href="/img/megazord-v28.7909a852..svg#mail"></use>
                     </svg>
                    </div><!---->
                   </div><!---->
                  </div>
                  <div class="tm-article-author__user-contacts" data-test-id="author-contacts">
                   <!----><!----><!---->
                  </div>
                 </div><!--]-->
                </div><!--]--><!---->
               </section><!----><!--[--><!--]--><!--]-->
               <div class="tm-article-blocks__comments">
                <div id="publication-comments" class="tm-article-page-comments">
                 <div>
                  <!--[-->
                  <div class="tm-article-comments-counter-link tm-article-comments-counter-button">
                   <a href="/ru/companies/rtk_service/articles/907262/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" data-test-id="counter-comments"><!--[-->
                    <svg class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted" height="24" width="24">
                     <title>
                      Комментарии
                     </title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use>
                    </svg><span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted"> Комментарии 3 </span><!--]--></a><!---->
                  </div><!--]-->
                 </div>
                </div>
               </div><!--[--><!--[--><!--]-->
               <section class="tm-block tm-block tm-block_spacing-bottom">
                <header class="tm-block__header tm-block__header tm-block__header_variant-borderless">
                 <div class="tm-block__header-container">
                  <h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2><!--[--><!--]-->
                 </div><!---->
                </header><!--[-->
                <div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim">
                 <!--[--><!--[-->
                 <div class="tm-tabs tm-tabs">
                  <div class="">
                   <!--[--><span class="tm-tabs__tab-item">
                    <button class="tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim tm-tabs__tab-link">Лучшие за сутки</button></span><span class="tm-tabs__tab-item">
                    <button class="tm-tabs__tab-link tm-tabs__tab-link_slim tm-tabs__tab-link">Похожие</button></span><!--]-->
                  </div><!---->
                 </div>
                 <div class="similar-and-daily__tab-view">
                  <div class="placeholder-wrapper">
                   <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                   <div class="tm-placeholder-article-cards">
                    <!--[-->
                    <div class="tm-placeholder-article-card">
                     <div class="tm-placeholder__user">
                      <div class="tm-placeholder__user-pic loads"></div>
                      <div class="tm-placeholder__user-date loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__title">
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                      <!--[-->
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div><!--]-->
                     </div>
                    </div>
                    <div class="tm-placeholder-article-card">
                     <div class="tm-placeholder__user">
                      <div class="tm-placeholder__user-pic loads"></div>
                      <div class="tm-placeholder__user-date loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__title">
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                      <!--[-->
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div><!--]-->
                     </div>
                    </div>
                    <div class="tm-placeholder-article-card">
                     <div class="tm-placeholder__user">
                      <div class="tm-placeholder__user-pic loads"></div>
                      <div class="tm-placeholder__user-date loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__title">
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                      <!--[-->
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div><!--]-->
                     </div>
                    </div>
                    <div class="tm-placeholder-article-card">
                     <div class="tm-placeholder__user">
                      <div class="tm-placeholder__user-pic loads"></div>
                      <div class="tm-placeholder__user-date loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__title">
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                      <!--[-->
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div><!--]-->
                     </div>
                    </div>
                    <div class="tm-placeholder-article-card">
                     <div class="tm-placeholder__user">
                      <div class="tm-placeholder__user-pic loads"></div>
                      <div class="tm-placeholder__user-date loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__title">
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                      <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                     </div>
                     <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                      <!--[-->
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div>
                      <div class="tm-placeholder-data-icon">
                       <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div>
                       <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                      </div><!--]-->
                     </div>
                    </div><!--]-->
                   </div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
                  </div><!---->
                 </div><!--]--><!--]-->
                </div><!--]--><!---->
               </section><!--[--><!--]--><!----><!--[--><!--]--><!--]-->
              </div><!--]--><!--]-->
             </div>
            </div><!--]--><!--]-->
           </div>
          </div>
          <div class="tm-page__sidebar">
           <!--[-->
           <div class="tm-layout-sidebar">
            <div class="tm-layout-sidebar__placeholder_initial"></div>
            <div class="tm-sexy-sidebar_initial tm-sexy-sidebar" style="margin-top:0px;">
             <!--[--><!--]--><!---->
             <div class="tm-layout-sidebar__placeholder_initial"></div><!--[-->
             <section class="tm-block tm-block tm-block_spacing-bottom">
              <header class="tm-block__header tm-block__header">
               <div class="tm-block__header-container">
                <h2 class="tm-block__title tm-block__title">Информация</h2><!--[--><!--]-->
               </div><!---->
              </header><!--[-->
              <div class="tm-block__body tm-block__body">
               <!--[-->
               <div class="tm-company-basic-info">
                <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                 <dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap tm-description-list__title">
                  Сайт
                 </dt>
                 <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap tm-description-list__body">
                  <!--[--><a class="tm-company-basic-info__link" href="https://www.rtk-service.ru/" target="_blank">www.rtk-service.ru</a><!--]-->
                 </dd>
                </dl><!----><!---->
                <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                 <dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap tm-description-list__title">
                  Численность
                 </dt>
                 <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap tm-description-list__body">
                  <!--[-->501–1 000 человек<!--]-->
                 </dd>
                </dl><!----><!---->
               </div><!--]-->
              </div><!--]--><!---->
             </section>
             <div class="tm-company-widgets">
              <!--[--><!--]-->
             </div><!----><!----><!--]--><!---->
            </div>
           </div><!--]-->
          </div>
         </div><!----><!--]-->
        </div>
       </div>
      </main><!---->
     </div>
     <div class="tm-footer-menu">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-footer-menu__container">
        <!--[-->
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Ваш аккаунт</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/companies/rtk_service/articles/907262/&amp;hl=ru" rel="nofollow" target="_self">Войти</a></li>
           <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/companies/rtk_service/articles/907262/&amp;hl=ru" rel="nofollow" target="_self">Регистрация</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Разделы</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/ru/articles/" class="footer-menu__item-link">Статьи</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">Новости</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">Хабы</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">Компании</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">Авторы</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">Песочница</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Информация</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">Для авторов</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">Для компаний</a></li>
           <li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">Документы</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">Соглашение</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">Конфиденциальность</a></li><!--]-->
          </ul>
         </div>
        </div>
        <div class="tm-footer-menu__block">
         <p class="tm-footer-menu__block-title">Услуги</p>
         <div class="tm-footer-menu__block-content">
          <ul class="tm-footer-menu__list">
           <!--[-->
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">Корпоративный блог</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">Медийная реклама</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">Нативные проекты</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">Образовательные программы</a></li>
           <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">Стартапам</a></li><!--]-->
          </ul>
         </div>
        </div><!--]-->
       </div><!--]-->
      </div>
     </div>
     <div class="tm-footer">
      <div class="tm-page-width">
       <!--[-->
       <div class="tm-footer__container">
        <!---->
        <div class="tm-footer__social">
         <!--[--><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Facebook
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-facebook"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Twitter
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-twitter"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            VK
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Telegram
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Youtube
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use>
          </svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank">
          <svg class="tm-svg-img tm-svg-icon" height="24" width="24">
           <title>
            Яндекс Дзен
           </title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use>
          </svg></a><!--]-->
        </div><!--teleport start--><!--teleport end-->
        <button class="tm-footer__link"><!----> Настройка языка</button><a href="/ru/feedback/" class="tm-footer__link">Техническая поддержка</a>
        <div class="tm-footer-copyright">
         <span class="tm-copyright"><span class="tm-copyright__years">© 2006–2025, </span><span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank">Habr</a></span></span>
        </div>
       </div><!--]-->
      </div>
     </div><!----><!--]-->
    </div><!---->
   </div>
   <script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"907262":{"id":"907262","timePublished":"2025-05-06T09:05:41+00:00","isCorporative":true,"lang":"ru","titleHtml":"Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?","leadData":{"textHtml":"\u003Cp\u003EВсем привет! Меня зовут \u003Cs\u003Eя сам прихожу\u003C\u002Fs\u003E Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась \u003Cs\u003Eс салата \u003C\u002Fs\u003Eеще в зимние каникулы. В ней в разных пропорциях смешались ISIS, QoS, загадочный PTPv2, распределение Пуассона, теория массового обслуживания и LTE TDD, отчего она показалась мне крайне интересна и достойна публикации отдельной статьей.\u003C\u002Fp\u003E\u003Cp\u003EСей трактат, направленный на решение конкретной прикладной проблемы, будет довольно длинным и с каждым листом А4 сложность для понимания будет нарастать. Затрагиваются, казалось бы, совсем далекие друг от друга галактики, поэтому если вы где-то не смогли уследить за руками факира — это норма. Главное, что в конце вас ждет награда - мы научимся вычислять джиттер на обычном калькуляторе по графикам из Заббикса. Поехали!\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4d1\u002F4d4\u002Fa8d\u002F4d14d4a8d686a6e7a9e642d1b3844714.jpg","buttonTextHtml":"Поехали","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4d1\u002F4d4\u002Fa8d\u002F4d14d4a8d686a6e7a9e642d1b3844714.jpg","fit":"cover","positionY":33,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"4898875","alias":"Denis_Vdovin","fullname":null,"avatarUrl":null,"speciality":null,"scoreStats":{"score":3,"votesCount":3},"rating":6,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"donationsMethod":null,"isInBlacklist":null,"careerProfile":null},"statistics":{"commentsCount":3,"favoritesCount":9,"readingCount":1111,"score":6,"votesCount":4,"votesCountPlus":4,"votesCountMinus":0},"hubs":[{"id":"23423","alias":"rtk_service","type":"corporative","title":"Блог компании РТК-Сервис","titleHtml":"Блог компании РТК-Сервис","isProfiled":false,"relatedData":null},{"id":"7606","alias":"tdd","type":"collective","title":"TDD","titleHtml":"TDD","isProfiled":true,"relatedData":null},{"id":"21958","alias":"network_hardware","type":"collective","title":"Сетевое оборудование","titleHtml":"Сетевое оборудование","isProfiled":false,"relatedData":null},{"id":"17123","alias":"network_technologies","type":"collective","title":"Сетевые технологии","titleHtml":"Сетевые технологии","isProfiled":true,"relatedData":null},{"id":"221","alias":"sys_admin","type":"collective","title":"Системное администрирование","titleHtml":"Системное администрирование","isProfiled":true,"relatedData":null}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование","titleHtml":"Администрирование"},{"id":"7","alias":"popsci","title":"Научпоп","titleHtml":"Научпоп"}],"relatedData":{"vote":null,"unreadCommentsCount":0,"bookmarked":false,"canComment":false,"canEdit":false,"canViewVotes":false,"votePlus":{"canVote":false,"isChargeEnough":false,"isKarmaEnough":false,"isVotingOver":false,"isPublicationLimitEnough":false},"voteMinus":{"canVote":false,"isChargeEnough":false,"isKarmaEnough":false,"isVotingOver":false,"isPublicationLimitEnough":false},"canModerateComments":false,"trackerSubscribed":false,"emailSubscribed":false},"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F824\u002Fe44\u002F989\u002F824e44989117fd1fa43106402d5d0e7e.jpg\" width=\"1018\" height=\"739\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F824\u002Fe44\u002F989\u002F824e44989117fd1fa43106402d5d0e7e.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F824\u002Fe44\u002F989\u002F824e44989117fd1fa43106402d5d0e7e.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВсем привет! Меня зовут \u003Cs\u003Eя сам прихожу\u003C\u002Fs\u003E Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась \u003Cs\u003Eс салата \u003C\u002Fs\u003Eеще в зимние каникулы. В ней в разных пропорциях смешались ISIS, QoS, загадочный PTPv2, распределение Пуассона, теория массового обслуживания и LTE TDD, отчего она показалась мне крайне интересна и достойна публикации отдельной статьей.\u003C\u002Fp\u003E\u003Cp\u003EСей трактат, направленный на решение конкретной прикладной проблемы, будет довольно длинным и с каждым листом А4 сложность для понимания будет нарастать. Затрагиваются, казалось бы, совсем далекие друг от друга галактики, поэтому если вы где-то не смогли уследить за руками факира — это норма. Главное, что в конце вас ждет награда - мы научимся вычислять джиттер на обычном калькуляторе по графикам из Заббикса. Поехали.\u003C\u002Fp\u003E\u003Cp\u003EК исходу десятого дня новогодних праздников, когда оливьешка, к слову, уже далеко не первой свежести, методично доламывала остатки нейронных связей в мозгу, замещая собой серое вещество, откуда-то из недр памяти всплыли мимолетом сказанные пару месяцев назад заказчиком слова, что у них есть сотни секторов БС LTE TDD и они не работают. Надо сказать, что на сетях заказчиков мы выполняем полный комплекс настроечных и монтажных работ: пишем HLD и LLD, готовим спецификации, монтируем и кроссируем, после чего долго и упорно, нажимая кнопки, претворяем в жизнь идеи, заложенные в дизайне. Короче, делаем сеть высокой культуры и быта «под ключ». И вот подумалось, это как это так, когда мы после нескольких десятков бессонных ночей уже почти закончили приведение сети из сотен маршрутизаторов к целевому дизайну, у нас там нестареющий MPLS, всякие FRR (которые FastReRoute), куда ж без него - BGP, на подходе сложнейший QoS, а какое-то там LTE не работает? Да что оно себе позволяет? И закипела кровь от такой несправедливости!\u003C\u002Fp\u003E\u003Ch2\u003EЧто за зверь LTE TDD?\u003C\u002Fh2\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd68\u002F20d\u002Fc7c\u002Fd6820dc7c216e1684b4eb38781f91d68.jpg\" width=\"803\" height=\"609\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd68\u002F20d\u002Fc7c\u002Fd6820dc7c216e1684b4eb38781f91d68.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd68\u002F20d\u002Fc7c\u002Fd6820dc7c216e1684b4eb38781f91d68.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак говорится, чтобы починить что-то неработающее, надо \u003Cs\u003Eслучайно сломать что-то работающее\u003C\u002Fs\u003E понять, что ж там конкретно не работает и к какому снаряду мы вообще подходим. Перво-наперво проведенный опрос свидетелей показал, что проблема действительно существует в заявленном виде. У заказчика (оператора фиксированной и мобильной связи) есть базовые станции разных поколений: 2G, 3G, 4G (LTE), которые связаны с контроллерами через таким трудом перенастраиваемую нами сеть MPLS (т. н. MBH – Mobile Backhaul – модненькое название обычной сети, по которой гоняются сервисы мобильной сети). В целом как бы все работает, но вот для предоставления 4G используется две технологии: LTE FDD и LTE TDD. С первой все хорошо, а со второй не очень. Точнее очень нехорошо. При включении базовой станции (БС) в системе управления вываливаются аварии о потере синхронизации, а на соседних БС (в т.ч. FDD) начинаются какие-то проблемы, из-за чего даже принято решение вывести сектора из эфира (а это, на минуточку, когда-то были миллионы инвестиций). Оказывается, базовые станции TDD, например, существенно дешевле своих FDDшных собратьев, но более требовательны к качеству синхронизации (это нам пока вообще ни о чем не говорит). Лучше всего синхронизируют системы спутникового позиционирования GPS\u002FГЛОНАСС\u002FBaidu. Когда это дело закупалось, что GPS, что ГЛОНАСС были безлимитными и чем-то совершенно естественным и доступным в любом месте страны, как воздух, солнце и вода. Но в 2022 году средствами РЭБ сигнал был много где (но не везде) заглушен, и на бОльшей части БС LTE TDD праздник мобильного интернета закончился. И уже почти три года бОльшая часть секторов греют воздух, вместо того чтобы радовать абонентов видосиками и мемасиками, потому что на альтернативном источнике PTPv2 оно не заработало. Видимо, куда-то сюда и надо будет копать.\u003C\u002Fp\u003E\u003Cp\u003EС предысторией немного разобрались, пора понять, что это за технологии.\u003C\u002Fp\u003E\u003Cp\u003EПредупреждение: читателям из мобильного мира и просто с тонкой душевной организацией просьба закрыть глаза на следующие пару абзацев, чтобы ваши чувства случайно не были оскорблены неточностью терминологии или некорректным описанием принципов. Для выстраивания общей картины сказать несколько слов про ваши технологии так и так придется, не обессудьте.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003ELTE FDD\u003C\u002Fstrong\u003E – Frequency Division Duplex – частотное разделение.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F35c\u002F202\u002F7a9\u002F35c2027a96be852b5b44139b0e28f3e0.jpg\" width=\"222\" height=\"212\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F35c\u002F202\u002F7a9\u002F35c2027a96be852b5b44139b0e28f3e0.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F35c\u002F202\u002F7a9\u002F35c2027a96be852b5b44139b0e28f3e0.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗа каждым оператором специальным органом ГКРЧ (Государственная комиссия по радиочастотам) по результатам гладиаторских боев (в формате все против всех, а нынче у кого толще кошелек) в каждом регионе присутствия закрепляется (или не закрепляется) некий спектр частот (для простоты — несущих). Правило простое: чем спектр шире, тем быстрее будет загружаться рутуб, тем счастливее будут абоненты. Поэтому за частоты борьба идет не на жизнь, а насмерть. А с трибуны за этим действом наблюдают военные, которые знают, что частота все равно останется у них :-)). Downlink и Uplink разнесены по разным частотам. Т.е. вместо одной на базу нужно две. \u003C\u002Fp\u003E\u003Cp\u003EЧтобы было понятнее, что за страшное испытание выпало на долю коллег из мобильного мира — это сродни тому, как в пакетных сетях получить новый блок IPv4. Если не получилось (а это не получилось), то в ход идут NAT, CG-NAT, NAToverNAT, а от безысходности и IPv6. И вот, несчастные операторы сотовой связи, жонглируя этими немногочисленными несущими, пытаются с одной стороны выжать максимум с одной БС, а с другой – размазать диапазон на весь город, чтобы одна БС не мешала другой (условно говоря, БС на одной частоте должны светить в разные стороны или находиться в разных частях города). И эти частоты нужно изолировать друг друга промежутками, а это неэффективное использование ценного ресурса. А ведь еще кто-то нехороший залазит на твою частоту. А еще используются очень сложные технологии кодирования и мультиплексирования типа OFDM, из-за чего оборудование существенно дороже (правда, скорости и дальность чудо как хороши). В ход идут разные ухищрения: рефарминг (перераспределение частот между технологиями), запуск VoLTE, отключение 3G, MVNO и т. д. Ужас-ужас, в общем, как сложно, поэтому у каждого оператора есть большие отделы ПиО (планирование и оптимизация), которые в эти шахматы на ежедневной основе вынуждены играть без перерывов на выходные и обед. Так или иначе, технология FDD доминирует в мире LTE, на ней построено большинство сетей.\u003C\u002Fp\u003E\u003Cp\u003EКак водится, есть второй способ подойти к снаряду: \u003Cstrong\u003ELTE TDD\u003C\u002Fstrong\u003E – Time Division Duplex – временное разделение.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd8\u002F845\u002F5c8\u002Fdd88455c8f2824d034e2a5cb4922bfaa.jpg\" width=\"507\" height=\"490\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd8\u002F845\u002F5c8\u002Fdd88455c8f2824d034e2a5cb4922bfaa.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd8\u002F845\u002F5c8\u002Fdd88455c8f2824d034e2a5cb4922bfaa.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EDownlink и Uplink работают на одной частоте, но под них выделяются разные временные промежутки (таймслоты), в зависимости от регулировки которых можно получать разное соотношение upload и download, не тратя драгоценную несущую (на картинке, кстати, полоса поделена 50\u002F50). Технология использует более простые алгоритмы модуляции, оборудование стоит дешевле, пинги больше, а главное, не очень-то распространена из-за текущих ограничений по скорости, дальности и требований к точности синхронизации (чтобы это ни значило). Из-за этого желающих ее использовать не то, чтобы вагон, а скромная маленькая тележка, в которой, как оказалось, мы путешествуем вместе с заказчиком. Вероятно, со временем к этой технологии присмотрятся более пристально, т.к. там еще есть свободные частоты.\u003C\u002Fp\u003E\u003Ch2\u003EСинхронизация — кто ты такое?  \u003C\u002Fh2\u003E\u003Cp\u003EЕсть в нашем мире коммутаторов и маршрутизаторов несколько вещей, которые выбиваются из стройной пакетной парадигмы, как-то отторгаются, что ли, нашим ethernet-сознанием. На мой взгляд, это мультикаст во всех его проявлениях (кроме, может, MVPN), QoS и синхронизация (а в последнее время и BGP из-за приставки MP- становится все менее уютным и ламповым) — страшно далеки они от нашей повседневной жизни, наполненной ip и mpls-заголовками.\u003C\u002Fp\u003E\u003Cp\u003EТак или иначе, но без синхронизации в мобильных (да и во многих других, например, энергетических, финансовых, военных) сетях — никуда. Последние 15 лет пакетный транспорт вытеснял-вытеснял, да так и недовытеснил TDM, но подвинул солидно. Для этого ему пришлось научиться в синхронизацию. Как говорилось выше, можно сделать дорого и красиво, просто прикрутив к каждому потребителю\u002Fмаршрутизатору по GPS-модулю (дополнительное оборачивание в консервную банку для преодоления РЭБа не предлагать!), а можно попытаться передать синхронизацию через сеть. Ведь TDM-транспорт с этим как-то же справляется? Давайте и мы попробуем разобраться, что там у нас в пакетке было придумано.\u003C\u002Fp\u003E\u003Cp\u003EНо сначала предлагаю узнать, что бы этакого можно было засинхронизировать, и зачем это надо. Фаза, время дня, частота, амплитуда. Все это хорошо понятно радиоинженерам и любителям электроники, а для тех, кто страшно далек от этих вещей, есть вот такой жизненный пример, который я подсмотрел на каком-то форуме. Значит, примерно за месяц-два до Парада на 9 Мая начинаются мероприятия по подготовке.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe4a\u002Fef5\u002F8d4\u002Fe4aef58d49873335bb02936a8a28a93a.jpg\" width=\"1200\" height=\"800\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe4a\u002Fef5\u002F8d4\u002Fe4aef58d49873335bb02936a8a28a93a.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe4a\u002Fef5\u002F8d4\u002Fe4aef58d49873335bb02936a8a28a93a.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗадача, надо сказать, нетривиальная. Заставить несколько тысяч человек шагать в ногу. В чем тут проблема? Поначалу каждый, чувствуя в себе личность, еще не подавленную железной волей командира, норовит шагнуть в случайный момент времени. В словах «шагом марш» без учета многозначительной паузы набирается 9 букв. Кто на какую стартанет — неизвестно. Т.е. не выровнено абсолютное время старта. Далее — этот ниже, этот выше, этому сапог жмет — длина шага у всех будет разная (т. е. кто-то будет убегать вперед, а кто-то отставать — в итоге с фазой каждого следующего шага начинаются проблемы). Ну и усиливают трескучие боли в седой голове командира проблемы с частотой шага — этот спешит, этот вразвалочку. В итоге картина ежегодно за месяц до парада вырисовывается совершенно неприглядная, и на взгляд обывателя даже катастрофическая. Но в ходе нудных и трудных ежедневных тренировок производится синхронизация всех участников, как внутри парадных коробочек, так и между ними. Общее движение всей колонны начинается в одно и то же время, далее каждый шаг начинается у всех в одно время (фаза), с одинаковой длиной (амплитуда) и происходит с одной частотой. Надеюсь, стало понятнее.\u003C\u002Fp\u003E\u003Cp\u003EИли вот дирижер машет палочкой. Это он не просто так делает, чтобы ему потом восторженные зрители в ладошки похлопали.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8c2\u002F46a\u002F636\u002F8c246a6363c39a4d1c33f571e888f20b.jpg\" width=\"1216\" height=\"832\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8c2\u002F46a\u002F636\u002F8c246a6363c39a4d1c33f571e888f20b.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8c2\u002F46a\u002F636\u002F8c246a6363c39a4d1c33f571e888f20b.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПеред глазами оркестрантов — только ноты, в которых указано, какие звуки надо извлечь из инструмента. Музыкантов в яму посажено много, они громкие и никого, кроме себя, как бы эгоистично ни было, не слышат, особенно кто дудит в духовые. А вот глядя на взмахи палочки дирижера (и его выразительно говорящие глаза), можно понять, насколько усердно и с какой частотой надо лупить по струнам. В итоге тромбон и арфа, сидящие в разных частях ямы, что называется, попадают в одни и те же ноты. Такой вот кожаный тактово-амплитудный синхронизатор. Так что, если вам понравилась музыка, то 50% успеха — на дирижере. И ест свой хлеб он не зря.  \u003C\u002Fp\u003E\u003Ch2\u003EПротоколы синхронизации в Ethernet и IP-сетях  \u003C\u002Fh2\u003E\u003Cp\u003EИтак, на текущий момент в ходу есть несколько протоколов синхронизации: NTP (и его отпрыск для локальных сетей SNTP), 1588v2 он же PTPv2, SyncE.\u003C\u002Fp\u003E\u003Cp\u003EСинхру можно передать на разных уровнях модели OSI: физическом, канальном, сетевом.\u003C\u002Fp\u003E\u003Cp\u003EЕсть разные потребители синхронизации, которые хотят разное и в разных комбинациях: абсолютное время (время суток), частоту, фазу (по-другому время, но не путать с абсолютным).\u003C\u002Fp\u003E\u003Cp\u003EНаверное, первый протокол синхронизации, который появился и крайне активно используется в пакетных сетях — \u003Cstrong\u003ENTP\u003C\u002Fstrong\u003E – Network Time Protocol.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F79a\u002F38d\u002F926\u002F79a38d92692c8985ff8736205143b6e6.jpg\" width=\"341\" height=\"200\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F79a\u002F38d\u002F926\u002F79a38d92692c8985ff8736205143b6e6.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F79a\u002F38d\u002F926\u002F79a38d92692c8985ff8736205143b6e6.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсть сервер точного времени, у которого клиент запрашивает это самое точное время. Работает в т.ч. через сеть интернет, поэтому точность его невелика, измеряется в миллисекундах. Условно говоря, если нужно выставить часы, чтобы будильник вовремя зазвонил или в лог-файле была временная отметка — великолепное решение. Все компьютеры в мире им пользуются и никто не жалуется. Раз интернет, значит, работает поверх IP, т.е. на сетевом уровне. Фактически протокол выполняет синхронизацию \u003Cem\u003Eабсолютного времени \u003C\u002Fem\u003Eили\u003Cem\u003E времени суток\u003C\u002Fem\u003E. Не так давно в российском сегменте интернета \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fyandex\u002Farticles\u002F861538\u002F\"\u003Eбыли большие проблемы\u003C\u002Fa\u003E с NTP, отчего части вирусологов и экспертов в области международной политики, вероятно, даже пришлось переквалифицироваться в ntpлогов.\u003C\u002Fp\u003E\u003Cp\u003EНельзя просто так взять и закопать TDM, не взяв оттуда принцип частотной синхронизации. Сказано — сделано. Держите протокол \u003Cstrong\u003ESyncE \u003C\u002Fstrong\u003E– Synchronous Ethernet – в чистом виде косплей на \u003Cem\u003Eчастотную\u003C\u002Fem\u003E синхронизацию из TDM. Работает на физическом уровне.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F816\u002F522\u002Fc15\u002F816522c15da1e6fe1b2420dbfe03e55e.jpg\" alt=\"Картинка отсюда\" title=\"Картинка отсюда\" width=\"480\" height=\"261\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F816\u002F522\u002Fc15\u002F816522c15da1e6fe1b2420dbfe03e55e.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F816\u002F522\u002Fc15\u002F816522c15da1e6fe1b2420dbfe03e55e.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003Cdiv\u003E\u003Cfigcaption\u003EКартинка \u003Ca href=\"https:\u002F\u002Ftf.zone\u002Fsolutions\u002Farchitecture-and-testing-of-network-synchronization-systems\u002F\"\u003Eотсюда\u003C\u002Fa\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Fdiv\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ сети есть эталонный источник, который передает эталонную частоту. Каждая транспортная железка на пути до потребителя должна поддерживать этот протокол, имея на борту отдельный чип для обработки физического синхросигнала. И это сложность, потому что аппаратная поддержка — это затраты на оборудование. А помимо этого, у ряда вендоров возникают и лицензионные ограничения. В общем, это уже серьезный протокол за серьезные деньги, который умеет передавать только частоту. И нужно хорошо понимать, кому и зачем он нужен. Сам протокол разбирать не будем, он выходит за рамки статьи. Общая архитектура красиво изображена в википедии.  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6fd\u002F158\u002F662\u002F6fd1586622e52aee469fecb188bf2661.jpg\" width=\"481\" height=\"292\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6fd\u002F158\u002F662\u002F6fd1586622e52aee469fecb188bf2661.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6fd\u002F158\u002F662\u002F6fd1586622e52aee469fecb188bf2661.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНу и, наверное, вишенкой на нашем прекрасном торте синхронизации и вершиной инженерной мысли является стандарт IEEE 1588, второе имя ему PTP – Precision Time Protocol. Есть две версии 1 и 2. Одна старая, другая новая, они между собой несовместимы. Смотреть будем на самую молоденькую от 2008 года \u003Cstrong\u003E1588v2\u003C\u002Fstrong\u003E \u003Cstrong\u003Eили\u003C\u002Fstrong\u003E \u003Cstrong\u003EPTPv2. \u003C\u002Fstrong\u003EЗаявленная точность измеряется в наносекундах, что очень жирно и на 5-6 порядков лучше, чем у NTP. Умеет синхронизировать \u003Cem\u003Eабсолютное время, фазу и частоту.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cp\u003EМне, как человеку, у которого всю жизнь перед глазами туда-сюда мельтешат пакеты в асинхронном режиме, где задержки в буфере составляют десятки миллисекунд, решительно непонятно было, каким образом можно было заставить пакетную сеть передавать синхронизацию. Ну ладно время еще, ладно фазу, но частоту-то как, камон? В этом, наверное, и есть гениальность людей, которые все эти протоколы изобретают. Будем разбираться.\u003C\u002Fp\u003E\u003Cp\u003EГлавной особенностью PTPv2 является то, что он как кофе 3 в 1 — дешевый (не всегда), желанный и умеет сразу все — передавать абсолютное время, фазу и частоту. Сам по себе 1588v2 в живой природе себя особо не проявил. Фактически он описывает набор сигнальных сообщений, правила их обработки и математику, по которой вычисляются требуемые потребителям величины. И имя ему \u003Cstrong\u003E1588v2 Default Profile\u003C\u002Fstrong\u003E. Это база. Просто транспорт для практических реализаций, если хотите. А уже дальше товарищи из разных отраслей народного хозяйства дополнили протокол профилями под собственные нужды: телекоммуникационный, энергетический, финансовый, военный. Профили отличаются видами транспорта (ethernet, ip), требуемой точностью, частотой отправки сигнальных сообщений, видами поддерживаемой синхронизации.\u003C\u002Fp\u003E\u003Cp\u003EНо давайте сперва про сам 1588v2. Чтение, наверное, лучше начать вот с \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F163253\u002F\"\u003E\u003Cstrong\u003Eэтой статьи\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EС аппаратной точки зрения в простейшем виде это сервер, который по сути своей владеет только сакральным знанием о точном мировом времени. Где уж он его берет — от GPS, ПЗГ, ВЗГ, SDH, атомных часов или сам придумывает – значения для нас не имеет. Там есть специальные люди, которые в этом очень сильно разбираются и всю эту синхронизацию в масштабах мира поддерживают. Далее есть клиент, который умеет получать сигнал точного времени и выгодным для себя образом интерпретировать, попутно задавая серверу наводящие вопросы. С программной точки зрения это всего-навсего 2 простейших сигнальных сообщения, которые всю эту магию и колдуют:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003EAnnounce\u003C\u002Fstrong\u003E – сервер рассказывает о своих возможностях, настроенном профиле, поддерживаемых видах синхронизации, классе точности. Посылается нечасто, что-то типа Hello в других протоколах, где он описывает, что жив-здоров и свои возможности. Потребитель по этому сообщению выбирает тот сервер, который ему больше мил и люб.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003ESync\u003C\u002Fstrong\u003E – сервер отправляет в сторону клиентов данные о своем времени (timestamp). А вот это уже самое главное. На основе сообщения Sync происходит синхронизация абсолютного времени (без поправки на задержку), и, что самое волшебное, частоты. Как? Разберемся чуть позже.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003EDelayReq\u003C\u002Fstrong\u003E и \u003Cstrong\u003EDelayResp\u003C\u002Fstrong\u003E – для того, чтобы сделать время более точным, необходимо убрать из расчетов задержку, возникающую при передаче пакетов через сеть (мы ведь помним, что все эти сообщения — это просто пакеты?). Клиент отправляет в сторону сервера сообщение DelayReq и получает в ответ с DelayResp. Ну дальше включается калькулятор, который по двум нехитрым формулам корректирует абсолютное время и фазу.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсть и еще сообщения, но они нам не особо интересны, т. к. суть не раскрывают.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EТеперь давайте в картинках разберемся, какое сообщение (Sync, DelayReq, DelayResp) на что влияет. Право, я перечитал множество статей с формулами несколько раз, но доходило крайне туго, пока не увидел у какого-то интуриста расчеты на конкретных числах.\u003C\u002Fp\u003E\u003Cp\u003EПоехали. Одно единственное сообщение Sync самым примитивным образом корректирует абсолютное время на клиенте.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F23d\u002Fe71\u002F3c5\u002F23de713c5659465259a68cb89a3a422c.jpg\" width=\"367\" height=\"381\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F23d\u002Fe71\u002F3c5\u002F23de713c5659465259a68cb89a3a422c.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F23d\u002Fe71\u002F3c5\u002F23de713c5659465259a68cb89a3a422c.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВот так незамысловато сервер вставил в пакет Sync текущую метку своего точного времени (в примере 0 секунд), отправил пакет по сети, где он, судя по графику, летел 1 секунду. У клиента в это время была своя рандомная шкала времени. На момент прихода пакета Sync натикало 19 секунд. Клиент просто берет и покорно применяет себе время сервера, не думая ни о каких задержках. \u003C\u002Fp\u003E\u003Cp\u003EТакс, самое простое позади, очень примерно выставили время, пусть это делу пока особо и не поможет.\u003C\u002Fp\u003E\u003Cp\u003EНо мы же знаем, что пакет по сети летит какое-то время, накапливая все большую и большую задержку: обработка маршрутизатором (наносекунды), буферизация (миллисекунды), сериализация (время передачи в линию — от наносекунд до миллисекунд в низкоскоростных линиях типа ADSL), передача по линии (где чем длиннее линия, тем больше задержка, например на спутниковых каналах легко набегает по 200мс в одну сторону). И вот эту задержку нам бы надо компенсировать. Делается это с помощью сообщений DelayReq и DelayResp.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F957\u002F54f\u002F462\u002F95754f462fe9926ea4a103dac4f824cf.jpg\" width=\"454\" height=\"383\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F957\u002F54f\u002F462\u002F95754f462fe9926ea4a103dac4f824cf.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F957\u002F54f\u002F462\u002F95754f462fe9926ea4a103dac4f824cf.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКлиент, ежели ему зачем-то надо (а оно не всегда так) выяснить совсем точное время, отправляет сообщение DelayReq с указанием своего абсолютного времени отправки (1 секунда). Сервер, немного подумав (неважно сколько), в ответ отправляет сообщение DelayResp, указав, что он получил это сообщение в 3 секунды по своей шкале. Клиент получает это сообщение и начинает строить в голове логическую цепочку: так, отправил я в 1 секунду, он получил в 3. Значит шло оно 3-1=2 секунды. Но мое-то время на предыдущем этапе по сообщению Sync также было выставлено с задержкой! Значит надо разделить на \u003Cem\u003Eполопам\u003C\u002Fem\u003E. (3-1)\u002F2=1 секунда. Это будет время односторонней задержки. И продолжает рассуждать: у меня на часах на момент получения DelayResp было 4 секунды, добавляем посчитанную одну секунду для коррекции и вуаля — мы с сервером полностью выровняли свое время. Сообщения Sync и Delay посылаются на постоянной основе несколько раз в секунду в зависимости от выбранного профиля.\u003C\u002Fp\u003E\u003Cp\u003EЧто тут занимательного? Время отправки и получения сообщения DelayResp ни на что не влияет, ни в каких в формулах расчета не участвует, оно просто переносит данные о метке времени. А вот сообщение DelayReq очень даже влияет. Также как и Sync. Ну и что? А то, что каналы в сервер-клиент и клиент-сервер должны быть симметричными. Зная, как вольно, бывает, обращаются в сетях с метриками или настройками прямых и обратных rsvp-туннелей, это может привести к проблемам. Зарубим себе на носу. И второе, чем меньше джиттер при доставке сообщение Sync и DelayReq, тем более точно подстраивается шкала времени клиента. Запишем и это в нашу книгу пожеланий.\u003C\u002Fp\u003E\u003Cp\u003EА самое главное знаете что? Мы сейчас с вами увидели принцип \u003Cstrong\u003Eфазовой (временной) синхронизации! \u003C\u002Fstrong\u003EЭто ли не чудо? Да, вот так просто. Фазовая (временная синхронизация) — это когда на разных железках одно и то же действие начинается в один и тот же момент. А еще знаете что? Именно этот тип синхронизации так нужен для корректной работы LTE TDD (но об этом чуть ниже).\u003C\u002Fp\u003E\u003Cp\u003EНо и это еще не все, до чего смогли додуматься эти крейзи инженеры. Ну вот казалось бы, ладно еще можно понять, когда у вас на физическом уровне в SyncE эталонная синусоида посылается с такой-то частотой, бери и по фронту синхронизируйся. Но как вы через пакеты-то это делаете??? А оно, оказывается, еще легче легкого.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Faf1\u002F76c\u002Fee7\u002Faf176cee7a05d938e0a61d559fb9bc47.png\" width=\"500\" height=\"358\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Faf1\u002F76c\u002Fee7\u002Faf176cee7a05d938e0a61d559fb9bc47.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Faf1\u002F76c\u002Fee7\u002Faf176cee7a05d938e0a61d559fb9bc47.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EУ каждого девайса есть встроенный тактовый генератор, который вообще-то  — уникальная неповторимая снежинка. Мало того, что частота может различаться на пару сотен герц, так еще и окружающие условия могут влиять (все как у людей). По итогу получаем, что 1 секунда на сервере гарантировано вообще не тоже самое, что на клиенте. Настало время побеждать и эту проблему.\u003C\u002Fp\u003E\u003Cp\u003EСообщения Sync имеют периодический характер. И вот за счет них-то и производится коррекция, а точнее — можно вычислить коэффициент, с которым часы (генератор) клиента убегает или отстает от сервера. Сервер отправляет сообщение Sync, проставив метку времени отправки 1 секунда, спустя пару секунд (в нашем примере) отправляет еще одно сообщение Sync (проставив метку 3 секунды). Клиент получает оба сообщения, видит, что первое он получил в 6 секунд, а второе в 12. Далее разницу времени отправки на сервере он делит на разницу времени получения на клиенте и получает искомый коэффициент, на который можно смело умножать время на клиенте. В нашем карикатурном случае часы на клиенте бегут в три раза быстрее, чем на сервере. Если коэффициент меньше 1, значит часы на клиенте бегут вперед, если больше 1 — отстают. Все гениальное — гениально! Таким образом решена проблема \u003Cstrong\u003Eчастотной синхронизации.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EЯ долго думал, ну как же так получилось, что частоту и фазу удалось откорректировать через показания времени, присланном в пакете \u003Cs\u003Eс пакетами\u003C\u002Fs\u003E? И вот буквально на днях дошло. Частота измеряется в герцах. А что такое герц? Это единица делить на секунду. Т.е. величина обратно пропорциональная времени. Разработчики стандарта взяли за основу поговорку «время временем вышибают» и воплотили в жизнь. Чертовы гении. Ну а с фазой совсем просто — это опять же просто время запаздывания или отклонения одного сигнала от другого.\u003C\u002Fp\u003E\u003Ch2\u003EПрофили PTPv2 (1588v2)  \u003C\u002Fh2\u003E\u003Cp\u003EМы молодцы, разобрались с \u003Cs\u003Eфизическими\u003C\u002Fs\u003E логическими основами пакетной синхронизации. Это хорошо. Но было лишь начало. Теперь давайте посмотрим, какие профили бывают. Как с умным видом говорилось ранее, протокол PTPv2 описывает формат сообщений и что из них можно выжать. А дальше каждый сам волен придумывать себе настройки под разные требования. Кому-то нужна только частота, кому-то подавай и фазу. Этим — точность десятки микросекунд,  тем — наносекунды. У этих есть только Ethernet, у этих IP (и заметьте, про MPLS ни слова).\u003C\u002Fp\u003E\u003Cp\u003EITU-T определил три профиля PTP для телекоммуникационных приложений, описанных в спецификациях G.8265.1, G.8275.1 и G.8275.2.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff36\u002Fb14\u002Ff79\u002Ff36b14f7922436fc9a91869276a744f3.jpg\" width=\"977\" height=\"416\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff36\u002Fb14\u002Ff79\u002Ff36b14f7922436fc9a91869276a744f3.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff36\u002Fb14\u002Ff79\u002Ff36b14f7922436fc9a91869276a744f3.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Cstrong\u003EG.8265.1 Profile \u003C\u002Fstrong\u003Eиспользуется\u003Cstrong\u003E \u003C\u002Fstrong\u003Eдля обеспечения точной частотной, но не временной синхронизации базовых станций мобильной связи. Хорошо подходит для 2G, 3G, LTE FDD. Старые сервера синхронизации умеют поддерживать только его. Реализован у многих мобильных операторов (чуть позже разберем как). В железе выглядит следующим образом.  \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff53\u002Fec7\u002F165\u002Ff53ec7165bb173c9a1cdf04981e2f35c.jpg\" width=\"1110\" height=\"371\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff53\u002Fec7\u002F165\u002Ff53ec7165bb173c9a1cdf04981e2f35c.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff53\u002Fec7\u002F165\u002Ff53ec7165bb173c9a1cdf04981e2f35c.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСервер с завидной регулярностью шлет сообщения Sync, на основе которых клиент (базовая станция) производит корректировку частоты. И изредка Announce, как аналог Hello в других протоколах. Работает поверх IP и тем удобен. И как бы все. Но не совсем. По факту в нем есть сообщения DelayReq и DelayResp, но для вычисления фазы они не используются. Вероятно, их можно использовать для выставления абсолютного времени. А еще 8265 в принципе по жизни работает без коррекции на промежуточных девайсах.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E\tG.8275.1 Profile\u003C\u002Fstrong\u003E предназначен для обеспечения высокоточной частотной синхронизации, фазовой синхронизации и синхронизации времени суток (ToD – time of day). Этот профиль работает только на канальном уровне методом мультикаст-вещания. Хорош собой, но требует обязательную поддержку на каждом транзитном устройстве. А это — капитальные затраты на обновление плат, софта, лицензий и железок в целом. Каждое устройство на пути производит коррекцию времени (вставляет время входа и выхода пакета, чтобы уже в сообщении Sync компенсировать джиттер). Профиль полностью независим от загрузки сети и в этом его жирнейший плюс. Но вот то, что его нельзя запустить без модернизации сети, — минус. Подходит для запуска 2G, 3G, LTE FDD и TDD.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E\tG.8275.2 Profile\u003C\u002Fstrong\u003E предназначен для обеспечения точной частотной синхронизации, фазовой синхронизации и ToD при лишь \u003Cstrong\u003E\u003Cem\u003Eчастичной\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E поддержке со стороны сети. А вот это уже интересно. Профиль является дальнейшим развитием 8275.1, но может, во-первых, работать поверх IP, а, во-вторых, не обязательно должен поддерживаться всеми транзитными маршрутизаторами. Второй пункт на самом деле в стандарте описан по-другому. В сети есть несколько типов устройств:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003EBoundary Clock (BC) – устройство, которое умеет производить расчеты времени. В т.ч. источник синхронизации (GrandMaster Clock)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EOrdinary Clock (OC) – потребитель синхронизации по-нашему, например, базовая станция\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003ETransparent Clock (TC) – транзитное устройство, которое умеет вносить корректировку задержки времени прихода и ухода пакета с железки\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EПозаимствуем картинку с сайта хуавея, которая описывает структуру сети, предложенную стандартом (кстати картинка одинакова для 1 и 2 профилей).\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe6d\u002F5c0\u002Fe8f\u002Fe6d5c0e8fe32ba3627fba7ca531d7d4b.jpg\" width=\"359\" height=\"396\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe6d\u002F5c0\u002Fe8f\u002Fe6d5c0e8fe32ba3627fba7ca531d7d4b.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe6d\u002F5c0\u002Fe8f\u002Fe6d5c0e8fe32ba3627fba7ca531d7d4b.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКаждое транзитное устройство в сети по стандарту должно быть BC или TC, т. е. на аппаратном уровне обеспечивать поддержку PTPv2 (ставить временные отметки в пакете), а это снова капитальные затраты на модернизацию сети. Но, PTPv2 на сетях операторов я видел (правда, неизвестно с каким профилем), а вот чтобы мы его как-то настраивали в железе – припомнить не могу… И вот за эту-то соломину будем цепляться зубами, интерпретируя эти данные нужным нам образом, но чуть позже. Прежде давайте посмотрим, как выглядит в Wireshark’е сигнальный обмен между сервером и клиентом (БС).\u003C\u002Fp\u003E\u003Cp\u003EСо стороны сервера мы можем лицезреть три типа сигнальных сообщений: Announce, Sync и DelayResp.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F52d\u002Fc73\u002Fb2f\u002F52dc73b2fb5554436640a8ead402bf89.jpg\" width=\"1133\" height=\"684\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F52d\u002Fc73\u002Fb2f\u002F52dc73b2fb5554436640a8ead402bf89.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F52d\u002Fc73\u002Fb2f\u002F52dc73b2fb5554436640a8ead402bf89.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видим, изредка сервер напоминает миру сообщением Announce (149 пакет) о своем существовании и параметрах. Периодическими сообщениями Sync (142,152,161,170 пакеты) производится коррекция частоты и просто поддержание точного времени суток. Ну а сообщения DelayResp летят в ответ на запрос клиента DelayReq из следующего дампа и служат для корректировки фазы. Кстати, обратите внимание, что на одно Sync приходится 8 сообщений Delay. Это как раз параметры выставляемые в телекоммуникационном профиле G.8275.2. Например в энергетическом профиле частота отправки этих сообщений будет немножечко другая, и по сути это и будет единственная разница между профилями. Но от частоты отправки этих сообщений зависят характеристики сервера (сколько клиентов в единицу времени он может обслуживать).\u003C\u002Fp\u003E\u003Cp\u003EНо давайте взглянем на обещанный дамп глазами клиента (базовой станции):\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F55f\u002Fb7b\u002F12a\u002F55fb7b12ae53814928b561a48ef4c110.jpg\" width=\"1124\" height=\"395\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F55f\u002Fb7b\u002F12a\u002F55fb7b12ae53814928b561a48ef4c110.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F55f\u002Fb7b\u002F12a\u002F55fb7b12ae53814928b561a48ef4c110.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видим, кроме как DelayReq базовая станция ничего не шлет. Да ей и не требуется. Частоту и время она получила из сообщений Sync, а вот фазу берет из сообщений Delay. Вот, собственно, и вся магия.\u003C\u002Fp\u003E\u003Cp\u003EДля закрепления давайте еще глянем на общие параметры частоты отправки Sync и Delay, под которые БС подстроилась, проанализировав сообщения Announce от разных серверов. Это выгрузка параметров с базовой станции, уж простите за качество.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F1b4\u002F3cd\u002Fc3d\u002F1b43cdc3d4e63afed09339997f1e39bc.jpg\" width=\"229\" height=\"269\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F1b4\u002F3cd\u002Fc3d\u002F1b43cdc3d4e63afed09339997f1e39bc.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F1b4\u002F3cd\u002Fc3d\u002F1b43cdc3d4e63afed09339997f1e39bc.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЧто здесь примечательного. Для начала БС поняла, что она Ordinary Clock, т. е. потребитель синхронизации. Настроена на работу с профилем G.8275.2 поверх IPv4 в unicast-режиме. Т.е. в настройках руками указаны сервера. Есть такое поле Domain = 44. Оно служит для разделения разных групп источников синхронизации, но для нас, как пакетчиков, оно интересно тем, что при анализе дампов оно может указать, какой профиль используется G.8275.2, G.8265.1, G.8275.1, потому что под профили эти номера доменов заранее предопределены. Как минимум в ходе реверс-инжиниринга (читай – ковыряния в дампах) мне это сильно помогло разобраться в происходящем. Ну и мы видим, что телекоммуникационным профилем G.8275.2 определена (точнее запрошена базой) частота отправки сообщений Sync 16Гц (или pps – packet per second), а сообщений Delay – с частотой 128 Гц (или опять же pps). Как раз разница в 8 раз, что мы видели в дампе выше.\u003C\u002Fp\u003E\u003Cp\u003EА теперь давайте подумаем, что мы имеем заключить из всего вышесказанного и увиденного? На базовой станции есть работающий профиль G.8275.2, зацепленный за сервер синхронизации, который по стандарту обладает наносекундной точностью. Это раз. Профиль есть, значит, есть фаза и частота, но LTE TDD не работает. Это два. Три — на пакетной сети никто не настраивал аппаратную поддержку этому профилю, хотя стандарт его требует. Т.е. в сети есть один Boundary Clock (он же Grandmaster, он же источник синхронизации) и множество Ordinary Clock (базовые станции). А всяких промежуточных Transparent clock нет. Четыре — режим IPv4, но мы-то знаем, что у нас на сети никого IPv4 нет — у нас там MPLS. Крайне любопытная картина вырисовывается. Т.е. фактически мы подаем на базовую станцию синхронизацию частоты и фазы. Точности частоты хватает, чтобы работало 2G, 3G и сектора LTE FDD, а вот точности фазы для запуска LTE TDD категорически не хватает. А это уже кое да что.\u003C\u002Fp\u003E\u003Cp\u003EКстати, по ходу разбирательств во всей этой синхронизации на глаза попалась \u003Ca href=\"https:\u002F\u002Ftf.zone\u002Fsolutions\u002Farchitecture-and-testing-of-network-synchronization-systems\u002F\"\u003E\u003Cstrong\u003Eхорошая справочная табличка\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E, в которой описаны разные виды рекомендаций для тех или иных технологий передачи данных.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F694\u002Ff2e\u002F544\u002F694f2e54431d5a8582082b7f718b9828.jpg\" width=\"481\" height=\"140\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F694\u002Ff2e\u002F544\u002F694f2e54431d5a8582082b7f718b9828.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F694\u002Ff2e\u002F544\u002F694f2e54431d5a8582082b7f718b9828.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EЧто там у мобилы?  \u003C\u002Fh2\u003E\u003Cp\u003EЧто ж, пора, наверное, поскролить \u003Cs\u003Eтик-ток\u003C\u002Fs\u003E интернет на предмет того, какие, собственно, требования выдвигаются со стороны мобильной сети для разных технологий. Основательный гуглеж показал, что веб-комьюнити, например, \u003Ca href=\"https:\u002F\u002Fwww.dealer.su\u002Farticles\u002F45916\u002F\"\u003E\u003Cstrong\u003Eвот здесь\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E\u003Cstrong\u003E.\u003C\u002Fstrong\u003E примерно сходится на одних и тех же параметрах и для LTE TDD требует точность синхронизации ± 1,5мкс.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2f5\u002F077\u002F0bb\u002F2f50770bbc93f2638de57c1d5d30c154.jpg\" width=\"481\" height=\"213\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2f5\u002F077\u002F0bb\u002F2f50770bbc93f2638de57c1d5d30c154.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2f5\u002F077\u002F0bb\u002F2f50770bbc93f2638de57c1d5d30c154.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Ftf.nist.gov\u002Fseminars\u002FWSTS\u002FPDFs\u002F2-2_Ericsson_Ruffini_Sync_in_MobileStandards_ruffini-rev3-tot.pdf\"\u003E\u003Cstrong\u003EВторят\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E\u003Cstrong\u003E \u003C\u002Fstrong\u003Eнашим отечественным коллегам и именитые импортные товарищи из Ericsson, которые в сотовой связи сильно хороши.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7e7\u002Fd25\u002Fb28\u002F7e7d25b280994f9aa4dd94d68267711f.jpg\" width=\"424\" height=\"301\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7e7\u002Fd25\u002Fb28\u002F7e7d25b280994f9aa4dd94d68267711f.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7e7\u002Fd25\u002Fb28\u002F7e7d25b280994f9aa4dd94d68267711f.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДоверяй, но проверяй. Если мы в пакетных сетях руководствуемся требованиями RFC, то мобила живет и строится по законам, описанным законодателем мобильной моды — 3GPP — 3rd Generation Partnership Project — консорциумом, разрабатывающим спецификации для мобильной телефонии. На слайдике выше указан любопытный документ 3GPP TS 36.133, в котором на 47 (из 462) странице озвучиваемые интернетом требования вполне подтверждаются. Хотят точность меньше 3 мкс для каких-то маленьких ячеек и 10 мкс для больших.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa6a\u002Fced\u002F330\u002Fa6aced330a335ae06738561f103fe267.jpg\" width=\"831\" height=\"459\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa6a\u002Fced\u002F330\u002Fa6aced330a335ae06738561f103fe267.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa6a\u002Fced\u002F330\u002Fa6aced330a335ae06738561f103fe267.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИ вот теперь впору слегка пригорюниться и словами одного автоблогера задать витающий в воздухе вопрос: «3GPP, вы там у себя не офигели»? Мы тут в пакетных сетях задержки измеряем в миллисекундах, как мы вам должны микро- и нано- обеспечивать? У нас даже скорость света конечна, по проводу длиной 10км пакет физически летит со скоростью 280000км\u002Fс 0,03мс (это уже 30мкс), а еще сериализация, буферизация, маршрутизация...\u003C\u002Fp\u003E\u003Cp\u003EНо если хорошенечко призадуматься, то тут явно что-то не то. И верно, раз транспортная сеть физически не в состоянии обеспечить микросекундые задержки (delay), значит, речь о другом. И это другое — джиттер (jitter) или дрожание. Пакеты приходят с какой-то задержкой и она плавает, например, в диапазоне от 10 до 15мс. Вот эта разница между максимальной и минимальной задержкой в 5мс и будет джиттером. Т.е. для успешного запуска LTE TDD нам нужно всего-то навсего — обеспечить джиттер синхропакетов в пределах 3 мкс... Без коррекции на промежуточных маршрутизаторах… Пффф,  да раз плюнуть.\u003C\u002Fp\u003E\u003Ch2\u003EСредний по больнице MBH  \u003C\u002Fh2\u003E\u003Cp\u003EДля понимания, откуда берется задержка, а вместе с ней и джиттер, надо глянуть на среднестатистическую структуру обычной российской се\u003Cs\u003Eмь\u003C\u002Fs\u003Eти. Строится она по одним и тем же лекалам у всех операторов: мобильная кора (пакетная и голосовая с контроллерами), сама сеть MBH из маршрутизаторов агрегации (подороже и помощнее) и доступа (подешевле и послабее), и собственно базовая станция, ради которой все это делается. Но давайте разберем чуточку подробнее, как это выглядит.  \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff9a\u002Fa9b\u002F746\u002Ff9aa9b746ad76b46e18302cd616e7c99.jpg\" width=\"707\" height=\"788\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff9a\u002Fa9b\u002F746\u002Ff9aa9b746ad76b46e18302cd616e7c99.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff9a\u002Fa9b\u002F746\u002Ff9aa9b746ad76b46e18302cd616e7c99.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EPS\u002FCS Core через Opt. A (набор вланов под разные интерфейсы мобильной сети Abis, Iub, S1 и управление OAM) стыкуются с городской\u002Fобластной mpls-сетью. Эта сеть обычно имеет выделенный уровень агрегации из мощных маршрутизаторов с большим количеством портов и толстых линков, который строится по кольцевой топологии. Пример очень простой, обычно роутеров больше. На агрегаторы опираются кольца доступа, состоящие из железок с функциональным названием CSR (Cell Site Router). К CSR’ам уже непосредственно подключаются базовые станции. С т.з. физики, наверное, у всех все одинаково. Различия начинаются в части логической архитектуры, что выливается в разный набор используемых протоколов для организации транспортной и сервисной составляющей: ospf\u002Fisis, ldp\u002Frsvp, l2vpn\u002Fl3vpn, \u003Cs\u003Ecanon\u002Fnikon\u003C\u002Fs\u003E, vpls\u002Fevpn, иерархический\u002Fплоский vpn — в общем, вариативность хорошая. Но по факту единственная цель дотянуться вланом или по l3 от PS Core до базовой станции, попутно обеспечивая резервирование узлов и линий связи с быстрым переключением на резерв.  \u003C\u002Fp\u003E\u003Ch2\u003EТеряем время  \u003C\u002Fh2\u003E\u003Cp\u003EДавайте попробуем разобраться, в каком месте сети набегает задержка и что добавляет ей неопределенности — того самого джиттера. Для этого рассмотрим трассу от PS Core до базовой станции, развернув схему выше в цепочку и пустим \u003Cs\u003Eскупую слезу\u003C\u002Fs\u003E пакет размером 1500Байт.  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F632\u002Fd84\u002F651\u002F632d84651511335f71de8c9261851ed6.jpg\" width=\"481\" height=\"82\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F632\u002Fd84\u002F651\u002F632d84651511335f71de8c9261851ed6.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F632\u002Fd84\u002F651\u002F632d84651511335f71de8c9261851ed6.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПри передаче по сети пакет проходит через маршрутизаторы и по линиям связи. Крупными мазками в маршрутизаторе он проходит:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003Eстадию внутренней обработки включая десериализацию (восстановление битового потока в пакет и поиск выходного интерфейса)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eбуферизацию перед отправкой в линию, если она вдруг занята\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eсериализацию (передача набора битов в линию)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EС линиями все просто. Оптический или электрический сигнал распространяется хотя и очень быстро, но с конечной скоростью, которая где-то в районе скорости света. Но т. к. у нас тут сферический конь не в вакууме, то она поменьше. Мне нравится думать про 280000 км\u002Fс (не знаю откуда взял). В итоге чем длиннее линия, тем дольше пакет будет по ней ехать.  \u003C\u002Fp\u003E\u003Cp\u003EДавайте рассчитаем примерную задержку для нашей сети, вызванную \u003Cstrong\u003Eдлиной линии\u003C\u002Fstrong\u003E. Примем, что длина каждого линка равна 10км. Сигнал преодолеет 10км за 10км\u002F280000км\u002Fс= 0,035мс = 35мкс. По дороге у нас пять таких линий, значит, в сумме это займет 0,035мс*5= 0,175мс = 175мкс. В целом немного. Для примера, если речь будет идти про спутниковую связь, то для геостационарной орбиты пока пакет слетает в космос на высоту 35000км делить на 300000км\u002Fс (тут уже вакуум) это займет 116мс. Отразится от спутника и долетит до наземного терминала это еще минимум 116мс, итого минимально физически возможное время односторонней задержки 232мс (а на самом деле сильно больше). У Старлинка в этом случае сильно веселее, орбита на 550км — это примерно 3,6мс. Этот параметр фактически зависит только от ограничений, налагаемых вселенной, и его не обойти. Наверное все, кто работал в эксплуатации, сталкивались с абонентами, которые жаловались на высокий пинг из условного Владивостока до Москвы — это как раз случай с расстояниями. И увы, здесь помогут только просветительская деятельность и надежда, что когда-нибудь сервер с танчиками поставят поближе к абонентам. Хотя бывают случаи, когда операторы из Владивостока стыкуются где-нибудь на М9 в Москве — это двойная пытка с административной составляющей для абонентов.\u003C\u002Fp\u003E\u003Cp\u003EТеперь давайте посчитаем, сколько времени пакет проводит внутри маршрутизатора. Скажу сразу, сделать это получится весьма условно, потому что зависит как минимум от типа обработки пакета. Допустим если он умеет обрабатывать «на лету», то ему не надо дожидаться поступления всего пакета, а достаточно только заголовка, из которого можно выяснить выходной интерфейс. Но обработать-то заголовок оно сможет, а вот передать дальше - нет, пока не получит весь пакет целиком. Почему? Потому что наш старый добрый Ethernet работает с полем контрольной суммы (FCS), которое вставляется в конец кадра. Т.е. сначала надо узнать, пришел ли пакет целым, а потом нужно сосчитать новую сумму, т.е. пакет так или иначе должен оказаться в маршрутизаторе целиком. Это будет десериализация. Операции десериализации (сборка пакета из битового потока) и поиск выходного интерфейса в целом можно распараллелить. Сколько времени будет длиться обработка пакета — одному чипу известно: это очень индивидуально, даже лезть не будем, но в современных маршрутизаторах это наносекунды. Но если кто-нибудь подскажет, как сделать трейсы пакетов на Huawei, Juniper и Nokia аналогично как в \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fcbs\u002Farticles\u002F323080\u002F\"\u003E\u003Cstrong\u003Eэтой статье\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E\u003Cstrong\u003E \u003C\u002Fstrong\u003Eпо циске, то нашей статье явно добавится точности. А так посчитаем только то, что можем точно посчитать.\u003C\u002Fp\u003E\u003Cp\u003EСперва переведем наши 1500 байтов в биты, чтобы делить и умножать одни и те же единицы. 1500 байт * 8 = 12000 бит.\u003C\u002Fp\u003E\u003Cp\u003EВсе начинается с того, что PS Core на скорости 100G выплевывает пакет в сеть. Это \u003Cstrong\u003Eсериализация\u003C\u002Fstrong\u003E. Время передачи всего пакета размером 12000 бит со скоростью 100Гб\u002Fс из порта в линию составит 12000бит \u002F 100Гбит\u002Fс = 0,12 мкс. Немного. Узел Agg1 в сторону Agg2, работая на 20G, затратит на эту же операцию сериализации в 5 раз больше времени, т. е. 0,6 мкс. Интерфейсы Agg2 и CSR1 в сторону БС работают на скорости 10G, поэтому они потратят по 1,2 мкс. Ну и CSR2 смотрит в БС на скорости 1G, т.е. он потратит 12 мкс. Просуммируем время сериализации 0,12 + 0,6 + 1,2 + 1,2 + 12 = 15,12 мкс = 0,01512 мс. В целом тоже не очень много.\u003C\u002Fp\u003E\u003Cp\u003EКакие выводы? С одной стороны, чем больше размер пакета, тем больше времени на его передачу надо. Товарищи, которым важно работать с данными в режиме реального времени, типа голоса или эмуляций потока поверх RTP, давно смекнули, что с мелкими пакетиками проще гарантировать какую-никакую стабильность (технология ATM со своими ячейками в 53 байта была родоначальником этой моды). С другой, чем выше скорость порта, тем меньше время, затрачиваемое на передачу. И этот параметр уже зависит от наших финансовых возможностей. Говорят, что купить можно все, кроме времени. Мы с вами только что разрушили этот миф! В дата-центрах все очень богатые и работают на межгалактических скоростях в 100G и 400G чуть не на доступе с основной целью — уменьшить задержку. Это у нас в провайдинге миллисекундой больше, миллисекундой меньше — все равно проблема абонента. А они там сети строят для себя любимых, чтобы ублажить протокол TCP или его гугловского братишку QUIC, которые в большинстве реализаций крайне чувствительны к задержке.\u003C\u002Fp\u003E\u003Cp\u003EНо если подумать, что такое 15мкс, которых у нас набрались за пяток маршрутизаторов — мелочи? Ан нет, можно очень неудачно вляпаться. Давайте откатимся на 10-15 лет назад, в эпоху xDSL и Serial-интерфейсов, которые местами встречаются и сейчас. Там скорости вращаются в районе 2Мб\u002Fс. А для 1500Б пакета это сразу же +6 мс на процедуре сериализации. А давайте сделаем еще хуже (мы это умеем) — выкручиваем MTU до 9000Б. И тут же получаем 30 мс. А это, на минуточку, пинг из Екатеринбурга до Москвы. Вот так легко и непринужденно мы довели сеть до крайности, заменив 4000 км оптики всего одним неудачным маршрутизатором. Чем еще плох медленный процесс сериализации? Пока железка мучительно передает пакет в линию, остальные томятся в буфере, а это уже про массовое влияние. Про half-duplex и коллизии уже говорить не будем — сегодняшняя статья не о том, как сломать жизнь себе или абонентам. Хотя нет, все-таки будем. Мы-то ведь как думаем, что потоки E1, Frame Relay, PPP и ADSL далеко в прошлом и больше мы об этом ничего не услышим. Услышим и еще как. Низкоскоростные интерфейсы не выходили и вряд ли уйдут из нашей жизни. Тот же LTE на своих радио-интерфейсах в сторону абонентов будет выдавать совсем небольшие скорости, в пределах нескольких мегабит в ЧНН в зависимости от числа абонентов на БС. Правда и здесь можно купить себе симочку подороже с более приоритетным QCI (quality class identifier — мобильный qos) и наслаждаться прелестями капитализма. В LTE TDD дополнительно добавляется задержка из-за half-duplex, потому что прием и передача ведутся по очереди (пусть и в разных пропорциях). Но LTE — это про абонентов. А в сетях провайдеров очень распространены радио-релейные линии, которые работают на скоростях и в 100М, и в 250М. Или остался SDH, который \u003Cs\u003Eвыкидывать жалко\u003C\u002Fs\u003E умеет EoS (Ethernet over SDH), и вот мы уже передаем Ethernet на скорости VC4 в районе 150М. Так что процедуру сериализации со счетов сбрасывать никак нельзя.\u003C\u002Fp\u003E\u003Cp\u003EНу ладно, с сериализацией разобрались. Пакет вылетел из PS Core по 100G линку, пролетел 10 км и попадает на AGG1. Здесь его ждет обратный процесс — десериализация. Из битового потока \u003Cs\u003Eсознания\u003C\u002Fs\u003E нужно собрать пакет обратно. По сути это займет столько же времени, поэтому просто добавляем еще 15,12 мкс к нашим расчетам и на этом успокаиваемся.\u003C\u002Fp\u003E\u003Cp\u003EВсего на линии и в процессе сериализации\u002Fдесериализации мы потеряли 175 + 15 + 15 = 205 мкс = 0,2мс. Знаете, что объединяет все виды задержки, которые были описаны и посчитаны в этой главе? Они нам неинтересны! Они статичны, даже если земля перестанет держаться на трех китах, формула расстояние = скорость*время не изменится. Понятно, что если размер пакета будет 100Б, а не 1500Б, то времени на его передачу уйдет поменьше, но сам принцип расчета останется простым и понятным как три копейки. На наши потуги запустить чудо-синхронизацию для LTE TDD оно особо не повлияет, потому что это delay, а не jitter, с которым мы будем биться. Хотя вообще-то в теории есть ситуация, когда и задержка повлияет — это процедура handover’а, т.е. передачи абонента с одной базы на другую, но это не точно.\u003C\u002Fp\u003E\u003Cp\u003EНу а вообще мы посмотрели на все основные виды задержки, которые возникают на сети, кроме буферизации. А вот она-то как раз ломает нашу стройную систему расчетов постоянной задержки, внося хаос и обеспечивая тот самый джиттер.\u003C\u002Fp\u003E\u003Ch2\u003EБуферизация  \u003C\u002Fh2\u003E\u003Cp\u003EЭто время, которое пакет находится в буфере (памяти), ожидая своей очереди на отправку (фактически до начала сериализации). Время это носит абсолютно случайный характер и зависит от множества параметров: сколько уже пакетиков лежит в буфере, сколько очередей и какие у них настройки, есть ли полисер, в какую очередь пакет попал, какой максимальный размер буфера, сколько юзеров в сети и как сильно им хочется интернета, насколько мощные сервера, есть ли шейпер и много другое, что делает процедуру буферизации на первый взгляд непредсказуемой.\u003C\u002Fp\u003E\u003Cp\u003E\tВ пакетных сетях буферизация возникает по двум основным причинам:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eпонижение скорости\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eодновременный приход пакетов\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003E\tСперва про понижение скорости. Тут все довольно просто. Нельзя просто взять и пакет, летящий на скорости 10G, передать в порт 1G. Сперва его нужно пропустить через замедлитель интернетных частиц, коим является буфер коммутатора\u002Fмаршрутизатора. Так сказать, произвести выравнивание линейных скоростей интерфейсов.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F43b\u002F99d\u002Ff20\u002F43b99df203b5518eb3b445ecfd70568a.jpg\" alt=\"Картинка отсюда  \" title=\"Картинка отсюда  \" width=\"481\" height=\"289\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F43b\u002F99d\u002Ff20\u002F43b99df203b5518eb3b445ecfd70568a.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F43b\u002F99d\u002Ff20\u002F43b99df203b5518eb3b445ecfd70568a.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003Cdiv\u003E\u003Cfigcaption\u003EКартинка \u003Ca href=\"https:\u002F\u002Fwww.ixbt.com\u002Fnews\u002F2023\u002F03\u002F24\u002Fv-bolshom-adronnom-kollajdere-vpervye-udalos-zaregistrirovat-samuju-neulovimuju-jelementarnuju-chasticu.html\"\u003Eотсюда\u003C\u002Fa\u003E  \u003C\u002Ffigcaption\u003E\u003C\u002Fdiv\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНо есть нюанс, который довольно сложно уловить. Замедляется не столько скорость отдельного пакета, сколько скорость потока данных. Ну вот смотрите. Есть сервера условного Яндекса или ВК, жесткие диски которых умеют производить чтение и передачу видосиков в сеть на скорости 100G, а есть телефонная станция, обученная сызмальства только теореме Котельникова, передающая разговор на скорости 64 кбит\u002Fс. Сервер Яндекса и телефонная станция могут быть подключены по 100G-интерфейсу. Но сервер будет передавать информационный поток на этой скорости, а телефонная станция как использовала свои 64 кбит\u002Fс, так и будет. Понятно, что поток данных на скорости 100G нельзя целиком засунуть в 10G, пакеты начинают складываться в буфер, потом буфер кончается и они теряются (а в это время усиленно работает TCP, который вычисляет реальную пропускную способность канала с точностью до нескольких килобит на основании всего двух параметров — двусторонней задержки и процента потерь, попутно подстраивая\u002Fпонижая скорость чтения жесткого диска до 10G, но это из другой оперы). При этом условная телефонная станция, несмотря на потрясающую скорость интерфейса, передает голосовой поток на скорости 64к, что без всякой буферизации прекрасно пройдет через 10G линк.\u003C\u002Fp\u003E\u003Cp\u003EЕсли пример с серверами не подходит, то возьмем из жизни. Вот перед нами 10 полосное шоссе, у которого из-за ремонта осталась только 1 полоса. В месте сужения полос возникнет пробка, которая, чем больше машин, тем длиннее растянется. Фактически, пробка — это буфер, который производит выравнивание возможностей 10-ти полосного шоссе с узкой дорогой. С другой стороны ночью, когда трафика нет, можно ворваться на однополоску — тапку в пол, волосы назад, т.е. выравнивать тут особо нечего, т.к. дорога свободна.\u003C\u002Fp\u003E\u003Cp\u003EВсе мы знаем, что пакетные сети изначально построены на \u003Cs\u003Eобмане потребителя\u003C\u002Fs\u003E теории вероятности. Это когда у нас у коммутатора 20*1G портов и 2*10G, причем только один 10G смотрит в аплинк. Итого мы запихиваем 20G в 10G, называя это нейтральным словом \u003Cem\u003Eмультиплексирование\u003C\u002Fem\u003E в соотношении 2:1 (а в случае с платами переподпиской). И в общем-то здесь все в порядке, вероятность того, что трафика одновременно будет хотя бы пару гигов, крайне низка, и на графиках в Cacti никто никакого криминала не увидит. В теории. А вот если копнуть чуть поглубже, то становится понятно — вероятность, что два пакета придут одновременно и захотят попасть в один и тот же выходной порт очень сильно больше 0.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe1a\u002Ff5b\u002F8fb\u002Fe1af5b8fba0196353706c0b4d52544c2.jpg\" width=\"481\" height=\"175\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe1a\u002Ff5b\u002F8fb\u002Fe1af5b8fba0196353706c0b4d52544c2.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe1a\u002Ff5b\u002F8fb\u002Fe1af5b8fba0196353706c0b4d52544c2.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПо итогу, одному из пакетов придется полежать в буфере, пока другой проходит сериализацию. Чем больше «одновременных» пакетов, тем дольше они будут сидеть в очереди. Это в чистом виде теория массового обслуживания, которую каждый из нас пропустил через себя с утра в плацкартном вагоне в очереди к столь вожделенному туалету на подъезде к конечной станции.\u003C\u002Fp\u003E\u003Cp\u003EОба механизма, приводящие к необходимости буферизации, желательно понять \u003Cs\u003Eи простить\u003C\u002Fs\u003E, чтобы знать, где очередь (а вместе с ней джиттер) может возникнуть, а где нет.\u003C\u002Fp\u003E\u003Ch2\u003EРадикальный сетевой фундаментализм  \u003C\u002Fh2\u003E\u003Cp\u003EА вот теперь будет немножечко хардкора, без которого эта заметка не имела бы такого смысла. Как чинить джиттер — не секрет, для этого существует QoS с правильной классификацией и продуманным планировщиком, но об этом немного попозже. Пока же обсудим одну статью в моем ультра кратком изложении, которая попалась на глаза за неумеренным потреблением оливье. Итак, простой парень из солнечного Сан-Хосе с исконно калифорнийским именем Diptanshu Singh задался вопросом, а как, собственно, \u003Ca href=\"https:\u002F\u002Fpacketpushers.net\u002Fblog\u002Faverage-network-delay\"\u003Eпосчитать этот джиттер\u003C\u002Fa\u003E. Если быть точнее, то в своей статье он вывел формулу для расчета времени буферизации, а это ни что иное, как джиттер. Я проверил, она работает на практике, поэтому хочется объяснить, что к чему, ведь это позволяет с простым калькулятором в руках проверить те или иные техрешения и предсказать, что заработает, а что нет.\u003C\u002Fp\u003E\u003Cp\u003EПроцесс буферизации в сети представляют собой модель массового обслуживания, которая хорошо изучена, разложена на компоненты и описана. Удобнее всего рассматривать на примере условного магазина с покупателями. Есть интенсивность поступления клиентов в очередь, есть сама очередь возле кассы, есть скорость обработки очереди (расторопность кассира).\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F459\u002F96b\u002F05f\u002F45996b05ff21cdf6181fe1a8e8960ce1.jpg\" width=\"334\" height=\"134\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F459\u002F96b\u002F05f\u002F45996b05ff21cdf6181fe1a8e8960ce1.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F459\u002F96b\u002F05f\u002F45996b05ff21cdf6181fe1a8e8960ce1.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПоступление клиентов в очередь удобно представлять в виде распределения Пуассона. Это когда мы знаем, что за час в среднем придет 5 человек, но когда конкретно они это сделают — загадка, друг на друга они не ориентируются. Могут прийти все вместе, а могут и нет. А могут и вообще прийти не 5, а 8. Это важный момент, свойственный именно пакетным сетям. Допустим, в TDM-сетях поступление данных осуществляется с постоянной скоростью через равные промежутки времени длиной в 1 таймслот (или канальный интервал для тех, кому ИКМ-30 ближе) и там все дальнейшие расчеты смысла уже не имеют. В распределении же Пуассона много случайностей.  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcb3\u002F1e4\u002F73b\u002Fcb31e473bfdb9ac72a7c98e19f7b175f.jpg\" width=\"152\" height=\"95\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcb3\u002F1e4\u002F73b\u002Fcb31e473bfdb9ac72a7c98e19f7b175f.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcb3\u002F1e4\u002F73b\u002Fcb31e473bfdb9ac72a7c98e19f7b175f.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДля процесса Пуассона придумана формула, которая рассказывает, с какой вероятностью за какое-то время произойдет n событий. Например, при средней интенсивности 5, придет все-таки не 5, а целых 8 человек. Эта формула на самом деле интересна, потому что через нее можно получить все что угодно. И, что особенно радует, нам она не нужна, с ней математики пусть работают ))  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff3f\u002F7a8\u002F123\u002Ff3f7a81231a2b1d218ec7ea1f92a7e00.jpg\" width=\"180\" height=\"58\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff3f\u002F7a8\u002F123\u002Ff3f7a81231a2b1d218ec7ea1f92a7e00.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff3f\u002F7a8\u002F123\u002Ff3f7a81231a2b1d218ec7ea1f92a7e00.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсть разные модели массового обслуживание, мы будем рассматривать самую простую M\u002FM\u002F1, которая нам подходит. В ней первая «М» означает поступление пакетов по распределению Пуассона. Вторая «М» — обработка пакетов «без памяти» вне зависимости, было что-то до этого сделано или нет. И «1» означает, что у нас только один обработчик очереди (когда мы будем считать реальную сеть, будет понятно, почему это допустимо).\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa22\u002F761\u002Fc81\u002Fa22761c813e19f750e4153a3dba1c43c.jpg\" width=\"262\" height=\"58\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa22\u002F761\u002Fc81\u002Fa22761c813e19f750e4153a3dba1c43c.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa22\u002F761\u002Fc81\u002Fa22761c813e19f750e4153a3dba1c43c.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EБазовыми характеристиками, описывающими систему массового обслуживания, являются интенсивность поступления пакетов \u003Cstrong\u003Eλ\u003C\u002Fstrong\u003E и интенсивности (скорость) их обработки \u003Cstrong\u003Eµ\u003C\u002Fstrong\u003E. Отношение интенсивности поступления к интенсивности обработки обозначается буковкой \u003Cstrong\u003Eρ\u003C\u002Fstrong\u003E  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb22\u002F135\u002Fc4b\u002Fb22135c4b3e95fb1290e178ce2723951.jpg\" width=\"180\" height=\"37\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb22\u002F135\u002Fc4b\u002Fb22135c4b3e95fb1290e178ce2723951.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb22\u002F135\u002Fc4b\u002Fb22135c4b3e95fb1290e178ce2723951.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсли соотношение меньше 1, значит система успевает обрабатывать всех клиентов, если больше — значит клиенты начинают теряться. Чем ближе \u003Cstrong\u003Eρ\u003C\u002Fstrong\u003E к нулю, тем меньше время ожидания в очереди.\u003C\u002Fp\u003E\u003Cp\u003EВообще-то, лично я бы уже на этой формуле закончил всю эту математику. Если вдуматься, то фактически здесь мы видим не только скорость убывания, но и в каком-то смысле коэффициент буферизации. Т.е. условно при интенсивности поступления 5 человек и скорости обслуживания кассы в 6 человек, ρ=5\u002F6 = 0,83 из них оказались бы постоянно в очереди. А почему бы не взять и именно так не интерпретировать эту формулу? Я бы так и сделал. И ошибся. Потому что именно понимание деталей процесса отличает математиков от меня — они-то знают, что каждый клиент, который находится на кассе, отнимает время у всех, кто стоит дальше за ним. Склоняю голову перед их умищем. Дальше в статье идет большая простыня из формул, которые приводят нас к простому способу вычисления среднего количества пакетов в отдельно взятой очереди N (внимание, формулой ниже этот же параметр обозначается буквой q).\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc49\u002F093\u002F5c4\u002Fc490935c42333a5eae6d357fae09db69.jpg\" width=\"75\" height=\"40\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc49\u002F093\u002F5c4\u002Fc490935c42333a5eae6d357fae09db69.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc49\u002F093\u002F5c4\u002Fc490935c42333a5eae6d357fae09db69.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсли на пути много очередей (в нашем случае маршрутизаторов), то для каждой из них считается свой N, где λ это скорость поступления пакетов усредненной длины, а µ это скорость обработки интерфейсом этих пакетов. И в итоге мы получаем, что при интенсивности 5 и скорости обработки 6, в очереди будет не 0,83 клиента (как я ошибочно хотел насчитать ранее), а 5\u002F(6-5)=5 клиентов. Если бы интенсивность поступления была 3, то очередь 3\u002F(6-3)=1 уменьшилась радикально. Популярное мнение, что лучший qos — это широкие линки, правильное. Но в целом мы с вами увидели ключевую формулу для расчета джиттера.\u003C\u002Fp\u003E\u003Cp\u003EБез стеснения жонглируя формулами товарищ выводит схему расчета \u003Cstrong\u003Eджиттера T для отдельного порта или маршрутизатора.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd7d\u002F985\u002F956\u002Fd7d9859562932d54873879b817ec696c.jpg\" width=\"220\" height=\"46\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd7d\u002F985\u002F956\u002Fd7d9859562932d54873879b817ec696c.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd7d\u002F985\u002F956\u002Fd7d9859562932d54873879b817ec696c.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЧестно говоря, не понял, что он хотел показать, используя в этой формуле букву q, а формулой выше букву N – это одно и тоже – среднее число пакетов, лежащих в буфере. Но не суть, главное теперь у нас есть формула расчета джиттера, которая в переводе на человеческий звучит как отношение числа пакетов в буфере q (или N) к интенсивности поступления пакетов.\u003C\u002Fp\u003E\u003Cp\u003EНу и если маршрутизаторов по трассе много, то нужно посчитать, сколько пакетов сидит в буферах на всех изучаемых портах и разделить это на сумму интенсивностей поступления трафика в эти порты.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffe3\u002F2ee\u002F859\u002Ffe32ee859712befad50182933467e92f.jpg\" width=\"332\" height=\"73\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffe3\u002F2ee\u002F859\u002Ffe32ee859712befad50182933467e92f.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffe3\u002F2ee\u002F859\u002Ffe32ee859712befad50182933467e92f.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ своей статье он зовет это задержкой, и c т.з. маршрутизатора он полностью прав — мы считаем время задержки пакета в буфере. Но с т.з. сети это уже в чистом виде джиттер. Позволю себе открыть паинт и переписать формулу.  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3de\u002F244\u002Fad8\u002F3de244ad8b18a41d82716467a66c230f.jpg\" width=\"244\" height=\"66\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3de\u002F244\u002Fad8\u002F3de244ad8b18a41d82716467a66c230f.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3de\u002F244\u002Fad8\u002F3de244ad8b18a41d82716467a66c230f.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EОчень интересно, но ничего не понятно? И это хорошо —  вы нормальный!\u003C\u002Fp\u003E\u003Cp\u003EДля желающих окунуться поглубже и подсмотреть еще пару фокусов, \u003Ca href=\"https:\u002F\u002Freal-statistics.com\u002Fprobability-functions\u002Fqueueing-theory\u002Fm-m-1-queueing-model\u002F\"\u003E\u003Cstrong\u003Eвот здесь\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E товарищ показывает нам, как еще можно провернуть эти формулы, причем удобненько в экселичке. На самом деле можно рекомендовать проделать это упражнение, в ходе которого можно спрогнозировать с какой вероятностью джиттер будет увеличиваться при разной загрузке порта. \u003C\u002Fp\u003E\u003Ch2\u003EКто виноват?  \u003C\u002Fh2\u003E\u003Cp\u003EКажется, сейчас самое время не отходя от кассы попробовать натянуть эту математику на нашу сеть и разобраться, почему же LTE TDD не захотело само заработать. Вспомним, что ключевым моментом является жесткое требование к джиттеру при передаче пакетов синхронизации в пределах 3мкс, чтобы обеспечить достойную фазовую синхронизацию. Профиль PTPv2 G.8275.2 с коррекцией фазы у нас есть, но что-то ему не хватает для счастья. Поэтому берем ту же самую сеть и с интересом препарируем кусочек, выделенный зеленым прямоугольничком. В нем у нас сервер синхронизации (в народе бывает зовется IPClock) по красной пунктирной стрелочке безуспешно пытается доставить фазу на базу.  \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc4e\u002F507\u002Fdda\u002Fc4e507ddad05a3d5826bb37dedecccc5.jpg\" width=\"740\" height=\"791\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc4e\u002F507\u002Fdda\u002Fc4e507ddad05a3d5826bb37dedecccc5.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc4e\u002F507\u002Fdda\u002Fc4e507ddad05a3d5826bb37dedecccc5.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДля начала нужно понять, где будет возникать джиттер. Напомню, что он появляется или при понижении скоростей, или, если трафик из нескольких линков пытается попасть в один. С одной стороны, это вызывает буферизацию, а с другой – наш маршрутизатор можно описать через распределение Пуассона и модель М\u002FМ\u002F1, что позволяет использовать формулы из прошлой главы.\u003C\u002Fp\u003E\u003Cp\u003EИтак, IPClock посылает пакеты на скорости 1G, он их источник, делает стабильно в рамках возможностей своего процессора. Никакого джиттера там нет. Следующая железка AGG1, в ней сходится несколько аплинков, т.е. для джиттера самое оно. Записали. На AGG2 мало того, что аплинки из разных направлений, так еще и понижение скорости с 20G до 10G. Наш кандидат. У CSR1 условно говоря только один аплинк, из которого прилетит трафик в сторону CSR2, оба порта работают на скорости 10G, условия не выполняются, так что мимо. Ну и последний девайс – это CSR2, он выполняет понижение скорости с 10G до 1G. Итого имеем, что буферизация производится на AGG2, AGG1, CSR2.\u003C\u002Fp\u003E\u003Cp\u003EХорошо, теперь надо посчитать λ и µ. Где их взять? Да очень просто. λ – это скорость, с какой идет трафик, а µ – это скорость на которой работают интерфейсы. Единственный момент, надо это дело перевести из мегабит\u002Fс в пакеты\u002Fс. Ну просто потому, что по сети у нас летают именно пакеты. Что ж, просто заходим на порт AGG1 делаем sh int X и получаем готовенький результат. Либо берем график с пиковыми значениями и идем считать.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2b8\u002Fd24\u002F03f\u002F2b8d2403f3b0e5da5a89c4878b81998b.jpg\" width=\"1269\" height=\"323\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2b8\u002Fd24\u002F03f\u002F2b8d2403f3b0e5da5a89c4878b81998b.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2b8\u002Fd24\u002F03f\u002F2b8d2403f3b0e5da5a89c4878b81998b.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗдесь мы видим, что интенсивность поступления в ЧНН:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eλ = 1,17 Mpps.\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EА еще обратите внимание, что я беру график со всего порта без деления на очереди, где вместе с голосом может летать домашний интернет. Все верно, до приведения QoS’ов на всей сети до желаемой модели трафик голоса, синхронизации, управления и всего остального может попадать совсем не в те очереди, где им место. В нашем случае он оказался в нулевой.\u003C\u002Fp\u003E\u003Cp\u003EТакс, а еще нам нужно вычислить средний размер пакета. Делается просто: делим скорость в мегабитах на скорость в пакетах, и на 8 не забываем, чтобы обратить биты в байты:   \u003C\u002Fp\u003E\u003Cp\u003E \u003Ccode\u003E11,52Gbps \u002F 8 \u002F 1,17Mpps = 1230 байт.\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EТеперь мы можем посчитать скорость обработки интерфейса 20G в pps для усредненных 1230 байтных пакетов:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eµ = 20Gbps \u002F 8 \u002F 1230B = 2 032 520 pps.\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EА теперь просто возьмем и посчитаем средний джиттер, который возникает при передаче пакетов через AGG1 при передаче через интерфейс по формуле\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff3f\u002F385\u002F017\u002Ff3f3850179fde52eed6abe1d2d8dcf1c.jpg\" width=\"220\" height=\"46\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff3f\u002F385\u002F017\u002Ff3f3850179fde52eed6abe1d2d8dcf1c.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff3f\u002F385\u002F017\u002Ff3f3850179fde52eed6abe1d2d8dcf1c.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(2032520pps-1170000pps)=1 \u002F 862520 pps=1,16*10\u003Csup\u003E-6\u003C\u002Fsup\u003Eс= 1,16мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВроде бы немного. Но мы посмотрели только на один линк, и он уже выбрал 30% от бюджета в 3мкс необходимого для запуска LTE TDD. А еще не будем забывать, что мы увидели \u003Cstrong\u003E\u003Cem\u003Eсреднюю\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E задержку буферизации. Распределение Пуассона говорит нам о том, что может прийти 1 Mpps, а может прийти и 1,5 Mpps (всплеск), пусть и с меньшей вероятностью. Мы на графике или счетчике видим оооочень усредненные значения, т. к. фактически джиттер плавает в значительно бОльших пределах. Так, при всплеске до 80% от емкости порта (это ~16G или ~1,6 Mpps) джиттер на линке составит\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(2032520pps-1600000pps)=1 \u002F 862520 pps=2,3*10\u003Csup\u003E-6\u003C\u002Fsup\u003Eс= 2,3мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EИ все, давай G.8275.2, до свидания.\u003C\u002Fp\u003E\u003Cp\u003EНо пока не будем о грустном, считаем трассу дальше. Берем график с AGG2, на порту xe-1\u002F1\u002F0 которого происходит понижение скорости с 20G до 10G.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb05\u002Feeb\u002Ff22\u002Fb05eebf2218ecadf1bbda31e94209bae.jpg\" width=\"1280\" height=\"324\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb05\u002Feeb\u002Ff22\u002Fb05eebf2218ecadf1bbda31e94209bae.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb05\u002Feeb\u002Ff22\u002Fb05eebf2218ecadf1bbda31e94209bae.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСредний размер пакета:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E607,62Mbps \u002F 8 \u002F 107kpps = 709B\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСкорость 10G интерфейса в pps:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eµ = 10Gbps \u002F 8 \u002F 709B = 1763000 Трафик в ЧНН поступает со скоростью:\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eλ = 107 kpps.\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003Epps\u003C\u002Fp\u003E\u003Cp\u003EДжиттер:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(1763000pps-107000pps)=1 \u002F 1656000 pps=6*10\u003Csup\u003E-7\u003C\u002Fsup\u003Eс= 0,6мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EИ посчитаем последний из интересных линков уже на CSR2, где происходит понижение с 10G до 1G непосредственно в базовую станцию. Также берем картиночку, стираем с нее отпечатки пальцев и смотрим, что выходит.\u003C\u002Fp\u003E\u003Cp\u003EТрафик идет со скоростью:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eλ = 6,7 kpps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСредний размер пакета:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E56,32Mbps \u002F 8 \u002F 6,7kpps = 1050B\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСкорость 10G интерфейса в pps:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe20\u002F701\u002F386\u002Fe2070138638f1c866a6a389a878477ac.png\" width=\"1280\" height=\"312\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe20\u002F701\u002F386\u002Fe2070138638f1c866a6a389a878477ac.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe20\u002F701\u002F386\u002Fe2070138638f1c866a6a389a878477ac.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Ccode\u003Eµ = 1Gbps \u002F 8 \u002F 1050B = 119000 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДжиттер:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(119000 pps-6700pps) =1 \u002F 112300 pps=8,9*10\u003Csup\u003E-6\u003C\u002Fsup\u003Eс= 8,9мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EА вот это уже интересно. Фактически на пустом гиговом порту, где в ЧНН 50М трафика (загрузка 5%) набежало джиттера сразу на 9 мкс. Ни о каком LTE TDD и 3мкс говорить больше не приходится. Вот оно – то место, которое нам гарантированно всю малину испортило. Какая бы классная сеть у нас не была, на гигабитном порту возникает крайне неприятный эффект накопления времени буферизации. Помните, мы ранее считали сериализацию. Так вот здесь, на медленном интерфейсе, она начинает влиять на время буферизации. Такой вот замкнутый круг.\u003C\u002Fp\u003E\u003Cp\u003EДля очистки совести давайте еще просуммируем джиттеры по всей трассе AGG1-AGG2-CSR2:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E1,16 мкс + 0,6 мкс + 8,9 мкс = 10,66 мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EИ заметьте, это только в одну сторону от PS Core до БС. Этот джиттер будет воздействовать на сообщения Sync в PTPv2 G.8275.2. От БС до PS Core тоже есть разные линки, и там будет накапливаться свой джиттер (немного меньше, но порядок тот же), который будет ломать нам сообщения DelayReq. А еще мы не учитывали (потому что не умеем), что поиск выходного порта (маршрутизация\u002Fкоммутация) все-таки занимает какое-то время.\u003C\u002Fp\u003E\u003Cp\u003EТакие дела. Только что мы с вами своими руками посчитали и нашли место (и не одно), где вся наша синхронизация сыпется.\u003C\u002Fp\u003E\u003Ch2\u003EЧто делать?  \u003C\u002Fh2\u003E\u003Cp\u003EПроблему нашли, дело за малым - ответить на извечный вопрос. Томить не буду, перед нами стоит две решаемые задачи:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EОбеспечить одинаковую задержку (delay) пакетов по направления PS Core – БС (для сообщений Sync) и БС — PS Core (для сообщений DelayReq). Делается с помощью ISIS\u002FOSPF (а у кого-то и RSVP, и BGP).\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EУменьшить задержку буферизации (jitter) хотя бы на порядок. Тут только QoS.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EПойдем по порядку. Для правильного расчета фазовой синхронизации необходимо, чтобы задержка в обе стороны была как можно более одинакова. Даже, наверное, нет так. Внутри одной БС постоянная ассиметричность маршрута ни на что влиять не должна. Но вот для правильного расчета фазовой синхронизации \u003Cstrong\u003Eдвух соседних секторов\u003C\u002Fstrong\u003E, между которыми осуществляется handover (передача абонента с одной БС на другую) - по логике симметричность совершенно необходима. Достигается это симметричностью трассы. И в самом деле, давайте глянем на нашу схему с немного вывернутой метрикой на участке CSR1-CSR2.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff90\u002F31e\u002Fe4c\u002Ff9031ee4c45b16aa41692684d36da3a8.jpg\" width=\"740\" height=\"791\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff90\u002F31e\u002Fe4c\u002Ff9031ee4c45b16aa41692684d36da3a8.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff90\u002F31e\u002Fe4c\u002Ff9031ee4c45b16aa41692684d36da3a8.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видим, из-за некорректно проставленных метрик сигнальный пакет Sync от сервера к БС пойдет короткой дорогой по красной линии, а вот пакет DelayReq побежит по длинной трассе (синяя линия), легко намотав сотню-другую километров оптики. А мы помним, что 100 км \u002F 280000 км\u002Fс = 357 мкс. И вот так легко мы внесем непоправимую ошибку в расчеты PTPv2 для абсолютного времени и фазы. Поэтому необходимо перелопатить всю сеть, обеспечив абсолютную симметрию всех метрик. И этот минимум мы сделали.\u003C\u002Fp\u003E\u003Cp\u003EДля донов, которые используют RSVP, задачка может оказаться посложнее (а местами и вовсе нерешаемой без редизайна). Во-первых, в старых HLD некоторые производители рекомендовали использовать explicit-path для решения всяких разных проблем (например, неумения софта рассчитывать резервные lsp  при частичном пересечении путей до появления опции overlap). И вот, когда инженеры вручную пишут эксплиситы, а потом через год что-то куда-то переносят, то прямые и обратные туннели легко разъезжаются по разным трассам, потому что сначала тут забыли исправить, потом там.\u003C\u002Fp\u003E\u003Cp\u003EВо-вторых, есть великолепный функционал RSVP Auto-bandwidth, который позволяет строить lsp из расчета загрузки линков. Очень помогает избежать ручного администрирования, но на больмень загруженной сети прямой и обратный туннели с изрядной доли вероятности в ЧНН скорее всего разойдутся по разным направлениям. И еще учитывайте, что синхронизация в принципе крайне нервно, даже истерично, относится к изменению физической трассы и, как следствие, задержки. Для синхронизации лучше использовать постоянные туннели.\u003C\u002Fp\u003E\u003Cp\u003EВ-третьих, есть и еще проблемка для сетей, где используется иерархический VPN (особо касается случаев с OSPF, где используется нулевая и номерные зоны). Не углядев за master\u002Fslave на транзитных железках, куда приземляются vpls (t-ldp) или l3vpn (mp-bgp opt B), возникнет еще одно место, где задержка поплывет. В общем, вариантов как сделать сеть хуже — масса, обращайтесь )).\u003C\u002Fp\u003E\u003Cp\u003EНас бог миловал, сеть по HLD запроектирована максимально простой на IGP+LDP, а проблемы емкости и прочего трафик-инжиниринга решаются выделением лямбды в хорошо развитом DWDM. Мы полностью переделывали только метрики в IGP, практически гарантировав симметрию (на самом деле мы полностью все переписали заново на сотнях маршрутизаторов). Остаются, конечно, нюансики, когда на пути есть ECMP. С одной стороны Juniper, с другой Cisco и скорее всего они посчитают хэш совершенно по-разному, но благо разница по расстояниям будет в пару километров, что приемлемо.\u003C\u002Fp\u003E\u003Cp\u003EТеперь давайте заборим джиттер. Здесь, конечно, сильно сложнее, потому что требуется внедрение QoS. Там большая теория, у меня на эту тему рассказать на 2-3 дня есть что. Начать ознакомление стоит, конечно же, с \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F420525\u002F\"\u003E\u003Cstrong\u003EСДСМ\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E. Наверное, без общего понимания как оно работает и какого-никакого опыта, сложно советовать залазить в эту тематику, потому что, скорее всего, получится сделать только хуже. Но объяснить попробую.\u003C\u002Fp\u003E\u003Cp\u003EQoS, как и все остальное в этих наших сетях состоит из данных, переносимых в пакетах и обработчике на маршрутизаторах\u002Fкоммутаторах. В зависимости от выполненных настроек, можно вкладывать разный смысл и философию:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eгарантировать разным видам трафика минимальную полосу\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eприоритезировать один вид трафика на другим\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eобеспечить моментальное обслуживание высокоприоритетному трафику\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eне дать кому-то больше, чем нужно, или как раз дать больше, чем нужно, но ненадолго\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eи т. д.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EВсе это можно миксовать между собой, запуская в придачу HQoS, который так-то сильно аппаратно зависим даже в рамках одного вендора. Тема QoS крайне обширная, включает в себя классификацию, полисинг, входную перемаркировку, маркировку (цветовую), управление перегрузками (RED\u002FWRED), работу с очередями (PQ\u002FWRR\u002FDWRR-CBWFQ), шейпинг, выходную перемаркировку, настройку размера очереди (в секундах или байтах) — сложно и много короче. А еще это должно быть одинаково на всей сети, вплоть до каждого порта и саб-интерфейса. Это называется единая политика QoS оператора или DiffServ-домен.\u003C\u002Fp\u003E\u003Cp\u003EМы настраиваем оператора связи, у него бегает трафик домашнего интернета с торрентами (b2c), iptv, трафик абонентов юр. лиц (b2b), протоколов маршрутизации, голоса и сигналки и мобильной и фиксированной телефонной связи и много чего еще — в общем полный набор. И здесь главная задача – определить, что важно, а что не очень. Вообще, как и все в сетях, умные люди постарались это дело стандартизировать. Например, нарисовали такую табличку\u003C\u002Fp\u003E\u003Cp\u003EГде разным видам трафика назначили разные приоритеты. И все - живи с этим как хочешь.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcbe\u002Febd\u002F744\u002Fcbeebd74499b93204738a13cf2325687.jpg\" width=\"382\" height=\"287\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcbe\u002Febd\u002F744\u002Fcbeebd74499b93204738a13cf2325687.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcbe\u002Febd\u002F744\u002Fcbeebd74499b93204738a13cf2325687.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДоны из 3GPP пошли чуть дальше и дополнили таблицу типов трафика требования к задержкам и потерям (причем это чисто мобильный QoS).  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F272\u002F944\u002Fda9\u002F272944da9d97beabd9a9f5a08c5867a7.jpg\" width=\"481\" height=\"247\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F272\u002F944\u002Fda9\u002F272944da9d97beabd9a9f5a08c5867a7.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F272\u002F944\u002Fda9\u002F272944da9d97beabd9a9f5a08c5867a7.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСтандартизация получилась не очень, надо сказать, потому что не только лишь все понимают, что с этим делать. Нет единой таблицы, которая бы связала воедино классификацию и настройки планировщика, слишком много места для безудержного полета фантазии, и, что хуже, реализации в железе. Так что это все рекомендации, а потому не имеют особого значения, потому что каждый оператор — Художник. Вот как он видит, такой QoS у него и будет.\u003C\u002Fp\u003E\u003Cp\u003EХватит бесполезно растекаться мыслью. Имея опыт работы с операторами, мы выделили (классифицировали) голосовой и сигнальный трафик (включая синхронизацию) в отдельный класс (условно назовем его VoIP) и поместили в очередь PQ (Priority Queue или SP – Strict Priority). Другие типы трафика поместим в другие очереди, которые обрабатываются по другим правилам. В целом это выглядит примерно как на этой картинке \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F246791\u002F\"\u003E\u003Cstrong\u003Eиз статьи\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E (у нас очередей только побольше и они по-другому называются).\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8b0\u002F606\u002Fc5f\u002F8b0606c5f1e34a55d4567038de09b4ba.jpg\" width=\"332\" height=\"181\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8b0\u002F606\u002Fc5f\u002F8b0606c5f1e34a55d4567038de09b4ba.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8b0\u002F606\u002Fc5f\u002F8b0606c5f1e34a55d4567038de09b4ba.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EОсобенность очереди VoIP (кстати, если из VoIP выкинуть букву «o», то станет VIP)) настроенной в режиме PQ в том, что пакеты из нее вынимаются, как только они там появляются, в то время как остальные обслуживаются по очереди, да еще и с отведенным лимитом, чтобы всем досталось времени обслуживания. Допустим, идем сверху вниз по картинке, сначала достали \u003Cstrong\u003Eвсе\u003C\u002Fstrong\u003E пакеты из очереди VoIP, потом сколько-то Call-Signalling, потом несколько из Critical Data. Тут снова \u003Cs\u003Eс ноги врывается\u003C\u002Fs\u003E появляется пакет в очереди VoIP. Бросаем все и сломя голову c криком \u003Cem\u003EБАНЗАЙ\u003C\u002Fem\u003E несемся обрабатывать пакеты VoIP. Вот в этот самый момент другие пакеты в очередях накапливают задержку (джиттер) сидя на лавке в \u003Cs\u003Eполиклинике\u003C\u002Fs\u003E буфере, а наш дерзкий и быстрый приоритетный пакетик синхронизации залетает  почти без задержки, чисто на харизме со словами  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7a4\u002Fb05\u002Fde2\u002F7a4b05de28ddb02ad907084d0cba3cd2.jpg\" alt=\"Источник: https:\u002F\u002Ffotostrana.ru\u002Fpublic\u002Fpost\u002F231949\u002F2663335609\" title=\"Источник: https:\u002F\u002Ffotostrana.ru\u002Fpublic\u002Fpost\u002F231949\u002F2663335609\" width=\"419\" height=\"419\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7a4\u002Fb05\u002Fde2\u002F7a4b05de28ddb02ad907084d0cba3cd2.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7a4\u002Fb05\u002Fde2\u002F7a4b05de28ddb02ad907084d0cba3cd2.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003Cdiv\u003E\u003Cfigcaption\u003EИсточник: \u003Ca href=\"https:\u002F\u002Ffotostrana.ru\u002Fpublic\u002Fpost\u002F231949\u002F2663335609\u002F\"\u003Ehttps:\u002F\u002Ffotostrana.ru\u002Fpublic\u002Fpost\u002F231949\u002F2663335609\u003C\u002Fa\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Fdiv\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНо это лирика. Что дает нам приоритетное обслуживание в очереди PQ с т.з. математики и ненавистных формул? Во-первых, ожидаемо мы сильно уменьшаем интенсивность поступления трафика. Отделив мух от котлет, а голос от торрентов, скорость λ уменьшается на порядок, а то и два. Хоть это и не принципиально на незагруженных линках.\u003C\u002Fp\u003E\u003Cp\u003EВо-вторых, мы всю пропускную способность порта отдаем в распоряжение нашей очереди с синхронизацией. Параметр µ будет использоваться нами без ограничений (в реальной сети, конечно, нужно ограничивать очереди PQ шейпером, чтобы при шторме он не убил всю сеть, но на расчеты это не влияет)\u003C\u002Fp\u003E\u003Cp\u003EВ-третьих, что более неожиданно и вообще-то является залогом успеха, мы уменьшаем средний размер пакета. Если домашний интернет бегает с пакетами по 1200 байт, то голос\u002Fсигнализация\u002Fсинхронизация по 100-135 байт. В 10 раз меньше. Просто потому, что эти виды трафика так устроены. Вот, например, дамп пакета PTPv2.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F07c\u002F345\u002Fcf6\u002F07c345cf6d65d641327ae8a798f3a425.jpg\" width=\"458\" height=\"85\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F07c\u002F345\u002Fcf6\u002F07c345cf6d65d641327ae8a798f3a425.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F07c\u002F345\u002Fcf6\u002F07c345cf6d65d641327ae8a798f3a425.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EА вот соседствующего с ним голосовой пакетик в технологии 3G.  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28e\u002F4f8\u002F1f2\u002F28e4f81f25fd26b7b483582185edc499.jpg\" width=\"388\" height=\"106\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28e\u002F4f8\u002F1f2\u002F28e4f81f25fd26b7b483582185edc499.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28e\u002F4f8\u002F1f2\u002F28e4f81f25fd26b7b483582185edc499.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДобавляем сюда пару заголовков mpls по 4 байта, накидываем 14 байт Ethernet, 4 байта 802.1q, можно еще преамбулу и контрольную сумму байт на 12. Короче то на то и выходит.\u003C\u002Fp\u003E\u003Cp\u003EИ вот это уже заявочка на победу. Помните, как в прошлой главе наши мечты расслабленно запустить синхронизацию на гиговом линке разбились о суровую реальность? При средней длине пакета в ~1200Б мы получили джиттер 8,9мкс. А коли мы уменьшим пакет в 10 раз до 120Б, то и джиттер упадет примерно в 10 раз до 0,89 мкс. И вот же оно!\u003C\u002Fp\u003E\u003Cp\u003EА, ну и излишне, наверное, говорить, что разработав модель QoS, учитывающую профили трафика Заказчика, мы вновь бессонными ночами прошлись по этим же сотням маршрутизаторов, перенастроив их фактически с нуля.\u003C\u002Fp\u003E\u003Ch2\u003EПосчитаем заново  \u003C\u002Fh2\u003E\u003Cp\u003EБерем нашу же сеть, и, даже не дожидаясь стандартного ЧНН в 20:00-22:00, идем по железкам собирать выводы счетчиков очередей (можно было бы и по графикам посчитать, да там очереди не рисуются, но заодно покажу другой метод расчета). Почему ЧНН ждать не обязательно? Потому что трафика в очереди VoIP несколько мегабит, что днем, что ночью. На расчеты это не влияет\u003C\u002Fp\u003E\u003Cp\u003EНа Juniper AGG1 это будет так\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Esh int queue ae10 forwarding-class VoIP\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E…\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EEgress queues: 8 supported, 8 in use\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EQueue: 5, Forwarding classes: VoIP\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E  Queued:\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E    Packets              :           28304481228                 10656 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E    Bytes                :         3505717139707              11136896 bps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E…\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EНа линке 20G трафика 11 мегабит, ну правда, оно не изменится на порядок. А если изменится, то это некритично. Напомню, что когда деления на очереди не было, то мы считали для 11 гигов, а не 11 мегабит.\u003C\u002Fp\u003E\u003Cp\u003EИтак, здесь у нас интенсивность поступления трафика\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eλ = 10656 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСредний размер пакета здесь и сейчас\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E11136896 bps \u002F 8 \u002F 10656 pps = 130 Байт\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСкорость работы интерфейса с пакетами размером 130 Байт\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eµ = 20Gbps \u002F 8 \u002F 130B = 19 230 769 pps (понятно, что такой скорости на практике вряд ли добиться)\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДжиттер\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(19230769 pps-10656 pps)=1 \u002F 19 220 113 pps=5,2*10\u003Csup\u003E-8\u003C\u002Fsup\u003Eс= 0,05мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EА до косов был 1,16 мкс. На этой железке уменьшили на порядок, точнее в 23 раза.\u003C\u002Fp\u003E\u003Cp\u003EИдем дальше, считаем AGG2\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eshow interfaces queue xe-1\u002F1\u002F0 forwarding-class VoIP\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E…\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EEgress queues: 8 supported, 8 in use\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EQueue: 5, Forwarding classes: VoIP\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E  Queued:\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E    Packets              :           32217685641                 11089 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E    Bytes                :         4696632048800              11856768 bps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E…\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EИнтенсивность\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eλ = 11089 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВнимательный читатель может спросить – WTF? Почему на нижестоящей железке трафика стало больше? Потому что у нее два аплинка и трафик между ними делится примерно поровну. 5,5М залетает с разных сторон.\u003C\u002Fp\u003E\u003Cp\u003EСредний размер пакета здесь и сейчас\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E11856768 bps \u002F 8 \u002F 11089 pps = 133 Байта\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСкорость работы интерфейса с пакетами размером 133 Байт\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eµ = 10Gbps \u002F 8 \u002F 133B = 9 398 496 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДжиттер\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(9 398 496 pps-11089 pps)=1 \u002F 9 387 407 pps=1*10\u003Csup\u003E-7\u003C\u002Fsup\u003Eс= 0,1мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EА до косов был 0,6 мкс. На этой железке уменьшили всего в 6 раз.\u003C\u002Fp\u003E\u003Cp\u003EВ оконцовке считаем CSR2, где была самая боль из-за гигового интерфейса.\u003C\u002Fp\u003E\u003Cp\u003EНа Huawei это выглядит\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Edis port-queue statistics interface gi0\u002F2\u002F20 ef outbound\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EGigabitEthernet0\u002F2\u002F20 outbound traffic statistics:\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E [ef]\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E  Pass:                  844,167,975 packets,            103,921,473,916 bytes\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E  Discard:                         0 packets,                          0 bytes\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E  Last 5 seconds pass rate:\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E                                 368 pps,                        324,328 bps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E  Last 5 seconds discard rate:\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E                                   0 pps,                              0 bps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EИнтенсивность\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eλ = 368 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСредний размер пакета здесь и сейчас\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E324328 bps \u002F 8 \u002F 368 pps = 110 Байт (такое ощущение, что Хуавей не учитывает l2 заголовок)\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСкорость работы интерфейса с пакетами размером 110 Байт\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eµ = 1Gbps \u002F 8 \u002F 110B = 1 136 363 pps\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДжиттер\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ET = 1\u002F(1 136 363 pps-368 pps)=1 \u002F 1 135 995 pps=8,8*10\u003Csup\u003E-7\u003C\u002Fsup\u003Eс= 0,88мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EА до косов был 8,6 мкс. На этой железке уменьшили на порядок, в 10 раз.\u003C\u002Fp\u003E\u003Cp\u003EИ давайте насладимся результатом, сложив все джиттеры по дороге AGG1-AGG2-CSR2\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E0,05 + 0,1 + 0,88 = 1 мкс\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВуаля, мы уложились! Не забываем добавить еще 1 мкс в обратную сторону (хотя ее бы неплохо посчитать таким же образом, но мне лень). И получается, что мы остались в рамках бюджета 3 мкс. На тоненького конечно, но пролазим же! Натурные эксперименты показали, что все работает. Пока не сломается).\u003C\u002Fp\u003E\u003Ch2\u003EДоверяй, но проверяй\u003C\u002Fh2\u003E\u003Cp\u003EУ читателя из нашей проф. среды ко всем этим выкладкам может возникнуть законный вопрос.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F1e2\u002F33b\u002Fe65\u002F1e233be653c0e8afd903b1f5a26f4d4d.jpg\" width=\"233\" height=\"288\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F1e2\u002F33b\u002Fe65\u002F1e233be653c0e8afd903b1f5a26f4d4d.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F1e2\u002F33b\u002Fe65\u002F1e233be653c0e8afd903b1f5a26f4d4d.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПраво, у самого были сомнения. Одно дело, что пробные базы LTE TDD заработали, но никто ж не может проверить, что там происходит в буфере с джиттерами. Расчеты расчетами, но хочется чего-то более осязаемого. И их есть у нас! Оказывается, в системе управления базовыми станциями можно запускать тесты качества синхронизации. Условно раз в секунду система залазит в стек PTPv2 и анализирует время.\u003C\u002Fp\u003E\u003Cp\u003EСкомпилированная таблица выгрузки по 9 тестовым базовым станциям в разных точках сети с разным количеством маршрутизаторов по дороге (от 3 до 10) выглядит следующим образом:\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc3d\u002F3ef\u002Ffc7\u002Fc3d3effc7e763a751d5f0952b0b78714.jpg\" width=\"384\" height=\"139\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc3d\u002F3ef\u002Ffc7\u002Fc3d3effc7e763a751d5f0952b0b78714.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc3d\u002F3ef\u002Ffc7\u002Fc3d3effc7e763a751d5f0952b0b78714.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ ней представлены максимальные отклонения от… а вот не знаю от чего. Либо от первого значения. Либо... да кто его знает. У меня документации на эту тему нет. В последней строчке данные по среднему значению задержки. Очень интересно, но кроме того, что некие результаты идут в ± микросекундах ничего не дает. Но, вот дальше по каждой БС есть своя статистика. Выглядит следующим образом:  \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd1\u002Fc1c\u002Ffcc\u002Fdd1c1cfcc3a00717e1245eb5436781c8.jpg\" width=\"481\" height=\"301\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd1\u002Fc1c\u002Ffcc\u002Fdd1c1cfcc3a00717e1245eb5436781c8.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd1\u002Fc1c\u002Ffcc\u002Fdd1c1cfcc3a00717e1245eb5436781c8.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ этой табличке видно, что проводится некий тест Phase Discrimination, что на русский переводится как изменение фазы или дрожание фазы, ну а на нашем пакетном языке — тот самый джиттер. И тут не совсем понятно что это за значения и почему часть из них имеет отрицательное значение. Либо система накапливает статистику двусторонних задержек за секунду и считает среднее. Либо берет какое-то случайное значение раз в секунду. Я склонен думать, что истина где-то посередине. Но главное, что в колонке G показан тот самый джиттер. Мы пытаемся попасть в ±1,5мкс (или ± 1500нс) и результат в колонке G радует глаз. А главное совпадает с расчетами. Можно задавать разную длительность теста. У нас он шел 2500 секунд (~40 минут). Естественно, результаты такого количества измерение приятнее смотреть на графике. Можно так\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F874\u002F997\u002F49a\u002F87499749a3e627e44bdf8869c986c6a3.jpg\" width=\"1003\" height=\"592\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F874\u002F997\u002F49a\u002F87499749a3e627e44bdf8869c986c6a3.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F874\u002F997\u002F49a\u002F87499749a3e627e44bdf8869c986c6a3.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМожно этак\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0a6\u002F491\u002F31d\u002F0a649131dd0315188b7915c3706011b3.jpg\" width=\"1003\" height=\"771\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0a6\u002F491\u002F31d\u002F0a649131dd0315188b7915c3706011b3.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0a6\u002F491\u002F31d\u002F0a649131dd0315188b7915c3706011b3.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЧто мы тут наблюдаем? Для БС3 основная масса значений находится в коридоре ± 1000нс. Есть случаи единичных выбросов за +2000нс и -3000нс. Что это означает, судить без документации не берусь. Могу лишь констатировать факт, что как и было рассчитано, джиттер плавает в зависимости от заполненности буферов на маршрутизаторах и в целом не особо зависит от количества железок в трассе. Как говорилось ранее, на джиттер в основном влияет понижение скорости по трассе типа 100G→10G, 10G→1G и несколько аплинков у железки. Для всех БС количество маршрутизаторов в трассе разное, но количество девайсов, где проводится понижение скорости или есть несколько аплинков — одинаковое: в ядре (несколько аплинков и понижение), на агрегации на входе в кольцо (несколько аплинков) и на конечном маршрутизаторе (понижение скорости). В итоге значения джиттера для БС в разных конца сети построенной по нашему дизайну похожи как братья близнецы. С чем нас и поздравляем.\u003C\u002Fp\u003E\u003Ch2\u003EАппаратная vs программная синхронизация  \u003C\u002Fh2\u003E\u003Cp\u003EОтличия качества синхронизации G.8275.1 с аппаратной поддержкой от G.8275.2 запущенного правильным дизайном, QoS’ом и божьей помощью можно оценить по той же самой скомпилированной табличке измерений джиттера из системы управления базовыми станциями. И видны они невооруженным взглядом  .\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F125\u002F3bf\u002Ff14\u002F1253bff14d5475f0307871a0e9f6cec7.jpg\" width=\"643\" height=\"361\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F125\u002F3bf\u002Ff14\u002F1253bff14d5475f0307871a0e9f6cec7.jpg 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F125\u002F3bf\u002Ff14\u002F1253bff14d5475f0307871a0e9f6cec7.jpg 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСмотрите. Желтым цветом это БС живущие на программном G.8275.2. Зеленым и синим — на аппаратном G.8275.1. Если для желтых БС1-БС9 джиттер (для примера выделен красный прямоугольник) измеряется в тысячах наносекунд, то для БС10-БС15 (зеленые) в единицах и десятках. А для БС16-БС18 (синие) в сотнях. Почему есть разница между желтыми и синими однозначно не скажу, скорее всего проблема в том, что синие живут на Juniper ACX2100, а там есть какие-то проблемки с простановкой timestamp в режиме boundary clock. Но тут интересно другое. На аппаратном профиле среднее значение задержки (фиолетовый прямоугольник) в районе 0 нс (это взяли и сложили все 2500 измерений). А на программном втором профиле оно болтается в районе микросекунды. И именно что болтается — никакой стабильности. Вот вам и разница, вот вам и ответ — аппаратный профиль точнее на целый порядок, а то и три, не зависит от загрузки на сети и позволяет без всяких QoS’ов и дизайнов запустить хоть LTE TDD, хоть LTE Advanced MIMO. Правда требуется заплатить денюжки за аппаратную часть и лицензии. Но это уже тема другого разговора.  \u003C\u002Fp\u003E\u003Ch2\u003EЧто это было?  \u003C\u002Fh2\u003E\u003Cp\u003EНо вообще мы с вами скрестили магию \u003Cs\u003Eводы и огня\u003C\u002Fs\u003E теории вероятностей и QoS’ов, чтобы посмотреть, как же оно там работает и что можно сделать. Если очень кратко, то разобравшись, как работает протокол PTPv2 (а именно вычисляет фазу и частоту), поняли, что для счастья нужно:\u003C\u002Fp\u003E\u003Cp\u003E1. обеспечить симметрию прямых и обратных путей\u003C\u002Fp\u003E\u003Cp\u003E2. уменьшить джиттер\u003C\u002Fp\u003E\u003Cp\u003EПервый пункт мы решили исправлением метрик с сопутствующей перенастройкой ISIS. А вот второй решали через QoS, поместив пакеты синхронизации в отдельную очередь с приоритетным обслуживанием. \u003Cstrong\u003E\u003Cem\u003EНо фокус состоял не в приоритетности обслуживания пакетов синхронизации как таковой, а в том, что в этой очереди мы собрали маленькие пакеты, уменьшив их среднюю длину в 10 раз, из-за чего джиттер также упал на один порядок\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E\u003Cem\u003E. \u003C\u002Fem\u003EЯ же говорю, что QoS крайне плохо стандартизирован и каждый художник вертит им как хочет в самую неожиданную сторону. На мой взгляд QoS – это крайне расплывчатая и даже не технология, а набор каких-то магических заклинаний, комбинируя которые можно гибко подходить к решению разных задач. Играть можно не только настройками классификатора и планировщика, но и разными метками (dscp\u002F802.1p\u002Fexp) в пакетах, но это как-нибудь в другой статье.\u003C\u002Fp\u003E\u003Ch2\u003EУспешный успех?  \u003C\u002Fh2\u003E\u003Cp\u003EПытливый читатель, домотав досюда все 45 листов А4, возможно спросит: «И че? В чем новизна? Что ты хотел сказать этой статьей? Отвечаю. Во-первых, получай 3GPP! Что вы там у себя думали, мы тут не сможем на коленке микросекунды собрать? А во-вторых, просто рассказать, как не случайно съеденная оливьешка \u003Cs\u003Eвзмахнула крылом\u003C\u002Fs\u003E случайно привела к формуле вычисления джиттера и ее практическому применению. Ну и вообще – еще одно подтверждение, что сеть надо не просто купить, но и как следует приготовить. А QoS он как мазик для оливьешки — серьезному блюду серьезный ингредиент, без которого даже докторская колбаса не вывезет.\u003C\u002Fp\u003E\u003Cp\u003E\tЗаказчик получил возможность запустить сотни простаивающих секторов LTE TDD на врЕменном решении. Почему временном? Потому что при данной реализации без промежуточной коррекции и с подачей PTPv2 G.8275.2 поверх MPLS, а не IP с аппаратной поддержкой (как завещано стандартом) есть зависимость от количества трафика на сети. Достаточно кому-то очень упорному или клиентоориентированному прописать толстый канал для абонента и раскрасить его realtime qos’ом, как синхронизация может посыпаться, унося в небытие радость интернета для мобильных абонентов. С другой стороны, никто не мешает написать скрипт, который будет укладывать отдельные сектора LTE TDD при потере\u002Fухудшении качества синхронизации, чтобы они не доставляли проблемы на сети, после чего идти оперативно разбираться с происходящим. В общем, заказчику вернули веру в счастливое будущее и возможность запустить сотни секторов, пока где-то едут платы с аппаратной поддержкой G.8275.1, чтоб уж точно не зависеть от геополитических раскладов на карте мира.\u003C\u002Fp\u003E\u003Cp\u003E\tВсем оливье, мира и сетей. Встретимся в других статьях.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp\u003EСписок сопутствующей литературы использованной при изысканиях:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fyandex\u002Farticles\u002F861538\u002F\"\u003Ehttps:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fyandex\u002Farticles\u002F861538\u002F\u003C\u002Fa\u003E - проблемы с NTP\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F163253\u002F\"\u003Ehttps:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F163253\u002F\u003C\u002Fa\u003E - про PTPv2\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Ftf.zone\u002Fsolutions\u002Farchitecture-and-testing-of-network-synchronization-systems\u002F\"\u003Ehttps:\u002F\u002Ftf.zone\u002Fsolutions\u002Farchitecture-and-testing-of-network-synchronization-systems\u002F\u003C\u002Fa\u003E - про синхронизацию в мобильных сетях\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Ftf.nist.gov\u002Fseminars\u002FWSTS\u002FPDFs\u002F2-2_Ericsson_Ruffini_Sync_in_MobileStandards_ruffini-rev3-tot.pdf\"\u003Ehttps:\u002F\u002Ftf.nist.gov\u002Fseminars\u002FWSTS\u002FPDFs\u002F2-2_Ericsson_Ruffini_Sync_in_MobileStandards_ruffini-rev3-tot.pdf\u003C\u002Fa\u003E — 3GPP TS36.133 про требования к LTE сетям\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fpacketpushers.net\u002Fblog\u002Faverage-network-delay\u002F\"\u003Ehttps:\u002F\u002Fpacketpushers.net\u002Fblog\u002Faverage-network-delay\u002F\u003C\u002Fa\u003E - про вычисление джиттера\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Freal-statistics.com\u002Fprobability-functions\u002Fqueueing-theory\u002Fm-m-1-queueing-model\u002F\"\u003Ehttps:\u002F\u002Freal-statistics.com\u002Fprobability-functions\u002Fqueueing-theory\u002Fm-m-1-queueing-model\u002F\u003C\u002Fa\u003E - теория вероятностей в экселичке\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F420525\u002F\"\u003Ehttps:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F420525\u002F\u003C\u002Fa\u003E - СДСМ QoS\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F246791\u002F\"\u003Ehttps:\u002F\u002Fhabr.com\u002Fru\u002Farticles\u002F246791\u002F\u003C\u002Fa\u003E - еще про QoS\u003C\u002Fp\u003E\u003Cp\u003EИ еще множество полезного прочитанного\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fwww.elec.ru\u002Fpublications\u002Ftsifrovye-tekhnologii-svjaz-izmerenija\u002F6015\u002F\"\u003Ehttps:\u002F\u002Fwww.elec.ru\u002Fpublications\u002Ftsifrovye‑tekhnologii‑svjaz‑izmerenija\u002F6015\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Frussianelectronics.ru\u002Fieee1588\u002F\"\u003Ehttps:\u002F\u002Frussianelectronics.ru\u002Fieee1588\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Finfocenter.nokia.com\u002Fpublic\u002F7210SAS229R1A\u002Findex.jsp?topic=%2Fcom.nokia.TSR_Basic_System_Guide%2Fieee_1588v2_ptp-ai9j4okj0i.html\"\u003Ehttps:\u002F\u002Finfocenter.nokia.com\u002Fpublic\u002F7210SAS229R1A\u002Findex.jsp?topic=%2Fcom.nokia.TSR_Basic_System_Guide%2Fieee_1588v2_ptp‑ai9j4okj0i.html\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fphoenix_contact\u002Farticles\u002F495920\u002F\"\u003Ehttps:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fphoenix_contact\u002Farticles\u002F495 920\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fwww.design-reuse.com\u002Farticles\u002F49934\u002Fdelivering-timing-accuracy-in-5g-networks.html\"\u003Ehttps:\u002F\u002Fwww.design‑reuse.com\u002Farticles\u002F49 934\u002Fdelivering‑timing‑accuracy‑in-5g‑networks.html\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fsupport.huawei.com\u002Fenterprise\u002Fen\u002Fdoc\u002FEDOC1100174721\u002F5cffe072\u002Fptp-sync-and-delay_req-messages\"\u003Ehttps:\u002F\u002Fsupport.huawei.com\u002Fenterprise\u002Fen\u002Fdoc\u002FEDOC1 100 174 721\u002F5cffe072\u002Fptp‑sync‑and‑delay_req‑messages\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"lte tdd"},{"titleHtml":"qos"},{"titleHtml":"ptpv2"},{"titleHtml":"isis"},{"titleHtml":"базовые станции"},{"titleHtml":"телеком"},{"titleHtml":"телекоммуникационное оборудование"},{"titleHtml":"сетевая инфраструктура"},{"titleHtml":"сетевое администрирование"},{"titleHtml":"сетевое программирование"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4d1\u002F4d4\u002Fa8d\u002F4d14d4a8d686a6e7a9e642d1b3844714.jpg","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4d1\u002F4d4\u002Fa8d\u002F4d14d4a8d686a6e7a9e642d1b3844714.jpg","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompanies\\\u002Frtk_service\\\u002Farticles\\\u002F907262\\\u002F\"},\"headline\":\"Как запустить LTE TDD, когда инфраструктуры нет, но очень хочется?\",\"datePublished\":\"2025-05-06T12:05:41+03:00\",\"dateModified\":\"2025-05-07T00:31:53+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Denis_Vdovin\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось расск...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompanies\\\u002Frtk_service\\\u002Farticles\\\u002F907262\\\u002F#post-content-body\",\"about\":[\"c_rtk_service\",\"h_tdd\",\"h_network_hardware\",\"h_network_technologies\",\"h_sys_admin\",\"f_develop\",\"f_admin\",\"f_popsci\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F907262\\\u002Fd01a7775bf64f3fb7f70daa76fe0651b\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F824\\\u002Fe44\\\u002F989\\\u002F824e44989117fd1fa43106402d5d0e7e.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fd68\\\u002F20d\\\u002Fc7c\\\u002Fd6820dc7c216e1684b4eb38781f91d68.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F35c\\\u002F202\\\u002F7a9\\\u002F35c2027a96be852b5b44139b0e28f3e0.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fdd8\\\u002F845\\\u002F5c8\\\u002Fdd88455c8f2824d034e2a5cb4922bfaa.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe4a\\\u002Fef5\\\u002F8d4\\\u002Fe4aef58d49873335bb02936a8a28a93a.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F8c2\\\u002F46a\\\u002F636\\\u002F8c246a6363c39a4d1c33f571e888f20b.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F79a\\\u002F38d\\\u002F926\\\u002F79a38d92692c8985ff8736205143b6e6.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F816\\\u002F522\\\u002Fc15\\\u002F816522c15da1e6fe1b2420dbfe03e55e.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F6fd\\\u002F158\\\u002F662\\\u002F6fd1586622e52aee469fecb188bf2661.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F23d\\\u002Fe71\\\u002F3c5\\\u002F23de713c5659465259a68cb89a3a422c.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F957\\\u002F54f\\\u002F462\\\u002F95754f462fe9926ea4a103dac4f824cf.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Faf1\\\u002F76c\\\u002Fee7\\\u002Faf176cee7a05d938e0a61d559fb9bc47.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff36\\\u002Fb14\\\u002Ff79\\\u002Ff36b14f7922436fc9a91869276a744f3.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff53\\\u002Fec7\\\u002F165\\\u002Ff53ec7165bb173c9a1cdf04981e2f35c.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe6d\\\u002F5c0\\\u002Fe8f\\\u002Fe6d5c0e8fe32ba3627fba7ca531d7d4b.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F52d\\\u002Fc73\\\u002Fb2f\\\u002F52dc73b2fb5554436640a8ead402bf89.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F55f\\\u002Fb7b\\\u002F12a\\\u002F55fb7b12ae53814928b561a48ef4c110.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F1b4\\\u002F3cd\\\u002Fc3d\\\u002F1b43cdc3d4e63afed09339997f1e39bc.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F694\\\u002Ff2e\\\u002F544\\\u002F694f2e54431d5a8582082b7f718b9828.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F2f5\\\u002F077\\\u002F0bb\\\u002F2f50770bbc93f2638de57c1d5d30c154.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F7e7\\\u002Fd25\\\u002Fb28\\\u002F7e7d25b280994f9aa4dd94d68267711f.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa6a\\\u002Fced\\\u002F330\\\u002Fa6aced330a335ae06738561f103fe267.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff9a\\\u002Fa9b\\\u002F746\\\u002Ff9aa9b746ad76b46e18302cd616e7c99.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F632\\\u002Fd84\\\u002F651\\\u002F632d84651511335f71de8c9261851ed6.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F43b\\\u002F99d\\\u002Ff20\\\u002F43b99df203b5518eb3b445ecfd70568a.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe1a\\\u002Ff5b\\\u002F8fb\\\u002Fe1af5b8fba0196353706c0b4d52544c2.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F459\\\u002F96b\\\u002F05f\\\u002F45996b05ff21cdf6181fe1a8e8960ce1.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fcb3\\\u002F1e4\\\u002F73b\\\u002Fcb31e473bfdb9ac72a7c98e19f7b175f.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff3f\\\u002F7a8\\\u002F123\\\u002Ff3f7a81231a2b1d218ec7ea1f92a7e00.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa22\\\u002F761\\\u002Fc81\\\u002Fa22761c813e19f750e4153a3dba1c43c.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb22\\\u002F135\\\u002Fc4b\\\u002Fb22135c4b3e95fb1290e178ce2723951.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc49\\\u002F093\\\u002F5c4\\\u002Fc490935c42333a5eae6d357fae09db69.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fd7d\\\u002F985\\\u002F956\\\u002Fd7d9859562932d54873879b817ec696c.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffe3\\\u002F2ee\\\u002F859\\\u002Ffe32ee859712befad50182933467e92f.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3de\\\u002F244\\\u002Fad8\\\u002F3de244ad8b18a41d82716467a66c230f.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc4e\\\u002F507\\\u002Fdda\\\u002Fc4e507ddad05a3d5826bb37dedecccc5.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F2b8\\\u002Fd24\\\u002F03f\\\u002F2b8d2403f3b0e5da5a89c4878b81998b.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff3f\\\u002F385\\\u002F017\\\u002Ff3f3850179fde52eed6abe1d2d8dcf1c.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb05\\\u002Feeb\\\u002Ff22\\\u002Fb05eebf2218ecadf1bbda31e94209bae.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe20\\\u002F701\\\u002F386\\\u002Fe2070138638f1c866a6a389a878477ac.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff90\\\u002F31e\\\u002Fe4c\\\u002Ff9031ee4c45b16aa41692684d36da3a8.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fcbe\\\u002Febd\\\u002F744\\\u002Fcbeebd74499b93204738a13cf2325687.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F272\\\u002F944\\\u002Fda9\\\u002F272944da9d97beabd9a9f5a08c5867a7.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F8b0\\\u002F606\\\u002Fc5f\\\u002F8b0606c5f1e34a55d4567038de09b4ba.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F7a4\\\u002Fb05\\\u002Fde2\\\u002F7a4b05de28ddb02ad907084d0cba3cd2.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F07c\\\u002F345\\\u002Fcf6\\\u002F07c345cf6d65d641327ae8a798f3a425.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F28e\\\u002F4f8\\\u002F1f2\\\u002F28e4f81f25fd26b7b483582185edc499.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F1e2\\\u002F33b\\\u002Fe65\\\u002F1e233be653c0e8afd903b1f5a26f4d4d.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc3d\\\u002F3ef\\\u002Ffc7\\\u002Fc3d3effc7e763a751d5f0952b0b78714.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fdd1\\\u002Fc1c\\\u002Ffcc\\\u002Fdd1c1cfcc3a00717e1245eb5436781c8.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F874\\\u002F997\\\u002F49a\\\u002F87499749a3e627e44bdf8869c986c6a3.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F0a6\\\u002F491\\\u002F31d\\\u002F0a649131dd0315188b7915c3706011b3.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F125\\\u002F3bf\\\u002Ff14\\\u002F1253bff14d5475f0307871a0e9f6cec7.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F4d1\\\u002F4d4\\\u002Fa8d\\\u002F4d14d4a8d686a6e7a9e642d1b3844714.jpg\"]}","metaDescription":"Всем привет! Меня зовут я сам прихожу Денис Вдовин, я системный архитектор в отделе мультисервисных (пакетных) сетей компании РТК-Сервис, и мне бы хотелось рассказать одну историю, которая началась с...","mainImageUrl":null,"amp":true,"customTrackerLinks":[]},"polls":[],"commentsEnabled":{"status":true,"reason":null},"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"hasPinnedComments":false,"format":"review","banner":null,"multiwidget":null,"multiwidgetUuid":null,"readingTime":46,"complexity":null,"isEditorial":false,"allowedFeatures":{"isTestTargetAllow":false}}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"postReasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"viewedPosts":[],"myFeedFilter":{"complexity":"all","score":"all","types":["articles","posts","news"]},"myFeedIsApplyFilters":false,"myFeedIsForce":false,"karma":{"userReasonsList":null}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"articlePinnedComments":{},"searchCommentsResults":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":"","idempotenceKey":""}},"companies":{"companyRefs":{"rtk_service":{"alias":"rtk_service","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002Fc54\u002F0b3\u002F20b\u002Fc540b320b21dcbd5c351f5dd831afca9.jpg","titleHtml":"РТК-Сервис","descriptionHtml":null,"relatedData":null,"statistics":{"subscribersCount":36,"rating":48.85,"invest":null,"postsCount":7,"threadsCount":0,"newsCount":0,"vacanciesCount":0,"employeesCount":5,"careerRating":null},"foundationDate":null,"location":null,"siteUrl":"https:\u002F\u002Fwww.rtk-service.ru\u002F","staffNumber":"501–1 000 человек","registrationDate":null,"representativeUser":null,"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fwww.rtk-service.ru\u002F","siteTitle":null,"favicon":null}],"settings":{"analyticsSettings":[],"branding":{"imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fbranding\u002F3d9\u002F71a\u002Fad8\u002F3d971aad80c9b24e73923683f499f56f.jpg","linkUrl":"https:\u002F\u002Fwww.rtk-service.ru\u002Fabout\u002F?utm_source=habr&utm_medium=oblozhka&utm_campaign=o_kompanii","pixelUrl":null,"uuid":"0191e176-5ba5-71fc-8766-bacf050b20bf"},"status":"active","isStartup":false,"hasActivePolls":false,"shouldShowHabrAds":false},"metadata":{"titleHtml":"РТК-Сервис - ","title":"РТК-Сервис - ","keywords":["телекоммуникационное оборудование","телеком","сетевое оборудование","сетевой инженер","техподдержка","операторы связи","сетевая инфраструктура","сервис оборудования","сервисный партнер","икт-партнер","постгарантийное обслуживание","сетевые технологии"],"descriptionHtml":"7 статей от авторов компании РТК-Сервис","description":"7 статей от авторов компании РТК-Сервис"},"aDeskSettings":null,"careerAlias":null,"schoolAlias":null}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"multiwidgets":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"multiwidgetLoading":false,"vacancies":{},"companiesGalleries":{},"companiesBanners":{},"companiesLandingVacancies":{},"companiesTechnologies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null,"jivoStatus":0,"adminNotifications":null,"availableInvitesCount":{}},"companyAdd":{"currentStep":"","stepsData":{},"uncompletedSteps":[],"isStepLoading":true,"isStepCommitting":false,"isInitialized":false,"agreementContent":""},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"pagesCount":0},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":true},"fixedBanner":{"isArticleStickyPanelVisible":false,"isArticleStickyPanelAtTheBottom":false,"isFixedBannerVisible":false,"isStickyPanelIconsHidden":false},"flows":{"updates":{}},"global":{"isPwa":false,"device":"desktop","isHabrCom":true,"requestId":"8c61f805324709af016e50ace7ffab99"},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"welcomePage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"query":{},"pathname":"\u002Fru\u002Fcompanies\u002Frtk_service\u002Farticles\u002F907262\u002F","path":"\u002Fru\u002Fcompanies\u002Frtk_service\u002Farticles\u002F907262\u002F","href":"\u002Fru\u002Fcompanies\u002Frtk_service\u002Farticles\u002F907262\u002F"}},"me":{"user":null,"uuid":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null,"userUpdates":{"feeds":{"newPostsCount":null,"newThreadsCount":null,"newNewsCount":null,"newCount":null},"conversationUnreadCount":0},"features":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"onboarding":{"currentStep":null,"stepsData":{},"stepsErrors":{},"completedSteps":[],"isStepCommitting":false,"isCommitDisabled":true},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null,"sticker":null},"publicationStatistics":{"statsInfo":{},"statsFunnels":{},"statsGraph":{},"defaultSuggest":{},"suggest":{},"timeTracker":{},"isTrackingActivity":false,"isUserActive":true,"otherPublicationStats":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":true,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"stories":{"stories":null},"technotext":{"years":[],"technotextDocForNominees":null,"technotextDocForWinners":null,"technotextInfo":{},"technotextInfoLoading":false,"technotextWinners":{},"technotextWinnersLoading":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"userVotes":{"karmaVotesList":[],"karmaVotesPagesCount":null,"karmaVotesListLoading":false,"commentsVotesList":[],"commentsVotesPagesCount":null,"commentsVotesListLoading":false,"postsVotesList":[],"postsVotesPagesCount":null,"postsVotesListLoading":false,"userVotesList":[],"userVotesPagesCount":null,"userVotesListLoading":false},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"notificationsLoading":false,"notificationsList":[],"notificationsPageCount":0,"pendingMarkNotificationsRead":[],"publicationsLoading":true,"publicationsList":[],"publicationsPageCount":0,"pendingDeletePublications":false,"pendingMarkPublicationsRead":false},"events":{"eventRefs":{},"eventIds":[],"pagesCount":0,"categories":[],"cities":[],"actualEvents":null,"currentEvent":null,"eventsFilter":{"city":"all","timeStarted":null,"timeEnded":null}},"wysiwyg":{"WYSIWYGRulesRefs":null},"refs":{"specializationRefs":[]},"hint":{"hints":{}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
   <script src="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" defer></script>
   <script src="https://assets.habr.com/habr-web/js/app.58b8c457.js" defer></script>
  </div>
  <div id="overlays">
   <!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor-->
  </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S28W1WC23F"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    </script>
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  </script>
  <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
 </body>
</html>